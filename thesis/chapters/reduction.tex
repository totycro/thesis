\chapter{Proof by Reduction to First-Order Logic without Equality}

A common theme of proofs in theoretical computer science is to instead of proving the result from first principles to reduce the problem to another one, which then is easier to solve.
In this instance, we are able to give a reduction for finding interpolants for first-order logic \emph{with} equality to first-order logic \emph{without} equality, where it is simpler to give an appropriate algorithm.

The general layout of this approach is the following:
From two sets $\Gamma$ and $\Delta$, where $\Gamma \cup \Delta$ is unsatisfiable, we compute $\Gamma'$ and $\Delta'$ which do not make use of equality but simulate equality it via axioms.
In the process of this transformation, also function symbols are replaced by predicate symbols with appropriate axioms to make sure that their behaviour is compatible to the one of functions.
Now an interpolant of $\Gamma'$ and $\Delta'$ can be derived using an algorithm that is only capable of handling predicate symbols, as all other non-logical symbols have been removed.
Since the additional axioms ensure that the newly added predicate symbols mimic equality and functions respectively, we will see that the occurrences of these predicates in the interpolant can be translated back to occurrences of equality and function symbols in first-order logic with equality in the language of $\Gamma$ and $\Delta$, thereby yielding the originally desired interpolant.


\section{Reduction to first-order logic without equality}

As we shall see in this section, first-order formulas with equality can be transformed into first-order formulas without equality in a way that is satisfiability-preserving, which is sufficient for our purposes.

In order to simplify notation, we shall consider constant symbols to be function symbols of arity $0$ in this section.

First, we define the axioms which allow for simulation of equality and functions in first order logic without equality and function symbols:

\begin{defi}
	For a first-order language $\LangSym$ and fresh predicate symbols $E$ and $F_f$ for $f\in \FS(\LangSym)$, we define:\nopagebreak
	\begin{align*}
		\FAX(\LangSym) \defeq{}& \smashoperator{\bigwedge_{f \in \FS(\LangSym)}}  \forall \bar x \exists y (F_f(\bar x, y) \land (\forall z (F_f(\bar x, z) \limpl E(y, z)))) \\
%		\EAX(A) \defeq{} & \forall x \; x=x~\land  \\
%																		 & \begin{aligned} \bigwedge_{\substack{P \in\PS(A)\cup\\ \{F_i\mid f_i\in \FS(A)\}}} &\forall x_1 \ldots \forall x_{\ar(P)} \forall y_1 \ldots \forall y_{\ar(P)} \\
%																 & (( x_1~=~y_1 \land \ldots \land x_{\ar(P)} = y_{\ar(P)}) \limpl  \\
%																 &  (P(x_1, \ldots, x_{\ar(P)}) \Lra P(y_1, \ldots, y_{\ar(P)}) ) ) \end{aligned} 
		\Refl(P) \defeq{}& \forall x P(x,x)  \\ 
		\Congr(P) \defeq{}& 
%\forall x_1 \ldots \forall x_{\ar(P)} \forall y_1 \ldots \forall y_{\ar(P)} \\
\forall x_1 \forall y_1 \ldots \forall x_{\ar(P)} \forall y_{\ar(P)} 
(( E(x_1,y_1) \land \ldots \land E(x_{\ar(P)},  y_{\ar(P)})) \limpl  \\
 & (P(x_1, \ldots, x_{\ar(P)}) \limpl P(y_1, \ldots, y_{\ar(P)}) )) \\
		\EAX(\LangSym) \defeq{}& \Refl(E) \land \;\smashoperator{\bigwedge_{\substack{P \in\PS(\LangSym)\cup\{E\}\cup\\ \{F_f\mid f\in \FS(\LangSym)\}}}}\; \Congr(P)
	%	\EAX(A) \defeq{} & \forall x E(x,x)\land  \\
	%																	 & \begin{aligned} \bigwedge_{\substack{P \in\PS(A)\cup\{E\}\cup\\ \{F_f\mid f\in \FS(A)\}}} &\forall x_1 \ldots \forall x_{\ar(P)} \forall y_1 \ldots \forall y_{\ar(P)} \\
	%																	 & (( E(x_1,y_1) \land \ldots \land E(x_{\ar(P)},  y_{\ar(P)})) \limpl  \\
	%															 &  (P(x_1, \ldots, x_{\ar(P)}) \Lra P(y_1, \ldots, y_{\ar(P)}) ) )
	%\end{aligned} 
\qedhere
\end{align*}
%For sets of first-order formulas $\Phi$ and $h \in \{\FAX, \EAX\}$, $h(\Phi) \defeq \bigcup_{A\in \Phi} h(A)$ .
%$\FAX$ and $\EAX$ generalise to sets of formulas by elementwise application.
\end{defi}

$\Refl(P)$ will be referred to as reflexivity axiom of $P$, $\Congr(P)$ as congruence axiom of $P$.

\begin{defi}[Translation of formulas]
	\label{def:trans}
	Let $A$ be a first-order formula and $E$ and $F_f$ for $f \in \FS(A)$ be fresh predicate symbols.
	Then $\Trans(A)$ is the result of applying the following algorithm to $A$:

	\begin{compactenum}
	\item Replace every occurrence of $s=t$ in $A$ by $E(s, t)$
	\label{def:trans_step1}
	\item As long as there is an occurrence of a function symbol $f$ in $A$:
	\label{def:trans_step2}

		Let $B$ be the atom in which $f$ as outermost symbol of a term occurs.
		Then $B$ is of the form $P(s_1, \ldots, s_{j-1}, f(\bar t),\allowbreak s_{j+1}, \ldots s_m)$.
		Replace $B$ in $A$ by $\exists y (F_f(\bar t, y) \land P(s_1, \ldots, s_{j-1}, y, s_{j+1}, \ldots s_m))$ for a variable $y$ which does not occur free in $B$.
	\end{compactenum}

	Moreover, let the inverse operation $\TransInv(B)$ for formulas $B$ in the language $\Trans(L(A))$ be defined as the result of applying the following algorithm to $B$:
	\begin{compactenum}
	\item Replace every occurrence of $E(s, t)$ in $B$ by $s=t$.
	\item For every $f \in FS(A)$, replace every occurrence of 
		$\exists y (F_f(\bar t, y) \land P(s_1, \ldots, s_{j-1},\allowbreak y,\allowbreak s_{j+1}, \ldots s_m))$
		in $B$ by $P(s_1, \ldots, s_{j-1},\allowbreak f(\bar t),\allowbreak s_{j+1}, \ldots s_m)$ and every remaining occurrence of $F_f(\bar t, s)$ by $f(\bar t) = s$.
	\end{compactenum}

	For sets of first-order formulas $\Phi$, let $\Trans(\Phi) \defeq \bigcup_{A\in\Phi} \Trans(A)$ and 
$\TransInv(\Phi) \defeq \bigcup_{A\in\Phi} \TransInv(A)$.
\end{defi}

\begin{lemma}
	\label{lemma:tinv}
	Let $A$ be a first-order formula and $\Phi$ be a set of first-order formulas.
	Then 
	$\TransInv(\Trans(A)) = A$
	and
	$\TransInv(\Trans(\Phi)) = \Phi$
	.
\end{lemma}
\begin{proof}
	Step 1 and 2 in the transformation algorithm for $\Trans$ and $\TransInv$ are concerned with different symbols each and therefore do not interfere with each other.
	Moreover, the respective steps in both algorithms are the inverse of each other.
	For step 1, this is immediate and for step 2, consider that all occurrences of $F_f$ for $f \in \FS(A)$ in $\Trans(A)$ have been introduced by $\Trans$ and are consequently of the form
	$\exists y (F_f(\bar t, y) \land P(s_1, \ldots, s_{j-1}, y, s_{j+1}, \ldots s_m))$, which in $\TransInv$ is replaced by 
$P(s_1, \ldots, s_{j-1},\allowbreak f(\bar t),\allowbreak s_{j+1}, \ldots s_m)$.
\end{proof}

\begin{defi}
	For first-order formulas $A$, let $\TransAll(A) = \FAX(\Lang(A)) \land \EAX(\Lang(A)) \land \Trans(A)$ and for sets of first-order formulas $\Phi$, let $\TransAll(\Phi) = \{\FAX(\Lang(\Phi)), \EAX(\Lang(\Phi))\} \cup \Trans(\Phi)$.
\end{defi}

\begin{lemma}
	\label{lemma:trans_transform}
	$\TransAll(\Gamma \cup \Delta)\,\liff\,\TransAll(\Gamma) \cup \TransAll(\Delta)$.
\end{lemma}
\begin{proof}
	\begin{align*}
		\TransAll(\Gamma \cup \Delta)\,\liff~&\{\FAX(\Lang(\Gamma\cup\Delta)), \EAX(\Lang(\Gamma \cup\Delta))\} \cup \Trans(\Gamma \cup \Delta) \\
		\liff~&\{\FAX(\Lang(\Gamma)\cup\Lang(\Delta)), \EAX(\Lang(\Gamma)\cup\Lang(\Delta))\} \cup \Trans(\Gamma \cup \Delta) \\
		\liff~&\{\FAX(\Lang(\Gamma)) \land \FAX(\Lang(\Delta)), \EAX(\Lang(\Gamma)) \land \EAX(\Lang(\Delta))\} \cup \Trans(\Gamma) \cup \Trans(\Delta) \\
		\liff~&\{\FAX(\Lang(\Gamma)),\EAX(\Lang(\Gamma))\} \cup \{\FAX(\Lang(\Delta)) \land \EAX(\Lang(\Delta))\} \cup \Trans(\Gamma) \cup \Trans(\Delta) \\
		\liff~&\TransAll(\Gamma) \cup \TransAll(\Delta)
		\qedhere
	\end{align*}
\end{proof}

Note that $\TransAll(A)$ contains neither the equality predicate nor function symbols but additional predicate symbols instead. More formally:

%\begin{defi}[continues=exa:cont]
%	Let $\LangSym$ be a first-order language. 
%	Then $\Trans(\LangSym)$ denotes $(\LangSym\cup \{E\}\cup\{F_f\mid f \in \FS(\LangSym)\}) \setminus(\{=\nolinebreak \} \cup\nolinebreak \FS(\LangSym))$.
%\end{defi}

\begin{defi}[Translation of languages]
	Let $\LangSym$ be a language.
	Then $\Trans(\LangSym)$ denotes $(\Lang(\LangSym)\cup \{E\}\cup\{F_f\mid f \in \FS(\LangSym)\}) \setminus(\{=\nolinebreak \} \cup\nolinebreak \FS(\LangSym))$.
\end{defi}

\begin{lemma}~ 
	\label{lemma:trans_lang}
	\begin{compactenum}
	\item
		Let $\Phi$ be a set of first-order formulas. Then $\TransAll(\Phi)$ is in the language~$\Trans(\Lang(\Phi))$.
		\label{lemma:trans_lang1}

	\item 
		If $\Psi$ is in the language $\Trans(\LangSym)$, then $\TransInv(\Psi)$ is in the language~$\LangSym$.
		\label{lemma:trans_lang2}
	\end{compactenum}
\end{lemma}

\begin{prop}
	\label{prop:trans_sat_equiv}
	Let $\Phi$ be a set of first-order formulas.
	\begin{compactenum}
		\item If $\Phi$ is satisfiable, then so is $\TransAll(\Phi)$.
			\label{prop:trans_sat_equiv1}
		\item Let $\LangSym$ be a first-order language and $\Phi$ a set of first-order formulas in the language~$\Trans(\LangSym)$.
			If $\{\FAX(\LangSym), \EAX(\LangSym)\} \cup \Phi $ is satisfiable, then so is $\TransInv(\Phi)$.
			\label{prop:trans_sat_equiv2}
	\end{compactenum}
\end{prop}
\begin{proof}
	Suppose $\Phi$ is satisfiable.
	Let $M$ be a model of $\Phi$.
	We show that $\TransAll(\Phi)$ is satisfiable by extending $M$ to the language $\Lang(\Phi)\cup\{E\}\cup\{F_f\mid f \in \FS(A)\}$ to satisfy to a model of $\TransAll(\Phi)$.

	First, let $M \entails E(s, t)$ if and only if $M \entails s = t$.
	By reflexivity of equality, it follows that $M \entails \Refl(E)$ and
	as equality satisfies the congruence axiom we get that $M$ is a model $\Congr(E)$ and in consequence also of $\EAX(\Phi)$.

	Second, let $M \entails F_f(\bar x, y)$ if and only if $M \entails f(\bar x) = y$ for all $f \in \FS(\Phi)$. 
	Since $M$ is a model of $\Phi$, it maps $f$ to a function, which returns a unique result for every combination of parameters.
	This however is precisely the logical requirement on $F_f$ stated by $\FAX(\Phi)$,   
	hence $M$ is a model of $\FAX(\Phi)$.

	Lastly, we show that $M \entails A$ for all $A \in \Phi$.
	By the above definition of $E$ in $M$, step $\ref{def:trans_step1}$ of the algorithm in definition \ref{def:trans} yields a formula that is satisfied by $M$.
	For step \ref{def:trans_step2}, suppose $P(s_1, \ldots, s_{j-1}, f(\bar t),\allowbreak s_{j+1}, \ldots s_m)$ does (not) hold under $M$.
	Let $y$ such that $M \entails f(\bar t)=y$.
	By our definition of $F$ under $M$, $M\entails F(\bar t, y)$ with this unique $y$.
	Hence $\exists y (F(\bar t, y) \land P(s_1, \ldots, s_{j-1}, y, \allowbreak s_{j+1}, \ldots s_m))$ does (not) hold under $M$.


	For the other direction, suppose $\{\FAX(\LangSym), \EAX(\LangSym)\} \cup \Phi$ is satisfiable.
	We extend a model $M$ of this set of formulas to a model of $\TransInv(\Phi)$ by extending it from the language $\Trans(\LangSym)$ to include $\{=\}$ and $\FS(\LangSym)$.

	First, let $M\entails s = t$ if and only if $M\entails E(s, t)$.
	As $M$ is a model of $\EAX(A)$, $E$ is reflexive. 
	Since $M \entails \Congr(E)$, we can derive the symmetry of $E$ by the following instantiation of it using reflexivity:
	$M \entails (E(s, t) \land E(s, s)) \limpl ( E(s, s) \limpl\nolinebreak E(t, s))$.
	By symmetry, we have that $M \entails E(s, r) \liff E(r, s)$, and hence we can show the transitivity of $E$ by another instance of $\Congr(E)$: 
	$M \entails (E(s, r) \land E(s, t)) \limpl ( E(s, s) \limpl\nolinebreak E(r, t))$, i.e.\ given $E(r, s)$ and $E(s, t)$, we can deduce $E(r, t)$ in $M$.
	As these properties directly also apply to $=$ in $M$, equality is defined properly in $M$.

	Second, let $M\entails f(\bar t) = s$ if and only if $M\entails F_f(\bar t, s)$ for all $f \in \FS(\LangSym)$.
	As by assumption $M$ is a model of $\FAX(A)$, we know that for every $\bar t$, some $s$ with $M\entails F(\bar t, s)$ exists and is uniquely defined.
	Hence $f$ in $M$ refers to a well-defined function.

	Lastly, to show that $M \entails \TransInv(\Phi)$, 
	consider that the interpretations of the predicates $E$ and $=$ coincide in $M$.
	Furthermore, let $B$ be an occurrence of $\exists y (F_f(\bar t, y) \land P(s_1, \ldots, s_{j-1}, y, s_{j+1}, \ldots s_m))$ for some $f \in \FS(\LangSym)$ in $\Phi$.
	Then by the above definition of $f$ in $M$, we have that $B$ is in $M$ equivalent to $\exists y f(\bar t) = y) \land P(s_1, \ldots, s_{j-1}, y, s_{j+1}, \ldots s_m))$, which due to $f$ being a function is equivalent to 
	$M \entails P(s_1, \ldots, s_{j-1}, f(\bar t), s_{j+1}, \ldots s_m))$.

	Similarly, let $B$ be an occurrence of $F_f(\bar t, s)$ in $\Phi$.
	Then by our above definition of $f$ in $M$, we have that $M \entails f(\bar t) = s$ iff $M \entails B$.
\end{proof}

\begin{corr}
	Let $\Phi$ be a set of first-order formulas.
	Then $\Phi$ is satisfiable if and only if $\TransAll(\Phi)$ is satisfiable.
\end{corr}
\begin{proof}
	The left-to-right direction is directly given in proposition \ref{prop:trans_sat_equiv}.
	For the other direction, consider that by proposition \ref{prop:trans_sat_equiv}, $\TransInv(\Trans(\Phi))$ is satisfiable and by Lemma \ref{lemma:tinv}, $\TransInv(\Trans(\Phi)) = \Phi$.
\end{proof}



\section{Computation of interpolants in first-order logic without equality and function symbols}


\begin{thm}
	\label{thm:prop_interpol}
	Let $\Gamma$ and $\Delta$ be sets of first-order clauses without equality and function symbols such that $\Gamma \cup \Delta$ is unsatisfiable. Then there is an interpolant of $\Gamma$ and $\Delta$.
\end{thm}
\begin{proof}
	By the Compactness Theorem, there are finite $\Gamma' \subseteq \Gamma$ and $\Delta' \subseteq \Delta$ such that $\Gamma' \cup \Delta'$ is unsatisfiable. Let $C = \bigwedge_{A \in \Gamma'} A$ and $D = \bigwedge_{A \in \Delta'} A$. As $C\land D$ is unsatisfiable, $C \entails \lnot D$.

	By the completness of cut-free sequent calculus, there is a proof of $C \entails \lnot D$. By Lemma \ref{lemma:maehara}, there is an interpolant of $C$ and $D$, which clearly is an interpolant of $\Gamma$ and $\Delta$.
\end{proof}

\begin{lemma}[Maehara]
	\label{lemma:maehara}
	Let $\pi$ be a cut-free sequent calculus proof of $C \entails \lnot D$. Then there is an interpolant $I$ of $C$ and $D$.
\end{lemma}



TODO: put some kind of propositional interpolation algorithm here as soon at it is clear which to pick



\section{Conclusion}

\begin{proof}[Proof of Theorem \ref{thm:interpolation} (Interpolation)]
	Since $\Gamma \cup \Delta$ is unsatisfiable,
	by proposition \ref{prop:trans_sat_equiv}, $\TransAll(\Gamma \cup \Delta)$ is unsatisfiable.
	It follows from Lemma \ref{lemma:trans_transform}, that $\TransAll(\Gamma) \cup \TransAll(\Delta)$ is unsatisfiable as well.
	By Lemma \refsub{lemma:trans_lang}{lemma:trans_lang1} $\TransAll(\Gamma) \cup \TransAll(\Delta)$ contains neither function symbols nor the equality symbol.
	Hence by Theorem \ref{thm:prop_interpol}, there is an interpolant $I$ such that
	\begin{enumerate}
	\item $\TransAll(\Gamma) \entails I$
	\item $\TransAll(\Delta) \entails \lnot I$ 
	\item $\Lang(I) \subseteq \Lang(\TransAll(\Gamma)) \cap \Lang(\TransAll(\Delta))$
		\label{proof:interpolation1_3}
	\end{enumerate}

	We now show that $\TransInv(I)$ is an interpolant of $\Gamma$ and $\Delta$.

	$\TransAll(\Gamma) \entails I$ is equivalent to $\TransAll(\Gamma) \cup \{\lnot I\}$ being unsatisfiable.
	Through the unfolding of $\TransAll(\Gamma)$, we get that 
	$\{\FAX(\Lang(\Gamma)), \EAX(\Lang(\Gamma))\} \cup \Trans(\Gamma) \cup \{\lnot I\}$ is unsatisfiable.

	Since $\Lang(\lnot I) \subseteq \Lang(\TransAll(\Gamma))$, we can apply Proposition
	\refsub{prop:trans_sat_equiv}{prop:trans_sat_equiv2}
	 by considering $\Trans(\Gamma) \cup \{\lnot I\}$ as $\Phi$ to conclude that $\TransInv(\Trans(\Gamma) \cup \{\lnot I\})$ is unsatisfiable. By pulling $\TransInv$ inward and an application of Lemma \ref{lemma:tinv}, we get that $\Gamma \cup \{\TransInv(\lnot I)\} = \Gamma \cup \{\lnot \TransInv(I)\}$ is unsatisfiable. 
	Therefore $\Gamma \entails \Trans^{-1}(I)$.

	For $\Delta$, an analoguous argument goes through and so from $\TransAll(\Gamma) \entails \lnot I$ we can deduce that $\Delta \entails \lnot \Trans^{-1}(I)$.

	By item \ref{proof:interpolation1_3}, $I$ is in the language $\Lang(\TransAll(\Gamma)) \cap \Lang(\TransAll(\Delta))$, which by Lemma \refsub{lemma:trans_lang}{lemma:trans_lang1} is $\Trans(\Lang(\Gamma)) \cap\nolinebreak \Trans(\Lang(\Delta)) $. 
	\begin{align*}
		\Trans(\Lang(\Gamma)) \cap\nolinebreak \Trans(\Lang(\Delta)) =\,&
		(\Lang(\Gamma)\cup \{E\}\cup\{F_f\mid f \in \FS(\Gamma)\}) \setminus(\{=\nolinebreak \} \cup\nolinebreak \FS(\Gamma))~\cap \\
	& (\Lang(\Delta)\cup \{E\}\cup\{F_f\mid f \in \FS(\Delta)\}) \setminus(\{=\nolinebreak \} \cup\nolinebreak \FS(\Delta))\\
		=\,& ((\Lang(\Gamma) \cap \Lang(\Delta)) \cup \{E\} \cup\{F_f\mid f \in \FS(\Gamma)\cap\FS(\Delta\}))  \setminus(\{=\} \cup \FS(\Gamma) \cup \FS(\Delta)) \\
		=\,& ((\Lang(\Gamma) \cap \Lang(\Delta)) \cup \{E\} \cup \{F_f\mid f\in \FS( \Lang(\Gamma) \cap \Lang(\Delta)) ) \setminus ( \{=\} \cup \FS(\Lang(\Gamma) \cap \Lang(\Delta)) )  \\ 
  =\,& \Trans(\Lang(\Gamma) \cap \Lang(\Delta))
	\end{align*}

	As $I$ is in the language $\Trans(\Lang(\Gamma) \cap \Lang(\Delta))$, by Lemma \refsub{lemma:trans_lang}{lemma:trans_lang2}, $\TransInv(I)$ is in the language $\Lang(\Gamma) \cap \Lang(\Delta)$.
\end{proof}


