\chapter{Interpolant extraction from resolution proofs in one phase}
\label{sec:one_phase}

In contrast to the approach described in chapter \ref{sec:two_phases}, where propositional interpolants are extracted first and colored terms lifted just in a second, separate phase, 
we now present a method which is based on the former but merges the two phases.

The motivation for the separation in two phases lies in the fact that just after the formation of the propositional interpolant, all terms and their logical relation can be known.
This however neglects the fact that proofs are frequently structured in a way such that the occurrence of certain symbols and variables are restricted to certain areas of the proof.
By lifting these and prefixing the entire interpolant with their respective quantifier, the resulting formula is not optimal in the sense that the quantifier scope can be minimised.

Consider the following example:
\todo{example notation reference}

\begin{exa}
	\label{exa:one_phase_motivation}
	Let $\Gamma = \{ P(x) \lor Q(y) \}$ and $\Delta = \{\lnot P(a), \lnot Q(a)\}$.
	We consider the following refutation of $\Gamma \cup \Delta$, which we annotate by the interpolation extraction by appending $\PI(C)$ to each clause $C$, separated by ``$|$''.
	For the sake of brevity, we sometimes give simplified by logically equivalent versions of $\PI(C)$.
	This notational convention will be used throughout this thesis for examples of a similar form.

	\begin{prooftree}
		\AxiomCm{ P(x) \lor Q(y) \mid \bot}
		\AxiomCm{ \lnot P(a)  \mid \top}
		\BinaryInfCm{ Q(y) \mid P(a) }
		\AxiomCm{ \lnot Q(a)  \mid \top}
		\BinaryInfCm{ \square \mid Q(a) \lor P(a) }
	\end{prooftree}

	Lifting and quantification of this propositional interpolant according to Theorem~\ref{thm:two_phases} gives the interpolant $\forall x_a (Q(x_a) \lor P(x_a))$.
	Note however that the more general formula $(\forall x_a Q(x_a) ) \lor (\forall x_a P(x_a))$ is an interpolant as well which cannot be constructed by this method.
	Consider yet that $\Delta$ entails only the negated interpolant, so by generalising the interpolant, the formula entailed by $\Delta$ becomes more specialised.
\end{exa}

%Colored terms satisfying certain restrictions which allow for determining the order of the quantifier of the their corresponding lifting variables are lifted and bound during the extractions of the interpolants.
%The resulting interpolants are therefore in general not in prenex form.

%The key idea which enables this early lifting of colored terms is that proofs often consist of several parts which are independent of each other. 


\section{Interpolant extraction with simultaneous lifting}

We now define the lifted interpolant $\LI$.
Note that the structure of the resulting formula coincides the ones from $\PI$ as defined in Definition~\ref{def:PI} except for quantifiers and, of course, the colored terms.

\begin{defi}[Incrementally lifted interpolant]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	We define $\LI(\pi)$ to be $\LI(\square)$, where $\square$ is the empty clause derived in $\pi$.

	Let $C$ be a clause in $\pi$. 
	%For a literal $\lambda$ in $C$, we denote the corresponding literal in $\LIcl(C)$ by $\lambda\cll$, whose existence is ensured Lemma~\ref{lemma:li_vs_clause_plus_literals_equal}.
	%We define $\LIcl(C) \defeq C$. \mytodo{if this version is final, drop $\LIcl(C)$ everywhere}
	We define the intermediary formula $\LI^\bullet(C)$ as follows:
	\begin{description}
		\item{} Base case.
			If $C \in \Gamma$, $\LI^\bullet(C) \defeq \bot$.
			If otherwise $C \in \Delta$, $\LI^\bullet(C) \defeq \top$.

		\item{} Resolution.
			If the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma =  l'\sigma$, then define $\LI(C)$ as follows:
			\begin{enumerate}
				\item If $l$ is $\Gamma$-colored:
					$\LIpre(C) \defeq \LI(C_1)\sigma\spas\lor \LI(C_2)\sigma $

				\item If $l$ is $\Delta$-colored:
					$\LIpre(C) \defeq \LI(C_1)\sigma\spas\land \LI(C_2)\sigma$

				\item If $l$ is grey:
					$\LIpre(C) \defeq
					(l\sigma \land \LI(C_2)\sigma) \spas\lor
					(\lnot l'\sigma\land \LI(C_1)\sigma)
					$

			\end{enumerate}

		\item{} Factorisation.
			If the clause $C$ is the result of a factorisation step $\inference$ of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\LIpre(C) \defeq \lifboth{\LI(C_1)\sigma}$.

		\item{} Paramodulation.
			If the clause $C$ is the result of a paramodulation step $\inference$ of $C_1 : s = t \lor D$ and $C_2: E\occ{r}$ with $\sigma = \mgu(\inference)$.
			Let $h\occ{r}$ be the maximal colored term in which $r$ occurs in $E\occ{r}$
			and define $\LI(C)$ as follows:

			\begin{enumerate}

				\item If $h\occur{r}$ is $\Delta$-colored and $h\occur{r}$ occurs more than once in $\LI(C_2)\sigma \lor E\occ{r}\sigma$:
					%\label{def:PI_paramod_1}
					\newline
					$\LIpre(C) \defeq  ( s=t \land \LI(C_2) )\sigma \lor (s\neq t \land \LI(C_1))\sigma \lor (s=t \land h\occur{s} \neq      h\occur{t})\sigma$

				\item If $h\occur{r}$ is $\Gamma$-colored and $h\occur{r}$ occurs more than once in $\LI(C_2)\sigma \lor E\occ{r}\sigma$:
					%\label{def:PI_paramod_2}
					\newline
					$\LIpre(C)\defeq{} [ ( s=t \land \LI(C_2) )\sigma \lor (s\neq t \land \LI(C_1))\sigma ] \land\allowbreak (s\neq t \lor h\occur{s} = h\occur{t})\sigma$

				\item If $r$ does not occur in a colored term in $E\occur{r}$ which occurs more than once in $\LI(C_2)\sigma \lor E\occ{r}\sigma$:
					%\label{def:PI_paramod_3}
					\newline
					$\LIpre(C) \defeq{} ( s=t \land \LI(C_2) )\sigma \lor (s\neq t \land \LI(C_1))\sigma $ 

			\end{enumerate}
	\end{description}

	\noindent
	$\LI(C)$ is built from $\LIpre(C)$ according to the following lifting procedure:

	\begin{enumerate}
		\item Lift all maximal colored occurrences of a term $t$ in $\LIpre(C)$ for which at least one of the following conditions, referred to as \defiemph{lifting conditions}, applies:
			\begin{itemize} 
				\item The term $t$ contains some variable $x$ such that $x$ does not occur in $C$.
				\item The term $t$ is ground and $C$ does not contain $t$.
			\end{itemize} 
			Denote the resulting formula by $\lifsym_\mathrm{part}(\LIpre(C))$.

		\item 
Let $\lifsym_\mathrm{part}^*(\LIpre(C))$ be 
$\lifsym_\mathrm{part}(\LIpre(C))$  where every lifting variable $z_t$, which occurs free, is substituted by a fresh lifting variable $z_{t'}$.\footnote{See Example~\ref{exa:lemma_part_renaming} for an illustration.} 
\label{lemma_part_renaming}

		\item Let $X$ ($Y$) be the set of $\Delta$-($\Gamma$-)lifting variables which occur free in  
			$\lifsym_\mathrm{part}^*(\LIpre(C))$.
			Form an arrangement $\Q(C)$ of the elements of $\{\forall x_t \mid x_t \in X\}\cup\allowbreak\{\exists y_t \mid y_t \in Y\}$ such that if $s$ and $r$ are terms such that $s$ is a subterm of $r$, then $z_s$ precedes\nolinebreak{} $z_r$.
			Finally, let $\LI(C) \defeq Q(C) \lifsym_\mathrm{part}^*(\LIpre(C))$.
			\qedhere
	\end{enumerate}
\end{defi}

%\section{Properties of $\LI$ and $\LIcl$}


\mytodo{example showing that we can quantify locally}

%\begin{remark}
%	As a local optimisation, the quantifiers can be moved inwards such that they exhibit the smallest scope which covers every occurrence of the bound variable.
%	Note that when doing so, non-maximal occurrences of these terms have to be taken as being lifted 
%\end{remark}


\section{Main lemma}
Note the the lifting conditions ensure that only terms are lifted,
which do not exhibit a direct logical relation with any term in the remaining clause.
More precisely, they do not influence the subsequent resolution derivation: 
If a variable $x$ occurs in $\LI(C)$ but not in $C$, then as clauses are variable-disjoint, the variable $x$ does not occur in any other clause.
For ground terms $r$ however which occur in $\LI(C)$ but not in $C$,
it is possible for them to cooccur in a subsequent clause. Let $p$ be the occurrence of $r$ in $\LI(C)$ and $q$ the occurrence of $r$ in a successor-clause of $C$.
Then due to the fact that $p$ is not used in any unification, 
$q$ must be created or originate from other occurrences of the same function and/or constant symbols.
Note that the lifting conditions ensure that for these, the order of the quantifiers of their respective lifting variables is established in a fashion appropriate to ensuring the logical validity of the interpolant, but despite the syntactic equality between $p$ and $q$, there is no logical relation between them.

We now show more formally that the lifting conditions ensure that if a term contains another term, the subterm is not lifted before the superterm:

\begin{lemma}
	\label{lemma:lifting_conditions}
	Let $C$ be a clause of a resolution refutation such that $\lifdeltanovar{\LIpre(C)}$ contains a maximal colored $\Gamma$-term $t$ which is lifted in $\lifdeltanovar{\LI(C)}$.
	Suppose furthermore that $t$ contains a $\Delta$-lifting variable $x_s$.
	Then $x_s$ occurs free as a subterm of $t$ in $\lifdeltanovar{\LIpre(C)}$.
\end{lemma}
\begin{proof}
	By the construction of $\LI$, the lemma is violated only if the term $s$ or a respective predecessor is lifted and bound due to fulfilling one of the lifting conditions.

	For the sake of contradiction suppose that this is the case in the inference creating the clause $C'$.
	Let $s'$ and $t'$ be the respective predecessors of $s$ and $t$ in $C'$.

	\begin{itemize}
		\item Suppose that $s'$ is lifted due to containing a variable which does not occur in\nolinebreak{} $C'$.
			Then as $s'$ is a subterm of $t'$, $t'$ contains this variable as well and therefore is lifted in $\LI(C')$, contradicting the assumption.

		\item Suppose that $s'$ is lifted due to being a ground term which does not occur in\nolinebreak{} $C'$.
			Then $t'$ does not occur in $C'$ either as any occurrence of $t'$ contains $s'$. 
			Hence $t'$ is lifted in $\LI(C')$, contradicting the assumption.
			\qedhere
	\end{itemize}
\end{proof}

Now, we proceed to the main lemma:

\begin{lemma}
	\label{lemma:gamma_entails_delta_lifted_invariant}
	Let $C$ be a clause in a resolution refutation of $\Gamma \cup \Delta$.
	Then
	$\Gamma \entails \lifdeltanovar{ \LI(C) } \lor \lifdeltanovar{C} $
\end{lemma}
\begin{proof}
	We show the strengthening
	$\Gamma \entails \lifdeltanovar{ \LI(C) } \lor \lifdeltanovar{C_\Gamma}$\footnote{Recall that $D_\Phi$ denotes the clause created from the clause $D$ by removing all literals which are not contained $\Lang(\Phi)$.}.

	As a first step, 
	we prove by induction that
	$\Gamma \entails \lifdeltanovar{ \LIpre(C) } \lor \lifdeltanovar{C_\Gamma}$.
	%First, we proceed by induction to prove that $\Gamma \entails \lifdeltanovar{ \LIpre(C) } \lor \lifdeltanovar{C_\Gamma} $.


	\begin{description}
		\item{} Base case.
			If $C\in \Gamma$, then $\lifdeltanovar{C} = C$ and clearly $\Gamma \entails C$.
			If otherwise $C \in \Delta$, then $\LI(C) = \top$.

		\item{} Resolution.
			Suppose the clause $C$ is the result of a resolution step \inference{} of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ with $\sigma = \mgu(\inference)$.

			By the induction hypothesis and Lemma~\ref{lemma:lift_logic_commute} we obtain that
			$\Gamma \entails \lifdeltanovar{\LI(C_1)} \lor \lifdeltanovar{D_\Gamma} \lor \lifdeltanovar{l_\Gamma}$
			as well as 
			$\Gamma \entails \lifdeltanovar{\LI(C_2)} \lor \lifdeltanovar{E_\Gamma} \lor \lnot \lifdeltanovar{l'_\Gamma}$.
			Now we apply $\tauelldelta$ and by Lemma~\ref{lemma:lifting_subst_commute} get that 

			$\Gamma \stackrel\markA\entails \lifdeltanovar{\LI(C_1)\sigma} \lor \lifdeltanovar{D_\Gamma\sigma} \lor \lifdeltanovar{l_\Gamma\sigma}$

			$\Gamma \stackrel\markB\entails \lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{E_\Gamma\sigma} \lor \lnot \lifdeltanovar{l'_\Gamma\sigma}$

			As $l_\Gamma\sigma \syneq l'_\Gamma\sigma$,
			$\lifdeltanovar{l_\Gamma\sigma} = \lifdeltanovar{l'_\Gamma\sigma}$.
			We proceed by a case distinction on the color of the resolved literal to show that in each case, we have that
			$\Gamma \entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$:
			\begin{itemize}
				\item Suppose that $l$ is $\Gamma$-colored.
					Then $l_\Gamma = l$ and $l'_\Gamma = l$, and we can perform a resolution step on \markA{} and \markB{} to obtain that
					$\Gamma \entails
					\lifdeltanovar{\LI(C_1)\sigma} \lor
					\lifdeltanovar{\LI(C_2)\sigma} \lor 
					\lifdeltanovar{D_\Gamma\sigma}  \lor
					\lifdeltanovar{E_\Gamma\sigma}$.
					This however is nothing else than $\Gamma \entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$.

				\item Suppose that $l$ is $\Delta$-colored.
					Then \markA{} and \markB{} reduce to 
					$\Gamma \entails \lifdeltanovar{\LI(C_1)\sigma} \lor \lifdeltanovar{D_\Gamma\sigma}$
					and
					$\Gamma \entails \lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{E_\Gamma\sigma}$
					respectively,
					which clearly implies that 
					$\Gamma \entails \lifdeltanovar{\LI(C_1)\sigma} \lor \lifdeltanovar{\LI(C_2)\sigma} \lor (\lifdeltanovar{D_\Gamma\sigma} \land \lifdeltanovar{E_\Gamma\sigma})$.
					This is turn is however just the unfolding of the definition of
					$\Gamma \entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$.

				\item Suppose that $l$ is grey.
					Then $l_\Gamma = l$ and $l'_\Gamma = l$, and 
					\markA{} and \markB{} imply that
					$\Gamma \entails
					\lifdeltanovar{\LI(C_1)\sigma} \spam\lor
					\lifdeltanovar{\LI(C_2)\sigma} \spam\lor\allowbreak
					(\lifdeltanovar{l_\Gamma\sigma} \land \lifdeltanovar{E_\Gamma\sigma}) \spam\lor\allowbreak
					(\lnot\lifdeltanovar{l'_\Gamma\sigma} \land \lifdeltanovar{D_\Gamma\sigma})$.
					But this is equivalent to
					$\Gamma \entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$.

			\end{itemize}

		\item{} Factorisation. 
			Suppose the clause $C$ is the result of a factorisation inference $\inference$ of $C_1: l \lor l' \lor D$ with $\sigma=\mgu(\inference)$.

			The induction hypothesis gives $\Gamma \entails \lifdeltanovar{ \LI(C_1) } \lor \lifdeltanovar{ l_\Gamma \lor l'_\Gamma \lor D_\Gamma }$.
			By applying $\tauelldelta$
			and Lemma~\ref{lemma:lifting_subst_commute}, we obtain
			$\Gamma \entails \lifdeltanovar{ \LI(C_1)\sigma } \lor \lifdeltanovar{ l_\Gamma\sigma \lor l'_\Gamma\sigma \lor D_\Gamma\sigma }$.
			As however $l\sigma \syneq l'\sigma$, 
			also $\lifboth{l\sigma} = \lifboth{l'\sigma}$, so we can apply a factorisation step and obtain that
			$\Gamma \entails \lifdeltanovar{ \LI(C_1)\sigma } \lor \lifdeltanovar{ l_\Gamma\sigma \lor D_\Gamma\sigma }$,
			which is nothing else than $\Gamma \entails \LIpre(C) \lor \lifdeltanovar{C_\Gamma}$.

		\item{} Paramodulation.
			Suppose the clause $C$ is the result of a paramodulation inference\nolinebreak{} $\inference$ of $C_1: s=t \lor D$ and $C_2: E\occatp{r}$ with $\sigma=\mgu(\inference)$.

			By the induction hypothesis, we obtain the following: 

			$\Gamma \stackrel\markA\entails \lifdeltanovar{\LI(C_1)} \lor \lifdeltanovar{D_\Gamma} \lor \lifdeltanovar{s}=\lifdeltanovar{t}$

			$\Gamma \stackrel\markB\entails \lifdeltanovar{\LI(C_2)} \lor \lifdeltanovar{(E\occatp{r})_\Gamma}$

			Suppose now that for a model $M$ of $\Gamma$ and an assignment $\alpha$ of the free variables of $\lifdeltanovar{s}$ and $\lifdeltanovar{t}$ that $M_\alpha \entails \lifdeltanovar{s}\neq \lifdeltanovar{t}$.
			Then we get by \markA{} that $M_\alpha \entails \lifdeltanovar{\LI(C_1)} \lor \lifdeltanovar{D_\Gamma}$, which by applying $\tauelldelta$ and Lemma~\ref{lemma:lifting_subst_commute} gives $M_\alpha \entails \lifdeltanovar{\LI(C_1)\sigma} \lor \lifdeltanovar{D_\Gamma\sigma}$.
			Note that $M_\alpha \entails \lifdeltanovar{s\sigma}\neq \lifdeltanovar{t\sigma} \land \lifdeltanovar{\LI(C_1)\sigma}$ suffices for $M_\alpha \entails \lifdeltanovar{\LIpre(C)}$ and $M_\alpha \entails \lifdeltanovar{D_\Gamma\sigma}$ implies that $M_\alpha \entails \lifdeltanovar{C_\Gamma}$.
			Therefore we obtain that 
			$M_\alpha \entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$.

			Now suppose to the contrary that for a model $M$ of $\Gamma$ that for any assignment of free variables $M \entails \lifdeltanovar{s}\nolinebreak=\lifdeltanovar{t}$.

			By applying $\tauelldelta$ and  Lemma~\ref{lemma:lifting_subst_commute} we obtain from \markB{} that
			$\Gamma \entails \lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{(E\occatp{r})_\Gamma\sigma}$.
			As however $r\sigma \syneq s\sigma$,
			$\lifdeltanovar{r\sigma} = \lifdeltanovar{s\sigma}$.
			Therefore we also have that 
			$\Gamma \entails \lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{(E\occatp{s})_\Gamma\sigma}$.

			We proceed by a case distinction:
			\begin{itemize}
				\item Suppose that the position $p$ in $E\occatp{s}$ is not contained in a $\Delta$-term.
					Then
					$\lifdeltanovar{(E\occatp{s})_\Gamma\sigma}$
					and
					$\lifdeltanovar{(E\occatp{t})_\Gamma\sigma}$
					only differ at at position $p$.
					As $M \entails \lifdeltanovar{s} = \lifdeltanovar{t}$, we can apply $\tauelldelta$ and by Lemma~\ref{lemma:lifting_subst_commute} obtain that 
					$M \entails \lifdeltanovar{s\sigma} = \lifdeltanovar{t\sigma}$.
					Thus
					$M\entails \lifdeltanovar{(E\occatp{s})_\Gamma\sigma} \semiff 
					\lifdeltanovar{(E\occatp{t})_\Gamma\sigma}$
					and consequently
					$M \entails \lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{(E\occatp{t})_\Gamma\sigma}$.
					As furthermore $\lifdeltanovar{s\sigma} =\lifdeltanovar{t\sigma} \land \lifdeltanovar{\LI(C_2)\sigma}$ entails $\lifdeltanovar{\LIpre(C)}$
					and $\lifdeltanovar{(E\occatp{t})_\Gamma\sigma}$ is sufficient for $\lifdeltanovar{C_\Gamma}$,
					we have that 
					$M\entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$.

				\item
					Suppose that the position $p$ in $E\occatp{s}$ is contained in a maximal $\Delta$-term $h\occ{s}$.
					We distinguish further:

					\begin{itemize}
						\item Suppose $h\occ{s}$ occurs more than once in $\LI(C_2)\sigma \lor E\occatp{s}\sigma$ and let $\alpha$ be an arbitrary assignment to the variables $\lifdeltanovar{h\occ{s}} = x_{h\occ{s}}$ and $\lifdeltanovar{h\occ{t}} = x_{h\occ{t}}$.\todo{lifting sym useful here}

							If $M_\alpha \entails \lifdeltanovar{h\occ{s}} \neq \lifdeltanovar{h\occ{t}}$, then we have that $M_\alpha \entails \lifdeltanovar{s}\nolinebreak=\lifdeltanovar{t} \land\allowbreak \lifdeltanovar{h\occ{s}} \neq \lifdeltanovar{h\occ{t}}$, which implies that $M_\alpha \entails \lifdeltanovar{\LIpre(C)}$.

							%Assume that $M \entails \lifdeltanovar{h\occ{s}} = \lifdeltanovar{h\occ{t}}$ as otherwise $M \entails \lifdeltanovar{s}\nolinebreak=\lifdeltanovar{t} \land\allowbreak \lifdeltanovar{h\occ{s}} \neq \lifdeltanovar{h\occ{t}}$, which implies that $M \entails \lifdeltanovar{\LIpre(C)}$.
							Otherwise it holds that $M_\alpha \entails \lifdeltanovar{h\occ{s}} = \lifdeltanovar{h\occ{t}}$.
							But then 
							$\lifdeltanovar{(E\occatp{s})_\Gamma\sigma}$
							and
							$\lifdeltanovar{(E\occatp{t})_\Gamma\sigma}$
							differ in subterms which are equal in the given model and with the given interpretation of the free variables,
							%at position of $h\occ{s}$ and $h\occ{t}$ respectively and
							so by a similar line of argument as in the preceding case, we can deduce that $M \entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C}$.

						\item Suppose $h\occ{s}$ occurs exactly once in $\LI(C_2)\sigma \lor E\occatp{s}\sigma$.
							Then the lifting variable $x_{h\occ{s}}$\todo{lifting sym useful here}
							occurs exactly once in $\lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{E\occatp{s}\sigma}$.

							Note that from \markB{} by applying $\tauelldelta$ and Lemma~\ref{lemma:lifting_subst_commute}, we obtain that $M\entails \lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{(E\occatp{s})_\Gamma\sigma}$.
							As $x_{h\occ{s}}$ occurs only once and free in this formula, it is implicitly universally quantified and we can instantiate it arbitrarily, in particular by $x_{h\occ{t}}$.
							But thereby we get that 
							$M\entails \lifdeltanovar{\LI(C_2)\sigma} \lor \lifdeltanovar{(E\occatp{t})_\Gamma\sigma}$, 
							which implies that
							$\Gamma\entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$.
					\end{itemize}
			\end{itemize}
	\end{description}


	%
	%\begin{lemma}
	%	\label{lemma:gamma_entails_delta_lifted_invariant}
	%	Let $C$ be a clause in a resolution refutation of $\Gamma \cup \Delta$.
	%	Then
	%	$\Gamma \entails \lifdeltanovar{ \LI(C) } \lor \lifdeltanovar{C} $
	%\end{lemma}
	%\begin{proof}
	%	By Lemma~\ref{lemma:gamma_entails_delta_lifted_preinvariant}, we have that 
	%	$\Gamma \entails \lifdeltanovar{\LIpre(C)} \lor \lifdeltanovar{C_\Gamma}$.

	As we have now established that
	$\Gamma \entails \lifdeltanovar{ \LIpre(C) } \lor \lifdeltanovar{C_\Gamma}$,
	we show that also
	$\Gamma \entails \lifdeltanovar{ \LI(C) } \lor \lifdeltanovar{C_\Gamma}$ holds.


	The difference between $\lifdeltanovar{\LIpre(C)}$ and $\lifdeltanovar{\LI(C)}$ lies only in certain maximal colored terms which are lifted and the resulting lifting variable bound in $\lifdeltanovar{\LI(C)}$, hence it suffices to consider these.
	Let $t$ be a colored term in $\LIpre(C)$ at position $p$ such that $\LI(C)\atp = \lifboth{t}$.
	Then $t$ is a maximal colored term. % and contains a variable which does not occur in\nolinebreak{} $C$.

	If $t$ is $\Delta$-colored, then $\lifdeltanovar{\LIpre(C)}\atp = \LI(C)\atp = x_t$.
	Note that as $t$ occurs at $p$ in $\LIpre(C)$, $x_t$ occurs free at $\lifdeltanovar{\LIpre(C)}\atp$.
	The renaming of lifting variables in step \ref{lemma_part_renaming} of the lifting procedure
	ensures that $x_t$ is a fresh lifting variable and hence is not bound by quantifiers introduced to to other occurrences of the term $t$, which would otherwise also be lifted by the same lifting variable and bound by the same quantifier\footnote{See Example~\ref{exa:lemma_part_renaming} for an illustration.}.
	Hence $x_t$ is implicitly universally quantified and therefore entails that an explicit universal quantification in $\LI(C)$ is valid with an arbitrarily placed universal quantifier. 

	If otherwise $t$ is a $\Gamma$-term, then $\lifdeltanovar{\LIpre(C)}\atp = \lifdeltanovar{t}$.
	Therefore $\lifdeltanovar{t}$ represents a witness term for the existentially quantified lifting variable $y_t$ at $\LI(C)\atp$.
	In general, $\lifdeltanovar{t}$ however contains $\Delta$-lifting variables, hence for $\lifdeltanovar{t}$ to be a valid witness term, these have to be bound such that the existential quantifier of $y_t$ is in their scope.
	Note that occurrences of colored terms which are not maximal colored terms are not lifted in $\LI$.

	Let $x_s$ be a $\Delta$-lifting variable which occurs in $\lifdeltanovar{t}$. 
	We show that $y_t$ is quantified in the scope of the quantification of $x_s$ by discussing the different possibilities for quantification of $x_s$:

	\begin{itemize}
		\item
			Clearly if $s$ or a respective successor is never bound due to not occurring at a maximal colored position, it is implicitly universally quantified.

		\item
			If $s$ or a respective successor does occur at a maximal colored position but does not satisfy any of the lifting conditions up to the stage where $t$ is lifted, it is bound at some later stage of the interpolant extraction, but as for any successor $C'$ of $C$, $\LI(C)$ is contained in $\LI(C')$, 
			the scope of its quantifier encompasses the quantifier for $y_t$.

		\item
			In the case that $s$ and $t$ are lifted at the same stage of the interpolant extraction, by the definition of the quantifier prefix, the quantification of $x_s$ precedes the quantification for $x_t$ as $s$ is a subterm of $t$.


		\item
			It is furthermore essential to see that neither $s$ nor a respective predecessor is lifted in a previous step of the interpolant extraction, which is shown by Lemma~\ref{lemma:lifting_conditions}.
			\qedhere
	\end{itemize}
\end{proof}

We now present an example which demonstrates that $\LI$ does produce formulas realising the idea presented in Example~\ref{exa:one_phase_motivation}.

\begin{exa}
	\label{exa:lemma_part_renaming}
	Let $\Gamma = \{ P(u, v) \lor Q(u) \lor R(v) \}$
	and $\Delta = \{ \lnot P(w, z), \lnot Q(a), \lnot R(a)\}$.
	We consider a resolution refutation of $\Gamma\cup\Delta$ combined with the interpolant extraction.
	In order to emphasise the lifting steps,
	we do not just write $C\mid \LI(C)$ in the derivation as usual for a clause $C$ but $C\mid\LIpre(C)$ above $C\mid \LI(C)$ without a separating line 
	in case $\LIpre(C)$ is different from $\LI(C)$.
	The primed variables make the renaming of lifting variables in step \ref{lemma_part_renaming} of the lifting procedure explicit.
	\begin{prooftree}
		\AxiomCm{ P(u, v) \lor Q(u) \lor R(v) \mid \bot}
		\AxiomCm{ \lnot P(w, z) \mid \top }

		\RightLabelm{\resrule{\resruleres}{w\mapsto u, v\mapsto z}}
		\BinaryInfCm{ Q(u) \lor R(v) \mid P(u, v) }

		\AxiomCm{ \lnot Q(a) \mid \top }

		\RightLabelm{\resrule{\resruleres}{u\mapsto a}}
		\BinaryInfCm{ R(v) \mid Q(a) \lor P(a, v) }
		\noLine
		\UnaryInfCm{ R(v) \mid \forall x_a( Q(x_a) \lor P(x_a, v) ) }

		\AxiomCm{ \lnot R(a) \mid \top }

		\RightLabelm{\resrule{\resruleres}{v\mapsto a}}
		\BinaryInfCm{ \square \mid R(a) \lor  \forall x_a( Q(x_a) \lor P(x_a, a) ) }
		\noLine
		\UnaryInfCm{ \square \mid \forall x'_a \big( R(x'_a) \lor  \forall x_a( Q(x_a) \lor P(x_a, x'_a) ) \big) }
	\end{prooftree}

	Hence we obtain here a non-prenex interpolant which reflects the logical expressiveness of $\Gamma$, in contrast to 
	the interpolant which is produced by the two phase approach described in chapter~\ref{sec:two_phases}, which in fact is
	$\forall x_a \big( R(x_a) \lor Q(x_a) \lor P(x_a, x_a) \big)$.

	Note that without the renaming of the lifting variables, the result of the extraction would be
	$\forall x_a \big( R(x_a) \lor  \forall x_a( Q(x_a) \lor P(x_a, x_a) ) \big) $.
	In order to emphasise the binding, we alpha-rename this formula to
	$\forall x \big( R(x) \lor  \forall y( Q(y) \lor P(y, y) ) \big) $.
	This is not an interpolant, as this formula is not entailed by $\Gamma$:

	Consider a model $M$ of $\Gamma$ with domain $\domainofmodel{M} = \{0, 1\}$ and an interpretation $\interpretation{M}$ such that
	$\interpretation{M}(R) = \{0\}$,
	$\interpretation{M}(Q) = \emptyset$ and 
	$\interpretation{M}(P) = \{ (0, 1), (1, 1) \}$.
	Then clearly $M \entails P(u, v) \lor Q(y) \lor R(v) $ as depending on the value of $v$, either $R(v)$ or $P(u, v)$ holds.
	But at the same time $M \notentails \forall x \big( R(x) \lor  \forall y( Q(y) \lor P(y, y) ) \big)$ since the instantiation of the bound variables $x$ to $1$ and $y$ to $0$ results in a formula which does not hold in $M$.

\end{exa}


\section{Towards an interpolant}

In a similar fashion as in Lemma~\ref{lemma:symmetry} for $\PI$, we can also show a symmetry-property for $\LI$:

\begin{lemma}
	\label{lemma:li_symmetry}
	Let $\pi$ be a refutation of $\Gamma\cup\Delta$ and $\bhat \pi$ be $\pi$ with $\bhat \Gamma = \Delta$ and $\bhat \Delta = \Gamma$.
	Then for a clause $C$ in $\pi$ and its corresponding clause $\bhat C$ in $\bhat \pi$, $\LI(C) \spas\semiff \lnot \LI(\bhat C)$.
\end{lemma}
\begin{proof}
	We proceed by induction to show that $\LIpre(C) \semiff \lnot \LIpre(\bhat C)$:
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, then $\LI(C) = \bot \semiff \lnot \top \semiff \lnot \LI(\bhat C)$ as $\bhat C\in\Delta$. 
			The case for $C\in\Delta$ can be argued analogously.

		\item[Resolution.]
			Suppose the clause $C$ is the result of a resolution step \inference{} of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ with $\sigma = \mgu(\inference)$.

			We distinguish the following cases:

			\begin{enumerate}

				\item $l$ is $\Gamma$-colored:
					\begin{align*}
						\hspace*{\dimexpr-\leftmargini-\leftmarginii}
						\LIpre(C)	&= \LI(C_1)\sigma\spas\lor {\LI(C_2)\sigma} \\
															 &\semiff \lnot (\lnot{\LI(C_1)\sigma}\spas\land \lnot {\LI(C_2)\sigma}) \\
						%&\semiff \lnot (\lifboth{(\lnot \LI(C_1))\sigma}\spas\land \lifboth{(\lnot \LI(C_2))\sigma}) \\
															 &\semiff \lnot ({\LI(\bhat C_1)\sigma}\spas\land {\LI(\bhat C_2)\sigma}) \\
															 &= \lnot \LIpre(\bhat C)
					\end{align*}

				\item $l$ is $\Delta$-colored:
					This case can be argued analogously.

				\item $l$ is grey:
					Note ${l\sigma} \stackrel{{\markB}}= {l'\sigma}$.
					\begin{align*}
						\hspace*{\dimexpr-\leftmargini-\leftmarginii}
						\LIpre(C) &\stackrel{{\phantom{\markB}}}=
						(\lnot {{l'\sigma}} \land {\LI(C_1)\sigma}) \spam\lor 
						({l\sigma} \land {\LI(C_2)\sigma})\\
						&\stackrel{{\markB}}\semiff\,
						({{l'\sigma}} \lor {\LI(C_1)\sigma}) \spam\land 
						(\lnot {l\sigma} \lor {\LI(C_2)\sigma})\\
						&\stackrel{{\phantom{\markB}}}\semiff \lnot [ (\lnot {{l'\sigma}} \land \lnot {\LI(C_1)\sigma}) \spam\lor 
					({l\sigma} \land \lnot{\LI(C_2)\sigma}) ] \\
					&\stackrel{{\phantom{\markB}}}=\lnot [ (\lnot {{\bhat l'\sigma}} \land {\LI(\bhat C_1)\sigma}) \spam\lor 
				({\bhat l\sigma} \land {\LI(\bhat C_2)\sigma}) ]\\
				& \stackrel{{\phantom{\markB}}}= \lnot \LIpre(\bhat C) 
			\end{align*}
	\end{enumerate}


\item[Factorisation.]
	Suppose the clause $C$ is the result of a factorisation $\inference$ of $C_1: l \lor l' \lor D$ 
	with $\sigma = \mgu(\inference)$.

	As the construction is not influenced by the coloring, the induction hypothesis $\LIpre(C) = \LI(C_1)\sigma$ suffices.

	Then $\LIpre(C) = \lifboth{\LI(C_1)\sigma}$, so the construction is not influenced by the coloring and by the induction hypothesis, $\LIpre(C) \semiff \lnot \LIpre(\bhat C)$.

\item[Paramodulation.]
	Suppose the clause $C$ is the result of a paramodulation inference $\inference$ of $C_1: s=t \lor D$ and $C_2: E\occatp{r}$ with $\sigma=\mgu(\inference)$.


	We proceed by a case distinction:
	\begin{itemize}
		\item Suppose that $p$ in $E\occatp{r}$ is contained in a maximal $\Delta$-term $h\occ{r}$, which occurs more than once in $E\occatp{r} \lor \LI(E\occatp{r})$. 
			Then $p$ in $\bhat E\occatp{r}$ is contained in a maximal $\Gamma$-term $h\occ{r}$, which occurs more than once in $\bhat E\occatp{r} \lor \LI(\bhat E\occatp{r})$. 

			\hspace*{\dimexpr-\leftmargini-1em}\parbox{\linewidth}{%
			%\hspace*{\dimexpr-\leftmargini-\leftmarginii}\parbox{\linewidth}{%
				%\hspace*{\dimexpr-\leftmargini-\leftmarginii}\parbox{\linewidth}{%
				\begin{align*}
					%\hspace*{\dimexpr-\leftmargini-\leftmarginii}
					\LIpre(C) 
					&= ({s\sigma=t\sigma} \land {\LI(C_2)\sigma} ) \lor ({s\sigma\neq t\sigma} \land {\LI(C_1)\sigma}) \lor ({s\sigma=t\sigma} \land {h\occur{s}\sigma \neq h\occur{t}\sigma}) \\
					&\semiff \lnot [ ({s\sigma\neq t\sigma} \lor \lnot {\LI(C_2)\sigma} ) \land ({s\sigma= t\sigma} \lor \lnot{\LI(C_1)\sigma}) \land ({s\sigma\neq t\sigma} \lor {h\occur{s}\sigma = h\occur{t}\sigma}) ] \\
					&= \lnot [ ({s\sigma\neq t\sigma} \lor {\LI(\bhat C_2)\sigma} ) \land ({s\sigma= t\sigma} \lor {\LI(\bhat C_1)\sigma}) \land ({s\sigma\neq t\sigma} \lor {h\occur{s}\sigma = h\occur{t}\sigma}) ] \\
					&\semiff \lnot [ ({s\sigma= t\sigma} \land {\LI(\bhat C_2)\sigma} ) \lor ({s\sigma\neq t\sigma} \land {\LI(\bhat C_1)\sigma}) \land ({s\sigma\neq t\sigma} \lor {h\occur{s}\sigma = h\occur{t}\sigma}) ]\\
					&= \lnot \LIpre(\bhat C)
				\end{align*}
			}\par

		\item Suppose that $p$ in $E\occatp{r}$ is contained in a maximal $\Gamma$-term $h\occ{r}$, which occurs more than once in $E\occatp{r} \lor \LI(E\occatp{r})$. 
			This case can be argued analogously.

		\item Otherwise:
			\todo{format like proof for $\PI$, if this are even kept as separate proofs}
			%\hspace*{\dimexpr-\leftmargini-\leftmarginii-\leftmarginiii}\parbox{\linewidth}{%
			%\hspace*{\dimexpr-\leftmargini-\leftmarginii}\parbox{\linewidth}{%
			\begin{align*}
				%\hspace*{\dimexpr-\leftmargini-\leftmarginii}
				\LIpre(C) 
				&= ({s\sigma=t\sigma} \land {\LI(C_2)\sigma} ) \spam\lor ({s\sigma\neq t\sigma} \land {\LI(C_1)\sigma}) \\
				&\semiff \lnot [ ({s\sigma\neq t\sigma} \lor \lnot {\LI(C_2)\sigma} ) \spam\land ({s\sigma= t\sigma} \lor \lnot {\LI(C_1)\sigma}) ] \\
				&= \lnot [ ({s\sigma\neq t\sigma} \lor {\LI(\bhat C_2)\sigma} ) \spam\land ({s\sigma= t\sigma} \lor {\LI(\bhat C_1)\sigma}) ] \\
				&\semiff \lnot [ ({s\sigma= t\sigma} \land {\LI(\bhat C_2)\sigma} ) \spam\lor ({s\sigma\neq t\sigma} \land {\LI(\bhat C_1)\sigma}) ] \\
				&= \lnot \LIpre(\bhat C)
			\end{align*}
			%}\par

	\end{itemize}

	\end{itemize}


	We conclude by showing that 
	$\LIpre(C) \semiff \lnot \LIpre(\bhat C)$ 
	entails that 
	$\LI(C) \semiff \lnot \LI(\bhat C)$:
	Clearly the terms to be lifted in $\LIpre(C)$ and $\LIpre(\bhat C)$ are the same and differ only in their color.
	Even though this results in different lifting variables, that is of no relevance as all lifted variables are instantly bound.
	Additionally, the quantifier type of any given lifting variable in $\Q(C)$ is dual to the respective one in $\Q(\bhat C)$.
	Furthermore note that the subterm-relation is not affected by the coloring, so the ordering of the quantifiers in $\Q(C)$ and $\Q(\bhat C)$ is identical.
	Hence 
	$\LI(C) \semiff \lnot \LI(\bhat C)$.
\end{proof}


\begin{lemma}
	\label{lemma:delta_entails_li}
	Let $C$ be a clause in a resolution refutation of $\Gamma \cup \Delta$.
	Then
	$\Delta \entails \lnot\lifgammanovar{\LI(C)} \lor \lifgammanovar{C}$.
\end{lemma}
\begin{proof}
	Construct $\bhat \pi$ with $\bhat \Gamma = \Delta$ and $\bhat \Delta = \Gamma$. 
	Then by Lemma~\ref{lemma:gamma_entails_delta_lifted_invariant}, $\bhat \Gamma \entails \liftnovar{\bhat \Delta}{\LI(\bhat C)} \lor \liftnovar{\bhat \Delta}{\bhat C}$, 
	which by Lemma~\ref{lemma:li_symmetry} is nothing else than
	$\Delta \entails \lnot \liftnovar{\Gamma}{\LI(C)} \lor \liftnovar{\Gamma}{C}$.
\end{proof}

\begin{thm}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	Then $\LI(\pi)$ is an interpolant for $\Gamma$ and $\Delta$.
\end{thm}
\begin{proof}
	We obtain by Lemma~\ref{lemma:gamma_entails_delta_lifted_invariant} that  $\Gamma \entails \liftnovar{\Delta}{\LI(\pi)}$ and
	by Lemma~\ref{lemma:delta_entails_li} that
	$\Delta \entails \lnot\lifgammanovar{\LI(\pi)}$.
	As the empty clause derived in $\pi$ trivially contains neither variables nor ground terms and as any colored term either contains variables or is ground, at least one lifting condition holds for any term in $\LIpre(\pi)$ and hence all colored terms are lifted in $\LI(\pi)$.
	Therefore $\lifdeltanovar{\LI(\pi)} = \LI(\pi)$ and $\lifgammanovar{\LI(\pi)} = \LI(\pi)$.
\end{proof}

We finish this chapter by an example demonstrating the application of the interpolant extraction procedure $\LI$ on a larger example:

\begin{exa}
	\newcommand{\var}[1]{\ensuremath{v_{#1}}}
	Let $\Gamma = \{R(f(\var{1}, \var{6})), P(f(\var{2}, g(\var{3}, \var{4}))) \lor Q(g(\var{3}, b)), \lnot S(b) \}$
	and $\Delta = \{ S(\var{8}) \lor \lnot P(\var{5}) \lor \lnot R(\var{5}), \lnot Q(g(a, \var{7})) \}$.
	We can produce an interpolant for $\Gamma$ and $\Delta$ using the following refutation and extraction in the same notation as Example~\ref{exa:lemma_part_renaming}:


	\mytodo{more text, use figure to make clear that it's a spearate page?}

	%\tiny


	\begin{landscape}
		\global\pdfpageattr\expandafter{\the\pdfpageattr/Rotate 90}
		\vspace*{\fill}
		\centering
		%\small
		\begin{adjustwidth}{-4cm}{}
			\begin{prooftree}
				\AxiomCm{ P(f(\var{2}, g(\var{3}, \var{4}))) \lor Q(g(\var{3}, b)) \mid \bot }
				\AxiomCm{ \lnot Q(g(a, \var{7})) \mid \top}

				\RightLabelm{\resrule{\resruleres}{\var{3}\mapsto a, \var{7}\mapsto b}}
				\BinaryInfCm{ P(f(\var{2}, g(a, \var{4}))) \mid Q(g(a, b))  }
				\noLine
				\UnaryInfCm{ P(f(\var{2}, g(a, \var{4}))) \mid \exists y_b Q(g(a, y_b))  }

				\AxiomCm{  S(\var{8}) \lor \lnot P(\var{5}) \lor \lnot R(\var{5}) \mid \top }
				\AxiomCm{  R(f(\var{1}, \var{6})) \mid \bot}
				\RightLabelm{\resrule{\resruleres}{\var{5} \mapsto f(\var{1}, \var{6})}}
				\BinaryInfCm{ S(\var{8}) \lor \lnot P(f(\var{1})) \mid R(f(\var{1}, \var{6}))}
				\noLine
				\UnaryInfCm{ S(\var{8}) \lor \lnot P(f(\var{1})) \mid \exists y_{f(\var{1}, \var{6})} R(y_{f(\var{1}, \var{6})})}

				\RightLabelm{\resrule{\resruleres}{\var{1} \mapsto \var{2}, \var{6}\mapsto g(a, \var{4})}}
				\BinaryInfCm{ S(\var{8}) \mid  P(f(\var{2}, g(a, \var{4}))) \land \exists y_{f(\var{1}, \var{6})} R(y_{f(\var{1}, \var{6})}) \spam \lor \lnot P(f(\var{2}, g(a, \var{4}))) \land \exists y_b Q(g(a, y_b))  }
				\noLine
				\UnaryInfCm{ S(\var{8}) \mid \forall x_a \exists y_{f(\var{2}, g(a, \var{4}))} \big(  P(y_{f(\var{2}, g(a, \var{4}))}) \land \exists y_{f(\var{1}, \var{6})} R(y_{f(\var{1}, \var{6})}) \spam \lor \lnot P(y_{f(\var{2}, g(a, \var{4}))}) \land \exists y_b Q(g(x_a, y_b)) \big) }

				\AxiomCm{\lnot S(b) \mid \top}
				\RightLabelm{\resrule{\resruleres}{\var{8} \mapsto b}}

				\insertBetweenHyps{\hskip -2cm}
				\BinaryInfCm{ \square \mid S(b) \land  \forall x_a \exists y_{f(\var{2}, g(a, \var{4}))} \big(  P(y_{f(\var{2}, g(a, \var{4}))}) \land \exists y_{f(\var{1}, \var{6})} R(y_{f(\var{1}, \var{6})}) \spam \lor \lnot P(y_{f(\var{2}, g(a, \var{4}))}) \land \exists y_b Q(g(x_a, y_b)) \big) }
				\noLine
				\UnaryInfCm{ \square \mid \exists y_b \big( S(y_b) \land  \forall x_a \exists y_{f(\var{2}, g(a, \var{4}))} \big(  P(y_{f(\var{2}, g(a, \var{4}))}) \land \exists y_{f(\var{1}, \var{6})} R(y_{f(\var{1}, \var{6})}) \spam \lor \lnot P(y_{f(\var{2}, g(a, \var{4}))}) \land \exists y_b Q(g(x_a, y_b)) \big) \big) }

			\end{prooftree}
			\qedhere
		\end{adjustwidth}
		\vspace*{\fill}
		
	\end{landscape}
	\global\pdfpageattr\expandafter{\the\pdfpageattr/Rotate 00}
\end{exa}
