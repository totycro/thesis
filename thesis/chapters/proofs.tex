
\section{WT: Interpolation extraction in one pass}

easy for constants, just as in huang but in one pass

terms can grow unpredictably, order cannot be determined during pass

\section{WT: Interpolation extraction in two passes}

\subsection{huang proof revisited}

\subsubsection{propositional part}

Let $\Gamma \cup \Delta$ be unsatisfiable. Let $\pi$ be a proof of $\square$ from $\Gamma \cup \Delta$. Then $\PI$ is a function that returns a interpolant w.r.t. the current clause. 

\begin{defi}
	$\theta$ is a \defiemph{propositional interpolant} with respect to a clause $C$ in a resolution refutation $\pi$ of $\Gamma \cup \Delta$ if 
	\label{def:rel_prop_interpol}
	\begin{compactenum}
		\item $\Gamma \entails \theta \lor C$
			\label{rel_prop_interpol_cond1}
		\item $\Delta \entails \lnot \theta \lor C$
			\label{rel_prop_interpol_cond2}
		\item $\Pred(\theta) \subseteq (\Pred(\Gamma) \intersect \Pred(\Delta)) \cup \{\top, \bot\} $.
			\label{rel_prop_interpol_cond_lang}
			\qedhere
	\end{compactenum}
\end{defi}

The third condition will sometimes be referred to as \emph{language restriction}.
It is easy to see that a propositional interpolant with respect to $\square$ is a propositional interpolant\todo{add this to the definition, i.e.~possible define rel prop interpol from prop interpol}, i.e.~it is an interpolant without the language restriction on constant, variable and function symbols.

We proceed by defining a procedure $\PI$ which extracts interpolants from a resolution refutation.

\begin{defi}
	\defiemph{$\PI$} is defined as follows:
\begin{itemize}
	\item[Base case.]
		If $C \in \Gamma$, $\PI(C) = \bot$. 
		If otherwise $C \in \Delta$, $\Delta(C) = \top$. 
	\item[Resolution.]
	\label{def:PI_resolution}
		Suppose the clause $C$ is the result of a resolution step. Then it has the following form: 

%	\begin{prooftree}
%		\AxiomCm{C_1: D \lor l}
%		\AxiomCm{C_2: E \lor \lnot l'}
%		\RightLabelm{\quad l\sigma = l'\sigma}
%		\BinaryInfCm{C: (D\lor E)\sigma}
%	\end{prooftree}
		%\todo{write as prooftree? (not necessary, but nicer)}
		If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\PI(C)$ is defined as follows:
	%$\PI(C)$ is defined according to this case distinction:
		\begin{enumerate}
			\item If $\Pred(l) \in \Lang(\Gamma) \setminus \Lang(\Delta)$:\todo{change to "is $\Gamma$-colored?"} $\PI(C) = [\PI(C_1) \lor \PI(C_2)]\sigma$
			\item If $\Pred(l) \in \Lang(\Delta) \setminus \Lang(\Gamma)$: $\PI(C) = [\PI(C_1) \land \PI(C_2)]\sigma$
			\item If $\Pred(l) \in \Lang(\Gamma) \intersect \Lang(\Delta)$: $\PI(C) = [(l \land \PI(C_2)) \lor (l' \land \PI(C_1)) ]\sigma $
		\end{enumerate}

	\item[Factorisation.]
		If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\PI(C) = \PI(C_1)\sigma$.

	\item[Paramodulation.]
		If the clause $C$ is the result of a paramodulation of $C_1: s=t \lor C$ and $C_2: D[r]$ using a unifier $\sigma$ such that $r\sigma = s\sigma$, then $\PI(C)$ is defined according to the following case distinction:
		\begin{enumerate}
			\item If $r$ occurs in a maximal $\Delta$-term $h(r)$ in $D[r]$ and $h(r)$ occurs more than once in $D[r] \lor \PI(D[r])$:
				\label{def:PI_paramod_1}
				\newline
				$\PI(C) = [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \lor (s=t \land h(s) \neq h(t))$ 
			\item If $r$ occurs in a maximal $\Gamma$-term $h(r)$ in $D[r]$ and $h(r)$ occurs more than once in $D[r] \lor \PI(D[r])$:
				\label{def:PI_paramod_2}
				\newline
				$\PI(C) = [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \land (s\neq t \lor h(s) = h(t))$ 
			\item Otherwise:
				\label{def:PI_paramod_3}
				\newline
				$\PI(C) = [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma$ \qedhere

		\end{enumerate}
\end{itemize}
\end{defi}


\begin{prop}
	Let $C$ be a clause of a resolution refutation.
	Then $\PI(C)$ is a propositional interpolant with respect to $C$. 
\end{prop}
\begin{proof}
	Proof by induction on the number of rule applications including the following strenghtenings:
	$\Gamma \entails \PI(C) \lor C_\Gamma$ and
	$\Delta \entails \lnot \PI(C) \lor C_\Delta$, where $D_\Phi$ denotes the clause D with only the literals which are contained in $\Lang(\Phi)$. They clearly imply conditions \ref{rel_prop_interpol_cond1} and \ref{rel_prop_interpol_cond2} of definition \ref{def:rel_prop_interpol}. 

\begin{itemize}
	\item[Base case.]
	Suppose no rules were applied. We distinguish two possible cases:
	\begin{enumerate}
		\item $C \in \Gamma$.
			Then $\PI(C) = \bot$. Clearly $\Gamma \entails \bot \lor C_\Gamma$ as $C_\Gamma = C \in \Gamma$, $\Delta \entails \lnot \bot \lor C_\Delta$ and $\bot$ satisfies the restriction on the language.

		\item $C \in \Delta$.
			Then $\PI(C) = \top$. Clearly $\Gamma \entails \top \lor C_\Gamma$, $\Delta \entails \lnot \top \lor C_\Delta$ as $C_\Delta = C \in \Delta$ and $\top$ satisfies the restriction on the language.
	\end{enumerate}

	Suppose the property holds for $n$ rule applications.
	We show that it holds for $n+1$ applications by considering the last one:

\item[Resolution.]
	Suppose the last rule application is an instance of resolution. Then it is of the form:
	\begin{prooftree}
		\AxiomCm{C_1: D \lor l}
		\AxiomCm{C_2: E \lor \lnot l'}
		\RightLabelm{\quad l\sigma = l'\sigma}
		\BinaryInfCm{C: (D\lor E)\sigma}
	\end{prooftree}

	By the induction hypothesis, we can assume that:

	$\Gamma \entails \PI(C_1) \lor (D\lor l)_\Gamma$

	$\Delta \entails \lnot \PI(C_1) \lor (D\lor l)_\Delta$

	$\Gamma \entails \PI(C_2) \lor (E\lor \lnot l')_\Gamma$

	$\Delta \entails \lnot \PI(C_2) \lor (E\lor \lnot l')_\Delta$

		We consider the respective cases from definition \ref{def:PI_resolution}:

			\begin{enumerate}
				\item $\Pred(l) \in \Lang(\Gamma) \setminus \Lang(\Delta)$:
					\label{huang_proof_prop_case_1}
					Then $\PI(C) = [\PI(C_1) \lor \PI(C_2)]\sigma$. 

					As $\Pred(l) \in \Lang(\Gamma)$,
					$\Gamma \entails (\PI(C_1) \lor D_\Gamma\lor l)\sigma$
					as well as $\Gamma \entails (\PI(C_2) \lor E_\Gamma\lor \lnot l')\sigma$.
					By a resolution step, we get $\Gamma \entails (\PI(C_1) \lor \PI(C_2))\sigma \lor ((D \lor E)\sigma)_\Gamma$.

					Furthermore, as $\Pred(l) \not\in \Lang(\PI)$, 
					$\Delta \entails (\lnot\PI(C_1) \lor D_\Delta)\sigma$
					as well as $\Delta \entails (\lnot\PI(C_2) \lor E_\Delta)\sigma$.
					Hence it certainly holds that $\Delta \entails (\lnot \PI(C_1) \lor \lnot\PI(C_2))\sigma \lor (D \lor E)\sigma_\Delta$.

					The language restriction clearly remains satisfied as no non-logical symbols are added.

				\item $\Pred(l) \in \Lang(\Delta) \setminus \Lang(\Gamma)$: 
					\label{huang_proof_prop_case_2}
					Then $\PI(C) = [\PI(C_1) \land \PI(C_2)]\sigma$. 

					As $\Pred(l) \not\in \Lang(\Gamma)$,
					$\Gamma \entails (\PI(C_1) \lor D_\Gamma)\sigma$
					as well as $\Gamma \entails (\PI(C_2) \lor E_\Gamma)\sigma$.
					Suppose that in a model $M$ of $\Gamma$, $M \cancel \entails D_\Gamma$ and $M \cancel \entails E_\Gamma$. Then $M \entails \PI(C_1) \land \PI(C_2)$.
					Hence 
					$\Gamma \entails (\PI(C_1) \land \PI(C_2))\sigma \lor ((D \lor E)\sigma)_\Gamma$.

					Furthermore due to $\Pred(l) \in \Lang(\Delta)$,
					$\Delta \entails (\lnot\PI(C_1) \lor D_\Delta \lor l)\sigma$
					as well as $\Delta \entails (\lnot\PI(C_2) \lor E_\Delta \lor \lnot l')\sigma$.
					By a resolution step, we get $\Delta \entails (\lnot\PI(C_1) \lor \lnot\PI(C_2))\sigma \lor (D_\Delta \lor E_\Delta)\sigma $
					and hence 
					$\Delta \entails \lnot (\PI(C_1) \land \PI(C_2))\sigma \lor (D_\Delta \lor E_\Delta)\sigma $.

					The language restriction again remains intact.

				\item $\Pred(l) \in \Lang(\Delta) \intersect \Lang(\Gamma)$:
					Then $\PI(C) = [(l \land \PI(C_2)) \lor (\lnot l' \land \PI(C_1)) ]\sigma $

					First, we have to show that 
					$ \Gamma \entails [(l \land \PI(C_2)) \lor (l' \land \PI(C_1)) ]\sigma \lor ((D \lor E)\sigma)_\Gamma$.
					Suppose that in a model $M$ of $\Gamma$, $M \cancel \entails D_\Gamma$ and $\Gamma \cancel \entails E$. Otherwise we are done.
					The induction assumtion hence simplifies to $M \entails \PI(C_1) \lor l$ and $M \entails \PI(C_2) \lor \lnot l'$ respectively.
					As $l\sigma = l'\sigma$, by a case distinction argument on the truth value of $l\sigma$, we get that either $M \entails (l \land \PI(C_2))\sigma$ or $M \entails  (\lnot l' \land \PI(C_1))\sigma$.


					Second, we show that 
					$\Delta \entails ((l \lor \lnot \PI(C_1)) \land (\lnot l' \lor \lnot \PI(C_2)))\sigma \lor ((D \lor E)\sigma)_\Delta$.
					Suppose again that in a model $M$ of $\Delta$, $M \cancel \entails D_\Delta$ and $\Gamma \cancel \entails E_\Delta$. 
					Then the required statement follows from the induction hypothesis.
					
					The language condition remains satisfied as only the common literal $l$ is added to the interpolant.


			\end{enumerate}

		\item[Factorisation.]	
			Suppose the last rule application is an instance of factorisation. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: l \lor l' \lor D}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\UnaryInfCm{C_1: (l \lor D)\sigma}
			\end{prooftree}

			Then the propositional interpolant $\PI(C)$ is defined as $\PI(C_1)$.
			By the induction hypothesis, we have:

			$\Gamma \entails \PI(C_1) \lor (l \lor l' \lor D)_\Gamma$

			$\Delta \entails \PI(C_1) \lor (l \lor l' \lor D)_\Delta$

			It is easy to see that then also:

			$\Gamma \entails (\PI(C_1)\lor (l \lor D)_\Gamma)\sigma$

			$\Delta \entails (\PI(C_1)\sigma \lor (l \lor D)_\Delta)\sigma$

			The restriction on the language trivially remains intract.
			

		\item[Paramodulation.]	
			Suppose the last rule application is an instance of paramodulation. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor s=t}
				\AxiomCm{C_2: E[r]}
				\RightLabel{$\quad \sigma = \mgu(s, r)$}
				\BinaryInfCm{C: (D \lor E[t])\sigma}
			\end{prooftree}

			By the induction hypothesis, we have:

			$\Gamma \entails \PI(C_1) \lor (D\lor s=t)_\Gamma$

			$\Delta \entails \lnot \PI(C_1) \lor (D\lor s=t)_\Delta$

			$\Gamma \entails \PI(C_2) \lor (E[r])_\Gamma$

			$\Delta \entails \lnot \PI(C_2) \lor (E[r])_\Delta$

			First, we show that $\PI(C)$ as constructed in case \ref{def:PI_paramod_3} of the definition is a propositional interpolant in any of these cases:

			$\PI(C) = (s=t \land \PI(C_2)) \lor (s\neq t \land \PI(C_1)) $
			
			Suppose that in a model $M$ of $\Gamma$, $M \cancel \entails D\sigma$ and $M \cancel \entails E[t]\sigma$. Otherwise we are done.
			Furthermore, assume that $M \entails (s=t)\sigma$. Then $M \cancel \entails E[r]\sigma$, but then necessarily $M \entails \PI(C_2)\sigma$. \\
			On the other hand, suppose $M \entails (s\neq t)\sigma$. As also $M \cancel \entails D\sigma$, $M \entails \PI(C_1)\sigma$.
			Consequently, $M \entails [(s=t \land \PI(C_2)) \lor (s\neq t \land \PI(C_1))]\sigma \lor [(D \lor E)_\Gamma]\sigma$

			By an analogous argument, we get $\Delta \entails [(s=t \land \lnot \PI(C_2)) \lor (s\neq t \land \lnot \PI(C_1))]\sigma \lor [(D \lor E)_\Delta]\sigma$,
			which implies
			$\Delta \entails [( s\neq t \lor \lnot \PI(C_2)) \land (s = t \lor \lnot \PI(C_1))]\sigma \lor ((D \lor E)_\Delta)\sigma $

			%By a similar case distinction for a model $M$ of $\Delta$ and assuming that $M \cancel \entails D_\Delta$ and $M \cancel \entails E_\Delta$, we get that if $M \entails (s=t)\sigma$, $M \entails \lnot P$, which implies

			The language restriction again remains satisfied as the only predicate, that is added to the interpolant, is $=$.

			This concludes the argumentation for case \ref{def:PI_paramod_3}. 

			The interpolant of case \ref{def:PI_paramod_1} differs only by an additional formula added via a disjunction and hence condition \ref{rel_prop_interpol_cond1} of definition \ref{def:rel_prop_interpol} holds by the above reasoning.
			As the adjoined formula is a contradiction, its negation is valid which in combination with the above reasoning establishes condition \ref{rel_prop_interpol_cond2}.
			Since no new predicated are added, the language condition remains intact. 

			The situation in case \ref{def:PI_paramod_2} is somewhat symmetric: 
			As a tautology is added to the interpolant with respect to case \ref{def:PI_paramod_1}, condition \ref{rel_prop_interpol_cond1} is satisfied by the above reasoning.
			For condition \ref{rel_prop_interpol_cond2}, consider that the negated interpolant of case \ref{def:PI_paramod_1} implies the negated interpolant of this case.
			The language condition again remains intact.
			\qedhere
	\end{itemize}

	proof that we are allowed to overbind

	TODO: define procedure

	TODO: proof

	\end{proof}


	\subsubsection{overbinding}

	Algorithm (input: propositional interpolant $\theta$):
	\begin{enumerate}
		\item Let $t_1, \ldots, t_n$ be the maximal occurrences of noncommon terms in $\theta$. Order $t_i$ ascendingly by term size. 
		\item Let $\theta^*$ be $\theta$ with maximal occurrences of $\Delta$-terms $r_1, \ldots, r_k$ replaced by fresh variables $x_1, \ldots, x_k$ and maximal occurrences of $\Gamma$-terms $s_1, \ldots, s_{n-k}$ by fresh variables $x_{k+1}, \ldots, x_{n}$
		\item Return $Q_1 x_1, \ldots Q_n x_n \theta^*$, where $Q_i$ is $\forall$ if $t_i$ is a $\Delta$-term and $\exists$ otherwise.
	\end{enumerate}

	Language condition easily established. To prove:

	$\Gamma \entails Q_1 x_1, \ldots Q_n x_n \theta^*$

	$\Delta \entails \lnot Q_1 x_1, \ldots Q_n x_n \theta^*$

	We know that $\theta$ works, just the terms are missing.

\subsection{final step of huang's proof}

\begin{thm}
	$Q_1 z_1 \ldots Q_n z_n \PI(\square)^*(z_1, \ldots, z_n)$ is a craig interpolant (order as in huang).
\end{thm}
\begin{proof}
	By lemma \ref{lemma:gamma_entails_interpolant}, $\Gamma \entails \forall x_1 \ldots \forall x_n \overline{\PI(\square)}(x_1, \ldots, x_n)$.

	The terms in $\overline{PI(\square)}$ are either among the $x_i$, $1 \leq i \leq n$ or grey terms or $\Gamma$-terms.
	Let $t$ be a maximal $\Gamma$-term in $\overline{\PI(\square)}$.
	Then it is of the form $f(x_{i_1}, \ldots, x_{i_{n_x}}, u_1, \ldots, u_{n_u}, v_1, \ldots, v_{n_v})$, where $f$ is $\Gamma$-colored, the $x_j$ are as before, the $u_j$ are grey terms and the $v_j$ are $\Gamma$-terms.\todo{basically only need the $x_j$}{}
	Note that the $\Delta$-terms, which are replaced by the $x_{i_1}, \ldots, x_{i_{n_x}}$ are of strictly smaller size than $t$ as they are ``strict'' subterms of $t$.

	In $\PI(\square)^*$, $t$ will be replaced by some $z_j$, which is existentially quantified.
	For this $z_j$, $t$ is a witness as due to the quantifier ordering, all the $x_{i_1}, \ldots, x_{i_{n_x}}$ will be quantified before the existential quantification of $z_j$.
	Therefore $\Gamma \entails Q_1 z_1 \ldots Q_n z_n \PI(\square)^*(z_1, \ldots, z_n)$

\end{proof}



