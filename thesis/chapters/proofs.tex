
\section{WT: Interpolation extraction in one pass}

easy for constants, just as in huang but in one pass

terms can grow unpredictably, order cannot be determined during pass

\section{WT: Interpolation extraction in two passes}

\subsection{huang proof: propositional}


Let $\Gamma \cup \Delta$ be unsatisfiable. Let $\pi$ be a proof of the empty clause from $\Gamma \cup \Delta$. Then $\PI$ is a function that returns a interpolant with respect to the current clause. 

\begin{defi}[Propositional interpolant]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	A formula $A$ is a \defiemph{propositional interpolant} if
	\label{def:rel_prop_interpol}
	\begin{enumerate}
		\item $\Gamma \entails A$
			\label{rel_prop_interpol_cond1}
		\item $\Delta \entails \lnot A$
			\label{rel_prop_interpol_cond2}
		\item $\Pred(A) \subseteq (\Pred(\Gamma) \intersect \Pred(\Delta)) \cup \{\top, \bot\} $.
			\label{rel_prop_interpol_cond_lang}
	\end{enumerate}


	For a clause $C$ in $\pi$, a formula $A_C$ is a \defiemph{propositional interpolant relative to $C$} if
	\label{def:rel_prop_interpol}
	\begin{enumerate}
		\item $\Gamma \entails A_C \lor C$
			\label{rel_prop_interpol_cond1}
		\item $\Delta \entails \lnot A_C \lor C$
			\label{rel_prop_interpol_cond2}
		\item $\Pred(A_C) \subseteq (\Pred(\Gamma) \intersect \Pred(\Delta)) \cup \{\top, \bot\} $.
			\label{rel_prop_interpol_cond_lang}
	\end{enumerate}

	The propositional interpolant of the empty clause derived in $\pi$ is denoted by $\PI(\pi)$.\qedhere
\end{defi}

The third condition of a propositional interpolant will sometimes be referred to as \emph{language restriction}.
It is easy to see that the propositional interpolant relative to the empty clause of a resolution refutation is a propositional interpolant.
%^\todo{add this to the definition, i.e.~possible define rel prop interpol from prop interpol}

We proceed by defining a procedure $\PI$ which extracts propositional interpolants from a resolution refutation.

\begin{defi}[Propositional interpolant extraction.]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	\defiemph{${\PI(\pi)}$} is defined to be $\PI(\square)$, where $\square$ is the empty clause derived in $\pi$.

	For a clause $C$ in $\pi$, \defiemph{$\PI(C)$} is defined as follows:
	\label{def:PI}
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, $\PI(C) = \bot$. 
			If otherwise $C \in \Delta$, $\PI(C) = \top$. 
		\item[Resolution.]
			\label{def:PI_resolution}
			%Suppose the clause $C$ is the result of a resolution step. Then it has the following form: 

			%	\begin{prooftree}
			%		\AxiomCm{C_1: D \lor l}
			%		\AxiomCm{C_2: E \lor \lnot l'}
			%		\RightLabelm{\quad l\sigma = l'\sigma}
			%		\BinaryInfCm{C: (D\lor E)\sigma}
			%	\end{prooftree}
			%\todo{write as prooftree? (not necessary, but nicer)}
			If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\PI(C)$ is defined as follows:
			%$\PI(C)$ is defined according to this case distinction:
			\begin{enumerate}
				\item If $l$ is $\Gamma$-colored: $\PI(C) = [\PI(C_1) \lor \PI(C_2)]\sigma$
				\item If $l$ is $\Delta$-colored: $\PI(C) = [\PI(C_1) \land \PI(C_2)]\sigma$
				\item If $l$ is grey: $\PI(C) = [(l \land \PI(C_2)) \lor (\lnot l' \land \PI(C_1)) ]\sigma $
			\end{enumerate}

		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\PI(C) = \PI(C_1)\sigma$.

		\item[Paramodulation.]
	\label{def:PI_paramod}
			If the clause $C$ is the result of a paramodulation of $C_1: s=t \lor C$ and $C_2: D\occur{r}$ using a unifier $\sigma$ such that $r\sigma = s\sigma$, then $\PI(C)$ is defined according to the following case distinction:
			\begin{enumerate}
				\item If $r$ occurs in a maximal $\Delta$-term $h(r)$ in $D\occur{r}$ and $h(r)$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$:
					\label{def:PI_paramod_1}
					\newline
					$\PI(C) = [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \lor (s=t \land h\occur{s} \neq h\occur{t})\sigma$ 
				\item If $r$ occurs in a maximal $\Gamma$-term $h(r)$ in $D\occur{r}$ and $h(r)$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$:
					\label{def:PI_paramod_2}
					\newline
					$\PI(C) = [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \land (s\neq t \lor h\occur{s} = h\occur{t})\sigma$ 
				\item Otherwise:
					\label{def:PI_paramod_3}
					\newline
					$\PI(C) = [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma$ \qedhere

			\end{enumerate}
	\end{itemize}
\end{defi}


\begin{prop}
	\label{prop:prop_interpol}
	Let $C$ be a clause of a resolution refutation of $\Gamma \cup \Delta$.
	Then $\PI(C)$ is a propositional interpolant with respect to $C$. 
\end{prop}
\begin{proof}
	Proof by induction on the number of rule applications including the following strengthenings:
	$\Gamma \entails \PI(C) \lor C_\Gamma$ and
	$\Delta \entails \lnot \PI(C) \lor C_\Delta$, where $D_\Phi$ denotes the clause D with only the literals which are contained in $\Lang(\Phi)$. They clearly imply conditions \ref{rel_prop_interpol_cond1} and \ref{rel_prop_interpol_cond2} of definition \ref{def:rel_prop_interpol}. 

	\begin{itemize}
		\item[Base case.]
			Suppose no rules were applied. We distinguish two possible cases:
			\begin{enumerate}
				\item $C \in \Gamma$.
					Then $\PI(C) = \bot$. Clearly $\Gamma \entails \bot \lor C_\Gamma$ as $C_\Gamma = C \in \Gamma$, $\Delta \entails \lnot \bot \lor C_\Delta$ and $\bot$ satisfies the restriction on the language.

				\item $C \in \Delta$.
					Then $\PI(C) = \top$. Clearly $\Gamma \entails \top \lor C_\Gamma$, $\Delta \entails \lnot \top \lor C_\Delta$ as $C_\Delta = C \in \Delta$ and $\top$ satisfies the restriction on the language.
			\end{enumerate}

			Suppose the property holds for $n$ rule applications.
			We show that it holds for $n+1$ applications by considering the last one:

		\item[Resolution.]
			Suppose the last rule application is an instance of resolution. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor l}
				\AxiomCm{C_2: E \lor \lnot l'}
				\RightLabelm{\quad l\sigma = l'\sigma}
				\BinaryInfCm{C: (D\lor E)\sigma}
			\end{prooftree}

			By the induction hypothesis, we can assume that:

			$\Gamma \entails \PI(C_1) \lor (D\lor l)_\Gamma$

			$\Delta \entails \lnot \PI(C_1) \lor (D\lor l)_\Delta$

			$\Gamma \entails \PI(C_2) \lor (E\lor \lnot l')_\Gamma$

			$\Delta \entails \lnot \PI(C_2) \lor (E\lor \lnot l')_\Delta$

			We consider the respective cases from definition \ref{def:PI_resolution}:

			\begin{enumerate}
				\item $l$ is $\Gamma$-colored.
					\label{huang_proof_prop_case_1}
					Then $\PI(C) = [\PI(C_1) \lor \PI(C_2)]\sigma$. 

					As $\Pred(l) \in \Lang(\Gamma)$,
					$\Gamma \entails (\PI(C_1) \lor D_\Gamma\lor l)\sigma$
					as well as $\Gamma \entails (\PI(C_2) \lor E_\Gamma\lor \lnot l')\sigma$.
					By a resolution step, we get $\Gamma \entails (\PI(C_1) \lor \PI(C_2))\sigma \lor ((D \lor E)\sigma)_\Gamma$.

					Furthermore, as $\Pred(l) \not\in \Lang(\PI)$, 
					$\Delta \entails (\lnot\PI(C_1) \lor D_\Delta)\sigma$
					as well as $\Delta \entails (\lnot\PI(C_2) \lor E_\Delta)\sigma$.
					Hence it certainly holds that $\Delta \entails (\lnot \PI(C_1) \lor \lnot\PI(C_2))\sigma \lor (D \lor E)\sigma_\Delta$.

					The language restriction clearly remains satisfied as no non-logical symbols are added.

				\item $l$ is $\Delta$-colored.
					\label{huang_proof_prop_case_2}
					Then $\PI(C) = [\PI(C_1) \land \PI(C_2)]\sigma$. 

					As $\Pred(l) \not\in \Lang(\Gamma)$,
					$\Gamma \entails (\PI(C_1) \lor D_\Gamma)\sigma$
					as well as $\Gamma \entails (\PI(C_2) \lor E_\Gamma)\sigma$.
					Suppose that in a model $M$ of $\Gamma$, $M \cancel \entails D_\Gamma$ and $M \cancel \entails E_\Gamma$. Then $M \entails \PI(C_1) \land \PI(C_2)$.
					Hence 
					$\Gamma \entails (\PI(C_1) \land \PI(C_2))\sigma \lor ((D \lor E)\sigma)_\Gamma$.

					Furthermore due to $\Pred(l) \in \Lang(\Delta)$,
					$\Delta \entails (\lnot\PI(C_1) \lor D_\Delta \lor l)\sigma$
					as well as $\Delta \entails (\lnot\PI(C_2) \lor E_\Delta \lor \lnot l')\sigma$.
					By a resolution step, we get $\Delta \entails (\lnot\PI(C_1) \lor \lnot\PI(C_2))\sigma \lor (D_\Delta \lor E_\Delta)\sigma $
					and hence 
					$\Delta \entails \lnot (\PI(C_1) \land \PI(C_2))\sigma \lor (D_\Delta \lor E_\Delta)\sigma $.

					The language restriction again remains intact.

				\item $l$ is grey.
					Then $\PI(C) = [(l \land \PI(C_2)) \lor (\lnot l' \land \PI(C_1)) ]\sigma $

					First, we have to show that 
					$ \Gamma \entails [(l \land \PI(C_2)) \lor (l' \land \PI(C_1)) ]\sigma \lor ((D \lor E)\sigma)_\Gamma$.
					Suppose that in a model $M$ of $\Gamma$, $M \cancel \entails D_\Gamma$ and $\Gamma \cancel \entails E$. Otherwise we are done.
					The induction assumption hence simplifies to $M \entails \PI(C_1) \lor l$ and $M \entails \PI(C_2) \lor \lnot l'$ respectively.
					As $l\sigma = l'\sigma$, by a case distinction argument on the truth value of $l\sigma$, we get that either $M \entails (l \land \PI(C_2))\sigma$ or $M \entails  (\lnot l' \land \PI(C_1))\sigma$.


					Second, we show that 
					$\Delta \entails ((l \lor \lnot \PI(C_1)) \land (\lnot l' \lor \lnot \PI(C_2)))\sigma \lor ((D \lor E)\sigma)_\Delta$.
					Suppose again that in a model $M$ of $\Delta$, $M \cancel \entails D_\Delta$ and $\Gamma \cancel \entails E_\Delta$. 
					Then the required statement follows from the induction hypothesis.

					The language condition remains satisfied as only the common literal $l$ is added to the interpolant.


			\end{enumerate}

		\item[Factorisation.]	
			Suppose the last rule application is an instance of factorisation. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: l \lor l' \lor D}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\UnaryInfCm{C_1: (l \lor D)\sigma}
			\end{prooftree}

			Then the propositional interpolant $\PI(C)$ is defined as $\PI(C_1)$.
			By the induction hypothesis, we have:

			$\Gamma \entails \PI(C_1) \lor (l \lor l' \lor D)_\Gamma$

			$\Delta \entails \PI(C_1) \lor (l \lor l' \lor D)_\Delta$

			It is easy to see that then also:

			$\Gamma \entails (\PI(C_1)\lor (l \lor D)_\Gamma)\sigma$

			$\Delta \entails (\PI(C_1)\sigma \lor (l \lor D)_\Delta)\sigma$

			The restriction on the language trivially remains intact.


		\item[Paramodulation.]	
			Suppose the last rule application is an instance of paramodulation. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor s=t}
				\AxiomCm{C_2: E[r]}
				\RightLabel{$\quad \sigma = \mgu(s, r)$}
				\BinaryInfCm{C: (D \lor E\occur{t})\sigma}
			\end{prooftree}

			By the induction hypothesis, we have:

			$\Gamma \entails \PI(C_1) \lor (D\lor s=t)_\Gamma$

			$\Delta \entails \lnot \PI(C_1) \lor (D\lor s=t)_\Delta$

			$\Gamma \entails \PI(C_2) \lor (E[r])_\Gamma$

			$\Delta \entails \lnot \PI(C_2) \lor (E[r])_\Delta$

			First, we show that $\PI(C)$ as constructed in case \ref{def:PI_paramod_3} of the definition is a propositional interpolant in any of these cases:

			$\PI(C) = (s=t \land \PI(C_2)) \lor (s\neq t \land \PI(C_1)) $

			Suppose that in a model $M$ of $\Gamma$, $M \cancel \entails D\sigma$ and $M \cancel \entails E\occur{t}\sigma$. Otherwise we are done.
			Furthermore, assume that $M \entails (s=t)\sigma$. Then $M \cancel \entails E[r]\sigma$, but then necessarily $M \entails \PI(C_2)\sigma$. \\
			On the other hand, suppose $M \entails (s\neq t)\sigma$. As also $M \cancel \entails D\sigma$, $M \entails \PI(C_1)\sigma$.
			Consequently, $M \entails [(s=t \land \PI(C_2)) \lor (s\neq t \land \PI(C_1))]\sigma \lor [(D \lor E)_\Gamma]\sigma$

			By an analogous argument, we get $\Delta \entails [(s=t \land \lnot \PI(C_2)) \lor (s\neq t \land \lnot \PI(C_1))]\sigma \lor [(D \lor E)_\Delta]\sigma$,
			which implies
			$\Delta \entails [( s\neq t \lor \lnot \PI(C_2)) \land (s = t \lor \lnot \PI(C_1))]\sigma \lor ((D \lor E)_\Delta)\sigma $

			%By a similar case distinction for a model $M$ of $\Delta$ and assuming that $M \cancel \entails D_\Delta$ and $M \cancel \entails E_\Delta$, we get that if $M \entails (s=t)\sigma$, $M \entails \lnot P$, which implies

			The language restriction again remains satisfied as the only predicate, that is added to the interpolant, is $=$.

			This concludes the argumentation for case \ref{def:PI_paramod_3}. 

			The interpolant for case \ref{def:PI_paramod_1} differs only by an additional formula added via a disjunction and hence condition \ref{rel_prop_interpol_cond1} of definition \ref{def:rel_prop_interpol} holds by the above reasoning.
			As the adjoined formula is a contradiction, its negation is valid which in combination with the above reasoning establishes condition \ref{rel_prop_interpol_cond2}.
			Since no new predicated are added, the language condition remains intact. 

			The situation in case \ref{def:PI_paramod_2} is somewhat symmetric: 
			As a tautology is added to the interpolant with respect to case \ref{def:PI_paramod_1}, condition \ref{rel_prop_interpol_cond1} is satisfied by the above reasoning.
			For condition \ref{rel_prop_interpol_cond2}, consider that the negated interpolant for case \ref{def:PI_paramod_1} implies the negated interpolant for this case.
			The language condition again remains intact.
			\qedhere
	\end{itemize}
\end{proof}

\subsection{huang proof: overbinding}
Before we are able to specify a procedure to transform the propositional interpolant generated by $\PI$ into a proper interpolant without any colored terms,
we need to make some observerations about tree refutations.

In a tree refutation where the input clauses have a disjoint sets of variables, every variable has a unique ancestor which traces back to an input clause and hence appears only along a certain path.
This insight allows us to push substitutions of the variables upwards along this path and arrive at the following definition and lemma:



%For every unification $\sigma$ in the deduction and for every variable $x$, either $x\sigma = x$ or $x\sigma = t$ where $x$ does not occur in $t$.
%Hence along the path from the input clause to its unification or removal by resolution or factorisation, it occurs unchanged.
%Therefore replacing $x$ along the path with $\sigma x$, where $\sigma$ is a non-trivial unifier used on $x$ in the derivation creates still a valid refutation of whatever.

\begin{defi}
	A resolution refutation is a \defiemph{propositional refutation} if no nontrivial substitutions are employed.
\end{defi}

\begin{lemma}
	Let $\Phi$ be unsatisfiable.
	Then there is a propositional refutation of $\Phi$ which starts from instances of $\Phi$.
\end{lemma}
\begin{proof}
	Let $\pi$ be a resolution refutation of $\Phi$.
	By Lemma \ref{lemma:bin_tree_deduction}, we can assume without loss of generality that $\pi$ is a tree refutation where the sets of variables of the input clauses are disjoint.
	Furthermore, we can assume that only most general unifiers are employed in $\pi$.

	Then any unifier in $\pi$ is either trivial on $x$ or there is one unique unifier $\sigma$ in $\pi$ with $x\sigma = t$ where $x$ does not occur in $t$.
	Hence along the path through the deduction where $x$ occurs, it remains unchanged.
	Therefore we can create a new resolution refutation $\pi'$ from $\pi$ where $x$ is replaced by $t$.
	Clearly $\pi'$ is rooted in instances of $\Phi$.

	By application of this procedure to all variable occurring in $\pi$, we obtain a desired resolution refutation.
\end{proof}

Even though propositional refutations have nice properties for theoretical analysis, their use in practise is not desired as its construction involves a considerable blowup of the refutation. 
But its use is still justified in this instance as we can show for arbitrary refutations $\pi$
that the algorithm stated in \ref{def:PI} gives closely related results for both $\pi$ and its corresponding propositional refutation.

\begin{lemma}
	Let $\pi$ be a resolution refutation of $\Phi$ and $\pi'$ a propositional refutation corresponding to $\pi$.
	Then for every clause $C$ in $\pi$ and its corresponding clause $C'$ in $\pi'$, $\PI(C)\sigma = \PI(C')$, where $\sigma$ is the composition of the unifications of $\pi$ which are applied to the variables occurring in $C$ .
\end{lemma}
\begin{proof}
	For the construction of the propositional skeleton of $\PI(\cdot)$ only the coloring of the clauses is relevant and since this is the same in both $\pi$ and $\pi'$, it coincides for $\PI(C)$ and $\PI(C')$.

	Hence $\PI(C)$ and $\PI(C')$ differ only in their term structure. 
	To be more specific, in $\PI(C')$, the composition of substitutions that are applied in $\pi$ have already been applied to the initial clauses of $\pi'$. 
	Note that substitution commutes with the rules of resolution.
	Therefore the only difference between $\PI(C)$ and $\PI(C')$ is that at certain term positions, there are variables in $\PI(C)$ where in $\PI(C')$ by some substitution a different term is located. 
	But these substitutions are certainly applied by $\sigma$, hence $\PI(C)\sigma = \PI(C')$.
\end{proof}

This establishes the theoretical framework which is required to define and show the correctness of the procedure to construct a proper interpolant from the propositional interpolant.
The idea of this procedure will be to replace colored terms still occurring in the propositional interpolant with variables and quantifying them appropriately.
This replacement is referred to as lifting:

\begin{defi}[Lifting]
	Let $\Gamma$ and $\Delta$ be sets of first-order formulas, 
	$\phi$ a formula or a term, $t_1, \ldots, t_n$ the maximal $\Phi$-terms for $\Phi \in \{\Gamma, \Delta\}$ in $\phi$ and $x_1, \ldots, x_n$ fresh variables.
	Then $\lft{\Phi}{x}{\phi}$ denotes $\phi\abstraction{t_1/x_1}\ldots\abstraction{t_n/x_n}$.
\end{defi}

\begin{lemma} 
	\label{lemma:lift_commute}
	Let $A$ and $B$ be first-order formulas. Then it holds that:
	\begin{enumerate}
		\item $\lift{\Phi}{\lnot A}{x} \semiff \lnot \lift{\Phi}{A}{x}$
		\item $\lift{\Phi}{A \circ B}{x} \semiff ( \lift{\Phi}{A}{x} \circ \lift{\Phi}{B}{x} )$ for $\circ \in \{\land, \lor\}$
	\end{enumerate}
\end{lemma}

First, we consider the lifting of the $\Delta$-terms:\nopagebreak[4]

\begin{lemma}
	\label{lemma:gamma_entails_lifted_interpolant}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$. 
	Then $\Gamma \entails \lift{\Delta}{ \PI(C) \lor C }{x} $ for $C$ in $\pi$.
\end{lemma}
\begin{proof}
	We proof this result by induction on the number of rule applications in the propositional refutation corresponding to $\pi$. 
	Similar to the proof of \ref{prop:prop_interpol}, we show the strengthening:
	$\Gamma \entails \lift{\Delta}{ \PI(C) \lor C_\Gamma }{x} $ for $C$ in $\pi$.

	\begin{itemize}

			\newcommand{\lif}[1]{\lift{\Delta}{#1}{x}}
		\item[Base case.]

			If no rules have been applied, $C$ is an instance of a clause of either $\Gamma$ or $\Delta$.
			In the former case, all $\Delta$-terms of $C$ were added by unification, hence by replacing them with variables, we obtain a clause $C'$ which still is an instance of $C$ and consequently is implied by $\Gamma$. 
			In the latter case, $\PI(C) = \top$. 

		\item[Resolution.] Suppose the last rule application is an instance of resolution. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: D\lor l}
				\AxiomCm{C_2: E\lor \lnot l}
				\BinaryInfCm{C: D \lor E}
			\end{prooftree}

			By the induction hypothesis,

			$\Gamma \entails \lift{\Delta}{ \PI(C_1) \lor (D \lor l)_\Gamma }{x}$ and

			$\Gamma \entails \lift{\Delta}{ \PI(C_2) \lor (E \lor \lnot l)_\Gamma }{x}$

			which by Lemma \ref{lemma:lift_commute} is equivalent to

			$\Gamma \entails \lift{\Delta}{ \PI(C_1) }{x} \lor
			\lift{\Delta}{ D_\Gamma }{x} \lor
			\lift{\Delta}{ l_\Gamma }{x} \;\; ^{(\circ)} $
			and

			$\Gamma \entails \lift{\Delta}{ \PI(C_2) }{x} \lor
			\lift{\Delta}{ E_\Gamma }{x} \lor
			\lnot \lift{\Delta}{ l_\Gamma }{x} \;\; ^{(*)}$ .


			\begin{enumerate}
				\item Suppose $l$ is $\Gamma$-colored.
					Then $\PI(C) = \PI(C_1) \lor \PI(C_2)$.
					By using resolution of $^{(*)}$ and $^{(\circ)}$ on $\lift{\Delta}{l_\Gamma}{x}$, we get that 
					$$\Gamma \entails\lift{\Delta}{ \PI(C_1) }{x} \lor \lift{\Delta}{ \PI(C_2) }{x} \lor
					\lift{\Delta}{ D_\Gamma }{x} \lor
					\lift{\Delta}{ E_\Gamma }{x}.$$
					Several applications of Lemma \ref{lemma:lift_commute} give
					$\Gamma \entails\lift{\Delta}{ \PI(C_1)  \lor  \PI(C_2) \lor (D \lor E)_\Gamma }{x}$.

				\item Suppose $l$ is $\Delta$-colored.
					Then $\PI(C) = \PI(C_1) \land \PI(C_2)$.

					As $l$ and $\lnot l$ are not contained in $\Lang(\Gamma)$, we get that 

					$\Gamma \entails \lift{\Delta}{ \PI(C_1) }{x} \lor
					\lift{\Delta}{ D_\Gamma }{x}$
					and

					$\Gamma \entails \lift{\Delta}{ \PI(C_2) }{x} \lor
					\lift{\Delta}{ E_\Gamma }{x}$.

					So if in a model $M$ of $\Gamma$ we have that
					$M \cancel\entails \lift{\Delta}{ D_\Gamma }{x}$ and 
					$M \cancel\entails \lift{\Delta}{ E_\Gamma }{x}$, it follows that $M \entails \lift{\Delta}{ \PI(C_1) }{x}$ and $M \entails \lift{\Delta}{ \PI(C_2) }{x}$. Hence by Lemma~\ref{lemma:lift_commute}
					$M \entails \lift{\Delta}{ \PI(C_1) \land \PI(C_2) }{x} \lor
					\lift{\Delta}{ (D \lor E)_\Gamma }{x}$.

				\item Suppose $l$ is grey.
					Then $\PI(C) =  (l \land \PI(C_2)) \lor (\lnot l \land \PI(C_1))$.

					We show that 
					$\Gamma \entails \lift{\Delta}{(l \land \PI(C_2)) \lor (\lnot l \land \PI(C_1)) \lor (D \lor E)_\Gamma  }{x} $. 

					Suppose that for a model $M$ of $\Gamma$ that 
					$M \cancel\entails \lift{\Delta}{ D_\Gamma }{x}$ and 
					$M \cancel\entails \lift{\Delta}{ E_\Gamma }{x}$.
					Then by $^{(\circ)}$
					and $^{(*)}$, we get that\nopagebreak

					$M \entails \lift{\Delta}{ \PI(C_1) }{x} \lor
					\lift{\Delta}{ l_\Gamma }{x}$ as well as

					$M \entails \lift{\Delta}{ \PI(C_2) }{x} \lor
					\lnot \lift{\Delta}{ l_\Gamma }{x}$.

					So $M \entails \lift{\Delta}{ l_\Gamma }{x}$ implies that 
					$M \entails \lift{\Delta}{\PI(C_2)}{x}$ and 
					$M \entails \lnot \lift{\Delta}{ l_\Gamma }{x}$  implies that 
					$M \entails \lift{\Delta}{\PI(C_1)}{x}$ and 

					Therefore
					$M\entails (\lif{l} \land \lif{\PI(C_2)}) \lor (\lnot \lif{l} \land \lif{\PI(C_1)}) \lor (\lif{D_\Gamma} \lor \lif{E_\Gamma}) $,
					and several applications of Lemma \ref{lemma:lift_commute} give
					$M\entails \lif{(l \land \PI(C_2)) \lor (\lnot {l} \land {\PI(C_1)}) \lor ({D_\Gamma} \lor {E_\Gamma})} $.
			\end{enumerate}


		\item[Factorisation.] Suppose the last rule application is an instance of factorisation. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: l \lor l \lor D}
				\UnaryInfCm{C: l \lor D}
			\end{prooftree}

			The propositional interpolant directly carried over from $C_1$, i.e.~$\PI(C) = \PI(C_1)$.

			By the induction hypothesis, we get that $\Gamma \entails \lif{\PI(C_1) \lor (l \lor l \lor D)_\Gamma}$.
			By Lemma \ref{lemma:lift_commute}, 

			$\Gamma \entails \lif{\PI(C_1)} \lor (\lif{l_\Gamma} \lor  \lif{l_\Gamma} \lor \lif{D_\Gamma})$,

			which clearly is equivalent to

			$\Gamma \entails \lif{\PI(C_1)} \lor (\lif{l_\Gamma} \lor \lif{D_\Gamma})$,

			so by again applying Lemma \ref{lemma:lift_commute}, we arrive at

			$\Gamma \entails \lif{\PI(C_1) \lor (l \lor D)_\Gamma}$.



		\item[Paramodulation.] Suppose the last rule application is an instance of paramodulation. Then it is of the form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor s=t}
				\AxiomCm{C_2: E\occurat{s}{p}}
				\BinaryInfCm{C: D \lor E\occurat{t}{p}}
			\end{prooftree}

			By the induction hypothesis, we have that 

			$\Gamma \entails \lif{\PI(C_1) \lor (D \lor s=t)_\Gamma}$ and 

			$\Gamma \entails \lif{\PI(C_2) \lor (E\occurat{s}{p})_\Gamma}$.

			By Lemma \ref{lemma:lift_commute}, we get that 

			$\Gamma \entails \lif{\PI(C_1)} \lor \lif{D_\Gamma} \lor \lif{s}=\lif{t}$ and 

			$\Gamma \entails \lif{\PI(C_2)} \lor \lif{(E\occurat{s}{p})_\Gamma}$.

			We distinguish two cases:\nopagebreak
			\begin{enumerate}
				\item Suppose $s$ does not occur in a maximal $\Delta$-term $h\occur{s}$ in $E\occurat{s}{p}$ which occurs more than once in $\PI(E(s)) \lor E\occurat{s}{p}$.

					We show that $\Gamma \entails \lif{ (s=t \land \PI(C_2)) \lor (s\neq t \land \PI(C_1)) \lor (D \lor E\occurat{t}{p})_\Gamma}$, which subsumes the cases \ref{def:PI_paramod_2} and \ref{def:PI_paramod_3} of 
					Definition \ref{def:PI_paramod}. By Lemma \ref{lemma:lift_commute}, this is equivalent to

					$\Gamma \entails (\lif{s}=\lif{t} \land \lif{\PI(C_2)}) \lor (\lif s\neq \lif t \land \lif{\PI(C_1)}) \lor (\lif{D_\Gamma} \lor \lif{(E\occurat{t}{p})_\Gamma})$

					Suppose that in a model $M$ of $\Gamma$,
					$M \cancel\entails \lift{\Delta}{ D_\Gamma }{x}$ and 
					$M \cancel\entails \lift{\Delta}{ (E\occurat{t}{p})_\Gamma }{x}$.
					We show that then, depending on whether $\lif{s} = \lif{t}$ holds in $M$, one of the first two disjuncts holds in $M$.

					Then in case $M \entails \lif{s} = \lif{t}$ we also get
					$M \cancel\entails \lift{\Delta}{ (E\occurat{s}{p})_\Gamma }{x}$ and consequently by the induction hypothesis $M\entails \lif{\PI(C_2)}$.

					However in case $M \entails \lif{s} \neq \lif{t}$ we get by the induction hypothesis that 
					$M\entails \lif{\PI(C_1)}$.

					\label{njktahjtkhltah}

				\item Otherwise $s$ occurs in a maximal $\Delta$-term $h\occur{s}$ in $E\occurat{s}{p}$ which occurs more than once in $\PI(E(s)) \lor E\occurat{s}{p}$.
				This reflects case \ref{def:PI_paramod_1} of Definition \ref{def:PI_paramod}.

					Then models are possible in which $s=t$ and therefore $\lif{s}=\lif{t}$ holds, while at the same time $\lif{h\occur{s}} \neq \lif{h\occur{t}}$ does not as $h\occur{s}$ and $h\occur{t}$ are replaced by distinct variables due to being different $\Delta$-terms.

					Therefore we amend the proof of case \ref{njktahjtkhltah} as follows:

					In case $M \entails \lif{s} = \lif{t}$ (otherwise proceed as in case \ref{njktahjtkhltah}), 
					one of the following cases holds:

					\begin{itemize}
					\item $M\entails \lif{h\occur{s}} = \lif{h\occur{t}}$. From this, it follows that as in the proof of case \ref{njktahjtkhltah}, $M \cancel \entails \lif{(E\occurat{s}{p})_\Gamma}$ and consequently $M \entails \lif{\PI(C_2)}$ again by the induction hypothesis.

					\item 
						$M \entails \lif{h\occur{s}} \neq \lif{h\occur{t}}$.
						However as here $\PI(C)$ contains the with respect to case \ref{njktahjtkhltah} additional disjunct $s=t \land h\occur{s} \neq h\occur{t}$,
						$M \entails \lif{PI(C)}$ due to $M \entails \lif{s}=\lif{t} \land \lif{h\occur{s}} \neq \lif{h\occur{t}}$
					\qedhere
					\end{itemize}
			\end{enumerate}

	\end{itemize}

\end{proof}

\begin{remark}

	{\huge

		\textsc{
		does not just work like this
	}

	}

	\newcommand{\lif}[1]{\lift{\Delta}{#1}{x}}
	This lemma does not directly hold for a non-propositional proof.

	%In that case, the natural induction hypothesis would state that 
	The statement of the lemma would be identical in this case. For resolution, by the induction hypothesis, we would get

	$\Gamma \entails \lif{ \PI(C_1)} \lor \lif D  \lor \lif l$

	$\Gamma \entails \lif{ \PI(C_2)} \lor \lif E  \lor \lnot \lif{l'}$

	By the resolution we know that 
	$l\sigma = l'\sigma$.

	In order to proceed as in the other proof, we would need $\sigma'$ s.t.\
	$\lif{l}\sigma' = \lif{l'}\sigma'$

	$\Gamma \entails (\lif{ \PI(C_1)} \lor \lif D  \lor \lif l )\sigma'$

	$\Gamma \entails \lif{ \PI(C_1)}\sigma' \lor \lif D\sigma'  \lor \lif l\sigma'$

	$\Gamma \entails (\lif{ \PI(C_2)} \lor \lif E  \lor \lnot \lif{l'})\sigma'$

	$\Gamma \entails \lif{ \PI(C_2)}\sigma' \lor \lif E\sigma'  \lor \lnot \lif{l'} \sigma'$

	Hence 

	$\Gamma \entails \lif{ \PI(C_2)}\sigma' \lor \lif E\sigma'  \lor
	\lif{ \PI(C_1)}\sigma' \lor \lif D\sigma' $

	and therefore

	$\Gamma \entails \lif{ \PI(C_2) \lor E  \lor
	\PI(C_1) \lor  D}\sigma' $

	And we need to show that 
	$\Gamma \entails \lif{( \PI(C_1) \lor \PI(C_2) \lor D \lor E)\sigma }$

	%$\Gamma \entails \lif{PI(C_1)\sigma} \lor \lif{\PI(C_2)\sigma} \lor \lif{D\sigma} \lor \lif{E\sigma} $


\end{remark}






\subsection{final step of huang's proof}

The definition $\PI$ posseses a convenient property which is termed \emph{symmetry} in \cite[Definition 5]{interpolantStrenth} and can be stated formally as follows:

\newcommand{\primex}[1]{\ensuremath{\hat{#1}}}
\begin{lemma}
	\label{lemma:symmetry}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$ and
	$\primex\pi$ be $\pi$ with $\primex\Gamma = \Delta$ and $\primex\Delta = \Gamma$.
	Then $\PI(\pi) \semiff \lnot \PI(\primex\pi)$.
\end{lemma}
\begin{proof}
	We prove this lemma by induction on $\pi$.
	Let $\primex\varphi$ denote the clause/formula/literal/term in $\primex\pi$ corresponding to the clause/formula/literal/term $\varphi$ in $\pi$.

	\newcommand{\p}[1]{\primex{#1}}
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, then $C' \in \Delta'$ and $\PI(C) = \bot \semiff \lnot \top = \lnot \PI(C')$. 
			The case for $C\in \Delta$ is analogous.

		\item[Resolution.]
			If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then by induction hypothesis, we get that
			$\PI(C_i) = \lnot \PI(C'_i)$ for $i\in \{1,2\}$.

			We distinguish the following cases:
			\begin{enumerate}
					\item $l$ is $\Gamma$-colored. Then $\primex l$ is $\Delta$-colored.
						\begin{align*}
							\PI(C) &= \PI(C_1) \lor \PI(C_2)\\
														 &\semiff \lnot ( \lnot \PI(C_1) \land \lnot \PI(C_2) )\\
														 &= \lnot ( \PI(\primex C_1) \land \PI(\primex C_2) ) \\
														 &= \lnot \PI(\primex C)  
						\end{align*}
					\item $l$ is $\Delta$-colored. This case can be argued analogously.

					\item $l$ is grey. Then $\primex l$ is grey.\nopagebreak 
			\begin{align*}
				\PI(C) 
				&=  [(l \land \PI(C_2)) \lor (\lnot l' \land \PI(C_1))] \sigma\\
				&=  (l\sigma \land \PI(C_2)\sigma) \lor (\lnot l' \sigma \land \PI(C_1)\sigma)\\
				&\semiff\,(\lnot l\sigma \lor \PI(C_2)\sigma) \land (l'\sigma \lor \PI(C_1)\sigma)\\
				&\semiff \lnot [(l\sigma \land \lnot \PI(C_2)\sigma) \lor (\lnot l' \sigma \land \lnot \PI(C_1)\sigma)]\\
				&= \lnot [(\p l\sigma \land \lnot \PI(C_2)\sigma ) \lor (\lnot \p{l'}\sigma \land \lnot \PI(C_1)\sigma)\\
				&= \lnot [(\p l \land\lnot \PI(C_2) ) \lor (\lnot \p{l'}\land \lnot \PI(C_1) )]\sigma\\
				&= \lnot  [(\p l \land \PI(\p C_2) ) \lor (\lnot \p{l'} \land \PI(\p C_1))]\sigma \\
				&= \lnot \PI(\p C)
			\end{align*}

			\end{enumerate}

		\item[Factorisation.]
			Suppose the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$. Then $\PI(C) = \PI(C_1)\sigma$ and the induction hypothesis gives the result.

		\item[Paramodulation.]
			Suppose the clause $C$ is the result of a paramodulation of $C_1: s=t \lor C$ and $C_2: D\occur{r}$ using a unifier $\sigma$ such that $r\sigma = s\sigma$. 
			We distinguish the following cases:

			\begin{enumerate}
				\item $r$ occurs in a maximal $\Delta$-term $h\occur{r}$ in $D\occur{r}$ and $h\occur{r}$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$.
					Then $\primex r$ occurs in a maximal $\Gamma$-term $\primex h\occur{r}$ in $\primex D\occur{r}$ and $\primex h\occur{r}$ occurs more than once in $\primex D\occur{r} \lor \PI(\primex D\occur{r})$.
					\begin{align*}
						\PI(C) &= [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \lor (s=t \land h\occur{s} \neq h\occur{t})\sigma\\
						 &= [ ( s=t \land \lnot \PI(\primex C_2) ) \lor (s\neq t \land \lnot \PI(\primex C_1)) ]\sigma \lor (s=t \land h\occur{s} \neq h\occur{t})\sigma\\
						 &\semiff \lnot [ ( s\neq t \lor \PI(\primex C_2) ) \land (s= t \lor \PI(\primex C_1)) ]\sigma \land \lnot (s\neq t \lor h\occur{s} = h\occur{t})\sigma\\
						 &\semiff \lnot [ ( s = t \land \PI(\primex C_2) ) \lor (s\neq t \land \PI(\primex C_1)) ]\sigma \land \lnot (s\neq t \lor h\occur{s} = h\occur{t})\sigma\\
						 &= \lnot \PI(\primex C)
					\end{align*}

				\item $r$ occurs in a maximal $\Gamma$-term $h(r)$ in $D\occur{r}$ and $h(r)$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$.
					This case can be argued analogously.
				\item Otherwise:
					\begin{align*}
						\PI(C) &= [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \\
									 &= [ ( s=t \land \lnot \PI(\primex C_2) ) \lor (s\neq t \land \lnot \PI(\primex C_1)) ]\sigma \\
									 &\semiff \lnot [ ( s\neq t \lor \PI(\primex C_2) ) \land (s=t \lor \PI(\primex C_1)) ]\sigma \\
									 &\semiff \lnot [ ( s=t \land \PI(\primex C_2) ) \lor (s\neq t \land \PI(\primex C_1)) ]\sigma \\
									 &= \lnot \PI(\primex C)
					\qedhere
					\end{align*}
			\end{enumerate}


	\end{itemize}

\end{proof}

This lemma can be leveraged to show a counterpart of Lemma \ref{lemma:gamma_entails_lifted_interpolant} for $\Delta$:\nopagebreak

\begin{cor}
	\label{cor:delta_entails_lifted_interpolant}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$. 
	Then $\Delta \entails \lft{\Gamma}{x}{ \lnot \PI(C) \lor C }$ for $C$ in $\pi$.
\end{cor}
\begin{proof}
	Build $\primex \pi$ from $\pi$ using $\primex \Gamma = \Delta$ and $\primex \Delta = \Gamma$ as initial clause set partition.
	\newline
	By Lemma \ref{lemma:gamma_entails_lifted_interpolant}, $\primex \Gamma \entails \lft{\primex\Delta}{x}{ \PI(\primex C) \lor \primex C }$ for $\primex C$ in $\primex \pi$.
	\newline
	By Lemma \ref{lemma:symmetry},
$\primex \Gamma \entails \lft{\primex\Delta}{x}{ \lnot \PI(C) \lor \primex C }$ for the clause $C$ in $\pi$ corresponding to $\primex C$ in $\primex \pi$. 
	This however is nothing else than 
$\Delta \entails\nolinebreak \lft{\Gamma}{x}{ \lnot \PI(C) \lor C }$.
\end{proof}

\begin{lemma}
	%Let $\{z_1,\ldots, z_n\}$ be the maximal colored terms of a clause $C$.
	%Then 
	%$ Q_1 z_1 \ldots Q_n z_n \lft{\Gamma}{y}{ \lft{\Delta}{x}{ C}  }
	%\;\liff\;
	%Q_1 z_1 \ldots Q_n z_n \lft{\Delta}{x'}{ \lft{\Gamma}{y'}{ C}  }$ for $Q_i \in \{\forall, \exists\}$ for $1\leq i\leq n$.

	$ \lft{\Gamma}{y}{ \lft{\Delta}{x}{ C}  }$ and 
	$ \lft{\Delta}{x'}{ \lft{\Gamma}{y'}{ C}  }$
	differ only in the naming of the variables replacing maximal colored terms.
	\label{lemma:naming_of_colored_variables}

\end{lemma}
\begin{proof}
	Suppose a term $t$ in $C$ is affected by a lifting.
	We only need to consider maximal colored terms as grey terms are not affected by the liftings.
	Without loss of generality let $t$ be a maximal $\Delta$-colored term.

	Let $\Phi$ be the positions of maximal occurrences of $t$.
	Then in the left hand side, exactly all terms at positions $\Phi$ are replaced by $x_i$ for some $i$.

	In the right hand side, all terms at positions $\Phi$ are replaced by $\lft{\Gamma}{y'}{t}$ first. 
	However after this step,
	all these terms are equal to $\lft{\Gamma}{y'}{t}$, and as all distinct maximal $\Gamma$-terms are replaced by distinct variables, no other maximal colored term is equal to $\lft{\Gamma}{y'}{t}$.
	Hence exactly the terms at positions $\Phi$ are replaced by the same variable $x'_j$ for some $j$.
\end{proof}

\begin{thm}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$ and
	$z_1, \dots, z_n$ be the variables which replace the colored terms in $\lifgamma{\lifdelta{\PI(\pi)}}$ ordered by their length.
	Then
	$Q_1 z_1 \ldots Q_n z_n\,\lifgamma{\lifdelta{\PI(\pi)}}$, where $Q_i$ is $\forall$ ($\exists$) if $z_i$ replaces a $\Delta$ ($\Gamma$)-term, is an interpolant.
\end{thm}
\begin{proof}
	By Lemma \ref{lemma:gamma_entails_lifted_interpolant}, $\Gamma \entails \forall x_1 \ldots \forall x_m\,\lifdelta{\PI(\pi)}$ where $m$ is the number of maximal $\Delta$-colored terms in $\PI(\pi)$.

	A term in $\lifdelta{\PI(\pi)}$ is either $x_i$, $1 \leq i \leq m$, a grey term or a $\Gamma$-terms.
	Let $t$ be a maximal $\Gamma$-term in $\lifdelta{\PI(\pi)}$ and $x_{j_1}, \dots, x_{j_k}$ the variables replacing $\Delta$-terms in~$t$.
	Note that the $\Delta$-terms, which are replaced by $x_{j_1}, \ldots, x_{i_{j_k}}$ respectively, are each of strictly smaller size than $t$ as they are strict subterms of $t$.

	%Then it is of the form $f(x_{i_1}, \ldots, x_{i_{n_x}}, u_1, \ldots, u_{n_u}, v_1, \ldots, v_{n_v})$, where $f$ is $\Gamma$-colored, the $u_j$, $1\leq j \leq n_u$ are grey terms and the $v_j$, $1\leq j\leq n_v$ are $\Gamma$-terms.

	In $\lifgamma{\lifdelta{\PI(\pi)}}$, $t$ is replaced by some $z_j$, which is existentially quantified.
	Hence $t$ is a witness for $z_j$ as due to the quantifier ordering,
	the existential quantification of $z_j$ is in the scope of the quantifiers of $x_{j_1}, \ldots, x_{j_k}$ respectively.
	Therefore $\Gamma \entails Q_1 z_1 \ldots Q_n z_n\,\lifgamma{\lifdelta{\PI(\pi)}}$.

	By Corollary \ref{cor:delta_entails_lifted_interpolant} $\Delta \entails \forall y_1 \dots \forall y_m\,\lnot \lift{\Gamma}{\PI(\pi)}{y}$, where $m$ is the number of $\Gamma$-colored terms in $\PI(\pi)$.
	By a similar line of argumentation as above, we can replace the maximal $\Delta$-terms by existentially quantified variables and arrive at
	$\Delta \entails\nolinebreak{} \overline Q_1 z_1 \dots \overline Q_n z_n\,\lnot \lft{\Delta}{x}{\lft{\Gamma}{y}{\PI(\pi)}}$ where $\overline Q_i = \exists$ ($\forall$) if $Q_i = \forall$ ($\exists$).
	Therefore also
	$\Delta \entails\nolinebreak{} \lnot Q_1 z_1 \dots Q_n z_n\,\lft{\Delta}{x}{\lft{\Gamma}{y}{\PI(\pi)}}$.
	By Lemma \ref{lemma:naming_of_colored_variables} and as all variables which replace colored terms are bound, 
	$\Delta \entails\nolinebreak{} \lnot Q_1 z_1 \dots Q_n z_n\,\lft{\Gamma}{y}{\lft{\Delta}{x}{\PI(\pi)}}$.

	As it is now easy to see that $Q_1 z_1 \dots Q_n z_n\,\lft{\Gamma}{y}{\lft{\Delta}{x}{\PI(\pi)}}$ contains no colored symbol, it is an interpolant.
\end{proof}



