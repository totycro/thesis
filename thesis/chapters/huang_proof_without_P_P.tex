\chapter{Interpolant extraction from resolution proofs in two phases}

In \cite{Huang95}, Huang proposes an algorithm for computing interpolants of two sets of first-order formulas $\Gamma$ and $\Delta$, where $\Gamma\cup\Delta$ is unsatisfiable, by traversing a resolution refutation of $\Gamma \cup \Delta$.
We present his proof in a modified form.
The central difference lies in the treatment of the interplay of substitutions and liftings. While in \cite{Huang95}, propositional deductions are employed where only trivial substitutions occur, we provide a method which allows for commuting substitutions and liftings under certain conditions.

See also \mytodo{} for a comments on the original proof.

\section{Layout of the proof}

The underlying algorithm produces in the first phase propositional interpolants inductively for every clause which occurs in the resolution refutation.
These interpolants are propositional in the sense that they only obey the language restriction on predicates and may contain colored terms.
The propositional interpolant assigned to the last clause, the empty clause, is a propositional interpolant for the initial clause sets.

The second phase of the algorithm addresses the colored terms still contained in the propositional interpolant.
These are eliminated (lifted) by replacing them with bound variables whose quantifiers are subject to a certain ordering.



\section{Extraction of propositional interpolants}

We define a procedure $\PI$, which produces propositional interpolants from resolution refutations. It only differs marginally from the ``Interpolation Algorithm'' in \cite{Huang95}.
\mytodo{adapt this when final version is decided}

\begin{defi}[Propositional interpolant extraction.]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	\defiemph{${\PI(\pi)}$} is defined to be $\PI(\square)$, where $\square$ is the empty clause derived in $\pi$.

	For a clause $C$ in $\pi$, \defiemph{$\PI(C)$} is defined as follows:
	\label{def:PI}
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, $\PI(C) \defeq \bot$.
			If otherwise $C \in \Delta$, $\PI(C) \defeq \top$.
		\item[Resolution.]
			\label{def:PI_resolution}
			%Suppose the clause $C$ is the result of a resolution step. Then it has the following form: 

      % \begin{prooftree}
      %   \AxiomCm{C_1: D \lor l}
      %   \AxiomCm{C_2: E \lor \lnot l'}
      %   \RightLabelm{\quad l\sigma = l'\sigma}
      %   \BinaryInfCm{C: (D\lor E)\sigma}
      % \end{prooftree}
      %\todo{write as prooftree? (not necessary, but nicer)}
      If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\PI(C)$ is defined as follows:
      %$\PI(C)$ is defined according to this case distinction:
      \begin{enumerate}
				\item If $l$ is $\Gamma$-colored: $\PI(C) \defeq{} [\PI(C_1) \lor \PI(C_2)]\sigma$
				\item If $l$ is $\Delta$-colored: $\PI(C) \defeq{} [\PI(C_1) \land \PI(C_2)]\sigma$
				\item If $l$ is grey: $\PI(C) \defeq{} [(l \land \PI(C_2)) \lor (\lnot l' \land \PI(C_1)) ]\sigma $
      \end{enumerate}

    \item[Factorisation.]
      If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\PI(C) = \PI(C_1)\sigma$.

    \item[Paramodulation.]
  \label{def:PI_paramod}
      Suppose the clause $C$ is the result of a paramodulation of $C_1: s=t \lor C$ and $C_2: D\occur{r}$ using a       unifier $\sigma$ such that $r\sigma = s\sigma$.
      Let $h\occur{r}$ be the maximal colored term in which $r$ occurs in $D\occur{r}$.
      Then $\PI(C)$ is defined according to the following case distinction:
      \begin{enumerate}

        \item If $h\occur{r}$ is $\Delta$-colored and $h\occur{r}$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$:
          \label{def:PI_paramod_1}
          \newline
					$\PI(C) \defeq{} [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \lor (s=t \land h\occur{s} \neq      h\occur{t})\sigma$
        \item If $h\occur{r}$ is $\Gamma$-colored and $h\occur{r}$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$:
          \label{def:PI_paramod_2}
          \newline
					$\PI(C) \defeq{} [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \land (s\neq t \lor h\occur{s} =     h\occur{t})\sigma$
				\item If $r$ does not occur in a colored term in $D\occur{r}$ {\color{red} or $s\syneq t$}:
          \label{def:PI_paramod_3}
          \newline
					$\PI(C) \defeq{} [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma$ \qedhere

      \end{enumerate}

  \end{itemize}
\end{defi}


The difference between $\PI$ and the ``Interpolation Algorithm'' in \cite{Huang95} lies in the definition for the case of paramodulation.
\mytodo{}


\section{Lifting of colored symbols}
As $\PI$ only fixes the propositional structure of the interpolant but still contains colored symbol, 
we define a procedure which replaces colored terms by lifting variables.


\begin{defi}[Lifting]
	Let $\varphi$ a formula or a term and $Z=\{\colterm{1}, \dotsc, \colterm{n}\}$ the maximal $\Phi$-colored terms in $\varphi$.

	Let furthermore $z_{\expa(\colterm{1})}, \ldots, z_{\expa(\colterm{n})}$ be fresh variables, referred to as \defiemph{$\Phi$-lifting variables} or \defiemph{lifting variables} if the coloring is clear from the context.
	The function $\expa$ replaces lifting variables occurring in colored terms by the term they lift in order to avoid lifting variables in the index of other lifting variables and is defined as follows:  
	\[\expa(t) \defeq \begin{cases}
		f(\expa(t_1),\dots, \expa(t_m)) & \text{if $t=f(t_1, \dots, t_m)$} \\
		t & \text{if $t$ is a non-lifting variable $x$} \\
		\expa(s) & \text{if $t$ is a lifting variable $z_s$}
	\end{cases}\]

	The lifting of $\varphi$, denoted by $\lft{\Phi}{z}{\varphi}$, is an abbreviation of % $\phi\abstractionOp{\colterm{1}/z_1}\dots\abstractionOp{\colterm{n}/z_n}$.
	$\lft{\Phi}{z}{\varphi, Z}$ which is defined as follows:
\[\lft{\Phi}{z}{\varphi, Z} \defeq \begin{cases} \varphi & Z = \emptyset \\ \lft{\Phi}{z}{\varphi\abstractionOp{\colterm{i}/z_{\colterm{i}}}, Z\setminus\{\colterm{i}\}} & \parbox[t]{0.4\linewidth}{$\colterm{i} \in Z$ such that $\colterm{i}$ is not subterm of another term in $Z$} \end{cases}\]
	To simplify the syntax, we sometimes write $\lifphinovar{\varphi}$ or $\lifboth{\varphi}$ if the lifting variables or the lifting variables and the color of the terms to lift respectively is clear from the context or not of the essence.
%	We denote $\varphi$ lifted of both $\Gamma$- and $\Delta$-terms by $\lifboth{\varphi}$ if the variables replacing the colored terms are clear from the context or are not crucial.
\end{defi}

We usually lift $\Delta$-terms by variables with the letter $x$ and $\Gamma$-terms with the letter $y$. If the lifting is not specific to a color, we use variables with the letter $z$.


Some elementary properties of liftings are described by the following lemmas:

 
\begin{lemma}[Commutativity of lifting and logical operators]
  \label{lemma:lift_commute}
  Let $A$ and $B$ be first-order formulas and $s$ and $t$ be terms. Then it holds that:
  \begin{enumerate}
    \item $\lift{\Phi}{\lnot A}{z} \spas\semiff{} \lnot \lift{\Phi}{A}{z}$
    \item $\lift{\Phi}{A \circ B}{z} \spas\semiff{} ( \lift{\Phi}{A}{z} \circ \lift{\Phi}{B}{z} )$ for  $\circ \in \{\land, \lor\}$
		\item $\lift{\Phi}{s = t}{z} \spas\semiff{} ( \lift{\Phi}{s}{z} = \lift{\Phi}{t}{z} )$
	\end{enumerate}
\end{lemma}

For the proof, we also require a means of commuting substitutions and liftings.
This however can not be achieved in a direct manner. The following examples illustrate
that in general for a term $t$, it is not the case that
$
\lft{\Phi}{z}{t\sigma} =
\lft{\Phi}{z}{t}\sigma 
$. However Lemma~\ref{lemma:lif} defines a substitution $\sigma'$ such that 
$
\lft{\Phi}{z}{t\sigma} =
\lft{\Phi}{z}{t}\sigma'
$.

\begin{subtheorem}{exa}
	\begin{exa}
		Let $t = f(x)$ be a $\Phi$-term and $\sigma = \{x \mapsto a\}$.
		Then $\lft{\Phi}{z}{t\sigma} = \lft{\Phi}{z}{f(x)\sigma} = \lft{\Phi}{z}{f(a)} = z_{f(a)}$.
		However $\lft{\Phi}{z}{t}\sigma = \lft{\Phi}{z}{f(x)}\sigma = z_{f(x)}\sigma = z_{f(x)}$.
	\end{exa}
	\begin{exa}
		Let $t=x$ be a variable and $\sigma = \{x\mapsto c\}$, where $c$ is a $\Phi$-term.
		Then $\lft{\Phi}{z}{t\sigma} = 
		\lft{\Phi}{z}{x\sigma} =
		\lft{\Phi}{z}{c} = z_c$.
		But 
		$\lft{\Phi}{z}{t}\sigma = 
		\lft{\Phi}{z}{x}\sigma = 
		x\sigma = 
		c$.
	\end{exa}
\end{subtheorem}


%\begin{lemma}[Commutativity of lifting and substitution]
\begin{restatable}[Commutativity of lifting and substitution]{lemma}{lemmaCommutLiftSubst}
	\label{lemma:lif}
	Let $C$ be a clause and $\sigma$ a substitution such that no lifting variable occurs in $C$ or $\sigma$.
	%Let $t_1,\ldots,t_n$ be all maximal $\Delta$-terms in this context, i.e.\ those that occur in $C$ or $C\sigma$,  and 
	%$x_1, \ldots, x_n$ the corresponding fresh variables to replace the $t_i$ (i.e.~none of the $x_i$ occur in $C$).
	Define $\sigma'$ with $\dom(\sigma') = \dom(\sigma) \cup \{ z_t \mid t\sigma \neq t \}$ such that for a variable $z$, 
	\[
		x \sigma' =
		\begin{cases} 
			z_{t\sigma} & \text{ if } x = z_t \text{ and } t\sigma \neq t \\
			\lifphi{x\sigma} & \text{ otherwise}
		\end{cases} 
	\]

	Then
	$\lifphi{C\sigma} =
	\lifphi{C}\sigma'$.
\end{restatable}
\begin{proof}
	As substitutions and liftings only affect the terms of a clause, it suffices to  show that 
	$\lifphi{t\sigma} = \lifphi{t}\sigma'$ for for a term $t$ in $C$.
	More precisely, only variables of $\dom(\sigma)$ and maximal $\Delta$-terms are affected. 
	We show that for terms $t$ of either kind that
	$ \lifphi{ t \sigma } = \lifphi{ t } \sigma'$ holds, which proves the lemma.

	Let $y$ be a variable in $\dom(\sigma)$, which occurs in $C$. Then $\lifphi{y}\sigma' = y\sigma' = \lifphi{y\sigma}$.

	Let $t$ be a maximal $\Phi$-term in $C$.
	Then $\lifphi{ t\sigma} = z_{t\sigma}$.
	We show that $z_{t\sigma} = \lifphi{t}\sigma'$.

	Suppose that $t\sigma = t$. Then $\lifphi{t}\sigma' = z_t\sigma' = z_t = z_{t\sigma}$.
	Note that $z_r$ must not occur in $t$ for some term $r$, as $z_r\sigma = z_r$, but potentially $z_r\sigma' \neq z_r$.

	Otherwise it is the case that $t\sigma \neq t$.
	Then $\lifphi{t}\sigma' = z_t\sigma'$, and by the definition of $\sigma'$, $z_t\sigma' = z_{t\sigma}$.
\end{proof}




\begin{comment}
\begin{lemma}
	Let $s$ and $t$ be terms such that no $x_i$ occurs in them, $\Phi$ a set of formulas and $M$ a model.
	Then $M\entails \lft{\Phi}{x}{s} = \lft{\Phi}{x}{t}$ implies that $M\entails s=t$.
	\label{lemma:lift_equality}
\end{lemma}
\begin{proof}
	Suppose no $\Delta$-term occurs in $s$ or $t$. Then $\lft{\Phi}{x}{s} = s$ 
	and $\lft{\Phi}{x}{t} = t$.

	Otherwise let $t_i$ be a maximal $\Delta$-term in $s$. Suppose it occurs at position $p$. In $\lft{\Phi}{x}{s}$, it is replaced by $x_i$.
	But as $M \entails \lft{\Phi}{x}{s} = \lft{\Phi}{x}{t}$, two situations can arise:
	\begin{compactenum}
	\item $x_i$ occurs at $p$ in $\lft{\Phi}{x}{t}$.
		As $x_i$ does not occur in $t$, it is placed there by the lifting.
		But $x_i$ is only employed in order to replace $t_i$, so at position $p$ in $t$, we have $t_i$.
	\item A term $r$ occurs at $p$ in $\lft{\Phi}{x}{t}$ which does not influence the evaluation of $\lft{\Phi}{x}{t}$ in $M$. This can be the case if $r$ is contained in a subterm of $u$ and in $M$, the function symbol of $u$ is interpreted such that it does not depend on the argument that contains $r$.
		
		But as the maximal $\Delta$-term $t_i$ occurs in $s$ at $p$ and $M \entails \lft{\Phi}{x}{s} = \lft{\Phi}{x}{t}$, there is a function symbol $u'$ in $\lft{\Phi}{x}{s}$ corresponding to $u$ which also does not depend on this argument.

		Hence even though $s$ and $t$ are not syntactically equal, $M\entails s=t$ in this case. \qedhere
	\end{compactenum}

\end{proof}
\end{comment}


\begin{exa}
	Let $M$ be a model and $c$ and $d$ be $\Phi$-colored constants such that $M\entails c=d$.  
	Then \todo[inline]{?????}
\end{exa}


\begin{lemma}
	\label{aga5tg5ba}
	Let $M$ be a model, $E$ a formula and $s$ and $t$ terms such that
	$M \entails \lifdelta{s} = \lifdelta{t}$.
	Let $h\occur{t}$ be a maximal $\Delta$-colored term containing $t$ at $p$ in $E\occurat{t}{p}$, if such a term exists. Then it holds that:
\begin{itemize}
\item If $h\occur{t}$ does not exists, then
	$M\entails \lifdelta{E\occurat{s}{p}} \semiff M \entails \lifdelta{E\occurat{s}{p}}$.
\item Otherwise
	$M\entails \lifdelta{E\occurat{s}{p}} \semiff M \entails \lifdelta{E\occurat{s}{p}}$
	or $M\entails \lifdelta{h\occur{s}} \neq \lifdelta{h\occur{t}}$ holds.
\end{itemize}
\end{lemma}
\begin{proof} 
	Suppose that the position $p$ in $E\occurat{s}{p}$ is not contained in a $\Delta$-colored term.
	Then $\lifdelta{E\occurat{t}{p}}$ and $\lifdelta{E\occurat{s}{p}}$ only differ at position $p$,
	where for the first, $\lifdelta{t}$ is at $p$, and for the latter, $\lifdelta{s}$ is at $p$.
	But in $M$, they are interpreted the same way, hence $M\entails\nolinebreak \lifdelta{E\occurat{s}{p}} \spas\semiff M \entails \lifdelta{E\occurat{t}{p}}$.

	Otherwise the position $p$ in $E\occurat{t}{p}$ is contained in the maximal $\Delta$-colored term $h\occur{t}$.
	Suppose that $M\entails \lifdelta{h\occur{s}}  = \lifdelta{h\occur{t}}$ as otherwise we would be done.
	But then $M \entails\nolinebreak \lifdelta{E\occurat{s}{p}} \semiff{} M\entails \lifdelta{E\occurat{t}{p}}$.
\end{proof} 



\section{Symmetry of the extracted interpolants}


The interpolant extraction procedure $\PI$ exhibits a convenient property which is termed \emph{symmetry} in \cite[Definition 5]{interpolantStrenth} and will be used to show that results concerning $\Gamma$ can easily be generalised to results for $\Delta$.
The symmetry-property of $\PI$ can be stated formally as follows:

\newcommand{\primex}[1]{\ensuremath{\bhat{#1}}}
\begin{lemma}
	\label{lemma:symmetry}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$ and
	$\primex\pi$ be $\pi$ with $\primex\Gamma = \Delta$ and $\primex\Delta = \Gamma$.
	Then $\PI(\pi) \semiff \lnot \PI(\primex\pi)$.
\end{lemma}
\begin{proof}
	We prove this lemma by induction on $\pi$.
	Let $\primex\varphi$ denote the clause/formula/literal/term in $\primex\pi$ corresponding to the clause/formula/literal/term $\varphi$ in $\pi$.

	\newcommand{\p}[1]{\primex{#1}}
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, then $C' \in \Delta'$ and $\PI(C) = \bot \semiff \lnot \top = \lnot \PI(C')$. 
			The case for $C\in \Delta$ is analogous.

		\item[Resolution.]
			If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then by induction hypothesis, we get that
			$\PI(C_i) = \lnot \PI(C'_i)$ for $i\in \{1,2\}$.

			We distinguish the following cases:
			\begin{enumerate}
					\item $l$ is $\Gamma$-colored. Then $\primex l$ is $\Delta$-colored.
						\begin{align*}
							\PI(C) &= \PI(C_1) \lor \PI(C_2)\\
														 &\semiff \lnot ( \lnot \PI(C_1) \land \lnot \PI(C_2) )\\
														 &= \lnot ( \PI(\primex C_1) \land \PI(\primex C_2) ) \\
														 &= \lnot \PI(\primex C)  
						\end{align*}
					\item $l$ is $\Delta$-colored. This case can be argued analogously.

					\item $l$ is grey. Then $\primex l$ is grey. 
						Note that $l\sigma \syneq l'\sigma$ \markB.
						\nopagebreak 
			\begin{align*}
				\PI(C) 
				&=  [(l \land \PI(C_2)) \lor (\lnot l' \land \PI(C_1))] \sigma\\
				&=  (l\sigma \land \PI(C_2)\sigma) \lor (\lnot l' \sigma \land \PI(C_1)\sigma)\\
				&\stackrel{\markB}\semiff\,(\lnot l\sigma \lor \PI(C_2)\sigma) \land (l'\sigma \lor \PI(C_1)\sigma)\\
				&\semiff \lnot [(l\sigma \land \lnot \PI(C_2)\sigma) \lor (\lnot l' \sigma \land \lnot \PI(C_1)\sigma)]\\
				&= \lnot [(\p l\sigma \land \lnot \PI(C_2)\sigma ) \lor (\lnot \p{l'}\sigma \land \lnot \PI(C_1)\sigma)\\
				&= \lnot [(\p l \land\lnot \PI(C_2) ) \lor (\lnot \p{l'}\land \lnot \PI(C_1) )]\sigma\\
				&= \lnot  [(\p l \land \PI(\p C_2) ) \lor (\lnot \p{l'} \land \PI(\p C_1))]\sigma \\
				&= \lnot \PI(\p C)
			\end{align*}

			\end{enumerate}

		\item[Factorisation.]
			Suppose the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$. Then $\PI(C) = \PI(C_1)\sigma$ and the induction hypothesis gives the result.

		\item[Paramodulation.]
			Suppose the clause $C$ is the result of a paramodulation of $C_1: s=t \lor C$ and $C_2: D\occur{r}$ using a unifier $\sigma$ such that $r\sigma = s\sigma$. 
			We distinguish the following cases:

			\begin{enumerate}
				\item $r$ occurs in a maximal $\Delta$-term $h\occur{r}$ in $D\occur{r}$ and $h\occur{r}$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$.
					Then $\primex r$ occurs in a maximal $\Gamma$-term $\primex h\occur{r}$ in $\primex D\occur{r}$ and $\primex h\occur{r}$ occurs more than once in $\primex D\occur{r} \lor \PI(\primex D\occur{r})$.
					\begin{align*}
						\PI(C) &= [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \lor (s=t \land h\occur{s} \neq h\occur{t})\sigma\\
						 &= [ ( s=t \land \lnot \PI(\primex C_2) ) \lor (s\neq t \land \lnot \PI(\primex C_1)) ]\sigma \lor (s=t \land h\occur{s} \neq h\occur{t})\sigma\\
						 &\semiff \lnot [ ( s\neq t \lor \PI(\primex C_2) ) \land (s= t \lor \PI(\primex C_1)) ]\sigma \land \lnot (s\neq t \lor h\occur{s} = h\occur{t})\sigma\\
						 &\semiff \lnot [ ( s = t \land \PI(\primex C_2) ) \lor (s\neq t \land \PI(\primex C_1)) ]\sigma \land \lnot (s\neq t \lor h\occur{s} = h\occur{t})\sigma\\
						 &= \lnot \PI(\primex C)
					\end{align*}

				\item $r$ occurs in a maximal $\Gamma$-term $h(r)$ in $D\occur{r}$ and $h(r)$ occurs more than once in $D\occur{r} \lor \PI(D\occur{r})$.
					This case can be argued analogously.
				\item Otherwise:
					\begin{align*}
						\PI(C) &= [ ( s=t \land \PI(C_2) ) \lor (s\neq t \land \PI(C_1)) ]\sigma \\
									 &= [ ( s=t \land \lnot \PI(\primex C_2) ) \lor (s\neq t \land \lnot \PI(\primex C_1)) ]\sigma \\
									 &\semiff \lnot [ ( s\neq t \lor \PI(\primex C_2) ) \land (s=t \lor \PI(\primex C_1)) ]\sigma \\
									 &\semiff \lnot [ ( s=t \land \PI(\primex C_2) ) \lor (s\neq t \land \PI(\primex C_1)) ]\sigma \\
									 &= \lnot \PI(\primex C)
					\qedhere
					\end{align*}
			\end{enumerate}


	\end{itemize}

\end{proof}

\begin{cor}
	\label{cor:delta_entails_lifted_interpolant}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$. 
	Then $\Delta \entails \lft{\Gamma}{x}{ \lnot \PI(C) \lor C }$ for $C$ in $\pi$.
\end{cor}
\begin{proof}
	Build $\primex \pi$ from $\pi$ using $\primex \Gamma = \Delta$ and $\primex \Delta = \Gamma$ as initial clause sets.
	By Lemma \ref{lemma:gamma_entails_lifted_interpolant}, $\primex \Gamma \entails \lft{\primex\Delta}{x}{ \PI(\primex C) \lor \primex C }$ for $\primex C$ in $\primex \pi$. 
	By Lemma \ref{lemma:symmetry},
$\primex \Gamma \entails \lft{\primex\Delta}{x}{ \lnot \PI(C) \lor \primex C }$ for the clause $C$ in $\pi$ corresponding to $\primex C$ in $\primex \pi$. 
	This however is nothing else than 
$\Delta \entails\nolinebreak \lft{\Gamma}{x}{ \lnot \PI(C) \lor C }$.
\end{proof}

\section{Main lemma}

By lifting the propositional interpolant, we are able to already obtain a formula partially fulfilling the requirements for interpolants:


%Now we show the ``main'' lemma of Huang's proof without using a propositional deduction $P_P$.
%The remaining part of his proof after this lemma does not use the restriction to propositional deductions and hence goes through.

\begin{lemma}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	Then for a clause $C$ in $\pi$,
	$ \Gamma \entails \lifdelta{\PI(C) \lor\nolinebreak C} $.
	\label{lemma:gamma_entails_lifted_interpolant}
\end{lemma}

Before we proceed with the proof of this lemma, we give a corollary which demonstrates that $\PI$ 
extracts propositional interpolants in the sense that besides possibly containing colored terms, they are proper interpolants:

\begin{cor}
	\label{cor:propositional_interpolant}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	Then
	\begin{enumerate}
		\item$\Gamma\entails \PI(\pi)$
		\item$\Delta\entails \lnot \PI(\pi)$
		\item $\PS(\PI(\pi)) \subseteq \PS(\Gamma) \cap \PS(\Delta)$.
		\end{enumerate}
\end{cor}
\begin{proof}
	By the definition of $\PI$, 
	$\PI(\pi)$ denotes $\PI(\square)$, where $\square$ is the empty clause derived in $\PI$.
	By Lemma~\ref{lemma:gamma_entails_lifted_interpolant}, we get that 
	$ \Gamma \entails \lifdelta{\PI(\pi)}$.
	As the lifting replaces terms by variables which are then implicitly universally quantified, $\PI(\pi)$ is an instance of $\lifdelta{\PI(\pi)}$.
	Therefore $\Gamma \entails \PI(\pi)$.

	By Corollary~\ref{cor:delta_entails_lifted_interpolant}, $\Delta \entails \lnot \lifgamma{\PI(\pi)}$,
	thus by a similar argument as above, $\Delta \entails \lnot \PI(\pi)$.


	By the construction of $\PI$, only grey predicates are added.
\end{proof}

\begin{proof}[Proof of Lemma~\ref{lemma:gamma_entails_lifted_interpolant}]
	We proceed by induction on the resolution refutation of the strengthening $\Gamma \entails \lifdelta{\PI(C) \lor\nolinebreak C_\Gamma}$,
	where $D_\Phi$ denotes the clause created from $D$ by removing all literals which are not contained $\Lang(\Phi)$.
	%i.e.\ we only consider literals of $C$ which are contained in $\Lang(\Gamma)$.

	\begin{description}
		\item{Base case.}
			Either $C \in \Gamma$, then $\lifdelta{C} = C$ and $\Gamma \entails C$.
			Otherwise $C \in \Delta$ and $\PI(C) = \top$.

		\item{Resolution.}
			Suppose the last rule application is an instance of resolution. Then it is of the following form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor l}
				\AxiomCm{C_2: E \lor \lnot l'}
				\RightLabelm{\quad l\sigma = l'\sigma}
				\BinaryInfCm{C: (D\lor E)\sigma}
			\end{prooftree}

			By the induction hypothesis, we can assume that
			$\Gamma \entails \lifdelta{\PI(C_1) \lor (D\lor l)_\Gamma}$ and $\Gamma \entails \lifdelta{\PI(C_2) \lor (E\lor \lnot l')_\Gamma}$,
			which by Lemma \ref{lemma:lift_commute} implies 
			\markA{} $\Gamma \entails \lifdelta{\PI(C_1)} \spas\lor\allowbreak \lifdelta{D_\Gamma} \spas\lor\allowbreak \lifdelta{l_\Gamma}$ and \markB{} $\Gamma \entails \lifdelta{\PI(C_2)} \spas\lor \lifdelta{E_\Gamma} \spas\lor \lnot \lifdelta{l'_\Gamma}$.
			Let $\sigma'$ be defined as in Lemma \ref{lemma:lif}.

			We proceed by a case distinction on the color of $l$:
			\begin{enumerate}
				\item $l$ is $\Gamma$-colored. Then $\PI(C) = [\PI(C_1) \lor \PI(C_2)]\sigma$.
					
					Since $\sigma = \mgu(l, l')$, $l\sigma \syneq l'\sigma$ and therefore $\lifdelta{l\sigma} = \lifdelta{l'\sigma}$.
					As by Lemma~\ref{lemma:lif} $\lifdelta{l\sigma} = \lifdelta{l}\sigma'$ and $\lifdelta{l'\sigma} = \lifdelta{l'}\sigma'$,
					we get $\lifdelta{l}\sigma' = \lifdelta{l'}\sigma'$.\label{aou5jklah}
					Hence by applying $\sigma'$ to \markA{} and \markB{} (note that $l_\Gamma = l$ and $l'_\Gamma = l'$ as they are $\Gamma$-colored), we can perform a resolution step on $\lifdelta{l}\sigma'$ and obtain
					$\Gamma \entails \lifdelta{\PI(C_1)}\sigma' \spas\lor \lifdelta{D_\Gamma} \sigma' \spas\lor \lifdelta{\PI(C_2)}\sigma' \spas\lor \lifdelta{E_\Gamma} \sigma'$.
					Now we apply Lemma~\ref{lemma:lif} and Lemma~\ref{lemma:lift_commute} in the other direction 
					and get that 
					$\Gamma \entails \lifdelta{\PI(C_1)\sigma \lor \PI(C_2)\sigma \lor\allowbreak (D \lor E)_\Gamma \sigma}$.
					This however is nothing else than 
					$\Gamma \entails \lifdelta{\PI(C) \lor C_\Gamma}$.

				\item $l$ is $\Delta$-colored. Then $\PI(C) = [\PI(C_1) \land \PI(C_2)]\sigma$.

					As $l$ and $l'$ are $\Delta$-colored, we can simplify \markA{} and \markB{} as follows and apply $\sigma'$:
					$\Gamma \entails \lifdelta{\PI(C_1)}\sigma' \spas\lor \lifdelta{D_\Gamma}\sigma' $ and $\Gamma \entails \lifdelta{\PI(C_2)}\sigma' \spas\lor \lifdelta{E_\Gamma}\sigma'$.
					These together imply that 
					$\Gamma \entails \Big(\lifdelta{\PI(C_1)}\sigma' \spas\land \lifdelta{\PI(C_2)}\sigma'\Big) \spas\lor \lifdelta{D_\Gamma}\sigma' \spas\lor \lifdelta{E_\Gamma}\sigma'$.
					By Lemma~\ref{lemma:lift_commute} and Lemma~\ref{lemma:lif}, this is equivalent to 
					$\Gamma \entails \lifdelta{(\PI(C_1) \land \PI(C_2))\sigma \spas\lor (D \lor E)_\Gamma\sigma}$, which is nothing else than
					$\Gamma \entails \lifdelta{\PI(C) \lor C_\Gamma}$.

				\item $l$ is grey. Then $\PI(C) = [(l \land \PI(C_2) ) \lor (\lnot l' \land \PI(C_1))]\sigma$.

					We show that $\Gamma \entails\allowbreak \lifdelta{ \Big((l \land \PI(C_2) ) \lor\allowbreak (\lnot l' \land \PI(C_2)) \lor D_\Gamma \lor E_\Gamma\Big)\sigma}$, for which by Lemma~\ref{lemma:lift_commute} and Lemma~\ref{lemma:lif} it suffices to show that 
					$\Gamma \entails\allowbreak \big(\lifdelta{l}\sigma' \land \lifdelta{\PI(C_2)}\sigma'\big)\spas\lor\allowbreak \big(\lnot \lifdelta{l'}\sigma' \land \lifdelta{\PI(C_2)}\sigma'\big)\spas\lor\allowbreak \lifdelta{D_\Gamma}\sigma' \lor \lifdelta{E_\Gamma}\sigma'$.

					Suppose for a model $M$ of $\Gamma$ that  $M \notentails \lifdelta{D_\Gamma}\sigma'$ and $M\notentails \lifdelta{E_\Gamma}\sigma'$ as otherwise we are done.
					But then by \markA{} and \markB{}, we get that 
					$M \entails \lifdelta{\PI(C_1)}\sigma' \lor \lifdelta{l}\sigma'$ and
					$M \entails\nolinebreak \lifdelta{\PI(C_2)}\sigma' \lor \lnot\lifdelta{l'}\sigma'$.
					As observed in case \ref{aou5jklah}, $\lifdelta{l}\sigma' = \lifdelta{l'}\sigma'$.
					We obtain the result by a case distinction on the truth value of $\lifdelta{l}\sigma'$.

			\end{enumerate}

		\item{Factorisation.}
			Suppose the last rule application is an instance of factorisation. Then it is of the following form:
			\begin{prooftree}
				\AxiomCm{C_1: l \lor l' \lor D}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\UnaryInfCm{C: (l \lor D)\sigma}
			\end{prooftree}
			% Then $\PI(C) = \PI(C_1)\sigma$.

			The induction hypothesis gives that
			$\Gamma \entails \lifdelta{\PI(C_1) \lor l \lor l' \lor D}$.
			Let $\sigma'$ be defined as in Lemma \ref{lemma:lif}.
			Then $\Gamma \entails \lifdelta{\PI(C_1) \lor l \lor l' \lor D}\sigma'$ and by Lemma \ref{lemma:lif} and Lemma~\ref{lemma:lift_commute},
			$\Gamma \entails \lifdelta{\PI(C_1)\sigma} \spas\lor \lifdelta{l\sigma} \spas\lor \lifdelta{l'\sigma} \spas\lor \lifdelta{D\sigma}$.

			As $\sigma = \mgu(l, l')$, $l\sigma \syneq l'\sigma$ and hence $\lifdelta{l\sigma} = \lifdelta{l'\sigma}$.
			But then we can apply a factorisation step and get that
			$\Gamma \entails \lifdelta{\PI(C_1)\sigma} \spas\lor \lifdelta{l\sigma} \spas\lor \lifdelta{D\sigma}$
			which by Lemma \ref{lemma:lif} and Lemma \ref{lemma:lift_commute} is equivalent to 
			$\Gamma \entails\nolinebreak \lifdelta{\PI(C_1)\sigma \lor l\sigma \lor D\sigma}$.
			This in turn is nothing else than $\Gamma \entails \lifdelta{\PI(C) \lor C}$.

		\item{Paramodulation.}
			Suppose the last rule application is an instance of paramodulation. Then it is of the following form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor s=t}
				\AxiomCm{C_2: E\occurat{r}{p}}
				\RightLabel{$\quad \sigma = \mgu(s, r)$}
				\BinaryInfCm{C: (D \lor E\occurat{t}{p})\sigma}
			\end{prooftree}
			By the induction hypothesis, we get that 
			$\Gamma \entails \lifdelta{\PI(C_1) \lor (D\lor s=t)_\Gamma}$ and 
			$\Gamma \entails \lifdelta{\PI(C_2) \lor (E\occurat{r}{p})_\Gamma}$.
			This is by Lemma~\ref{lemma:lift_commute} equivalent to
			\markA{} $\Gamma \entails \lifdelta{\PI(C_1)} \spas\lor\allowbreak \lifdelta{D_\Gamma} \spas\lor \lifdelta{s} = \lifdelta{t}$
			and \markB{} 
			$\Gamma \entails \lifdelta{\PI(C_2)} \spas\lor \lifdelta{(E\occurat{r}{p})_\Gamma}$ respectively.


				We distinguish two cases:\nopagebreak
				\begin{enumerate}
					\item Suppose $s$ does not occur in a maximal $\Delta$-term $h\occur{s}$ in $E\occurat{s}{p}$, which occurs more than once in $\PI(C_2) \lor (E\occurat{r}{p})_\Gamma$.
						\label{klehjy}

						Let $M$ be a model of $\Gamma$.
						First, assume that $M \entails \lifdelta{s} \neq \lifdelta{t}$.
						Then by \markA{} we have that $M \entails \lifdelta{\PI(C_1)} \lor \lifdelta{D_\Gamma}$.
						By applying $\sigma'$ and Lemma~\ref{lemma:lif}, we hence can conclude from 
						$M \entails \lifdelta{s\sigma} \neq \lifdelta{t\sigma}$ that 
						$M \entails \lifdelta{\PI(C_1)\sigma} \lor \lifdelta{D_\Gamma\sigma}$.


						Second, assume to the contrary that $M \entails \lifdelta{s} = \lifdelta{t}$.
						We distinguish cases:
						\begin{itemize}
							\item
								Suppose that $s$ does not occur in a maximal $\Delta$-term in $(E\occat{s}{p})_\Gamma$.
								Then by Lemma~\ref{aga5tg5ba} $M\entails \lifdelta{(E\occat{t}{p})_\Gamma} \semiff M \entails \lifdelta{(E\occat{s}{t})_\Gamma}$.

								Due to $\sigma=\mgu(s, r)$, $s\sigma \syneq r\sigma$.
								Suppose they are both not $\Delta$-colored.
								Then the lifting does not affect them and 
								$\lifdelta{(E\occurat{s}{p})_\Gamma\sigma} \syneq \lifdelta{(E\occurat{r}{p})_\Gamma\sigma}$.
								Otherwise the lifting will replace them with the same variable and we as well get that
								$\lifdelta{(E\occurat{s}{p})_\Gamma\sigma} \syneq \lifdelta{(E\occurat{r}{p})_\Gamma\sigma}$.
								Hence $M\entails \lifdelta{(E\occurat{t}{p})_\Gamma\sigma} \semiff\allowbreak M\entails 
								\lifdelta{(E\occurat{r}{p})_\Gamma\sigma}$

							\item
								Otherwise $r$ occurs in a maximal $\Delta$-term $h\occ{r}$ in $(E\occat{r}{p})_\Gamma$, but $h(r)$ does not occur elsewhere in $\PI(C_2) \lor (E\occurat{r}{p})_\Gamma$.
								Then the lifting variable $x_r$ occurs only once in \markB{}.
								Hence $\Gamma$ does not pose any restriction on $x_r$ and we can substitute it in  by $x_t$. 
								So in $M$ we have that $M\entails \lifdelta{(E\occurat{t}{p})_\Gamma} \semiff\allowbreak M\entails \lifdelta{(E\occurat{r}{p})_\Gamma}$.

						\end{itemize}

						Hence in any of the cases, by \markB{} and by applying $\sigma'$ and Lemma~\ref{lemma:lif}
						it follows from $M\entails \lifdelta{s\sigma} = \lifdelta{t\sigma}$ 
						that $M \entails \lifdelta{\PI(C_2)\sigma} \lor \lifdelta{(E\occurat{t}{p})_\Gamma\sigma}$. 
						\medskip

						In conclusion, we can derive that 
						$\Gamma \entails
						(\lifdelta{s\sigma} \neq \lifdelta{t\sigma} \spas\land\allowbreak (\lifdelta{\PI(C_1)\sigma} \lor \lifdelta{D_\Gamma}\sigma))
						\spam{\lor}\allowbreak
						(\lifdelta{s\sigma} = \lifdelta{t\sigma} \spas\land (\lifdelta{\PI(C_2)\sigma} \lor \lifdelta{(E\occat{t}{p})_\Gamma\sigma}))$.
						This however implies that
						$\Gamma \entails
						\Big(\lifdelta{s\sigma} \neq \lifdelta{t\sigma} \spas\land (\lifdelta{\PI(C_1)\sigma} )\Big)
						\spas{\lor}\allowbreak
						\Big(\lifdelta{s\sigma} =\nolinebreak \lifdelta{t\sigma} \spas\land (\lifdelta{\PI(C_2)\sigma}) \Big)
						\spas\lor\allowbreak \Big(\lifdelta{D_\Gamma\sigma} \lor \lifdelta{(E\occat{t}{p})_\Gamma\sigma}\Big)$, 
					which by Lemma~\ref{lemma:lift_commute} is nothing else than
						$\Gamma \entails \lifdelta{\PI(C) \lor C}$.

					\item Otherwise $s$ occurs in a maximal $\Delta$-term $h\occurat{s}{q}$ in $E\occurat{s}{p}$, which occurs more than once in $E\occat{s}{p}$.

						Then a similar line of argument as in case~\ref{klehjy} can be employed, with the difference that the application of Lemma~\ref{aga5tg5ba} in the case of $M\entails \lifdelta{s} = \lifdelta{t}$ yields the additional possibility that 
			$M\entails \lifdelta{h\occur{s}} \neq \lifdelta{h\occur{t}}$.
 Hence we arrive at:

				$\Gamma \entails
				\Big(\lifdelta{s}\sigma'=\lifdelta{t}\sigma' \land \lifdelta{\PI(C_2)}\sigma'\Big) \spas\lor\allowbreak
				\Big(\lifdelta{s}\sigma'\neq\lifdelta{t}\sigma' \land \lifdelta{\PI(C_1)}\sigma'\Big) \spas\lor\allowbreak
				\Big(\lifdelta{s}\sigma'=\lifdelta{t}\sigma' \land (\lifdelta{h\occur{s}}\sigma') \neq (\lifdelta{h\occur{t}}\sigma' )\Big) \spas\lor\allowbreak
				\Big(\lifdelta{D_\Gamma}\sigma' \lor \lifdelta{(E\occurat{t}{p})_\Gamma}\sigma'\Big)$

				This however is by Lemma~\ref{lemma:lif} and Lemma~\ref{lemma:lift_commute} equivalent to $\Gamma \entails \lifdelta{\PI(C) \lor\nolinebreak C}$.
				\qedhere
		\end{enumerate}
\end{description}
\end{proof}



\section{Quantifying over lifting variables}

As we have already seen in Corollary~\ref{cor:propositional_interpolant} that $\PI(\pi)$ forms a propositional interpolant, it remains to lift all colored terms and quantify over the resulting lifting variables in a viable order.


\begin{lemma}
	%Let $\{z_1,\ldots, z_n\}$ be the maximal colored terms of a clause $C$.
	%Then 
	%$ Q_1 z_1 \ldots Q_n z_n \lft{\Gamma}{y}{ \lft{\Delta}{x}{ C}  }
	%\;\liff\;
	%Q_1 z_1 \ldots Q_n z_n \lft{\Delta}{x'}{ \lft{\Gamma}{y'}{ C}  }$ for $Q_i \in \{\forall, \exists\}$ for $1\varleq i\varleq n$.

	For a formula or term $\varphi$,
	$ \lft{\Gamma}{y}{ \lft{\Delta}{x}{ \varphi}  } =
	 \lft{\Delta}{x}{ \lft{\Gamma}{y}{ \varphi }  }$.
	%\label{lemma:naming_of_colored_variables}
	\label{lemma:lifting_order_not_relevant}

\end{lemma}
\begin{proof}
	Let $\varphi$ be a mixed-colored term as otherwise we are done.
	Suppose without loss of generality that it is a $\Gamma$-term which contains a maximal $\Delta$-term $t$ as position $p$.
	Then $\lft{\Delta}{x}{ \lft{\Gamma}{y}{ \varphi }  }
	= \lft{\Delta}{x}{ y_\varphi }
	= y_\varphi $.

	On the other hand
	$\lft{\Gamma}{y}{ \lft{\Delta}{x}{ \varphi}  } = \lft{\Gamma}{y}{ \psi }$ such that $\psi$ is equal to $\varphi$ besides having $x_t$ at position $p$.
	But $\lft{\Gamma}{y}{ \psi } = y_{\expa(\psi)} = y_\varphi$.
	\begin{comment}

		Suppose a term $t$ in $C$ is affected by a lifting.
		We only need to consider maximal colored terms as grey terms are not affected by the liftings.
		Without loss of generality let $t$ be a maximal $\Delta$-colored term.

		Let $\Phi$ be the positions of maximal occurrences of $t$.
		Then in the left hand side, exactly all terms at positions $\Phi$ are replaced by $x_i$ for some $i$.

		In the right hand side, all terms at positions $\Phi$ are replaced by $\lft{\Gamma}{y'}{t}$ first. 
		However after this step,
		all these terms are equal to $\lft{\Gamma}{y'}{t}$, and as all distinct maximal $\Gamma$-terms are replaced by distinct variables, no other maximal colored term is equal to $\lft{\Gamma}{y'}{t}$.
		Hence exactly the terms at positions $\Phi$ are replaced by the same variable $x'_j$ for some $j$.
	\end{comment}
\end{proof}


\begin{thm}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$ and
	$z_1, \dots, z_n$ be the variables which replace the colored terms in $\lifgamma{\lifdelta{\PI(\pi)}}$ ordered by their length.
	Then
	$Q_1 z_1 \ldots Q_n z_n\,\lifgamma{\lifdelta{\PI(\pi)}}$, where $Q_i$ is $\forall$ $(\exists)$ if $z_i$ replaces a $\Delta$ $(\Gamma)$-term, is an interpolant.
\end{thm}
\begin{proof}
	By Lemma \ref{lemma:gamma_entails_lifted_interpolant}, $\Gamma \entails \forall x_1 \ldots \forall x_m\,\lifdelta{\PI(\pi)}$ where $m$ is the number of maximal $\Delta$-colored terms in $\PI(\pi)$.

	A term in $\lifdelta{\PI(\pi)}$ is either $x_i$, $1 \varleq i \varleq m$, a grey term or a $\Gamma$-terms.
	Let $t$ be a maximal $\Gamma$-term in $\lifdelta{\PI(\pi)}$ and $x_{j_1}, \dots, x_{j_k}$ the variables replacing $\Delta$-terms in~$t$.
	Note that the $\Delta$-terms, which are replaced by $x_{j_1}, \ldots, x_{i_{j_k}}$ respectively, are each of strictly smaller size than $t$ as they are strict subterms of $t$.

	%Then it is of the form $f(x_{i_1}, \ldots, x_{i_{n_x}}, u_1, \ldots, u_{n_u}, v_1, \ldots, v_{n_v})$, where $f$ is $\Gamma$-colored, the $u_j$, $1\varleq j \varleq n_u$ are grey terms and the $v_j$, $1\varleq j\varleq n_v$ are $\Gamma$-terms.

	In $\lifgamma{\lifdelta{\PI(\pi)}}$, $t$ is replaced by some $z_j$, which is existentially quantified.
	Hence $t$ is a witness for $z_j$ as due to the quantifier ordering,
	the existential quantification of $z_j$ is in the scope of the quantifiers of $x_{j_1}, \ldots, x_{j_k}$ respectively.
	Therefore $\Gamma \entails Q_1 z_1 \ldots Q_n z_n\,\lifgamma{\lifdelta{\PI(\pi)}}$.

	By Corollary \ref{cor:delta_entails_lifted_interpolant} $\Delta \entails \forall y_1 \dots \forall y_k\,\lnot \lift{\Gamma}{\PI(\pi)}{y}$, where $k$ is the number of $\Gamma$-colored terms in $\PI(\pi)$.
	By a similar line of argumentation as above, we can replace the maximal $\Delta$-terms by existentially quantified variables and arrive at
	$\Delta \entails\nolinebreak{} \overline Q_1 z_1 \dots \overline Q_n z_n\,\lnot \lft{\Delta}{x}{\lft{\Gamma}{y}{\PI(\pi)}}$ where $\overline Q_i = \exists$ ($\forall$) if $Q_i = \forall$ ($\exists$).
	Therefore also
	$\Delta \entails\nolinebreak{} \lnot Q_1 z_1 \dots Q_n z_n\,\lft{\Delta}{x}{\lft{\Gamma}{y}{\PI(\pi)}}$.
	By Lemma \ref{lemma:lifting_order_not_relevant},
	$\Delta \entails\nolinebreak{} \lnot Q_1 z_1 \dots Q_n z_n\,\lft{\Gamma}{y}{\lft{\Delta}{x}{\PI(\pi)}}$.

	As it is now easy to see that $Q_1 z_1 \dots Q_n z_n\,\lft{\Gamma}{y}{\lft{\Delta}{x}{\PI(\pi)}}$ contains no colored symbol, it is an interpolant.
\end{proof}





