\documentclass[,%fontsize=11pt,%
	paper=a4,% 
	%landscape,
	%DIV12, % mehr text pro seite als defaultyyp
	DIV14, 
	%DIV=calc,%
	%twoside=false,%
	liststotoc,
	bibtotoc,
	draft=false,% final|draft % draft ist platzsparender (kein code, bilder..)
	%titlepage,
	numbers=noendperiod
]{scrartcl}

\usepackage{lscape}
\usepackage{stackengine}


\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}

\usepackage{enumerate}
\usepackage{paralist}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,backgrounds,graphs,%
	matrix,patterns,arrows,decorations.pathmorphing,decorations.pathreplacing,%
	positioning,fit,calc,decorations.text,shadows%
}


\input{../latex_header.tex}

% subsections also in toc
\setcounter{tocdepth}{2}

%\declaretheorem[title=Theorem,qed=$\triangle$,parent=chapter]{thm}
\newcommand{\thmqed}{$\square$} % for thms without proof
\newcommand{\propqed}{$\square$} % for props without proof
\declaretheorem[title=Theorem]{thm}
\declaretheorem[title=Proposition,sibling=thm]{prop}
%\declaretheorem[title=Lemma,parent=chapter]{lemma}
\declaretheorem[sibling=thm]{lemma}
\declaretheorem[title=Corollary,sibling=thm]{corr}
\declaretheorem[sibling=thm,title=Definition,style=definition,qed=$\triangle$]{defi}
%\declaretheorem[title=Definition,qed=$\triangle$,parent=chapter]{defi}
\declaretheorem[title=Example,style=definition,qed=$\triangle$,sibling=thm]{exa}

\declaretheorem[sibling=thm,title=Conjecture]{conj}
\declaretheorem[title=Remark,style=remark,numbered=no,qed=$\triangle$]{remark}


%\def\proofSkipAmount{ \vskip -0.5em}



%\usepackage{bussproof}

%\usepackage{vaucanson-g}
\usepackage{amssymb}
\usepackage{latexsym}

% for color-highlighted code
%\usepackage{color} % for grey comments
%\usepackage{alltt}

%\usepackage[doublespacing]{setspace}
\usepackage[onehalfspacing]{setspace}
%\usepackage[singlespacing]{setspace}
\usepackage{tabularx}
\usepackage{hyperref}
\usepackage{comment}
\usepackage{color}
\usepackage[final]{listings} % sourcecode in document
\usepackage{url}      % for urls
\usepackage{multicol}
\usepackage{float}
\usepackage{caption}
\usepackage{subfigure}
\usepackage{amsmath}
\usepackage{amssymb}

\usepackage{graphicx}

\usepackage[authoryear]{natbib} % \cite ; square|round etc.
%\usepackage[numbers,square]{natbib}
%\usepackage[square, authoryear]{natbib}
%\usepackage[language=english]{biblatex}

%\bibliographystyle{plain}
\bibliographystyle{alpha}
%\bibliographystyle{alphadin}
%\bibliographystyle{dinat}
%\bibliographystyle{chicago}
%\bibliographystyle{plainnat}

\bibdata{bib.bib}

\renewcommand*{\partformat}{\partname\ \thepart\ -}
\let\partheadmidvskip\

\newcommand{\comp}{\ensuremath{\text{comp}}}
% smaller url style
\makeatletter
\def\url@leostyle{%
\@ifundefined{selectfont}{\def\UrlFont{\sf}}{\def\UrlFont{\small\ttfamily}}}
\makeatother
\urlstyle{leo}

\newcommand{\myfig}[5] {
	\begin{figure}[tbph]
		\centering
		\includegraphics[#3]{#1}
		\caption[#4]{#5}
		\label{fig:#2}
	\end{figure}
}

\setlength{\parindent}{0em}
%\usepackage{thmtools} % actually already in latex_header.tex ...

\usepackage{amsthm}


\usepackage{tikz-qtree}

%\newcommand{\sig}[1]{{#1}_\Sigma}
%\newcommand{\p}[1]{{#1}_\Pi}
\newcommand{\sig}[1]{\stackrel{\Sigma}{#1}}
\newcommand{\p}[1]{\stackrel{\Pi}{#1}}

\newcommand{\e}[1]{\vskip .7em   \subsection*{#1}}

\def\proofSkipAmount{ \vskip -0.3em}

\begin{document}

\newcommand{\lif}[1]{\lift{\Delta}{#1}{x}}


	\newcommand{\lifboth}[1]{\lft{\Gamma\cup\Delta}{z}{#1}}

\section{Overbinding in one step}


\begin{conj}
	Suppose every variable occurs only once in $\Gamma \cup \Delta$.
	Then the order of the quantifiers for $\PI(\square)^*$ does not matter.
\end{conj}
\begin{prop}

	Let $A(x_1, \ldots, x_n)$ be an atom in a relative interpolant.
	A variable occurs in one of the $x_i$ if and only if there are atoms $A(y_1, \ldots, y_n)$ and $A(z_1, \ldots, z_n)$ in $\Gamma$ and $\Delta$ respectively, where $x_i$ can be unified with $z_i$ and $y_i$ such that there is still a variable at that location.

	This means that either the term structure above the variable is the same in the original clauses or there are some variables. Intended meaning: the original clauses prove at least the $x_i$, i.e.~are at least as or more general.
	\medskip

	Special case for outermost variables:

	Let $A(x_1, \ldots, x_n)$ be an atom in a relative interpolant.
	An $x_i$ is a variable if and only if there are atoms $A(y_1, \ldots, y_n)$ and $A(z_1, \ldots, z_n)$ in $\Gamma$ and $\Delta$ respectively, where $y_i$ and $z_i$ are variables.
\end{prop}

need more narrow version: clauses do appear in parent clauses in derivation.



\begin{prop}


	Suppose in a partial interpolant, there are two maximal terms $t_1$ and $t_2$ such that w.l.o.g.~$t_1$ is smaller (as defined in \ref{def:order}) than $t_2$. Then it the final interpolant, an overbinding can be defined where the variable corresponding to $t_1$ is quantified over before the variable corresponding to $t_2$ is.
\end{prop}

The subterm-relation is reflexive.

\begin{defi}


	(OLD)
	Let $s$ be a term that is in $\PI(C)$ but not in any predecessor $\PI(C_i)$, $i \in \{1,2\}$. $s$ is smaller than a term $t$ in $\PI(C)$ if $s$ is of strictly smaller length than $t$ and there is a subterm in $s$ which also occurs in $t$.
\end{defi}

\begin{defi}
	\label{def:order}
	(NEW)
	%A term $s$ is smaller than a term $t$ if in some parent of a rule application, a subterm of $s$, which is a variable, appears in $t$ and $s$ is smaller in length than $t$.

	OUTDATED! DOES NOT WORK LIKE THIS

	Let $C$ be a clause.

	A maximal term $s$ of $C$ is smaller than a maximal term $t$ of $C$ if $s$ is a variable and occurs in $t$, but $s\neq t$. 
	%if in some parent of a rule application, a subterm of $s$, which is a variable, appears in $t$ and $s$ is smaller in length than $t$.

	OUTDATED! DOES NOT WORK LIKE THIS

\end{defi}

\section{Half-baked approaches}

\begin{defi}
	Direct interpolation extraction.

	This version of overline and star does NOT overbind variables! If they happen to be in the final interpolant, just overbind them somehow, but not earlier. This is ok as the interpolant only contains variables if both corresponding atoms in $\Gamma$ and $\Delta$ do. Variables are the only terms in the interpolant that can ``change their color'', so we don't know a priori if there are constraints on the quantifier to overbind them with.

	Convention w.r.t. a clause $C$ which has been derived from $C_1$ and $C_2$:
	$\bar Q_n = Q_1 z_1 \ldots Q_n z_n$, such that the $z_i$ correspond to the maximal terms $t_i$ in $\PI(C)$. Same terms must be overbound by same variable, see 101a for counterexample to per-occurrence-overbinding.
	The $z_i$ are ordered such that
	\begin{compactenum}
	\item the orderings in the $Q_{n_1}$ and $Q_{n_2}$ are respected (no circlular relations can occur in combination with merging as a term is only smaller than another term if it is smaller in length as well, which excludes cycles) 
	\item as well as ordering constraints of terms newly introduced in $\PI(C)$ (i.e.~those that were not present in $\PI(C_1)$ and $\PI(C_2)$). 
	\end{compactenum}
	Basically, track dependencies and define actual order later.


	\begin{itemize}
		\item[Resolution.]~
			\begin{prooftree}
				\AxiomCm{C_1: D \lor l}
				\AxiomCm{C_2: E \lor \lnot l'}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\BinaryInfCm{C: (D\lor E)\sigma}
			\end{prooftree}

			$\bar Q_{n_1} \PI(C_1)^*$

			$\bar Q_{n_2} \PI(C_2)^* $

			\begin{enumerate}
				\item $l$ and $l'$ $\Gamma$-colored:

					$\PI(C) \equiv (\PI(C_1) \lor \PI(C_2))\sigma $

					$\PI(C)^* \equiv (\PI(C_1)^* \lor \PI(C_2)^*)\sigma $ (just replace maximal terms)

					intended meaning of $\sigma$: to change the free variables still in the $\PI(C_i)$

					TODO: basically do nothing here since no new atoms (revisit after mixed colored case has been dealt with)

					Let $t_1, \ldots, t_{n_1}$ be terms overbound in $\PI(C_1)$ and
					$s_1, \ldots, s_{n_2}$ terms overbound in $\PI(C_2)$.

					$\{ z_1, \ldots, z_n \} = \{t_1, \ldots, t_{n_1}\} \sigma \cup \{s_1, \ldots, s_{n_2}\} \sigma$ $\quad$ // common terms are merged

					order relations as in $C_1, C_2$

					$\bar Q_n \PI(C)^* \equiv \bar Q_n ( \PI(C_1)^* \lor \PI(C_2)^*) $

				\item $l$ and $l'$ $\Delta$-colored:

					similar to first case

				\item $l$ and $l'$ grey:
					nothing here


			\end{enumerate}
	\end{itemize}

\end{defi}

\clearpage

\section{current proof attempts}


\begin{lemma}
	\label{lemma:interpolant_atom_origin}
	If an atom $A$ appears in the interpolant, it appeared in both original clause sets, once positively and once negatively.

	$A$ is contained in some instance of the respective clauses in $\Gamma$ and $\Delta$.

\end{lemma}

\begin{lemma}
	Let $C \in \Phi$ for some initial clause set $\Phi$. 
	\begin{enumerate}
		\item
			Let $x$ be an occurrence of a variable in $C$ and $x'$ another occurrence of the same variable in a different position but at the same term depth.
			Then $\Phi \entails Q y C\subst{x/y}\subst{x'/y}$ for $Q \in \{\forall, \exists\}$.

		\item
			Let $x$ be an occurrence of a variable in $C$ with the lowest depth and $x'$ another occurrence of the same variable with a higher depth.
			Let $t$ be the maximal colored term which contains $x'$. $t$ is $\Phi$-colored since it appears in $\Phi$.
			Then $\Phi \entails Q y \exists z C\subst{x/y}\abstraction{t/z}$ for $Q \in \{\forall, \exists\}$.
	\end{enumerate}
\end{lemma}

\begin{lemma}

	Let $t$ be a maximal colored term in $C$ in $\Phi$. It is $\Phi$-colored.
	Let $x_1, \ldots, x_n$ be the variables which occur in $t$.
	Then $\Phi \entails Q \bar x \exists y C\abstraction{t/y}$ for $Q \in \{\forall, \exists\}$.

\end{lemma}

\clearpage

{\huge

	actually

	We have that $\Gamma \entails \forall \bar x \lif{ \PI(C) \lor C}$.

	Note that both are lifted.
	\medskip


}
We have that $\Gamma \entails \forall \bar x \lif{C} \lor C$.
\bigskip

Let $t$ be a maximal $\Gamma$-term.
It in general contains $\Gamma$-colored and grey terms, and also $\Delta$-terms.
The latter have entered it by unification.

If $t$ contains no $\Delta$ terms, we can just overbind it existentially and give a witness.

Otherwise it contains $\Delta$-terms.
Then there is a variable in $t$ at position say $p$ which also occurs elsewhere in $C$, say at position $q$.

If $q$ is the outermost term or if it has only grey term ancestors, then quantifying over whatever is in $q$ before quantifying over whatever is in $p$ is fine. Hence there is an arrow.

$q$ can not be contained in a $\Delta$ term since dependencies cannot be introduced and must be there from the beginning, where no color mix is possible.

So otherwise $q$ is contained in a maximal $\Gamma$-term $s$. For finding witnesses, we will put the same one for the variable at both $q$ and $t$.
As $q$ introduces a $\Delta$-term, at some point, there had had to be a unification with a formula from $\Delta$ (this then could have been passed on through ``mirroring'').

Conjecture: there are arrows along the path from the origin of the $\Delta$-path to $q$.

Hence whatever is placed in $q$ and $p$ is quantified over earlier than the variables which replace $t$ and~$s$.

TODO: Proof or refute\dots

{

	conjecture: put all terms that share variables and appear in the same clause and are all overbound with the same quantifier in the same quantifier block.

	probably does not work when facing other dependencies, check that !

}




\vspace{4em}

Notation:

$p_1$ is the position of $s$ in $t$

$p_2$ is the elsewhere position of the shared var 


A unification where a $\Gamma$-colored term $s$ enters $t$ happens when 

\begin{itemize}
	\item the other unified clause has a variable at the position of $t$ ($p_1$)
	\item a variable is both in $t$ ($p_1$) and elsewhere in the unified clause ($p_2$)
	\item $p_2$ is either in a grey term or as outermost or a $\Delta$-colored term
		\begin{itemize}
			\item if $p_2$ directly in grey term or as outermost, the ancestor of $p_2$ will not be overbound (only $p_2$).
				we need $p_2$ as witness for overbinding $t$, but not the other way.

				Hence quantifying over $p_2$ first is ok.

			\item
				if $p_2$ is in a $\Delta$-colored term, say in maximal $\Delta$-term $s'$,
				Then $s'$ and $t$ are overbound with the same quantifier and order between them doesn't matter.

				for witness, we both need whatever the var is, and that we get by the inherited relation.

				? there must be an inherited relation as since both $s'$ and $t$ are $\Gamma$ and contain a $\Delta$-term, the $\Delta$ term must have gotten into a $\Gamma$-colored term using aufschauckeln ?
		\end{itemize}
\end{itemize}



\section{structured proof}

\begin{lemma}
	$\Gamma \entails PI(C) \lor C$ for $C$ in a prop proof.
	\label{structured1}
\end{lemma}
\begin{proof}
	See Huang.
\end{proof}

\begin{lemma}
	$\Gamma \entails \forall x_1 \ldots \forall x_n  \lif{PI(C) \lor C}$ for $C$ in a prop proof.
	\label{structured2}
\end{lemma}
\begin{proof}
	Still the same as in Huang.
\end{proof}


\begin{lemma}
	\label{lemma:pi_ai_the_same}
	$\AImatrix(C) = \lifboth{PI(C)}$ for $C \in \pi$.
\end{lemma}

SUPPOSE NO VARIABLE OCCURS TWICE IN A COLORED TERM IN AN INITIAL CLAUSE SET 

\begin{lemma}
	if there is a max $\Delta$-term in a max $\Gamma$-term, there is an arrow from occurrence of $\Delta$-term to the occurrence of $\Gamma$-term in $\AI$.
\end{lemma}
\begin{proof}

	induction:

	base case: no foreign terms

	$C_1: D \lor l$ and $C_2: E \lor \lnot l$

	resolution, same color: 
	induction hypothesis!!!

	resolution, different color: 
	$l$ and $l'$ unified. 
	Disregard grey terms.
	Supp one of the unification locations, a term has a variable and all the prefix is grey/shared in $l$ and $l'$.
	Then term from other literal enters, possibly foreign.
	Then by replacing all variables in $C_1$ or $C_2$, a $\Delta$-term might enter a $\Gamma$-term. But in this case, we have an arrow.

	$\Gamma$-terms and $\Delta$-terms are different and hence not unifiable.

	Suppose same prefix (i.e. same colored prefix), then different variables each. Supp variable at one end, foreign colored term at other.
	then arrows of literals are merged, and by induction hypothesis, the term with the foreign colored term has an arrow to the foreign colored term. 




	\comm{
	for each unification where possibly foreign terms are introduced, there is an arrow.

	Either resolution with same color:
	as long as just same color resolutions, no new literals in interpolant (but new terms by resolution?)

	if after chain of same color resolution a grey literal is resolved, transitive edges kick in (chain of arrows)


	resolution with grey literals:
	resolved literals share grey or aufgeschaukelter prefix before the variable.

	RESTRICTION APPLIES HERE: no aufgeschaukelte prefixes

	if the variable occurs elsewhere in one of the clauses, a foreign term might have been introduced in a colored term. in this case, there is an arrow
}
\end{proof}

\begin{lemma}
	$\Gamma \entails \bar Q_n  \lifgamma{ \lifdelta{PI(C)\lor C} } $ for $C$ in a prop proof.

	i.e.

	$\Gamma \entails \AI(C) $ for $C$ in a prop proof.
\end{lemma}
\begin{proof}
%	By \ref{structured2}, 
%	$\Gamma \entails \forall x_1 \ldots \forall x_n  \lif{PI(C) \lor C}$.
	Show that the existential quantifiers in $\bar Q_n$ have witnesses.

	If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l$, then by induction hypothesis, we get that

	supp $l$ grey:
	$\AI(C) = Q_1 u_i\dots Q_m u_m (\lnot \chi \land \AImatrix(C_2)) \lor (l \land \AImatrix(C_1)) $

	Know:   $\Gamma \entails  \lifgamma{{PI(C)\lor C} }$

	By Lemma \ref{lemma:pi_ai_the_same}:
	Know:   $  \lifboth{{{\PI(C)\lor C} }} = \AImatrix(C) \lor \lifboth{C}$


	Need:
	$\Gamma \entails \AI(C) \lor C$ \comm{C in binding of $\AI$}

	i.e.
	$\Gamma \entails \{Q_{n_1} \cup Q_{n_2} \cup \text{new ones}\} ( \lifboth{(l \land \lifboth{ \PI(C_2)) } \lor (\lnot l \land \lifboth{\PI(C_1)}) \lor D \lor E })$



	existentially overbound variables in $\lifboth{\PI(C_i)}$ will still work if relative order is maintained, which it is.

	for new terms in $l$, we have lemma \ref{structured2}, which provide witnesses.

	huang-style: show how a foreign term got into a colored term, and this is how it must have an arrow.


	TODO: show for restricted version: all variables occur once as maximal ``colored'' term. 




\end{proof}


\clearpage


\begin{lemma}
	Suppose no colored term occurs in $\PI(C) \lor C$ for $C \in \pi$.
	Then 
	$\Gamma \entails \AImatrix(C) \lor \AIclause(C)$ \comm{implicit universal quantification}
\end{lemma}
\begin{proof}

	Proof by induction.

	Base case:

	For $C \in \Gamma$, $\AImatrix(C) = \bot$ and $\AIclause = \lifboth{C} = \lifgamma{C} $. By the restriction, $\lifgamma{C} = C$ and $\Gamma \entails C$.

	For $C \in \Delta$, $\AImatrix(C) = \top$.

	Induction step:

	We know: $\Gamma \entails \AImatrix(C_i) \lor \AIclause(C_i)$, $i\in\{1,2\}$.

	\begin{itemize}
		\item
			Suppose $l$ and $l'$ of opposite color.

			$\AImatrix(C)' =
			\Big((\lnot l \land \AImatrix(C_1)) \lor (l \land \AImatrix(C_2))\Big)\sigma$

			$\AIclause(C)' = \Big((\AIclause(C_1) \setminus \{l\}) \lor (\AIclause(C_2)\setminus \{\lnot l'\})\Big) \sigma$ \comm{ setminus: remove clause with that ancestor }

			To show: $\Gamma \entails \lifboth{ \AImatrix(C)' \lor \AIclause(C)' }$, but as $\sigma $ does not introduce a colored term, this is the same as $\Gamma \entails \AImatrix(C)' \lor \AIclause(C)'$.

			Suppose $\Gamma \notentails (\AIclause(C_1) \setminus \{l\})\sigma$ and $\Gamma \notentails (\AIclause(C_2) \setminus \{\lnot l'\})\sigma$ as otherwise we would be done.

			Then $\Gamma \notentails (\AIclause(C_1) \setminus \{l\})$ and $\Gamma \notentails (\AIclause(C_1) \setminus \{l\})$.

			Hence the induction hypothesis reduces to $\Gamma \entails \AImatrix(C_1) \lor l$ and $\Gamma \entails \AImatrix(C_2) \lor \lnot l'$.

			Therefore also $\Gamma \entails (\AImatrix(C_1) \lor l)\sigma$ and $\Gamma \entails (\AImatrix(C_2) \lor \lnot l')\sigma$. 

			Now as $l\sigma = l'\sigma$, their interpretation is linked, so we get the result in a similar way as in Huang's proof.


	\end{itemize}


\end{proof}


\begin{lemma}
	$\AImatrix(C)$ and $\AIclause(C)$ do not contain colored terms.
	\label{lemma:no_colored_terms}
\end{lemma}

\begin{remark}
	Let $t$ be a term without $\Gamma$-terms.
	It contains $\Delta$-terms $t_i$, grey terms $g_i$ and free variables $v_i$.
	$\lifdelta{t}$ is $t$, where the maximal $\Delta$-term $t_i$ is replaced by free variable $x_i$.

	A substitution $\sigma$ occuring in a resolution refutation does not affect any of the $x_i$, as these symbols do not occur in the initial clause sets.

	Hence $\lifdelta{t} \sigma $ differs from $\lifdelta{t}$ in the $v_i$, which are potentially substituted.
	The $v_i$ can be substituted to other free variables $v'_i$ (not the same ones as factors of clauses are variable disjoint), grey terms $g'_i$ or $\Delta$-terms $t'_i$ (or combinations of $g'_i$ and $t'_i$ including occurrences of $v'_i$).
	%Hence $\lifdelta{ \lifdelta{t} \sigma }$ 

	Assumption: $\lifdelta$ keeps track of the terms it replaces and always uses the same variables.
	
	Goal: $\lifdelta{\lifdelta{t} \sigma} = \lifdelta{t\sigma}$.
	Suppose $\sigma$ does not affect $t$ (and also not the $x_i$ as it occurs in a resolution rule application). Then it holds.

	Otherwise it changes a variable $v_i$ at position $p$.
	$\lifdelta{t}$ has at position $p$ $v_i$ as well if the path to $p$ does not contain colored symbol.
	So $\lifdelta{\lifdelta{t}\sigma}$ and $\lifdelta{t\sigma}$ coincide at $p$, irrespective of what $\sigma$ introduces (var, $\Delta$-/grey-term).

	If $p$ points into a maximal $\Delta$-colored term, $p \mod k$ for some $k\geq 1$ is a $\Delta$-colored term $t_j$.
	Hence in $\lifdelta{t}$, $\pos(p\mod k) = x_j$.

	However in $\lifdelta{t\sigma}$, $\pos(p\mod k) = x_l$.

	TODO: argue with arrows that this does not break anything?

\end{remark}

\begin{lemma}
	If $l \in C$, then $\lifboth{l} \in \AIclause(C)$.
	\label{lemma:literals_in_aiclause}
\end{lemma}
\begin{proof} By induction:

	Base case by definition.

	Let $\lambda \in C_1$ w.l.o.g. Resolution $C_1 : D \lor l$ and $C_2 : E \lor \lnot l'$ with $l\sigma = l'\sigma$ give $C: (D\lor E)\sigma$.
	Then $(\lambda\sigma) \in C$.
	
	Have to show $ \lifboth{\lambda\sigma} \in \AIclause(C)$.
	
	Induction hypothesis: $\lifboth{\lambda} \in \AIclause(C_1)$. $\lambda \neq l$.
	\begin{itemize}
		\item Supp.~$l$ grey.

			$\AIclause(C) = \lifboth{ \Big( (\AIclause(C_1) \setminus \{\lifboth{l}\}) \lor (\AIclause(C_2) \setminus \{\lnot \lifboth{l'}\}) \Big) \sigma} $

			As $\lifboth{\lambda} \in \AIclause(C_1)$, $\lifboth{\lifboth{\lambda} \sigma} \in \AIclause(C) $.

		It remains to show that $\lifboth{\lifboth{\lambda} \sigma} = \lifboth{\lambda \sigma}$

		TODO after remark

	\end{itemize}



\end{proof}

\begin{lemma}
	Suppose no maximal $\Gamma$-term occurs in $\PI(C) \lor C$ for $C \in \pi$.
	Then 
	$\Gamma \entails \AImatrix(C) \lor \AIclause(C)$ \comm{implicit universal quantification}
\end{lemma}
\begin{proof}
	\comm{
		Given that $\Gamma \entails \lifdelta{\PI(C)}$.

		By the restriction to $\Gamma$-terms, $\lifdelta{\PI(C)} = \lifboth{\PI(C)}$.
		$\AI(C)$ differs from $\lifboth{\PI(C)}$ insofar as in the latter, all equal maximal $\Gamma$-terms are overbound with the same variable.

		In $\AI(C)$, occurrences of the same maximal $\Gamma$-term in $l$ or $l'$ are overbound with the same variable as well as all occurrences of the same variable which are contained in grey terms only.

	}


	Proof by induction.

	Base case:

	For $C \in \Gamma$, $\AImatrix(C) = \bot$ and $\AIclause = \lifboth{C} = \lifgamma{C} $. By the restriction, $\lifgamma{C} = C$ and $\Gamma \entails C$.

	For $C \in \Delta$, $\AImatrix(C) = \top$.

	Induction step:


	\begin{description}
		\item{Resolution.}
			\begin{prooftree}
				\AxiomCm{C_1: D \lor l}
				\AxiomCm{C_2: E \lor \lnot l'}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\BinaryInfCm{C: (D\lor E)\sigma}
			\end{prooftree}


			By the induction hypothesis,
			$\Gamma \entails \AImatrix(C_i) \lor \AIclause(C_i)$, $i\in\{1,2\}$, or expressed differently (cf.~Lemma \ref{lemma:literals_in_aiclause}):
			
			$\Gamma \stackrel{\markA}\entails \AImatrix(C_1) \lor (\AIclause(C_1)\setminus\{\lifboth{l}\}) \lor \lifboth{l}$

			$\Gamma \stackrel{\markB}\entails \AImatrix(C_2) \lor (\AIclause(C_2)\setminus\{\lnot \lifboth{l'}\}) \lor \lnot \lifboth{l'}$

			\begin{itemize}
				\item
					Suppose $l$ and $l'$ of opposite color.


					$\AImatrix(C)' =
					(\lnot l \land \AImatrix(C_1)) \lor (l \land \AImatrix(C_2))$

					$\AIclause(C)' = (\AIclause(C_1) \setminus \{l\}) \lor (\AIclause(C_2)\setminus \{\lnot l'\})$ \comm{     setminus: remove clause with that ancestor }

					$\left.\begin{tabular}{l}
						$\AImatrix(C) = \lifboth{\AImatrix(C)' \sigma}$\\

						$\AIclause(C) = \lifboth{\AIclause(C)' \sigma}$
				\end{tabular}\right\} \lifboth $ with same overbinding!

				We show: $\Gamma \entails \lifboth{ \AImatrix(C) \lor \AIclause(C) }$,
				which by the restriction is equivalent to $\Gamma \entails \lifdelta{ \AImatrix(C)'\sigma} \lor \lifdelta{\AIclause(C)'\sigma }$


				Suppose for a model $M$ of $\Gamma$ that $M \notentails \AIclause(C)'$.
				Otherwise $M \entails \AIclause(C)'\sigma$.
				But $\sigma$ only introduces grey terms and $\Delta$-terms, hence $M \entails \lifdelta{ \AIclause(C)'\sigma }$ which proves the result.

				As $\sigma = \mgu(l, l')$, $\lifdelta{l\sigma} = \lifdelta{l'\sigma}$.

				Suppose that $M\entails \lifdelta{l\sigma}$. Then by \markB, $M\entails \AImatrix(C_2)$.






		\end{itemize}
\end{description}


\end{proof}


\clearpage
\section{old stuff, not sure if valuable}

\begin{prop}
	$\Gamma \entails Q_1 z_1 \ldots Q_n z_n \overline{\PI(C) \lor C}(z_1, \ldots, z_n)$ , quantifiers ordered as in \ref{def:order}, is a craig interpolant.
\end{prop}

\begin{proof}

	Induction.

	Suppose Resolution.
	\begin{prooftree}
		\AxiomCm{C_1: D \lor l}
		\AxiomCm{C_2: E \lor \lnot l'}
		\RightLabelm{\quad \sigma = \mgu(l, l')}
		\BinaryInfCm{C: (D\lor E)\sigma}
	\end{prooftree}

	$\Gamma \entails \bar Q_{n_1} \overline{\PI(C_1)  \lor D \lor l}$

	$\Gamma \entails \bar Q_{n_2} \overline{\PI(C_2)  \lor E \lor \lnot l'}$

	to show:

	$\Gamma \entails \bar Q_n \overline {\PI(C) \lor (D \lor E)\sigma}$ $\quad$ // somewhat imprecise on $\bar Q_n$, but that's just useless quantifiers


	$\Gamma \entails ( \bar Q_{n_1} \overline{PI(C_1)}  \lor D \lor l )\sigma$

	$\Gamma \entails (\bar Q_{n_2} \overline{PI(C_2)}  \lor E \lor \lnot l')\sigma$

	By resolution:

	$\Gamma \entails (\bar Q_{n_1} \overline{\PI(C_1)}\lor \bar Q_{n_2} \overline{\PI(C_2)})\sigma  \lor (D \lor E )\sigma$


	\begin{enumerate}
		\item Suppose $l, l'$ are from $\Gamma$ alone:
			TODO


		\item Suppose $l$ and $l'$ are colored with different colors and w.l.o.g~$l$ is $\Gamma$-colored and $l'$ is $\Delta$-colored.

			$\bar Q_n \overline{\PI(C)} \equiv \bar Q_n  \overline{[ (\lnot l' \land \PI(C_1)^*) \lor (l \land \PI(C_2)^*) ] \sigma}$

			$\equiv \bar Q_n  (\overline{\lnot l'\sigma} \land \overline{\overline{\PI(C_1)}\sigma}) \lor (\overline{l\sigma} \land \overline{\overline{\PI(C_2)}\sigma})$

			Adapt Huang proof to this, need to consider quantifiers:

			If $\Gamma \cancel \entails D \sigma$ and 
			$\Gamma \cancel \entails E \sigma$ (else we are done), then  

			$\Gamma \entails [ (\lnot l' \land \bar Q_{n_1} \overline{PI(C_1)}) \lor (l \land \bar Q_{n_2} \overline{\PI(C_2)}) ] \sigma$

			As $\bar Q_{n_1}$ and $\bar Q_{n_2}$ disjoint and their variables do not appear in $l$ or $l'$,

			$\Gamma \entails (\bar Q_{n_1} \bar Q_{n_2} [ (\lnot l' \land  \overline{PI(C_1)}) \lor (l \land \overline{PI(C_2)}) ] ) \sigma$

			$\Gamma \entails \bar Q_{n_1} \bar Q_{n_2} [ (\lnot l'\sigma \land  \overline{\PI(C_1)}\sigma) \lor (l\sigma \land \overline{\PI(C_2)}\sigma) ] $

			Consider the maximal terms of this expression which are $\Delta$-colored.

			The $\PI(C_i)$, $i \in \{1,2\}$ contain no colored terms. $\sigma$ can introduce one by replacing a free variable $x$ by a $\Delta$-term $t$. But then overline replaces it with an universally quantified variable again, hence the formula is still entailed by $\Gamma$.

			$\Gamma \entails \bar Q_{n_1} \bar Q_{n_2} [ (\lnot l'\sigma \land  \overline{\overline{\PI(C_1)}\sigma}) \lor (l\sigma \land \overline{\overline{\PI(C_2)}\sigma}) ] $



			TODO: should work out similarily as huang if using $P_P$ or it's the same as what i'm trying above.

	\end{enumerate}
\end{proof}



\begin{prop}
	$\Gamma \entails Q_1 z_1 \ldots Q_n z_n \PI(C)^*(z_1, \ldots, z_n)  \lor C$, quantifiers ordered as in \ref{def:order}, is a craig interpolant.
\end{prop}

\begin{proof}

	Induction.


	Suppose Resolution.
	\begin{prooftree}
		\AxiomCm{C_1: D \lor l}
		\AxiomCm{C_2: E \lor \lnot l'}
		\RightLabelm{\quad \sigma = \mgu(l, l')}
		\BinaryInfCm{C: (D\lor E)\sigma}
	\end{prooftree}

	$\Gamma \entails \bar Q_{n_1} \PI(C_1)^*  \lor D \lor l$

	$\Gamma \entails \bar Q_{n_2} \PI(C_2)^*  \lor E \lor \lnot l'$

	to show:
	$\Gamma \entails \bar Q_n \PI(C)^* \lor (D \lor E)\sigma$


	$\Gamma \entails ( \bar Q_{n_1} \PI(C_1)^*  \lor D \lor l )\sigma$

	$\Gamma \entails (\bar Q_{n_2} \PI(C_2)^*  \lor E \lor \lnot l')\sigma$

	By resolution:

	$\Gamma \entails (\bar Q_{n_1} \PI(C_1)^*\lor \bar Q_{n_2} \PI(C_2)^*)\sigma  \lor (D \lor E )\sigma$


	\begin{enumerate}
		\item Suppose $l, l'$ are from $\Gamma$ alone:
			TODO


		\item Suppose $l$ and $l'$ are colored with different colors and w.l.o.g~$l$ is $\Gamma$-colored and $l'$ is $\Delta$-colored.

			$\bar Q_n \PI(C)^* \equiv \bar Q_n  ([ (\lnot l' \land \PI(C_1)^*) \lor (l \land \PI(C_2)^*) ] \sigma)^*$

			Adapt Huang proof to this, need to consider quantifiers:

			If $\Gamma \cancel \entails D \sigma$ and 
			$\Gamma \cancel \entails E \sigma$ (else we are done), then  

			$\Gamma \entails [ (\lnot l' \land \bar Q_{n_1} \PI(C_1)^*) \lor (l \land \bar Q_{n_2} \PI(C_2)^*) ] \sigma$

			As $\bar Q_{n_1}$ and $\bar Q_{n_2}$ disjoint and their variables do not appear in $l$ or $l'$,

			$\Gamma \entails (\bar Q_{n_1} \bar Q_{n_2} [ (\lnot l' \land  \PI(C_1)^*) \lor (l \land \PI(C_2)^*) ] ) \sigma$

			The $\PI(C_i)$, $i \in \{1,2\}$ contain no colored terms. $\sigma$ can introduce one by replacing a free variable $x$. 

			Consider the maximal terms of this expression which are $\Gamma$-colored.



			Either they only have grey subterms, then if they are existentially quantified, we can just use it as witness as the terms aren't replaced.

			Otherwise they contain at least a $\Gamma$- or a $\Delta$-colored subterm.






	\end{enumerate}


	{ \color{gray}


		Base case: simple.

		Suppose Resolution.
		\begin{prooftree}
			\AxiomCm{C_1: D \lor l}
			\AxiomCm{C_2: E \lor \lnot l'}
			\RightLabelm{\quad \sigma = \mgu(l, l')}
			\BinaryInfCm{C: (D\lor E)\sigma}
		\end{prooftree}

		$\Gamma \entails \bar Q_{n_1} \PI(C_1)^*  \lor D \lor l$

		$\Gamma \entails \bar Q_{n_2} \PI(C_2)^*  \lor E \lor \lnot l'$

		to show:
		$\Gamma \entails \bar Q_n \PI(C)^* \sigma \lor (D \lor E)\sigma$


		Note that a term newly introduced in $\PI(C)$ occurs in either $l$ or $l'$, but not in both.

		Let $t$ be a colored term in $\PI(C)$, which has just been added
		W.l.o.g.\ let it occur in $l$, i.e.\ in $C_1$.



		Case distinction:

		~

		\begin{enumerate}
			\item Suppose $l, l'$ are from $\Gamma$ alone:

				By induction hypothesis:

				$\Gamma \entails ( \bar Q_{n_1} \PI(C_1)^*  \lor D \lor l )\sigma$

				$\Gamma \entails (\bar Q_{n_2} \PI(C_2)^*  \lor E \lor \lnot l')\sigma$

				By resolution:

				$\Gamma \entails (\bar Q_{n_1} \PI(C_1)^*\lor \bar Q_{n_2} \PI(C_2)^*)\sigma  \lor (D \lor E )\sigma$


				\begin{description}
					\item [Suppose $t$ is $\Gamma$-colored.] ~

						Then it will be replaced by $x_i$ and existentially quantified.
						It appears in either $\PI(C_1)$ or $\PI(C_2)$.

						$t$ is a witness for $x_i$ because it contains subterms $t_1, \ldots, t_n$. If they are overbound as well, they are so before $t$ and are available here.

						TODO: derive properties using examples 103 or so


				\end{description}

		\end{enumerate}
	}

	{ \color{gray}
		OTHER TRY: 

		Then $\sigma$ replaces variables $y_1, \ldots, y_k$ in $E \lor \lnot l'$ with terms that contain~$t$.

		By the induction hypothesis, $\Gamma \entails Q_1 z_1 \ldots Q_{n_2} z_{n_2} \PI(C_2)^*(z_1, \ldots, z_{n_2})  \lor E \lor \lnot l'$.

		Hence $\Gamma \entails (Q_1 z_1 \ldots Q_{n_2} z_{n_2} \PI(C_2)^*(z_1, \ldots, z_{n_2})  \lor E \lor \lnot l' ) \sigma$.

		Also $\Gamma \entails Q_1 z_1 \ldots Q_{n_2} z_{n_2} (\PI(C_2)^*(z_1, \ldots, z_{n_2})\sigma)  \lor E\sigma \lor \lnot l'\sigma$.

		Similarily,
		$\Gamma \entails Q_1 z_1 \ldots Q_{n_1} z_{n_1} (\PI(C_1)^*(z_1, \ldots, z_{n_1})\sigma)  \lor D\sigma \lor l\sigma$

		$\Gamma \entails Q_1 z_1 \ldots Q_{n} z_{n} ( (\lnot l \land \PI(C_2)) \lor (l \land \PI(C_1))) ^*(z_1, \ldots, z_{n})\sigma)  \lor D\sigma \lor l\sigma$

		$l$ basically is the only new thing ($l\sigma = l'\sigma$).

		Either $l$ does not contain any subterms of other terms, then it does not depend on anything and $l$ serves as witness for itself.

		Otherwise it does depend on other terms and we have to make sure that that term is available.
		Depending on another term means that it uses information that is only available from another term,
		i.e.~it contains a subterm of another term. but then that subterm is quantified over before the variable that replaces $t$ is, so it works out.


	\item [$t$ is $\Delta$-colored.]
		Then it is replaced by a universally quantified variable.
		But it ``was already universally quantified'' in the induction hypothesis.
		There, it was some free variable, because that's the only thing that can be substituted, but even with this free var, it worked out.


		%When proving $\Gamma \entails Q_1 z_1 \ldots Q_{n} z_{n} \PI(C)^*(z_1, \ldots, z_{n}$, it will be replaced by an existentially quantified variable, which is ok since $t$ is the witness.



	}
\end{proof}



\begin{conj}
	$\Gamma \cup \Delta$ unsat, $\pi$ propositional resolution refutation. Then $\Gamma \entails \bar Q_n \PI(C)^* \lor C$ and $\Delta \entails \lnot \bar Q_n \PI(C)^* \lor C$ for all $C$ in $\pi$.
\end{conj}
\begin{proof}
	Base case as in Huang.


	Induction.


	Suppose Resolution.
	\begin{prooftree}
		\AxiomCm{C_1: D \lor l}
		\AxiomCm{C_2: E \lor \lnot l}
		\BinaryInfCm{C: D\lor E}
	\end{prooftree}

	$\Gamma \entails \bar Q_{n_1} \PI(C_1)^*  \lor D \lor l$

	$\Gamma \entails \bar Q_{n_2} \PI(C_2)^*  \lor E \lor \lnot l$

	to show:
	$\Gamma \entails \bar Q_n \PI(C)^* \lor D \lor E$, i.e.~
	\newline
	$\Gamma \entails \operatorname{sort}( Q_{n_1} \cup Q_{n_2} \cup \operatorname{colored-terms}(l)) ( (\lnot l^* \land  PI(C_1)^*) \lor (l^* \land PI(C_2)^*)  ) \lor D \lor E$


	If $\Gamma \cancel \entails D $ and 
	$\Gamma \cancel \entails E $ (else we are done), then  

	$\Gamma \entails  (\lnot l \land \bar Q_{n_1} PI(C_1)^*) \lor (l \land \bar Q_{n_2} \PI(C_2)^*)  $

	As $\bar Q_{n_1}$ and $\bar Q_{n_2}$ disjoint and their variables do not appear in $l$ or $l$,

	$\Gamma \entails \bar Q_{n_1} \bar Q_{n_2} [ (\lnot l \land  PI(C_1)^*) \lor (l \land PI(C_2)^*) ]  $

	Since we've pushed the variables outside, no colored terms appear in $\PI(C_i)^*$.

	Suppose $l$ does not contain colored terms. Then $l = l^*$ and we are done.

	Otherwise let $t$ be a maximal colored term in $l$.

	By lemma \ref{lemma:interpolant_atom_origin}, $l$ appears in $\Gamma$ with a certain polarity, say in clause $E$.
	$l$ is an instance of $E$.

	In fact, $l$ is contained in $C\sigma$ where $\sigma$ is the composition of unifiers applied in the deriviation up to the current point.

	Hence $\Gamma \entails C\sigma$.


	\begin{enumerate}
		\item Suppose $t$ is $\Gamma$-colored.
			$\Gamma \entails l$ implies that $\Gamma \entails \exists y\,l\abstraction{t/y}$

		\item Suppose $t$ is $\Delta$-colored.
			$\Gamma \entails \forall y\,l\abstraction{t/y}$ because:



	\end{enumerate}


\end{proof}



\end{document}

