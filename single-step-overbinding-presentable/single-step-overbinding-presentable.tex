\documentclass[,%fontsize=11pt,%
	paper=a4,% 
	%landscape,
	DIV12, % mehr text pro seite als defaultyyp
	%DIV10, 
	%DIV=calc,%
	twoside=false,%
	liststotoc,
	bibtotoc,
	draft=false,% final|draft % draft ist platzsparender (kein code, bilder..)
	%titlepage,
	numbers=noendperiod
]{scrartcl}

\usepackage{lscape}
\usepackage{stackengine}


\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}

\usepackage{enumerate}
\usepackage{paralist}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,backgrounds,graphs,%
	matrix,patterns,arrows,decorations.pathmorphing,decorations.pathreplacing,%
	positioning,fit,calc,decorations.text,shadows%
}


\input{../latex_header.tex}

% subsections also in toc
\setcounter{tocdepth}{2}

%\declaretheorem[title=Theorem,qed=$\triangle$,parent=chapter]{thm}
\newcommand{\thmqed}{$\square$} % for thms without proof
\newcommand{\propqed}{$\square$} % for props without proof
\declaretheorem[title=Theorem]{thm}
\declaretheorem[title=Proposition,sibling=thm]{prop}
%\declaretheorem[title=Lemma,parent=chapter]{lemma}
\declaretheorem[sibling=thm]{lemma}
\declaretheorem[title=Corollary,sibling=thm]{corr}
\declaretheorem[sibling=thm,title=Definition,style=definition,qed=$\triangle$]{defi}
%\declaretheorem[title=Definition,qed=$\triangle$,parent=chapter]{defi}
\declaretheorem[title=Example,style=definition,qed=$\triangle$,sibling=thm]{exa}

\declaretheorem[sibling=thm,title=Conjecture]{conj}

\declaretheorem[title=Remark,style=remark,numbered=no,qed=$\triangle$]{remark}

%\def\proofSkipAmount{ \vskip -0.5em}



%\usepackage{bussproof}

%\usepackage{vaucanson-g}
\usepackage{amssymb}
\usepackage{latexsym}

% for color-highlighted code
%\usepackage{color} % for grey comments
%\usepackage{alltt}

%\usepackage[doublespacing]{setspace}
%\usepackage[onehalfspacing]{setspace}
\usepackage[singlespacing]{setspace}
\usepackage{tabularx}
\usepackage{hyperref}
\usepackage{comment}
\usepackage{color}
\usepackage[final]{listings} % sourcecode in document
\usepackage{url}      % for urls
\usepackage{multicol}
\usepackage{float}
\usepackage{caption}
\usepackage{subfigure}
\usepackage{amsmath}
\usepackage{amssymb}

\usepackage{graphicx}

\usepackage[authoryear]{natbib} % \cite ; square|round etc.
%\usepackage[numbers,square]{natbib}
%\usepackage[square, authoryear]{natbib}
%\usepackage[language=english]{biblatex}

%\bibliographystyle{plain}
\bibliographystyle{alpha}
%\bibliographystyle{alphadin}
%\bibliographystyle{dinat}
%\bibliographystyle{chicago}
%\bibliographystyle{plainnat}

\bibdata{bib.bib}

\renewcommand*{\partformat}{\partname\ \thepart\ -}
\let\partheadmidvskip\

\newcommand{\comp}{\ensuremath{\text{comp}}}
% smaller url style
\makeatletter
\def\url@leostyle{%
\@ifundefined{selectfont}{\def\UrlFont{\sf}}{\def\UrlFont{\small\ttfamily}}}
\makeatother
\urlstyle{leo}

\newcommand{\myfig}[5] {
	\begin{figure}[tbph]
		\centering
		\includegraphics[#3]{#1}
		\caption[#4]{#5}
		\label{fig:#2}
	\end{figure}
}

\setlength{\parindent}{0em}
%\usepackage{thmtools} % actually already in latex_header.tex ...

\usepackage{amsthm}


\usepackage{tikz-qtree}

%\newcommand{\sig}[1]{{#1}_\Sigma}
%\newcommand{\p}[1]{{#1}_\Pi}
\newcommand{\sig}[1]{\stackrel{\Sigma}{#1}}
\newcommand{\p}[1]{\stackrel{\Pi}{#1}}

\newcommand{\e}[1]{\vskip .7em   \subsection*{#1}}

\def\proofSkipAmount{ \vskip -0.3em}

\usepackage{refcheck}

\begin{document}

\newcommand{\lif}[1]{\lift{\Delta}{#1}{x}}


%\newcommand{\lifboth}[1]{\lft{\Gamma\cup\Delta}{z}{#1}}

\section{Arrow-Algo}

\subsection{term positions}

Every literal in any initial clause set has (conceptually) a globally unique id/number.
It is the same for literals in the derivation as for literals in the interpolant generated from the literals in the derivation.

Ex: $P(y, a, f(z, g(y, b)) ) \lor Q(x)$

Term position:

$0.2.1.0$ means first literal, 3rd arg, 2nd arg, fst arg: $y$

$0.1$ is $a$

$0.2.1$ is $g(z, b)$

$\pos$ calculates the position of a term or the term of a position, depending on the argument type.

for a position $p_i$, $\pos(p_i)$ denotes the term at position $p_i$.

for a term $t$, $\pos(t)$ denotes the position in $t$ in its respective clause.

for a position $p$, $\poslit(p)$ denotes the position of the literal

for a position $p$, $\posterm(p)$ denotes the position of the term in $p_i$ 

``$.$'' can be used for concatenation: $p = \poslit(p).\posterm(p)$

for a position $p$, $p \mod i$ denotes $p$ with $i$ least significant places cut off, $0.2.1.0 \mod 2 = 0.2$

\subsection{Arrows}

\begin{defi}[Coloring of variable occurrences]
	An occurrence of a variable $x$ is called \defiemph{$\Phi$-colored} if it is contained in a maximal $\Phi$-colored term. It is called \defiemph{colored} if it is of any color and \defiemph{grey} otherwise.
\end{defi}

$\arr$ is a set of ordered pairs of term positions which point to positions in terms in literals

$\warr$ is a set of unordered pairs of term positions which point to positions in terms in literals

Note that the ``anchor point'' for arrows are \emph{literals} and not clauses.
All literals occur in the initial clause sets.
The literals in $\AI(C)$ are derived from these and the arrows apply to them.
Literals of colored predicates do not occur in $\AI(C)$ but can be relevant by transitivity.

Notation: If $l$ is a literal in a clause $C$, $l\cl$ denotes the corresponding literal in $\AIclause(C)$. It exists by Lemma~\ref{lemma:literal_in_clause_similar}.

\subsubsection{Arrows in the derivation}
w.r.t a refutation $\pi$ of $\Gamma \cup \Delta$:

\newcommand{\Phicol}{\Phi^{\operatorname{col}}}
\newcommand{\Phigrey}{\Phi^{\operatorname{grey}}}
\newcommand{\MaxCol}{\operatorname{MaxCol}}
\begin{enumerate}
	\item For each initial clause $C$ in $\Gamma \cup \Delta$:

		\begin{quote}
			For every variable $x$ in $C$:

			\begin{quote}

				Let $\Phi_x$ be the set of occurrences of $x$ in $C$. 

				Let $\Phicol_x = \{p \in \Phi_x \mid \text{$p$ is contained in a colored term} \}$
				and $\Phigrey_x = \Phi_x \setminus \Phicol_x$.

				Let $\MaxCol(\Phi) = \{q \mid \text{$q$ is the occurrence of the maximal colored term containing $p$ for $p \in \Phi$} \}$

				$\arr_x(C) \defeq \Phigrey_x \times \MaxCol(\Phicol_x)$. \comm{introduction of multicolored terms}

				%Add to $\warr$ all $(p_1, p_2)$ such that $p_1\in\MaxCol(\Phicol_x)$ and $p_2\in\MaxCol(\Phicol_x)$ and $p_1 \neq p_2$.

				$\warr_x(C) \defeq \MaxCol(\Phicol_x) \times \MaxCol(\Phicol_x) \spam\cup
				\Phigrey_x\times\Phigrey_x$. \comm{travel route of multicolored terms}

				Arrows of the form $(a, a)$ in $\warr$ have no effect.

				CONJECTURE: we only need merge arrows if  there are no grey occurrences. this is an optimisation, so we don't consider it right now.
			\end{quote}

			$\arr(C) \defeq\displaystyle \bigcup_{ x \text{ occurs in }C} \arr_x(C)$

			$\warr(C) \defeq\displaystyle \bigcup_{x \text{ occurs in }C} \warr_x(C)$
		\end{quote}

		%Add to $\arr$ all $(p_1, p_2)$ in $C$ such that $p_1$ contains only grey symbol and $\pos(p_1)$ is a variable and $\pos(p_1) = \pos(p_2)$ but $p_1 \neq p_2$.

		%Add to $\warr$ all $\{p_1, p_2\}$ such that there is a colored symbol in $p_1$ and a possible different one in $p_2$ and $\pos(p_1)$ is a var and $\pos(p_1) = \pos(p_2)$.

	\item 
		For each $C$ resulting from a resolution step from $C_1: D\lor l$ and $C_2: E\lor \lnot l$ to $C = D \lor E$ with prop interpolant $\PI(\cdot)$:

		The literals $l$ and $l'$ are unified and henceforth considered to be the same literal.
		Therefore the arrows of $l$ and $l'$ are merged:

		For $\mathcal{X} \in \{\arr, \warr\}$:

		$\mathcal{X}^*(C) \stackrel{\operatorname{def}}{=} \mathcal{X}(C_1) \cup \mathcal{X}(C_2)$

		$\mathcal{X}(C) \stackrel{\operatorname{def}}{=} \mathcal{X}^*(C) \cup \{(a,c) \mid ((a,b)\in\mathcal{X}^*(C) \land \poslit(c) = l \land \posterm(c) = \posterm(b) \land \poslit(b) = l') \lor \text{\dots~other cases \dots}\}$

		\comm{(deprecated, not needed) Variable renamings: For $\marr(C)$, we also add $\{p_1, p_2\}$
		for
		$\pos(p_1)$ and $\pos(p_2)$ grey occurrences of variables,
		$\pos(p_1) \neq\nolinebreak \pos(p_2)$,
		$\pos(p_1) \sigma = \pos(p_2)$.
		This is only necessary if the renaming is caused due to unification of colored terms which contain the two variables.
	}

		%\wrong{
		%Then (backwards merging): \circled{42} If $(a, c)$ and $(b, c)$ are in $\arr(C)$, add $\{a, b\}$ to $\warr(C)$ in case it is not there already.}
		%\NB{Cannot do this as it would create merge arrows between e.g. $x$ and $g(x)$, $g$ colored (see 210g and 210g')}

		%Also (forward merging): \circled{43} If $(a, b)$ and $(a, c)$ are in $\arr(C)$, add $\{b, c\}$ to $\warr(C)$ in case it is not there already. \NB{not sure if we can do this actually and if it's used somewhere}

		\comm{not finished: If $y$ occurs grey in $C_i$ and colored at $\bhat y$ in the resolved literal, 
		$y \sigma = t\occur{x}$ for some variable $x$, then add an arrow to $\arr(C)$}

		\hl{feasible} Backwards merge case 1:\todo{necessary special case}{} if for variables $x,y,z$
		and the unifier $\sigma$ of the resolution step we have that $x$ occurs grey in $z\sigma$ and $x$ occurs \emph{colored} in $y\sigma$, then add an arrow from every grey occurrence of $z$ to every \emph{grey} occurrence of $y$. \NB{this is a composition of case 3 and case 4, if merge edges are interpreted as needed here.}

		\hl{infeasible} Backwards merge case 1':\todo{necessary special case}{} if for variables $x,y,z$
		and the unifier $\sigma$ of the resolution step we have that $x$ occurs grey in $z\sigma$ and $x$ occurs \emph{grey} in $y\sigma$, then add an arrow from every grey occurrence of $z$ to every \emph{colored} occurrence of $y$ (this is also not visible after lifting).

		\hl{infeasible} Backwards merge case 2:\todo{necessary special case}{} 
		same as 1, but also add arrows from every grey occurrence of $z$ to every \emph{colored} occurrence of $y$ (which is not visible after lifting. Maybe we can work in $\AIde$/$\AI^\Gamma$).

		\hl{feasible} Backwards merge case 3:\todo{necessary special case}{} 
		If $x$ occurs \emph{colored} in $y\sigma$, then add an arrow from every grey occurrence of $x$ in $C$ to every grey occurrence of $y$.

		\hl{feasible} Backwards merge case 4:\todo{necessary special case}{} 
		If $x$ occurs \emph{grey} in $y\sigma$, then add a merge edge from every grey occurrence of $x$ in $C$ to every grey occurrence of $y$ (this is a renaming).

		\comm{(deprecated, unused) special case 210g':
		If a variable $x$ occurs grey in $C$ and for some other variable $y$ in $C$ with a grey occurrence we have that $y\sigma = t\occ{x}$, then add $(x, y)$ to $\arr(C)$.
	}
		
	

		In the graph-theoretic view, this should mean that if terms $t$ and $t'$ are from $l$ and $l'$ respectively and unified, then their components are to be merged.

		Note that $C$ in $\mathcal{X}(C)$ denotes the position in the proof, not the set of possible positions of arrows.
		This is because some literals are removed from the clause but not added to the interpolant, but their arrows can still matter by transitivity (cf.~example TODO).

	\item Factorisation. $C_1: D \lor l \lor l'$, $\sigma = \mgu(l, l')$, then $C: (D\lor l)\sigma$.

		Merge arrows in literal.

		For $\mathcal{X} \in \{\arr, \warr\}$:

		$\mathcal{X}(C) \stackrel{\operatorname{def}}{=} \mathcal{X}(C_1) \cup \{(a,c) \mid ((a,b)\in\mathcal{X}(C_1) \land \poslit(c) = l \land \posterm(c) = \posterm(b) \land \poslit(b) = l') \lor \text{\dots~other cases \dots}\}$


\end{enumerate}

\begin{conj}
	The position of arrows always ``exists'', i.e.~is not destroyed by lifting. If the literal occurs in $C$ or $\AI(C)$, then it points to some term whereever it exists.
	\mytodo{write about that if the position exists in $C$ and $\AI(C)$, then the terms are the same, probably it's best to refer to some lemma}
\end{conj}

\subsection{$\aiu$}

$\aiu$ is a function which calculates a substitution, which is used to ensure that the lifting variables occurring $\AIclause$ are equal when the corresponding literals in the derivation are. This is necessary for resolved literals or factorised literals.

Let $A(a_1, \dotsc, a_n)$ and $A(b_1, \dotsc, b_n)$ be literals.

$\aiu(A(a_1, \dotsc, a_n), A(b_1, \dotsc, b_n)) \defeq \bigcup_{i=1}^n \aiu(a_i, b_i)$

$ \aiu (a\fromclause, b\fromclause) \defeq$\newline
$
\begin{cases}
	\bigcup_{j=1}^n \aiu(s_j, t_j) & \text{if $a\cl=f_s(\bar s)$ grey and $b\cl = f_t(\bar t)$ (includes $f_s$ being a constant)} \\
	\{x_j \mapsto x_m, x_k \mapsto x_m\} & \parbox[t]{.6\textwidth}{if $a\cl = x_j$ and $b\cl = x_k$, both lifting variables, and $x_m$ is the corresponding lifted term in the unified literal, i.e. $x_m = \lifboth{a\sigma} = \lifboth{b\sigma}$.
	{\tiny

		%More formally, $p = \pos(a) = \pos(b)$ and $\pos(\poslit(\lifboth{l\sigma}).\posterm(p)) = \pos(\poslit(\lifboth{l'\sigma}).\posterm(p)) = t_m$ and $\lifboth{t_m} = x_m$.

}}\\
\id & \text{if $\lifboth{a\sigma} = \lifboth{b\sigma} = x_j$ }
\end{cases} $


\subsection{$\AImatrix$ and $\AIclause$}

Here, we define $\AImatrix$, which represents the \emph{matrix} of what will be the interpolant, and $\AIclause$, which represents the \emph{clauses} in the refutation applied with the same unifications as $\AImatrix$.

\begin{enumerate}
	\item 
		For each initial clause $C$:

		$\AImatrix(C) = \PI(C)$ (i.e.~$\bot$ if the clause is from $\Gamma$ and $\top$ if the clause is from $\Delta$)

		$\AIclause(C) = \lifboth{C}$

	\item
		For each $C$ resulting from a resolution step from $C_1: D\lor l$ and $C_2: E\lor \lnot l'$ to $C = (D \lor E)\sigma$ with $l\sigma = l'\sigma$ with prop interpolant $\PI(\cdot)$:

		%literal to put in $\AImatrix$ is defined as $x_i =\lifboth{l\sigma} = \lifboth{l'\sigma}$
		%$l^\circ\dotsc$ literal to put in $\AImatrix$ is defined as $x_i =\lifboth{l\sigma} = \lifboth{l'\sigma}$

		\begin{description}
			\item[Formal definition.]

				Let 
				$\lifboth{l\cl\sigma} = A(a_1, \dotsc, a_n)$, $\lifboth{l\cl'\sigma} = A(b_1, \dotsc, b_n)$

				$\tau = \aiu(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma})$

				$\AIclause(C) =
				\lifboth{\Big( (\AIclause(C_1) \setminus \{l\fromclause\}) \lor (\AIclause(C_2)\setminus \{l\fromclause'\}) \Big)\sigma} \tau$ 



				\begin{itemize}
					\item if $l$ and $l'$ don't have the same color:

						$\AImatrix(C) =
						(\lnot {\lifboth{l'\fromclause\sigma}\tau} \land \lifboth{\AImatrix(C_1)\sigma}\tau) \lor
						(\lifboth{l\fromclause\sigma}\tau \land \lifboth{\AImatrix(C_2)\sigma) }\tau
						$


						%$\AImatrix(C) =
						%\lifboth{\Big( (\lnot l \land \AImatrix(C_1)) \lor (l \land \AImatrix(C_2)) \Big) \sigma} $


						%		$\left.\begin{tabular}{l}
						%		$\AImatrix(C) = \lifboth{\AImatrix(C)' \sigma}$\\

						%		$\AIclause(C) = \lifboth{\AIclause(C)' \sigma}$
						%\end{tabular}\right\} \lifboth $ with same overbinding!


						%				$\lifboth{ \AImatrix(C)' \lor \AIclause(C)' } = \underbrace{\lifboth{ \AImatrix(C)' }}_{\AImatrix(C)} \lor \underbrace{\lifboth{\AIclause(C)'}}_{\AIclause(C)}$ 


					\item if $l$ and $l'$ are $\Gamma$-colored :

						%$\AImatrix(C) = \lifboth{( \AImatrix(C_1) \lor/\land \AImatrix(C_2) )\sigma}$
						%as above but with  $\AImatrix(C)' = \Big(\AImatrix(C_1) \lor \AImatrix(C_2)\Big)\sigma$
						$\AImatrix(C) = \lifboth{\Big(\AImatrix(C_1) \lor \AImatrix(C_2)\Big)\sigma} \tau$
					\item if $l$ and $l'$ are $\Delta$-colored:

						%as above but with  $\AImatrix(C)' = \Big(\AImatrix(C_1) \land \AImatrix(C_2)\Big)\sigma$
						$\AImatrix(C) = \lifboth{\Big(\AImatrix(C_1) \land \AImatrix(C_2)\Big)\sigma} \tau$


				\end{itemize}

			\item[Prose explanation of formal definition.]
				$l\sigma = l'\sigma$, but $l\fromclause$ and $l\fromclause'$ might have been overbound with different variables. Still, they in a sense refer to the same ground literal, so we ``can just'' ``unify'' them.

				Shape must be the same in the sense that grey terms are the same, otherwise there is $\Phi$-replacing-var vs $\Phi$-replacing-var (let arbitrary one win) or $\Phi$-term and $\Phi$-term (replace both with same var). 
				($\Phi$-replacing-var vs $\Phi$-term cannot happen as $\Phi$-term is overbound as it has to be colored as otherwise the terms wouldn't unify).
				Also apply these to substitutions in $\AIclause$ and $\AImatrix$ here.

				$\aiu$ is defined on lifted terms of $\lifboth{l\fromclause\sigma}$ and $\lifboth{l\cl'\sigma}$, where the literals $l\fromclause$ and $l\fromclause'$
				occur in $\AIclause(C_1)$, $\AIclause(C_2)$ such that for their corresponding $l$ and $l'$, $l\sigma = l'\sigma$.
				Note that if one of the arguments of $\aiu$ has assigned a color, the other one either has none or the same color.
				There cannot be a conflict as otherwise their original form would not be unifiable.

				Note that $\aiu(a, b)$ is well-defined, i.e.~never maps a variable to two different values as each occurrence of some $x_j$ refers to a term with possible free variables, and since across the definition of $\aiu$, always the same substitution $\sigma$ is used as reference, every occurrence of $x_j$ will be mapped to the same variable. (NOTE: this is what yet unproven conjectures in the other pdf are trying to formalize.)


				$l\cl$ and $l'\cl$ are as they occur in $\AIclause(C_1)$ and $\AIclause(C_2)$. As the actual terms in the clause unify, we know that here, at least all terms have proper color after unification/lifting.


		\end{description}

	\item Factorisation. $C_1: D \lor l \lor l'$, $\sigma = \mgu(l, l')$, then $C: (D\lor l)\sigma$.

		$\tau = \aiu(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma})$

		$\AImatrix(C) = \lifboth{\AImatrix(C_1)\sigma}\tau$

		$\AIclause(C) = \lifboth{ \big(\AIclause(C_1) \setminus \{l'\cl\}\big)\sigma}\tau$



\end{enumerate}

\subsection{$\AI$}


$\AI(C) = Q_1 u_1 \ldots Q_m u_m \Big( \AImatrix(C) \lor \AIclause(C) \Big)$

where $u_1, \ldots, u_m$ are comprised of all lifting variables $x_i$ and $y_i$ in $\AImatrix(C)$.

\comm{there are free variables in $\AImatrix(C)$, which are ``implicitly'' universally quantified.}

$Q_i$ is $\exists$ if $u_i = y_i$ for some $i$, $\forall$ if $u_i = x_i$ for some $i$.

\subsubsection{Quantifier ordering -- components}
see corresponding pdf

\subsubsection{Quantifier ordering -- deprecated}

%Combine dependencies of positions which are connected by weak arrows:
All ``nodes'' connected by merge edges describe the same arrows, i.e.~collapse the nodes to a supernode merging the arrows:

%$\arr' =  \arr \union \{(a, c) \mid (a, b) \in \arr \land \{b, c\} \in \warr\} \union \{(a, c) \mid (b, c) \in \arr \land \{a, b\} \in \warr\} $

$\arr'(C) = \{ (a,c) \mid  (a,c) \in  \arr(C) \spam\lor ((a,b) \in \arr(C) \land \{b, c\} \in \warr(C) ) \spam\lor  ((c, b) \in \arr(C) \land \{a, c\} \in \warr(C)) \}$

%\union \{(a, c) \mid (a, b) \in \arr \land \{b, c\} \in \warr\} \union \{(a, c) \mid (b, c) \in \arr \land \{a, b\} \in \warr\} $

$\arrFinal(C) = \operatorname{TransitiveClosure}(\arr'(C))$

The quantifiers are ordered such that $u_i \ltArrC u_j$ implies that $u_i$ is quantified before $u_j$ is.

%$(p_1, p_2) \in \arrFinal(C)$ implies that $u_i$ occurs before $u_j$ in the quantifier prefix if $u_i$ is contained in $\pos(p_1)$ and  $u_j$ is contained in $\pos(p_2)$.


\largered{conjecture: arrow matters for maximal colored terms which are subterms of where the arrow points to}

\begin{defi}[Arrow paths]
	For two terms $s$ and $t$, $s\apath t$ holds if there is some $(p_1, p_2) \in \arrFinal(C)$ such that $s$ is contained in $\pos(p_1)$ and $t$ is contained in $\pos(p_2)$. $s\notapath t$ holds if $s\apath t$ does not hold.

	For two terms $s$ and $t$, $s\mpath t$ holds if there is some $(p_1, p_2) \in \marr(C)$ such that $s$ is contained in $\pos(p_1)$ and $t$ is contained in $\pos(p_2)$.
 $s\notmpath t$ holds if $s\mpath t$ does not hold.
\end{defi}

\begin{defi}[Arrow-induced ordering on lifting variables]
	For two lifting variables $u_i$ and $u_j$, $u_i \ltArrC u_j$ holds if $u_i \apath u_j$.
\end{defi}

\begin{conj}
	$\arrFinal$ is acyclic and irreflexive.
\end{conj}


\clearpage

\section{proof of propositional aspect of $\AI$}

The following lemma works in the other proof, but the remark below shows why it is not applicable here:

\begin{lemma}[Restated from proof without propositional refutation, lemma 1] 
	\label{lemma:lift_subst_commute}
	Let $C$ be a clause and $\sigma$ a substitution.
	Let $\colterm{1},\ldots,\colterm{n}$ be all maximal $\Delta$-terms in this context, i.e.\ those that occur in $C$ or $C\sigma$,  and
	$x_1, \ldots, x_n$ the corresponding fresh variables to replace the $\colterm{i}$ (i.e.~none of the $x_i$ occur in $C$).
	Define $\sigma'$ such that for a variable $z$,
	\[
		z \sigma' =
		\begin{cases} 
			x_l & \text{ if } z = x_k \text{ and } \colterm{k}\sigma = \colterm{l}  \\
			\lif{z\sigma} & \text{ otherwise}
		\end{cases} 
	\]

	Then
	$\lif{C\sigma} =
	\lif{C}\sigma'$.
\end{lemma}

\begin{remark}[Restriction of Lemma \ref{lemma:lift_subst_commute}]
	Lemma \ref{lemma:lift_subst_commute} does not hold in case $x_i$ occurs in $C$.
	This can easily be seen using the following counterexample:


	Let $\sigma = \{x \mapsto a\}$ and $\colterm{1} = f(x)$ and $\colterm{2} = f(a)$. 
	Then clearly $\colterm{1}\sigma = \colterm{2}$ and therefore $x_1\sigma' = x_2$.

	But now consider $x_1 \sigma$. 
	As $x_1$ has its place in the domain of variables to replace colored terms, and $\sigma$ is taken from a resolution refutation, they do not affect each other. 
	Hence $x_1\sigma = x_1$ and therefore $\lifdelta{x_1\sigma} = x_1$, but $\lifdelta{x_1}\sigma' = \lifdelta{x_1}\sigma' = x_2$.


	However such a situation arises naturally if we lift colored terms after every step of the interpolant extraction procedure, as there, the intermediate relative interpolants clearly contains variables to overbind terms, but we also need to treat terms that enter the interpolant by means of unification.
\end{remark}

\begin{lemma}[corresponds to Lemma 4.8 in thesis and Lemma 11 in Huang]
	\label{lemma:lift_logic_commute}
	Let $A$ and $B$ be first-order formulas and $s$ and $t$ be terms. Then it holds that:
	\begin{enumerate}
		\item $\lift{\Phi}{\lnot A}{x} \semiff{} \lnot \lift{\Phi}{A}{x}$
		\item $\lift{\Phi}{A \circ B}{x} \semiff{} ( \lift{\Phi}{A}{x} \circ \lift{\Phi}{B}{x} )$ for  $\circ \in     \{\land, \lor\}$
		\item $\lift{\Phi}{s = t}{x} \semiff{} ( \lift{\Phi}{s}{x} = \lift{\Phi}{t}{x} )$
	\end{enumerate}
\end{lemma}



\begin{lemma}
	\label{lemma:no_colored_terms}
	$\AImatrix(C)$ and $\AIclause(C)$ contain only grey terms and variables replacing colored terms. They do not contain colored terms.
	\comm{true and used}
\end{lemma}
\begin{proof}
	$\AImatrix(C)$ and $\AIclause(C)$ contain only terms of the form $\lifboth{t}\tau$ for some term $t$.
	The lifting replaces any colored term by a lifting variable, and $\tau$ merely exchanges lifting variables for other lifting variables.
\end{proof}



\begin{corr}
	\label{corr:lift_ai}
	For a clause $C$ in a resolution refutation $\pi$ of $\Gamma \cup \Delta$:
	\begin{compactenum}
	\item $\AImatrix(C) = \lifboth{\AImatrix(C)}$.

	\item $\AIclause(C) = \lifboth{\AIclause(C)}$.
	\end{compactenum}
	\comm{true and unused}
\end{corr}

\begin{lemma}
	\label{lemma:no_lifting_vars_in_subst}
	Lifting variables do not occur in any substitution of a resolution refutation.
	\comm{true and used, also generally relevant}
\end{lemma}

\begin{lemma}
	\label{lemma:substitute_and_lift}
	Let $F$ be a formula without colored terms such that for a set of formulas $\Phi$, $\Phi \entails F$.
	Then $\Phi \entails \lifboth{F\sigma}$ for a substitution $\sigma$.
\end{lemma}
\begin{proof}
	Note that substitutions only replace variables. Term positions, which are replaced by grey terms by $\sigma$ are not affected by the lifting and hold due to being special cases of~$F$.

	Term positions, which are replaced by colored term by $\sigma$ are again reduced to variables.
	All occurrences of a certain variable in $F$ are substituted by the same term, so as the lifting replaces a certain term always be the same variables, all these occurrences of the variable are replaced by the same variable.
\end{proof}

\begin{exa} 
	\label{exa:lifting_var_refers_to_different_term}
	We illustrate that the given procedure, if a lifting variable $x_k$ occurs in $\AIclause(C)$, it does not necessarily mean that $\colterm{k}$ occurs in $C$:

	$\Gamma = \{P(f(x))\lor Q(x)\}$

	$\Delta = \{\lnot P(y), \lnot Q(a)\}$
	\begin{prooftree}
		\AxiomCm{ \bot \mid P(x_1)\lor Q(x) \comm{P(f(x) \lor Q(x) }}
		\AxiomCm{ \top \mid \lnot P(y) }

		\BinaryInfCm{ P(x_1) \mid Q(x) }

		\AxiomCm{ \top \mid \lnot Q(y_1) \comm{Q(a)} }

		\BinaryInfCm{  Q(y_2) \lor P(x_1) \mid \square }
	\end{prooftree}
	Here, $x_1$ first refers to $f(x)$ and later to $f(a)$.
	This however is not essential for the correctness of the procedure, and it would be tedious to fix all such $x_1$ see also corresponding remark in case distinction in Lemma~\ref{lemma:literal_in_clause_similar}.
\end{exa} 

\begin{conj}
	$\aiu$ is well defined:
	In a call of $\aiu(a\cl, b\cl)$, if one of the arguments is a lifting variable of a certain color, then so is the other.
\end{conj}


\begin{lemma} 
	\label{lemma:literal_in_clause_similar}
	If a literal $l$ occurs in a clause $C$ of a resolution refutation,
	then $\AIclause(C)$ contains a corresponding literal $l\fromclause$ such that $l\fromclause \sim \lifboth{l}$, where $\sim$ means equal up to the index of lifting variables.
	\comm{true and used}
\end{lemma}
\begin{proof}
	Base case: By Definition of $\AIclause$.

	The induction cases for resolution and factorisation are very similar. These are the different beginnings, the rest of the proof is the same for both:\todo{how to write this more formally?}

	\begin{itemize}
		\item
			Let $C$ be the result of a resolution step from $C_1: D\lor l$ and $C_2: E\lor \lnot l'$ to $C = (D \lor E)\sigma$.
			Let $\lambda$ be a literal w.l.o.g.\ in $C_1$ such that a literal derived from it occurs in $C$ (hence $\lambda \neq l$). 
			%Every literal of $C$ is derived from a literal in $C_1$ or $C_2$. Let $\lambda$ be a literal in $C_1$. The case for a literal in $C_2$ is analogous.
			%Note that $\lambda \neq l$ as otherwise $\lambda$ would not be contained in $C$.

		\item
			Let $C$ be the result of a factorisation of $C_1: D \lor l \lor l'$ with $\sigma = \mgu(l, l')$ to $C = (D \lor l)\sigma$. 
			Let $\lambda$ be a literal w.l.o.g.\ in $C_1$ such that a literal derived from it occurs in $C$ (hence $\lambda \neq l'$). 
	\end{itemize}


	By assumption $\lambda \in C_1$. Then by the resolution rule application, $\lambda\sigma \in C$.

	\newcommand{\lclOne}{\lambda\cl}
	By the induction hypothesis, there is a $\lclOne \in \AIclause(C_1)$ such that $\lclOne \sim \lifboth{\lambda}$.
	By the definition of $\AIclause$, $\lifboth{\lclOne\sigma}\tau \in \AIclause(C)$ 
	with $\tau = \aiu(l, l')$.

	So we have to show that $\lifboth{ \lambda \sigma }  \sim \lifboth{\lambda\cl\sigma}\tau$.

	Remark on $\tau$: $\tau$ only replaces lifting terms by other lifting by other lifting terms
	\NB{this is where variable indices may not match.}

	We perform an induction on the depth of terms in $\lambda$ (except the non-maximal colored terms). Note that as $\lambda$ occurs in a clause of the refutation, it does not contain lifting variables.
	\begin{itemize}
			\begin{comment} NO LIFTING VARS!
			\item Suppose $t$ is a term of size $1$ in $\lambda$ and it is a lifting variable, say $z_i$.
				Then by Lemma~\ref{lemma:no_lifting_vars_in_subst}, $t\sigma = t$ and also $\lifboth{t\sigma} = t$.

				As by the induction hypothesis $t\fromclause \sim \lifboth{t}$, $t\fromclause =z_j$ for some $j$.
				Hence, $\lifboth{t\cl\sigma} = t\cl$.
				By the remark on~$\tau$,
				$\lifboth{t\sigma} \sim \lifboth{t\cl\sigma}\tau$.
			\end{comment}

		\item Suppose $t$ is a term of size $1$ in $\lambda$ and it is a non-lifting variable, say $u$.
			%Suppose that $\sigma$ is trivial on $u$. Then $\lifboth{u\sigma} = u \sim u\cl = \lifboth{u\cl\sigma} = \lifboth{u\cl\sigma}\tau$.

			%Otherwise suppose that $\sigma$ is not trival on $u$.
			As $\lifboth{u}\sim u\cl$ and $u$ is a variable, $u = u\cl$.
			But then $u\sigma = u\cl\sigma$ and also $\lifboth{u \sigma} = \lifboth{u\cl\sigma}$, so clearly 
			$\lifboth{u\sigma} \sim \lifboth{u\cl\sigma}\tau$.

			%Note that by the induction hypothesis, we get the desired relation for possible subterms of $u\sigma$.
			%Suppose that $u\sigma$ is a grey term. Then $\lifboth{u\sigma} = u\sigma$. 
			%Furthermore as $\lifboth{u} = u$, $\lifboth{u}\sigma = u\sigma$. Hence $\lifboth{u\sigma} = \lifboth{\lifboth{u}\sigma}$. 
			%As $\tau$ again only replaces variables which replace colored terms by other variables of the same kind, the induction holds in this case. \NB{$\tau$ stuff again}


		\item Suppose $t$ is a term of size $1$ in $\lambda$ and it is a constant.

			Suppose $t$ is grey. Then it is unaffected by both liftings and substitutions, so we are done.

			Suppose $t$ is colored.
			Then $\lifboth{t\sigma}$ is a lifting variable, but 
			as $t\cl = \lifboth{t}$, so is $\lifboth{t\fromclause\sigma}\tau$.

			\NB{From the point on where $t$ was lifted, $t\cl$ even always refers to exactly the lifting var $\lifboth{t} = x_k$ for some $k$ (just the term in the refutation may change).
			Cf.\ Lemma~\ref{lemma:jka5a5halat}. Hence this case is no obstacle to showing the statement with $\lifboth{t}=t\fromclause$ (and not just $\lifboth{t}\sim t\cl$).}


		\item Suppose $t$ is of the form $f(t_{1}, \dotsc, t_{n})$ in $\lambda$.
			Then by the induction hypothesis, $\lifboth{t_{i}\sigma} \sim \lifboth{(t_{i})\fromclause\sigma}\tau$ for $1 \leq i \leq n$.
			\begin{compactitem}
			\item Suppose $f$ is grey.
				Then $f$ is neither affected by substitutions nor by liftings.

			\item Suppose $f$ is colored.
				We only consider the case of occurrences of maximal colored terms as the other ones are discarded by the lifting.
				As $t\cl \sim \lifboth{t}$, $t\cl$ is a lifting variable. Hence also $\lifboth{t\cl\sigma}\tau$ is a lifting variable.
				But so is $\lifboth{t\sigma}$.
				\qedhere

				\NB{Note that even if it was the case that $\lifboth{t}=t\fromclause$ (and not just $\lifboth{t}\sim t\cl$), $\lifboth{t\sigma}$ might not be equal to $\lifboth{t\fromclause\sigma}$, but only $\lifboth{t\sigma} \sim \lifboth{t\fromclause\sigma}$.

					E.g.\ $t = f(x)$, $\lifboth{t} = x_1$, $t\cl = x_1$, $\sigma = \{x\mapsto a\}$. 
					Then $\lifboth{t\sigma} = \lifboth{f(a)} = x_2$, but $\lifboth{t\cl\sigma} = x_1$.
					$\tau$ does not fix this, but could potentially if it is more careful than $\sigma'$.
					See also Example~\ref{exa:lifting_var_refers_to_different_term}.
				}

			\end{compactitem}
	\end{itemize}
\end{proof}

\begin{exa}
	TODO: example with terms in $\pi$ vs $AI$, similar to 206a and last part of 208a:

	$f(x)$ vs $ x_j $

	$f(g(y))$ vs $ x_j $ (actual term is changed but lifting variable stays the same

	$f(g(h(z)))$ vs $ x_k $ (now $x_j$ appears in resolution, either this occurrence or another occurrence of this var)

	$f(g(h(a)))$ vs $ x_k $ (again actual term is changed without changing the lifting variable)
\end{exa}

By Lemma~\ref{lemma:literal_in_clause_similar}, we have that $l\cl \sim \lifboth{l}$.
But we can also show that the terms in $l$ only become more specialised, i.e.\ if a lifting variable $z_j$ occurs in $l\cl$, the corresponding term in $\lifboth{l}$ is a specialisation of $\colterm{j}$, 
\begin{lemma}
	\label{lemma:lifting_var_refers_to_abstraction_of_term}
	Let $a\cl = z_j$ a lifting variable for a term position $a\cl$ in $\AIclause(C)$. Then $a = \colterm{j}\rho$ for some substitution $\rho$.
	Even more, if a substitution $z_j\mapsto z_k$ for lifting variables $z_j$ and $z_k$ occurs,
	$z_k$ refers to exactly $\colterm{k}$ and there exists a substitution $\rho'$ such that $\colterm{k} = \colterm{j}\rho'$.
	\comm{used}
\end{lemma}
\NB{this probably also hold in $\AImatrix$ and for terms not occurring $\AIclause$ as well.}
\begin{proof}
	Base case:
	$z_j$ is introduced to lift $\colterm{j}$, $\rho$ is the identity function.

	Induction step:
	Suppose $z_j$ refers to $\colterm{j}\rho$ for some $\rho$.

	Suppose $\colterm{j}\rho$ changes in the course of the resolution derivation.
	As it is a term in a resolution derivation, it changes only by means of unification, say by the unifier $\sigma$.
	Hence it changes to $\colterm{j}\rho\sigma$ and $z_j$ refers to $\colterm{j}\rho\sigma$.

	Suppose $z_j$ changes. By the construction of $\AIclause$/$\AImatrix$, lifting variables are not affected by the resolution unifications (cf.\ Lemma~\ref{lemma:no_lifting_vars_in_subst}) or the liftings, but only by $\tau$.

	Suppose $(z_j\mapsto z_k)\in \tau$.
	Then by the definition of $\aiu$, the term at position $a$ is now $\colterm{k}$. 
	As by the induction hypothesis $a = \colterm{j}\rho$ in the preceding clause, $a\sigma = \colterm{k}$.
	Hence $\colterm{j}\rho\sigma = \colterm{k}$.
\end{proof}



\begin{comment}
	\cbstart
	\begin{lemma}[Strenghtening of \ref{lemma:literal_in_clause_similar}]
		\label{lemma:literal_in_clause_similar_strenghtened}

		If $s\cl$ is a lifting variable $z_i$ and $\lifboth{s} = z_j$ (i.e.\ $s=\colterm{j}$),
		then there is a substitution $\rho$ such that $\colterm{i}\rho = \colterm{j}$.
	\end{lemma} 
	\begin{proof}
		Note that if $i=j$, the $\rho$ is the identity function.

		Note that by Lemma~\ref{lemma:literal_in_clause_similar}, $s\cl \sim \lifboth{s}$.

		At some point in the resolution proof, $s\cl = z_i$ was introduced in $\AIclause(C^*)$ for a clause $C^*$. 
		Hence the corresponding term in $C^*$ is $\colterm{i}$.

		In the resolution derivation, $\colterm{i}$ is, in general, changed by means of substitution, so $s$ in later stages of the proof refers to $\colterm{i}\sigma^*$ for some $\sigma^*$.

		If $z_i$ is never affected by $\tau$, we are done.

		Suppose that at the position of $s\cl$, $z_k$ is introduced and later changed to $z_i$.
		We have to show that there is a substitution $\rho$ such that $\colterm{k}\rho = \colterm{i}$.
		See Lemma~\ref{lemma:tau_is_specialisation}.
	\end{proof}
	\cbend
\end{comment}



\begin{lemma}
	\label{lemma:disjoint_lifting_variables}
	The set of lifting variables, which refer to terms which have free variables, is disjoint for every incomparable clause.
	\comm{true but ok to have unused}
\end{lemma}
\begin{proof}
	The free variables for every initial clause is disjoint.
\end{proof}


The substitution $\tau$ establishes equality for the terms in the literals being resolved on (Lemma~\ref{lemma:literals_clauses_equal}) and a relation close to equality for other literals in the remaining clause (Lemma~\ref{lemma:literal_in_clause_similar}).
\begin{lemma}
	\label{lemma:literals_clauses_equal}
	%Let $l\fromclause$, $l\fromclause'$ be the literal in $\AIclause(C_1)$ and $\AIclause(C_2)$ corresponding to $l$ and $l'$ where 
	%$C$ is the result of a resolution step from $C_1: D\lor l$ and $C_2: E\lor \lnot l'$ to $C = (D \lor E)\sigma$
	%(i.e.~$l\sigma=l'\sigma$).


	Let $l$ and $l'$ be the literals resolved on in a resolution step with $l\sigma = l'\sigma$ or literals factorised in a factorisation step with $l\sigma = l'\sigma$.
	Let $\tau$ be as in the respective deduction step, i.e.\ $\tau = \aiu(\lifboth{l\fromclause\sigma}, \lifboth{l\fromclause'\sigma})$. Then $\lifboth{l\fromclause\sigma}\tau = \lifboth{l\fromclause'\sigma}\tau$.
	\comm{true and used}
\end{lemma}
\begin{proof} 
	Let $s\fromclause$ be a (sub-)term of a parameter of $l\fromclause\sigma$ and $t\cl$ the term at the same term position in $l\fromclause'\sigma$.
	Let $s$ and $t$ be their corresponding (sub)-term at the same term position in $l\sigma$ and $l'\sigma$.
	We show that $\lifboth{s\fromclause\sigma}\tau = \lifboth{t\fromclause\sigma}\tau$ by induction on the structure of $s\fromclause$ and $t\fromclause$ respectively.

	Note that by Lemma~\ref{lemma:no_colored_terms}, $s\fromclause$ and $t\fromclause$ do not contain colored terms. This also implies that only grey terms can contain subterms.

	By Lemma~\ref{lemma:literal_in_clause_similar}, $l\cl \sim \lifboth{l}$ and
	$l'\cl \sim \lifboth{l'}$. 

	\begin{description}
		\item[Lifting variables.]

			Suppose that $s\fromclause = z_i$ and/or $t\fromclause = z_j$ for some $i$ and $j$.
			Suppose that $s\fromclause \neq t\fromclause$ as otherwise we are done.
			%Hence $s\neq t$, but
			By the respective rule application $s\sigma = t\sigma$. Cases:
			\begin{compactitem}
			\item $s\fromclause = z_i$ and $t\fromclause = z_j$ with $i\neq j$.
				As $\sigma$ affects neither $s\fromclause$ nor $t\fromclause$,
				$\lifboth{s\fromclause \sigma}  = s\fromclause$ and
				$\lifboth{t\fromclause \sigma}  = t\fromclause$.
				We show that $s\fromclause\tau = t\fromclause\tau$.

				Note that the function $\aiu$ visits all subterms and combines all mappings it encounters.
				Hence $\aiu(s\fromclause, t\fromclause)$ is part of the final substitution $\tau$.
				However due to the just established circumstances, $\aiu(s\fromclause, t\fromclause) = \{z_i \mapsto z_m, z_j \mapsto z_m\}$ with $m$ as in the definition of $\aiu$, so $s\fromclause\tau = t\fromclause\tau$.
				\NB{this is the somewhat crude step where all lifting variables in the resolved literal are just reset.}

			\item W.l.o.g.~$s\fromclause = z_i$ and $t\fromclause$ is not a lifting variable.
				As $t\cl \sim \lifboth{t}$, $t$ is not a colored term.
				But due to $s\cl \sim \lifboth{s}$, $s$ is a colored term.
				As $s\sigma = t\sigma$, $t$ must be a variable and $t\sigma$ a colored term.
				So $\lifboth{t\sigma} = z_k$ for some $k$.
				Note that the function $\aiu$ visits all subterms and combines all mappings it encounters.
				By the construction of $\aiu$, at $\aiu(s\fromclause, t\fromclause)$, $\{ z_i \mapsto z_k \}$ is added.
				Therefore $\lifboth{s\fromclause\sigma}\tau = \lifboth{z_i\sigma}\tau = \lifboth{z_i}\tau = z_i\tau = z_k$.

				Due to $t\cl \sim \lifboth{t}$ and as $t$ is a variable, $t=t\cl$.
				Then $\lifboth{t\cl\sigma}\tau = \lifboth{t\sigma}\tau = z_k\tau$.

				It remains to show that $z_k\tau = z_k$.

				As $t$ is a variable and due to $t\sigma = \colterm{k}$ and as $\sigma$ is the most general unifier, it is necessary to substitute $\colterm{k}$ in order to unify the literals. 

				We continue with a proof by contradiction and suppose that $(z_k \mapsto z_l) \in \tau$. Let $k\neq l$ as otherwise we are done.
				%This situation only arises if $z_k$ occurs elsewhere (i.e., besides from $\lifboth{s\fromclause\sigma}\tau$) in one of the direct ancestors of $C$, i.e.\ $C_1$ or $C_2$. 
				By the definition of $\aiu$, $z_k$ must occur in either $\AIclause(C_1)$ or $\AIclause(C_2)$.
				Furthermore, at least one of the ancestors of $C_1$ or $C_2$, or $C_1$ or $C_2$ themselves, contains~$\colterm{k}$, as only this term is lifted using $z_k$.

				By Lemma~\ref{lemma:lifting_var_refers_to_abstraction_of_term}, $z_l$ refers to precisely $\colterm{l}$. %and there exists a substitution $\rho''$ such that $\colterm{k}\sigma = t_l$.
				As $z_l$ replaces $z_k$, and $z_k$ used to refer to $\colterm{k}$,
				%but as at the same position now $z_l$ refers to $\colterm{l}$,
				some sequence of substitutions occurred which changed $\colterm{k}$ to $\colterm{l}$.
				This sequence of substitutions has substituted at least one variable of $\colterm{k}$ as $\colterm{k}\neq\colterm{l}$.
				As the set of clauses is unique for a clause, this variable does not occur in the subsequent derivation.

				As however $\sigma$ introduces $\colterm{k}$ and therefore all of its variables as subterms, 
				$\colterm{k}$ has never been updated to $\colterm{l}$, but then $(z_k \mapsto z_l) \not\in \tau$.
				%By Lemma~\ref{lemma:jus\colterm{i}ntroduced_lifting_vars_not_affected_by_tau}, $z_k\tau = z_k$.

				%			But as $t\fromclause = \lifboth{t}$ and $t$ is a variable, $t\fromclause\sigma = s$.
				%Note that $\sigma$ does not affect $s\fromclause$.
				%So $\lifboth{t\fromclause\sigma} = \lifboth{s} =  s\fromclause = s\fromclause\sigma = \lifboth{s\fromclause\sigma}$ and also 
				%$\lifboth{t\fromclause\sigma}\tau = \lifboth{s\fromclause\sigma}\tau$.
			\end{compactitem}

		\item[Grey terms.]
			Suppose that at least one of $s\cl$ and $t\cl$ is a grey term.
			\begin{itemize}
				\item
					Suppose that both $s\fromclause$ and $t\fromclause$ are grey terms:
					By $s\fromclause = \lifboth{s}$ and 
					$t\fromclause = \lifboth{t}$, and as $s\sigma = t\sigma$, their outermost symbol is the same in all these terms.
					The equality of the parameters is established by the induction hypothesis.
					Note that grey constants can be treated as grey functions without parameters.

				\item
					Suppose that exactly one of $s\fromclause$ and $t\fromclause$ is a grey terms. W.l.o.g.~let $s\fromclause$ be a grey term. Then as $s\sigma=t\sigma$, $s\fromclause = \lifboth{s}$ and $t\fromclause = \lifboth{t}$, $t\fromclause$ is a variable and $t=t\cl$.
					Furthermore, $t\fromclause\sigma$ is a grey term. 
					Due to $s\sigma = t\sigma$, the outermost symbol of $s\cl$ and $t\cl$ is the same.
					Equality of potential parameters in $s\fromclause$ is established by the induction hypothesis.
			\end{itemize}


		\item[Variables.]
			Suppose that both $s\fromclause$ and $t\fromclause$ are variables. 
			Suppose that $\sigma$ is non-trivial on at least $s\fromclause$ or $t\fromclause$, as otherwise we are done.
			Due to $s\fromclause = \lifboth{s}$ and $t\fromclause = \lifboth{t}$, $s = s\fromclause$ and $t=t\fromclause$.
			As $s\sigma=t\sigma$,  the outermost symbol of both $s\fromclause\sigma$ is the same as the one of~$t\fromclause\sigma$. As the equality of potential parameters of $s\fromclause\sigma$ and $t\fromclause\sigma$ is established by the induction hypothesis, we are done.
			\qedhere
	\end{description}
\end{proof}

\newcommand{\clauseOnePrime}{\AIclause(C_1)^*}
\newcommand{\clauseTwoPrime}{\AIclause(C_2)^*}


\begin{lemma}
	\label{ref:gamma_entails_delta_terms_lifted}
	Let every $\Gamma$-term be grey. (To establish valid conditions, for each $\Gamma$-term $t$, add $P(t)$ to $\Delta$ where $P$ is a fresh predicate symbol. Then the resolution refutation is unaffected).
	Then
	$\Gamma \entails \AImatrix(C) \lor \AIclause(C)$.
\end{lemma}
\begin{proof}
	Proof by induction of the strengthening:
	$\Gamma \entails \AImatrix(C) \lor \AIclause(C_\Gamma)$.

	Base case:

	For $C \in \Gamma$, $\AImatrix(C) = \bot$ and $\AIclause(C) = \lifboth{C_\Gamma} = \lifgamma{C}$. As $\Gamma$-terms are not lifted, $\lifgamma{C} = C$ and $\Gamma \entails C$.

	For $C \in \Delta$, $\AImatrix(C) = \top$.

	Induction step:
	\begin{description}
		\item[Resolution.]\hfill
			\begin{prooftree}
				\AxiomCm{C_1: D \lor l}
				\AxiomCm{C_2: E \lor \lnot l'}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\BinaryInfCm{C: (D\lor E)\sigma}
			\end{prooftree}
			We introduce the following abbreviations:

			$ \clauseOnePrime = \AIclause((C_1)_\Gamma) \setminus \{\lifboth{(l{\fromclause})_\Gamma}\}$

			$ \clauseTwoPrime = \AIclause((C_2)_\Gamma)\setminus \{\lifboth{\lnot (l{\fromclause'})_\Gamma}\}$

			$\tau  = \aiu((l{\fromclause})_\Gamma, (l{\fromclause'})_\Gamma)$

			$\AIclause(C_\Gamma) =
			\lifboth{\Big( \clauseOnePrime \lor \clauseTwoPrime \Big)\sigma} \tau$.

			By Lemma~\ref{lemma:lift_logic_commute},
			$\AIclause(C_\Gamma) =
			\lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma} \tau$.

			By the induction hypothesis,
			$\Gamma \entails \AImatrix(C_i) \lor \AIclause({C_i}_\Gamma)$, $i\in\{1,2\}$, or expressed differently:


			$\Gamma \entails \AImatrix(C_1) \lor \clauseOnePrime \lor {(l{\fromclause})_\Gamma}$

			$\Gamma \entails \AImatrix(C_2) \lor \clauseTwoPrime \lor {\lnot (l{\fromclause'})_\Gamma}$

			By Lemma~\ref{lemma:no_colored_terms}, $\AImatrix(C_1)$ and $\AIclause(C_1)$ as well as $\AImatrix(C_2)$ and $\AIclause(C_2)$ do not contain colored terms.
			Hence by Lemma~\ref{lemma:substitute_and_lift}, Lemma~\ref{lemma:lift_logic_commute} and applying $\tau$, we get that 

			$\Gamma \stackrel{\markA}\entails \lifboth{\AImatrix(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{(l{\fromclause})_\Gamma\sigma}\tau$

			$\Gamma \stackrel{\markB}\entails \lifboth{\AImatrix(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau \lor \lnot \lifboth{(l{\fromclause'})_\Gamma\sigma}\tau$


			%Furthermore,
			%$\sigma = \mgu(l, l')$, so $\lifboth{l\sigma} = \lifboth{l'\sigma}$ and $\lifboth{l}\sigma' = \lifboth{l'}\sigma'$ by Lemma \ref{lemma:lift_subst_commute}.

			By Lemma~\ref{lemma:literals_clauses_equal}, $\lifboth{(l\fromclause)_\Gamma\sigma}\tau = \lifboth{(l{\fromclause'})_\Gamma\sigma} \tau$.

			\begin{itemize}
				\item If $l$ and $l'$ grey:

					$\AImatrix(C) =
					(\lnot {\lifboth{l\fromclause\sigma}\tau} \land \lifboth{\AImatrix(C_1)\sigma}\tau) \lor
					(\lifboth{l\fromclause\sigma}\tau \land \lifboth{\AImatrix(C_2)\sigma) }\tau
					$

					Suppose for a model $M$ of $\Gamma$ that $M \notentails \AIclause(C)$,
					i.e.~$M \notentails \lifboth{\AIclause(C_1)\sigma}\tau$ and $M \notentails\nolinebreak \lifboth{\AIclause(C_2)\sigma}\tau$ as otherwise we would be done.
					Then by \markA{} and \markB:

					$M \entails \lifboth{\AImatrix(C_1)\sigma}\tau \lor \lifboth{l{\fromclause}\sigma}\tau$

					$M \entails \lifboth{\AImatrix(C_2)\sigma}\tau \lor \lnot \lifboth{l{\fromclause'}\sigma}\tau$

					By Lemma~\ref{lemma:literals_clauses_equal}, $\lifboth{l\fromclause\sigma}\tau = \lifboth{l{\fromclause'}\sigma} \tau$.
					By a case distinction on the truth value of $\lifboth{l\fromclause\sigma}\tau$ in $M$, we obtain that $M \entails \AImatrix(C)$.


				\item If $l$ and $l'$ are $\Gamma$-colored:
					$\AImatrix(C) = \lifboth{\Big(\AImatrix(C_1) \lor \AImatrix(C_2)\Big)\sigma} \tau$

					By Lemma~\ref{lemma:literals_clauses_equal}, we can do a resolution step on $\lifboth{l\fromclause\sigma}\tau$ of \markA{} and \markB{} to arrive at 

					$\Gamma \entails \lifboth{\AImatrix(C_1)\sigma}\tau \spam\lor \lifboth{\clauseOnePrime\sigma}\tau\spam\lor 
					\lifboth{\AImatrix(C_2)\sigma}\tau\spam\lor \lifboth{\clauseTwoPrime\sigma}\tau $

					This however is by Lemma~\ref{lemma:lift_logic_commute} nothing else than
					$\Gamma \entails \AImatrix(C) \lor \AIclause(C)$

				\item If $l$ and $l'$ are $\Delta$-colored:
					$\AImatrix(C) = \lifboth{\Big(\AImatrix(C_1) \land \AImatrix(C_2)\Big)\sigma} \tau$

					As $l$ is $\Delta$-colored, \markA{} and \markB{} reduce to:

					$\Gamma \entails \lifboth{\AImatrix(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau$

					$\Gamma \entails \lifboth{\AImatrix(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau$

					But this implies that 

					$\Gamma \entails \Big(\lifboth{\AImatrix(C_1)\sigma}\tau \land \lifboth{\AImatrix(C_2)\sigma}\tau\Big) 
					\spam\lor \lifboth{\clauseOnePrime\sigma}\tau
					\spam\lor \lifboth{\clauseTwoPrime\sigma}\tau$

					This however is by Lemma~\ref{lemma:lift_logic_commute} nothing else than 
					$\Gamma \entails \AImatrix(C) \lor \AIclause(C)$.
			\end{itemize}


		\item[Factorisation.]\hfill
			\begin{prooftree} 
				\AxiomCm{C_1: D\lor l \lor l'}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\UnaryInfCm{C: (D\lor l)\sigma}
			\end{prooftree} 

			$\AImatrix(C) = \lifboth{\AImatrix(C_1)\sigma}\tau$

			$\AIclause(C) = \lifboth{ \big(\AIclause(C_1) \setminus \{l'\cl\}\big)\sigma}\tau$

			We define:
			$ \clauseOnePrime = \AIclause((C_1)_\Gamma) \setminus \{\lifboth{(l{\fromclause})_\Gamma}, \lifboth{(l'{\fromclause})_\Gamma}\}$

			By the induction hypothesis, we get that 
			$\Gamma \entails \AImatrix(C_1) \spam\lor \clauseOnePrime \spam\lor (l\cl)_\Gamma \spam\lor (l'\cl)_\Gamma $.
			By Lemma~\ref{lemma:no_colored_terms} and \ref{lemma:substitute_and_lift} and after applying $\tau$, we also have that
			$\Gamma \entails \lifboth{\AImatrix(C_1)\sigma}\tau \spam\lor\allowbreak \lifboth{\clauseOnePrime\sigma}\tau \spam\lor\allowbreak \lifboth{(l\cl)_\Gamma\sigma}\tau \spam\lor\allowbreak \lifboth{(l'\cl)_\Gamma\sigma}\tau $.

			By Lemma~\ref{lemma:literals_clauses_equal} and due to $l\sigma = l'\sigma$, we have that $\lifboth{l\sigma}\tau = \lifboth{l'\sigma}\tau$.
			Hence it is easy to see that 
			$\Gamma \entails \lifboth{\AImatrix(C_1)\sigma}\tau \spam\lor \lifboth{\clauseOnePrime\sigma}\tau \spam\lor \lifboth{(l\cl)_\Gamma\sigma}\tau $, which is nothing else than $\Gamma\entails\nolinebreak \AImatrix(C) \spam\lor \AIclause(C)$.

		\item[Paramodulation.]\hfill
			\begin{prooftree}
				\AxiomCm{C_1: D \lor s=t}
				\AxiomCm{C_2: E\occat{r}{p}}
				\RightLabelm{\quad\sigma = \mgu(s, r)}
				\BinaryInfCm{C: (D \lor E\occat{t}{p})\sigma}
			\end{prooftree}

			$\AImatrix(C) = (\lifboth{(s=t)\sigma}\tau \land \lifboth{\AImatrix(C_2)\sigma}\tau ) \spam\lor (\lifboth{(s\neq t)\sigma}\tau \land \lifboth{\AImatrix(C_1)\sigma}\tau )$

			$\AIclause(C) = \lifboth{ \Big(\AIclause(C_1) \setminus \{(s=t)\cl\} \lor \AIclause(C_2) \Big)\sigma}\tau $

			\mytodo{}

			\mytodo{}

			\mytodo{}

			\mytodo{}

			\mytodo{}

			\mytodo{}

			\mytodo{}

			\mytodo{}

			\mytodo{}




					\qedhere
	\end{description}
\end{proof}

\begin{conj}
	Lemma~\ref{ref:gamma_entails_delta_terms_lifted} basically calculates $\AI^\Delta$, where in $\AIclause$ and $\AImatrix$ instead of $\lifboth{\cdot}$ $\lifdeltanovar{\cdot}$ is employed.
	\mytodo{NEEDS A PROOF}
\end{conj}

\begin{lemma}
	\label{lemma:lifting_gamma_terms_from_aidelta}
	$\lifgamma{\AI^\Delta(C)} \sim \AI(C)$.
\end{lemma}
\begin{proof}
	Base case:
	\newcommand{\de}{^\Delta}
	$\AImatrix$ and $\AImatrix^\Delta$ coincide for initial clauses.
	$\AIclause(C) = \lifboth{C}$, $\AIclause\de(C) = \lifdeltanovar{C}$. By Lemma~4.9 (\verb+lemma:naming_of_colored_variables+) of the thesis, $\lifboth{C} \sim \lifgamma{\lifdeltanovar{C}}$.

	Induction step.
	$C$ is the result of a resolution step from $C_1: D\lor l$ and $C_2: E\lor \lnot l'$ to $C = (D \lor E)\sigma$.
	Suppose $\AI(C_1)\sim\AI\de(C_1)$ and $\AI(C_2)\sim\AI\de(C_2)$.

	$\AIclause$ is defined as follows:

	$\AIclause(C) = \lifboth{\Big( (\AIclause(C_1) \setminus \{l\fromclause\}) \lor (\AIclause(C_2)\setminus \{l\fromclause'\}) \Big)\sigma} \tau$ 

	$\AIclause\de(C) = \lifdeltanovar{\Big( (\AIclause\de(C_1) \setminus \{l\fromclausede\}) \lor (\AIclause\de(C_2)\setminus \{l\fromclausede'\}) \Big)\sigma} \tau$ 

	We consider the case of a grey literal $l$ for the induction step for $\AImatrix$ as it subsumes the others in this respect:

	$\AImatrix(C) =
	(\lnot {\lifboth{l\fromclause\sigma}\tau} \land \lifboth{\AImatrix(C_1)\sigma}\tau) \spam\lor
	(\lifboth{l\fromclause\sigma}\tau \land \lifboth{\AImatrix(C_2)\sigma) }\tau
	$

	$\AImatrix\de(C) =
	(\lnot {\lifdeltanovar{l'\fromclausede\sigma}\tau} \land \lifdeltanovar{\AImatrix\de(C_1)\sigma}\tau) \spam\lor
	(\lifdeltanovar{l\fromclausede\sigma}\tau \land \lifdeltanovar{\AImatrix\de(C_2)\sigma) }\tau
	$

	As $\AI(C_i)$ and $\AI\de(C_1)$ as well as
	$\AI(C_2)$ and $\AI\de(C_2)$ only differ in the index of the lifting variables, and by Lemma~\ref{lemma:no_lifting_vars_in_subst} lifting variables do not occur in $\sigma$, $\sigma$ has the same effect on both.
	Furthermore the lifting does not affect lifting variables and $\tau$ only renames lifting variables.

	So $\AIclause(C)$ and $\AIclause\de(C)$ as well as
	$\AImatrix(C)$ and $\AImatrix\de(C)$ 
	differ only in the index of the lifting variables and the presence of $\Gamma$-terms in $\AIclause\de(C)$.
	Hence lifing the $\Gamma$-terms gives the result.
	\NB{(not sure how this remark applies to $\AImatrix$, but it does apply to $\AIclause$) Here, we do not have that the set of occurrences of some lifting variable $z_j$ in $\AIclause\de(C)$ is the same as the set of occurrences of some lifting variable $z_{j'}$ in $\AIclause(C)$ and the other way around. This is because in $\AIclause\de(C)$, all equal $\Gamma$-terms receive the same lifting variable, but in $\AIclause(C)$, they might be different since $\tau$ only refers to a term OR its specialisation.}
\end{proof}


\begin{conj}
	$\Gamma \entails \AI(C)$. (Recall that $\AI(C) = Q_1 u_1 \ldots Q_m u_m \Big( \AImatrix(C) \lor \AIclause(C) \Big)$.)
\end{conj}
\begin{proof}
	\begin{comment}
		\begin{description}
			\item[Induction start.]
				For $C\in\Gamma$, $\AImatrix(C) = \bot$ and $\AIclause(C) = \lifgamma{C}$.
				Furthermore, the quantifier prefix is $\exists y_1 \dots \exists y_n $, where $y_1n\dotsc , y_n$ are the maximal $\Gamma$-terms of $C$.
				Hence as $\Gamma \entails C$, $C$ acts as witness for the existential terms in $\AIclause(C)$ and we get that $\Gamma \entails \exists y_1 \dots \exists y_n \AIclause(C)$.

				For $C\in \Delta$, $\Gamma \entails \AImatrix(C)$ as $\AImatrix(C) = \top$.

				$\AI(C) = Q_1 u_1 \ldots Q_m u_m \Big( \AImatrix(C) \lor \AIclause(C) \Big)$

			\item[Induction step.]
				$C$ is the result of a resolution step from $C_1: D\lor l$ and $C_2: E\lor \lnot l'$ to $C = (D \lor E)\sigma$.

				$ \clauseOnePrime = \AIclause((C_1)_\Gamma) \setminus \{\lifboth{(l{\fromclause})_\Gamma}\}$

				$ \clauseTwoPrime = \AIclause((C_2)_\Gamma)\setminus \{\lifboth{\lnot (l{\fromclause'})_\Gamma}\}$

				$\tau  = \aiu((l{\fromclause})_\Gamma, (l{\fromclause'})_\Gamma)$


				$\AIclause(C_\Gamma) =
				\lifboth{\Big( \clauseOnePrime \lor \clauseTwoPrime \Big)\sigma} \tau$.


				By Lemma~\ref{lemma:lift_logic_commute},
				$\AIclause(C_\Gamma) =
				\lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma} \tau$.

				By the induction hypothesis:

				$\Gamma \entails Q_1 z_1 \dots Q_m z_m \Big( \AImatrix(C_1) \lor \AIclause(C_1)  \Big)$

				$\Gamma \entails Q_1' z_1' \dots Q_{m'}' z_{m'}' \Big( \AImatrix(C_2) \lor \AIclause(C_2) \Big)$

				or, expressed differently:

				$\Gamma \entails  Q_1 z_1 \dots Q_m z_m \Big( \AImatrix(C_1) \lor \clauseOnePrime \lor {(l{\fromclause})_\Gamma}\Big)$

				$\Gamma \entails Q_1' z_1' \dots Q_{m'}' z_{m'}' \Big( \AImatrix(C_2) \lor \clauseTwoPrime \lor {\lnot (l{\fromclause'})_\Gamma} \Big)$
				\bigskip


				By the previous proof:

				$\Gamma \stackrel{\markA}\entails Q_1 z_1 \dots Q_m z_m \Big(\lifboth{\AImatrix(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{(l{\fromclause})_\Gamma\sigma}\tau \Big)$

				$\Gamma \stackrel{\markB}\entails Q_1' z_1' \dots Q_{m'}' z_{m'}' \Big(  \lifboth{\AImatrix(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau \lor \lnot \lifboth{(l{\fromclause'})_\Gamma\sigma}\tau \Big)$

		\end{description}
	\end{comment}

	By Lemma~\ref{ref:gamma_entails_delta_terms_lifted}, by considering $\Gamma$-terms to be grey, there is a ``witness formula'' 
	$\AImatrix(C) \lor \AIclause(C)$ which contains all $\Gamma$-terms and all $\Delta$-terms are lifted and implicitly universally quantified.

	By Lemma~\ref{lemma:lifting_gamma_terms_from_aidelta},
	$\lifgammanovar{\AI^\Delta(C)} \sim \AI(C)$.
	However if we now prefix $\lifgammanovar{\AI^\Delta(C)}$ with the quantifier block of $\AI(C)$ with the indices of lifting variables adapted, we obtain a formula which is equivalent to $\AI(C)$.
	It remains to show that $\lifgammanovar{\AI^\Delta(C)}$ with said quantifier block is entailed by $\Gamma$.

	As a $\Gamma$-term $\colterm{i}$ in general contains lifting variables which lift $\Delta$-terms, we have to ensure that these are quantified before $y_i$ is.
	However by Lemma~\ref{lemma:arrows_for_lifting_terms}, $x_j \ltArrC y_i$ for $x_j$ occurring in $y_i$.


	%	Note that this implies that in $C$, a $\Delta$-term is contained in a $\Gamma$-term.
	%	As the quantifier prefix is ordered according to the arrows, Lemma~\ref{lemma:arrows_for_lifting_terms} gives the result.

	\mytodo{In this formulation, all $\Gamma$-terms are overbound with the right lifting variable. 
		in $\AI(C)$, $x_k$ might not stand for $\colterm{k}$, so we do need to show here that every $x_k$ can be replaced by the same $\colterm{i}$ for some $i$ (which is a specialisation, might be important for the proof). 
		otherwise we can't generalise this to $\AI(C)$, it would only hold for $\lifgamma{\AI^\Delta(C)}$
	}
\end{proof}

\begin{defi}[Unification algorithm]
	Let $\id$ denote the identity function and $\textbf{fail}$ be returned by $\mgu$ in case the arguments are not unifiable. Treat constants as $0$-ary functions.
	Let $s$ and $t$ denote terms and $x$ a variable.

	The most general unifier $\mgu$ of two literals $l = A(s_1,\dotsc, s_n)$ and $l' = A(t_1,\dots, t_n)$ is defined to be $\mgu(\{ (s_1, t_1), \dotsc, (s_n, t_n)\})$.


	The $\mgu$ for a set of pairs of terms $T$ is defined as follows:

	$
	\mgu(\emptyset) = \id
	$

	\newcommand{\aatahfdgasdfg}{.4\textwidth}
	$
	\mbox{$\mgu(\{t\} \cup T)$} =
	%\mgu(\{t\} \cup T) =$
	\begin{cases}
		\mathbf{fail} 				& \parbox[t]{\aatahfdgasdfg}{if $t = (x, s)$ or $t=(s,x)$ and $x$ occurs in $s$ but $x\neq s$ } \\
		\mgu(T\subst{x/s})\subst{x/s} \cup \{x\mapsto s\} 		& \parbox[t]{\aatahfdgasdfg}{if $t = (x, s)$ or $t=(s,x)$ and $x$ does not occur in $s$ or $x=x$} \\
		\mathbf{fail} 				& \parbox[t]{\aatahfdgasdfg}{if $t = (f(s_1,\dotsc,s_n), g(s_1,\dotsc,s_n))$ with $f\neq g$} \\
		\mgu(T \cup \{(s_1, t_1), \dotsc, (t_n, s_n)\})		& \parbox[t]{\aatahfdgasdfg}{if $t = (f(s_1,\dotsc,s_n), f(t_1,\dotsc,t_n))$} \\
		\mgu(T) 							& \text{if $t=(s, s)$} \\
	\end{cases}
	$
	\qedhere
\end{defi}

\begin{defi}
	A term is called \defiemph{multicolored} if it contains both $\Gamma$- and $\Delta$-colored subterms.
\end{defi}
Note that a multicolored $\Phi$-term consequently is a term whose outermost symbol is $\Phi$-colored and contains a colored but not $\Phi$-colored subterm.


\begin{lemma}
	\label{lemma:mixed_colored_term_introduction}
	A resolution derivation can only contain multicolored $\Gamma$-term if there is a variable which has a $\Gamma$-colored occurrence and a grey occurrence in a clause. \comm{is nice and explains the approach, but is not used}
\end{lemma}
\begin{proof}
	Suppose no such variable exists in $\Gamma$ and $\Delta$.
	By the definition of the colors, no $\Gamma$-colored term initially contains a $\Delta$-colored term. We show that no resolution rule application can introduce one.

	As terms in clauses are only changed by means of unification, we have to show that no most general unifier $\sigma$ exists for any clauses derived from $\Gamma$ and $\Delta$ which introduces a $\Delta$-term in an existing $\Gamma$-term or a new $\Gamma$-term, which contains a $\Delta$-term.

	\begin{enumerate}
		\item
			\label{a5hsefdgsy6}
			Suppose a unifier $\sigma$ of two literals $l$ and $l'$ of $C_1$ and $C_2$ respectively introduces a multicolored $\Gamma$-term $s$ in $C$. 
			Then a variable $x$ occurs in $s$ such that $x\sigma = t$.
			By the unification algorithm, this implies that $x$ is directly unified with a term $t'$ which has the same outermost symbol as $t$.
			Note that clauses involved in a resolution step are variable disjoint, so $x$ only occurs in $C_1$ and its preceding clauses, but not in $C_2$. 
			Since $x$ has a $\Gamma$-colored occurrence, it does by assumption not have a grey occurrence. 
			Hence all occurrences of $x$ are of the form $r\occur{x}$, where the outermost symbol of $r$ is colored.
			As $x$ occurs in a $\Gamma$-term, it must originate from a clause in $\Gamma$.
			As by Lemma~\ref{lemma:variable_never_added} variables are never added in a resolution derivation, all $r\occur{x}$ must be $\Gamma$-colored terms.

			$\Gamma$- and $\Delta$-colored terms are not unifiable, so a unifier mapping $x$ to a $\Delta$-colored term must be created from a unification of a term of the form $r[x]$ and a $\Gamma$-term.
			But by assumption, no $\Gamma$-colored term contains a $\Delta$-colored term. 

			Hence there cannot be an $\mgu$ of $l$ and $l'$ which maps $x$ to a $\Delta$-colored term.


		\item
			Suppose a unifier $\sigma$ of two literals $l$ and $l'$ of $C_1$ and $C_2$ respectively introduces a multicolored $\Gamma$-term~$s$.
			As by assumption no such term $s$ exists in $C_1$ or $C_2$, the unification algorithm does not encounter it as term to unify a variable with directly. 

			This however does not exclude the case that a variable $y$ is unified first with a $\Gamma$-term containing a variable $x$, where later $x$ is unified with a $\Delta$-term. 
			However the argumentation in case~\ref{a5hsefdgsy6} excludes precisely the case that a variable, which is contained in a $\Gamma$-term, is unified with a $\Delta$-term.
			\qedhere
	\end{enumerate}
\end{proof}

\cbstart
\begin{conj}
	\label{lemma:variable_never_added}
	Variables are never added in a resolution derivation. 
	Hence if they are present in a clause $C$ at some point in the derivation, their position in the original clause has been a variable or has been contained in a variable in case a variable has been added inside of a term.
\end{conj}


\begin{conj}
	\label{lemma:arrow_from_grey_to_colored}
	In the course of a derivation, there always is an arrow between a grey occurrence of a variable $u$ and a colored occurrence of a variable $u$ in a clause. 
	\mytodo{The proof probably requires a handling of renamings (unifications of vars with other vars) and a discussion of introductions of occurrences of $u$ via unification.}
	\comm{used in main arrow proof}
\end{conj}



\begin{lemma}
	\label{lemma:arrow_for_variables_in_differently_colored_terms}
	Suppose that in a clause $C$ of a resolution derivation,
	a variable $u$ occurs in a maximal colored term $t\occur{u}$ which is a $\Gamma$-term and $u$ also occurs in a maximal colored term $r\occur{u}$ which is a $\Delta$-term.
	Then there is an arrow from a grey occurrence of $u$ to both $t\occur{u}$ and $r\occur{u}$.
	\comm{fairly specialised but true \& used}
\end{lemma}
\begin{proof}
	Note that initially, this situation does not occur.

	Variables are only introduces by means of substitution.
	Hence at some point in the derivation, w.l.o.g.\ some $\Gamma$-term $t\occur{u}$, containing a variable $u$, is applied a substitution $\sigma$ with $u\sigma = v$, where $v$ also occurs in a $\Delta$-term $r\occur{v}$ such that $t\occur{v}$ and $r\occur{v}$ occur in a clause $C$.

	\begin{itemize}
		\item
			\mytodo{extract tacit assumption that there is a weak connection between the max col terms $c\occur{x}$ and $d\occur{x}$, if they occur in the same clause and make a lemma}

			Suppose that $r\occur{v}$ and $t\occur{u}$ are in the same clause, say in $C_1$.
			As clauses are variable disjoint, $u$ and $v$ only occur in $C_1$

			$u$ and $v$ have to occur in the literal being unified, say $l$, as otherwise they would not be affected by the unification.
			They are only unified if in $C_2$, a variable $x$ occurs in the respective positions of $v$ and $u$ in $C_2$.

			If $u$ ($v$) occurs grey in $l$, then there is an arrow to $t\occur{u}$ ($r\occur{v}$).
			If $u$ ($v$) occurs colored in $l$, then it is either $t\occur{u}$ ($r\occur{v}$) itself or there is weak arrow to $t\occur{u}$ ($r\occur{v}$) and they share arrows.
			In any case, if there an arrow points towards $u$ ($v$), it by transitivity or by merging arrows, the arrow points to $t\occur{u}$ ($r\occur{v}$) as well.

			We denote by $u'$ and $v'$ the terms in $l'$ that $u$ and $v$ in $l$ are unified with.
			We know that $u'$ and $v'$ are occurrences of the same variable, say $x$.

			\begin{itemize}
				\item
					Suppose $u'$ and $v'$ are contained in colored terms of opposite color.
					Then this is the same situation as $t\occur{u}$ and $r\occur{u}$.
					As this situation is not present initially and a resolution derivation is finite, a propagation like this can only happen finitely often.
					Hence at some point, $u'$ and $v'$ are not terms of opposite color, which is handled by another case of the proof.
					So we can assume that there are arrows from a grey occurrence of $x$ in $C_2$ to the respectve maximal colored terms containing $u'$ and $v'$.
					However as $l$ and $l'$ are unified, their arrows are merged, so there is an arrow from $x$ to $t\occur{u}$ and $r\occur{v}$ respectively. As by assumption $u\sigma = v$, $x\sigma = v$.

				\item
					Suppose $u'$ and $v'$ are contained in colored terms of the same color.
					Suppose the color is $\Gamma$. The other case can be argued analoguously.

					As there is the same variable at both $u'$ and $v'$, there is a weak arrow between them.
					Furthermore, $u$ and $v$ in $l$ are contained in $\Gamma$-terms as well as they are respectively unifiable with $u'$ and $v'$.
					But $v$ already occurs in the $\Delta$-term $r\occur{v}$.
					So we get that there are arrows from a grey occurrence of $v$ to $r\occur{v}$ and the maximal colored term containing $v$ in $l$ by the induction hypothesis.

					As $u'$ and $v'$ are weakly connected and $l$ and $l'$ are resolved upon and hence their arrows are merged, the maximal colored terms containing $u$ and $v$ in $l$ are weakly connected.
					As $u$ occursr in $t\occur{u}$ and in an as well $\Gamma$-colored term in $l$, there is a weak connection between them.

					Hence there is a weak connection between all occurrences of these variables and an ``original'' arrow by induction hypothesis, so all other occurrences share these arrows.

					Figure: $ P(r(v), t(u)) \lor Q(c(u), d(v));  \lnot Q(c(u'), d(v'))$; $\Gamma: r, c, d$; $\Delta: t$


			\end{itemize}


		\item
			Suppose that $r\occur{v}$ and $t\occur{u}$ occur in different clauses, say $C_1$ and $C_2$

			\mytodo{
				ICI ICI ICI

				merge part below with sentence above.

				ICI ICI ICI
			}
			Note that $r\occur{v}$ and $t\occur{u}$ are not unifiable as their outermost symbol is different.
			As $u\sigma = v$, by the unification algorithm, there are terms $s\occur{u}$ and $s'\occur{v}$ being unified which agree on the ``path'' to $u$ and $v$ respectively.
			Hence $s\occur{u}$ and $s'\occur{v}$ are of the same color.

			\mytodo{same color -> get arrow by induction hypothesis}

			Suppose that $u$ in $s\occur{u}$ and $v$ in $s'\occur{v}$ are grey occurrences of $u$ and $v$.
			Then there is an arrow from $u$ in $s\occur{u}$ to $t\occur{u}$ and from $u$ in $s'\occur{v}$ to $r\occur{v}$. 
			As $s\occur{u}$ and $s'\occur{v}$ are unified, they each occur in one of the literals being unified at the same position.
			Therefore their arrows are merged.
			\mytodo{this does not mean that the literal occurs anywhere, is this of relevance?}
	\end{itemize}
\end{proof}

\begin{prop}
	Let $t \in \AI(C)$. Then there is either a corresponding term either in $C$ if $t$ is in $\AIclause(C)$ or 
	in $t$ is in $\AImatrix(C)$ and the corresponding term is not present anymore.
	There are however also terms in $C$, which in the course of the resolution derivation disappear without going into $\AI(\cdot)$ (i.e. the ones in colored predicate symbols).
\end{prop}



\newcommand{\newterm}{^*}
\newcommand{\de}{^\Delta}
Ontology of cases of main lemma:
\begin{multicols}{3}
	Resolution derivation:
	\begin{prooftree}
		\AxiomCm{C_1: D\lor l}
		\AxiomCm{C_2: E\lor l'}
		\BinaryInfCm{C: (D\lor E)\sigma}
	\end{prooftree}

	~

	~

	Relative interpolants:
	\begin{prooftree}
		\AxiomCm{\AI(C_1)}
		\AxiomCm{\AI(C_2)}
		\BinaryInfCm{\AI(C)}
	\end{prooftree}

	~

	~

	$\AI$ sketched:
	\vspace{-2em}
	\begin{prooftree}
		\AxiomCm{\AImatrix(D\lor l) \lor \AIclause(D \lor l)}
		%\AxiomCm{\AImatrix(E\lor l') \lor \AIclause(E \lor l')}
		\AxiomCm{\AI(C_2)}
		\BinaryInfCm{\AImatrix(D \lor E \lor l \lor l' ) \lor \AIclause(D \lor E)}
		\noLine
		\UnaryInfCm{\text{OR: }\AImatrix(D\lor E) \lor \AIclause(D \lor E)}
	\end{prooftree}
\end{multicols}

We suppose that $\gamma_j\newterm\occur{x_i}$ is in $\AI\de(C)$ and it isn't in $\AI\de(C_1)$ or $\AI\de(C_2)$.
\mytodo{formulate this into a proper induction}

{\bfseries Suppose introduction of $\Delta$-term into $\Gamma$-term}

$\gamma\newterm_j$ has a predecessor in $\AI(C_1)$ or $\AI(C_2)$. Call it $\gamma_j\occur{u}$. It has a variable as otherwise a $\Delta$-term could not have entered (can't via $\tau$ alone), we call the variable $u$. We know that $\lifboth{\gamma_j\occur{u} \sigma} \tau = \gamma\newterm_j\occur{x_i}$.

If $\gamma_j\occur{u}$ occurs in $l\cl$, it has a corresponding term in $l$, which in gerneral is not $\gamma_j\occur{u}$ as $\Delta$-terms are not lifted there.

At some point of the unifcation algorithm, $u$ is substituted by an abstraction of $\delta_i$.
This occurrence of $u$ is in $l$. Call it $\hat u$.

2 phases: show that the occurrence of $u$ has a respective arrow, and show that there is an connection between $u$ and $u$ in the $\gamma_j\occur{u}$

If $\hat u$ is at position $p$ in $l$, let $\hat u'$ be the term at position $p$ in $l'$. $\hat u'$ is an abstraction of $\delta_i$, so a variable or a $\Delta$-term.

\textbf{Cases: $\hat u$ vs $\gamma_j\occur{u}$}
\begin{compactitem}
\item $\hat u$ is a grey occurrence 

	$\Ra$ have arrow

	\begin{compactitem}
	\item $\hat u'$ is variable such that $u\sigma = u'\sigma$, which is $\delta_i$.

		Then $\hat u$ becomes lifting of $\Delta$-term (check if it's the right one)
	\item $\hat u'$ is $\Delta$-term

		Then $\hat u$ becomes lifting of $\Delta$-term (check if it's the right one)
	\end{compactitem}

\item $\hat u$ is in a maximal colored term which is a $\Gamma$-term

	either $\hat u$ is in $\gamma_j\occur{u}$ \checkmark

	OR: should have merge arrow (proof this in a lemma!)

	\begin{compactitem}
	\item $\hat u'$ is variable 

		Then there is the same $\Gamma$-term on the other side, same situation, can only happen finitely often.

	\item $\hat u'$ is $\Delta$-term

		Then it's a $\Delta$-term in a $\Gamma$ term $\Ra$ ind hyp
	\end{compactitem}
\item $\hat u$ is in a maximal colored term which is a $\Delta$-term

	That extra lemma. Subcases of $\hat u'$ being var or $\Delta$-term should somehow be treated there as it would then mean that a $\Delta$-term is in a $\Delta$-term, which isn't overly fascinating.
\end{compactitem}


~

{\bfseries Suppose introduction of $\gamma_j\newterm\occur{x_i}$ via $\sigma$ and lifting directly}

$v\sigma = \gamma_j\newterm\occur{\delta_i}$ for some $v$.

As $v$ is affected by the unification, it occurs in the literal being unified, say in $l$.
At exactly one point in the unification algorithm, $v$ is substituted by an abstraction of $\gamma_j\newterm\occur{\delta_i}$.
Let $p$ be the position of the occurrence of $v$ in $l$ where this happens.

%Let $p$ be the position of $v$ in $l$ (there can be multiple ones), where the unification algorithm changes 
%at position $p$.
Let $v'$ be the term at position $p$ in the corresponding literal in $l'$.

\textbf{Cases}
\begin{compactitem}
\item $v'$ is a variable 

	then same lemma + weak arrows

\item $v'$ is a $\Gamma$-term not containing a $\Delta$-term 

	As $v'$ is an abstraction of $\gamma_j\newterm\occur{\delta_i}$, $v'$ contains variables which are unified to $\Delta$-terms (= other case) or multicolored $\Gamma$-terms (= same case but can't happen infinitely often as term shrinks).

	+ have arrows since weak arrows

\item $v'$ is a $\Gamma$-term containing a $\Delta$-term 

	$\Ra$ ind hyp + weak arrows
\end{compactitem}

\mytodo{ICI}

\mytodo{ICI}

\mytodo{ICI}

\mytodo{Reproof lemma below with new statement, then also include that other lemma.}

\mytodo{ICI}

\mytodo{ICI}

\mytodo{ICI}


new statement:
Suppose that in $\AI^\Delta(C)$, a lifting variable $x_i$ (lifting a $\Delta$-term $\delta_i$)
occurs inside of a maximal $\Gamma$-term $\gamma_j\occur{\delta_i}$.
Then there is an arrow from an occurrence of $x_k$ in $\AI^\Delta(C)$ to $\gamma_j\occur{\delta_i}$ in $\arr''$. $k$ is such that $\delta_i$ is a specialisation of $\delta_k$.


\begin{conj}
	\label{lemma:arrows_for_lifting_terms}
	In $\AI^\Delta(C)$, if a lifting variable $x_i$ (lifting a $\Delta$-term)
	occurs inside of a maximal $\Gamma$-term $t\newterm$, 
	then there is an arrow from an occurrence of $x_i$ to $t\newterm$ in $\AI^\Delta(C)$ in $\arr''$.
	\medskip

	\mytodo{NOT from $x_i$, but from $x_j$ such that $\colterm{j}$ is an abstraction of $\colterm{i}$, i.e.~the actual term in the derivation is $\colterm{i}$, but here we might be imprecise but only since in the proof, the variable is quantified and we can put there whatever we want.} 
	\medskip

	\mytodo{ acutally, $x_i$ may not occur in $\AI^\Delta(C)$ but can disappear if the literal is not added to the interpolant.

		We have to show that then, even if $x_i$ occurs elsewhere in $\AI^\Delta(C)$, it is not vital to quantify it earlier than $t\newterm$. 
		There might however be a chain of arrows from other lifting vars, which do occur in $\AI^\Delta(C)$. I suspect that these have to be overbound earlier (check examples).
	}
\end{conj}
\begin{proof}
	For a term to occur in $\AI(C)$ means to occur in $\AImatrix(C) \lor \AIclause(C)$.

	Base case: No foreign terms occur in the initial clauses.

	Induction step:
	Suppose a clause $C$ is the result of a resolution of $C_1: D \lor l$ and $C_2: E \lor \lnot l$ with $l\sigma = l'\sigma$.
	By the induction hypothesis, all $t$ which occur in $\AI(C_1)$ and $\AI(C_2)$ satisfy the condition.

	Note that every $x_i$ from $\AI(C_1)$ or $\AI(C_2)$ is carried over to $\AI(C)$. $\tau$ might rename $x_i$ to another lifting variable, but as this applies to every occurrence of $x_i$, the statement of this lemma is not violated.

	Hence we consider all introductions of new $t\newterm$ in $\AI(C)$, i.e.~those that have not been present in $\AI(C_1)$ or $\AI(C_2)$.
	Let $t$ be the term in w.l.o.g.~$\AI(C_1)$ where $t\newterm$ originates from, i.e.~$\lifboth{t\sigma}\tau = t\newterm$.

	\begin{multicols}{3}
		Resolution derivation:
		\begin{prooftree}
			\AxiomCm{C_1}
			\AxiomCm{C_2}
			\BinaryInfCm{C}
		\end{prooftree}

		~


		Relative interpolants:
		\begin{prooftree}
			\AxiomCm{\AI(C_1)}
			\AxiomCm{\AI(C_2)}
			\BinaryInfCm{\AI(C)}
		\end{prooftree}

		~

		Terms:

		$t\in \AI(C_1)$

		$t'\in \AI(C_2)$

		$\lifboth{t\sigma}\tau = \lifboth{t'\sigma}\tau = t\newterm \in \AI(C)$
	\end{multicols}
	\begin{flushright}
		$t\newterm$ is maximal $\Gamma$-term and contains $x_i$, lifting a $\Delta$-term $\colterm{i}$
	\end{flushright}

	$\AI(C) = Q_1 u_1 \ldots Q_m u_m \Big( \AImatrix(C) \lor \AIclause(C) \Big)$

	All terms of
	$\AIclause(C)$ are contained in 
	$\lifboth{(\AIclause(C_1) \setminus \{l\fromclause\})\sigma}\tau$ or $\lifboth{ (\AIclause(C_2)\setminus\nolinebreak \{l\fromclause'\})\sigma} \tau$ 
	and all terms of 
	$\AImatrix(C)$ are contained in $\lifboth{l\fromclause\sigma}\tau$, $\lifboth{l'\fromclause\sigma}\tau$, $\lifboth{\AImatrix(C_1)\sigma}\tau$ or
	$\lifboth{\AImatrix(C_2)\sigma) }\tau$.
	%As by Lemma~\ref{lemma:literals_clauses_equal} $\lifboth{l\fromclause\sigma}\tau = \lifboth{l'\fromclause\sigma}\tau$, 
	As by Lemma~\ref{lemma:no_lifting_vars_in_subst} $\sigma$ does not introduce lifting variables, $\sigma$ does not introduce $t\newterm$.
	There are 2 cases, we show that in both of them, there is an arrow from an occurrence of $x_i$ to $t\newterm$ in $\arr''$.

	\begin{itemize}
		\item $\sigma$ introduces the $\Delta$-colored term $\colterm{i}$ in the $\Gamma$-term $t\newterm$.
			Hence $t$ is a $\Gamma$-term and contains a variable $u$ such that $u\sigma = \colterm{i}$.

			\begin{itemize}
				\item
					Suppose $t\occur{u}$ does not occur in the literal being unified.
					Then $u$ is changed because of an occurrence in literal being unified.
					We show that there is an arrow from a grey occurrence of $u$ to $t\occur{u}$. As $u\sigma = \colterm{i}$ and the positions occupied by $u$ in $\AI^\Delta(C_1)$ are occupied by $\lifboth{u\sigma}\tau$ in $\AI^\Delta(C)$, the desired arrow is present in $\AI^\Delta(C)$.
					\markA{}

					\begin{itemize}
						\item
							Suppose the occurrence $u$ in the literal is grey. Call this occurrence $r$.
							$u$ in $t\occur{u}$ is a colored occurrence.
							As variables are never added (cf.~\ref{lemma:variable_never_added}) and arrows never removed, the original arrows still apply.
							Then there is by construction an arrow from $r$ to $t\occur{u}$.

							%As $u\sigma = \colterm{i}$, all occurrences of $u$ in in $\AI(C)$ are changed to $\lifboth{u\sigma}\tau = x_j$. \mytodo{possibly argue that $\tau$ doesn't change anything as it's exactly the term in the literal, is there some lemma for it?}
							%$Hence there is an arrow from $r$ to $t\occur{x_j}$, which is ported over to $\AI(C)$, where the arrow points from $x_j$ to $\lifboth{t\occur{u}\sigma}\tau = t\newterm\occur{x_i}$.

						\item
							Otherwise suppose $u$ occurs in the maximal colored term $r\occur{u}$ in the literal.
							Then there is a weak connection between $r\occur{u}$ and $t\occur{u}$, so by construction, $r$ and $t$ share all arrows.
							Let $p$ be the position of $u$ in $r\occur{u}$ and $r'$ the term corresponding to $r$ in $l'$.
							As $r$ is unified to $\colterm{i}$, $r'$ and $\colterm{i}$ must coincide on the position $p$ in the $C_2$, so in $\AI(C_2)$, where $r'$ actually lives, there is a lifting variable.
							Since $r$ and $r'$ are unifiable, they must coincide on the ``path'' leading to $p$.

							Suppose $r'$ is a $\Gamma$-term. Then it is a multicolored $\Gamma$-term which occurs in $C_2$ and there is an arrow from an appropriate lifting term by the induction hypothesis.

							Otherwise suppose $r'$ is a $\Delta$-term (in the clause, so $r'$ in $\AIclause$ is a lifting var). 
							Then $r\occur{u}$ is a $\Delta$-term as well.

							Note that $r\occur{u}$ is maximal colored and $t\occur{u}$ is maximal $\Gamma$-colored. As no $\Delta$-terms occur in $\AI(C_1)$, but $t\occur{u}$ occurs in $\AI(C_1)$, it is a maximal colored term.
							Hence by Lemma~\ref{lemma:arrow_for_variables_in_differently_colored_terms}, there is an arrow from a grey occurrence of $u$ to $r\occur{u}$ and to $t\occur{u}$.



					\end{itemize}
				\item
					Suppose $t$ does occur in the literal being unified, say in $l$.
					Let $t'$ be the term in $l'$ that $t$ is unified with.
					Let $p_u$ be the position of $u$ in $t$

					\begin{itemize}
						\item Suppose $t'$ is more specific on the position $p_u$, i.e.~there is a contant or a function symbol, but not a variable.
							Then the unifier maps $u$ to whatever is on the respective position in $t'$. 
							As $t'$ is a $\Gamma$-term (as $t$ is one and $t$ and $t'$ are unifiable) and whatever $u$ is mapped to has to be a $\Delta$-term (since $\colterm{i}$ is one), $t'$ has is a multicolored $\Gamma$-term.
							Hence by the induction hypothesis, there is an arrow from an occurrence of the respective lifting var to $t'$. 
							However the arrows of $t$ and $t'$ are merged.\mytodo{see TODO in lemma statement, we don't get exactly the right lifting var in general (i.e.~not an arrow from $x_i$ in this case), but that's ok.}

						\item Suppose that at $p_u$ in $t'$, there is a variable, say $v$.
							Then the unifier picks one variable arbitrarily to unify the other with. 
							As $u\mapsto \colterm{i}$ and $v\mapsto \colterm{i}$, there must be another occurrence of $u$ or $v$.
							This case however is handled at \markA{}.

						\item Suppose position $p_u$ does not exist at $t'$. As $t$ and $t'$ are unifiable, $t'$ must have a somewhere variable at the path to $p_u$, say $v$.
							The unifier maps $v$ to the respective subterm of $t$, but as $u\sigma = \colterm{i}$, $u$ must occur elsewhere. 
							This case again is handled at \markA{}.
					\end{itemize}



			\end{itemize}



		\item $\sigma$ introduces the mixed-colored term $t'$.
			\mytodo{}

	\end{itemize}
\end{proof}
\cbend



\begin{exa}
	TODO: example showing that if lifting vars occur in both $\AIclause(C_1)$ and $\AIclause(C_2)$, combining them with the same quantifier is fine as they both have the same dependencies. $\forall x F(x)$ and $\exists y G(y)$ combines nicely to $\forall x\exists y (F(x) \lor G(y))$ anyway as the bound variables are different.
\end{exa}

\begin{conj}
	Let $\colterm{i}$ be contained in some literal in $\Gamma$ and
	a term $t$ derived from $\colterm{i}$ occurs in $\AI(C)$ for some $C$ as in Lemma~\ref{ref:gamma_entails_delta_terms_lifted}. 
	Suppose $t_{\AI}$ contains some $\Delta$-colored $\colterm{j}$.
	$t = \colterm{i}\rho$ for some $\rho$.
	Then as $\Delta$-terms are lifted in $t$, it contains $z_j$ for some $j$.

	There is an arrow from some occurrence of $z_j$ in $\AI(C)$ to the position of $\colterm{i}$ (where there's actually some kind of lifting variable)

	\NB{this is what the proof above needs}

\end{conj}

\begin{conj}
	Let $\colterm{i}$ be a term of some color and $\colterm{j}$ be a term of a different color, which contains $\colterm{i}$ as subterm.
	If the corresponding lifting variables $z_i$ and $z_j$ occur in $\AI(C)$ for some $C$, then there is an arrow from an occurrence of $z_i$ to an occurrence of $z_j$ (or for different $i$, $j$, as the $z$'s can become more specialised).

	\NB{this seems to be provable, but check what it actually implies/expresses}
\end{conj}

\section{arrow proof}

\begin{conj}
	Let $x$ be a variable in $\AIclause(C)$.
	Suppose there is a colored and a grey occurrence of $x$.
	Then for every colored occurrence $p$ of $x$ there is an arrow from some grey occurrence to~$p$.
\end{conj}

\begin{conj}
	If there is a term in $C$ which contains a subterm of a different color, then there is variable in an ancestor of $C$ which has a grey and a colored occurrence.
\end{conj}

If a variable occurs twice in colored terms, foreign terms can be propagated.
If it's once as grey and once as colored occurrence, foreign terms can be introduced.




\begin{lemma}
	\label{lemma:arrow_for_same_variables}
	Whenever the same variable appears multiple times in $\PI(C)\lor C$ for $C \in \pi$, there are arrows.

	\begin{itemize}
		\item If both variables are contained only in grey terms, there is a double arrow \comm{they unify to exactly the same}
		\item If only one variable is only contained in grey terms, there is an arrow from it to the other one \comm{either unify the one in grey term, then other one must be overbound later. if otherwise var in the colored term is unified, we can still overbind the grey one first. }
		\item otherwise there are weak arrows between them \comm{have same quantifier, so order does not matter, but want to keep dependencies on both the same}
	\end{itemize}
\end{lemma}
\begin{proof}
	By induction. Note: As required by resolution, all initial clauses are variable disjoint.

	Base case:
	In the initial clause sets, consider for a clause $C$ two different positions $p_1$ and $p_2$ pointing to the same variable. 
	Then either:
	\begin{itemize}
		\item $p_1$ and $p_2$ contain only grey symbols. Then $(p_1, p_2) \in \arr$.
		\item Only $p_i$, $i\in\{1,2\}$ contains only grey symbols. Then $(p_i, p_{(i \mod 2)+1}) \in \arr$.
		\item There are not only grey symbols in both $p_1$ and $p_2$, i.e.~both contain at least a colored symbol. Then $\{p_1, p_2\} \in \warr$. 
	\end{itemize}

	Induction step:
	Suppose a clause $C$ is the result of a resolution of $C_1: D \lor l$ and $C_2: E \lor \lnot l$ with $l\sigma = l'\sigma$.
	$\PI(C)$ is $[\PI(C_1) \circ \PI(C)]\sigma$ or $[(l \land \PI(C_2)) \lor (\lnot l \land \PI(C_1)) ] \sigma $.

	Assumption: $C_1$ and $C_2$ are variable disjoint, i.e.~variables are renamed in case $C_1$ and $C_2$ are derived from some common original clause and share variables.

	By the induction hypothesis, there are appropriate arrows in both $\PI(C_i) \lor C_i$, $i \in \{1,2\}$.

	If the variables were present in $C_1$ or $C_2$, the arrow is still there, either in $\PI(C)$ (in the case of $l$ or $l'$), $C$ (in case of $D$ and $E$) or in currently not shown literal (in case $l$ and $l'$ have the same color).

	Otherwise, it was introduced by unification in $l\sigma$ or $\PI(C_i)\sigma$.
	In this case, there is some term position $q$ in with $\pos(l).q$ a variable and $\pos(l').q$ a variable or a term containing variables (or other way around).
	Hence unification maps a variable to a variable or a term containing variables.
	The variable being unified is in $\PI(C_i)\lor C_i$ for some $i\in\{1,2\}$.
	But by the induction hypothesis, all occurrences of each variable does already have appropriate arrows, which are still present. 
\end{proof}



\begin{lemma}
	In $\PI(C)\lor C$ for $C \in \pi$, if there is a $\Delta$-colored term $s$ in a $\Gamma$-term $t$, then there is an arrow from $p_1$ to $p_2$ such that $\pos(p_1) = s$ and $\pos(p_2) = s$ and for some $i$, $\pos( p_2 \mod i ) = t$.
\end{lemma}
Note: $p_1$ might be in some clause, the prop interpolant or none of both. 
\begin{proof}
	By induction.

	Base case: There are no foreign terms in the initial clause sets, so no arrows necessary.

	Induction step:

	\begin{itemize}
		\item[Resolution.]
			Suppose a clause $C$ is the result of a resolution of $C_1: D \lor l$ and $C_2: E \lor \lnot l$ with $l\sigma = l'\sigma$.

			\begin{enumerate}
				\item Suppose $l$ is colored. 
					This case is similar to the grey one, with the exception that the cases applying to $l$ in $\PI$ do not apply.

				\item Suppose $l$ is grey. Then  $\PI(C) = [(l \land \PI(C_2)) \lor (\lnot l \land \PI(C_1)) ] \sigma $

					By the induction hypothesis, there are appropriate arrows in $\PI(C_1) \lor C_1$ and $\PI(C_2) \lor C_2$.

					We show that for all maximal $\Gamma$-terms in $\PI(C)\lor C$ with $\Delta$-terms in them which were not present in $\PI(C_i)\lor C_i$, $i \in \{1,2\}$, there is an arrow.

					$\Gamma$-terms and $\Delta$-terms are not unifiable.
					%Hence all pairs of terms $(\colterm{1}, \colterm{2})$ in the same positions in $l$ and $l'$ (if both positions exist) are both grey, or w.l.o.g.~$\colterm{1}$ is a variable and $\colterm{2}$ is a colored/grey term.
					Hence all pairs of terms $(\colterm{1}, \colterm{2})$ in the same positions in $l$ and $l'$ (if both positions exist) either point to the same symbol or (w.l.o.g.) $\colterm{1}$ is a variable and $\colterm{2}$ is a term. \mytodo{or the outermost symbol is the same and contains variables.}
					If there are $\Delta$-terms in $\Gamma$-terms in the prefix, they are present in both ancestors and handled by the induction hypothesis.

					The only way a $\Delta$-colored term may enter a $\Gamma$-colored term is in the situation where $\colterm{1}$ is a variable and $\colterm{2}$ a colored term.
					But then $\mgu(\colterm{1}, \colterm{2})$ applied to $\colterm{1}$ yields $\colterm{2}$, i.e.~``the parts of $\sigma$ concerned with unifying $\colterm{1}$ and $\colterm{2}$'' do not introduce new $\Delta$-terms in $\Gamma$-terms.
					In other words, all such situation have been present in $\PI(C_i) \lor C_i$ for $i \in \{1,2\}$ and since the arrows for $l$ and $l'$ are merged, they are present for $l\sigma$ in $\PI(C)$.

					This handles the case where terms $\colterm{1}$ and $\colterm{2}$ are unified. 
					But unification also affects all other occurrences of variables, this means ``the parts of $\sigma$ not concerned with unifying $\colterm{1}$ and $\colterm{2}$''.
					The relevant case for this lemma is when a $\Gamma$-term contains a variable, that is substituted by a term containing $\Delta$-terms.
					But in this case, by Lemma \ref{lemma:arrow_for_same_variables}, there is an arrow from the other occurrence of the variable to the one in the $\Gamma$-term: either double arrow in $\arr$ if both prefixes are grey, one in $\arr$ if one of the prefixes is grey or one in $\warr$ if both prefixes contain a colored symbol.
					\qedhere
			\end{enumerate}
	\end{itemize}
\end{proof}


\end{document}
