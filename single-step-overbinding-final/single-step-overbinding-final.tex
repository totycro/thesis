\documentclass[,%fontsize=11pt,%
	%landscape,
	%DIV8, % mehr text pro seite als defaultyyp
	%DIV10,
	%DIV=calc,%
	draft=false,% final|draft % draft ist platzsparender (kein code, bilder..)
	%titlepage,
	numbers=noendperiod
	11pt,
	a4paper,
	oneside,% apparently, this should stay below some other parameter to have an effect
	openany,
	%]{scrartcl}
]{memoir}



\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}


%\usepackage[urw-garamond]{mathdesign}

\usepackage{lscape}
\usepackage{stackengine}
\usepackage{enumerate}
\usepackage{paralist}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,backgrounds,graphs,%
	matrix,patterns,arrows,decorations.pathmorphing,decorations.pathreplacing,%
	positioning,fit,calc,decorations.text,shadows%
}


\input{../latex_header.tex}


% subsections also in toc
\setcounter{tocdepth}{2}
\setsecnumdepth{subsection}


%\declaretheorem[title=Theorem,qed=$\triangle$,parent=chapter]{thm}
\newcommand{\thmqed}{$\square$} % for thms without proof
\newcommand{\propqed}{$\square$} % for props without proof
\declaretheorem[title=Theorem]{thm}
\declaretheorem[title=Proposition,sibling=thm]{prop}
%\declaretheorem[title=Lemma,parent=chapter]{lemma}
\declaretheorem[sibling=thm]{lemma}
\declaretheorem[title=Corollary,sibling=thm]{corr}
\declaretheorem[sibling=thm,title=Definition,style=definition,qed=$\triangle$]{defi}
%\declaretheorem[title=Definition,qed=$\triangle$,parent=chapter]{defi}
\declaretheorem[title=Example,style=definition,qed=$\triangle$,sibling=thm]{exa}

\declaretheorem[sibling=thm,title=Conjecture]{conj}

\declaretheorem[title=Remark,style=remark,numbered=no,qed=$\triangle$]{remark}

\def\proofSkipAmount{ \vskip -0.1em }


%\usepackage{bussproof}

%\usepackage{vaucanson-g}
%\usepackage{amssymb}
\usepackage{latexsym}

% for color-highlighted code
%\usepackage{color} % for grey comments
%\usepackage{alltt}

%\usepackage[doublespacing]{setspace}
%\usepackage[onehalfspacing]{setspace}
%\usepackage[singlespacing]{setspace}
%\usepackage{tabularx}
%\usepackage{hyperref}
%\usepackage{comment}
%\usepackage{color}
%\usepackage[final]{listings} % sourcecode in document
%\usepackage{url}      % for urls
%\usepackage{multicol}
%\usepackage{float}
%\usepackage{caption}
%\usepackage{amsmath}
%\usepackage{amssymb}
%
%\usepackage{graphicx}
%
%\usepackage[authoryear]{natbib} % \cite ; square|round etc.
%\usepackage[numbers,square]{natbib}
%\usepackage[square, authoryear]{natbib}
%\usepackage[language=english]{biblatex}

%\bibliographystyle{plain}
%\bibliographystyle{alpha}
%\bibliographystyle{alphadin}
%\bibliographystyle{dinat}
%\bibliographystyle{chicago}
%\bibliographystyle{plainnat}

% smaller url style
\makeatletter
\def\url@leostyle{%
\@ifundefined{selectfont}{\def\UrlFont{\sf}}{\def\UrlFont{\small\ttfamily}}}
\makeatother
\urlstyle{leo}

\newcommand{\myfig}[5] {
	\begin{figure}[tbph]
		\centering
		\includegraphics[#3]{#1}
		\caption[#4]{#5}
		\label{fig:#2}
	\end{figure}
}

%\usepackage{thmtools} % actually already in latex_header.tex ...

\usepackage{amsthm}


\chapterstyle{madsen}

% define page numbering styles
\makepagestyle{numberCorner}
\makeevenfoot{numberCorner}{\thepage}{}{}
\makeoddfoot{numberCorner}{}{}{\thepage}

\makepagestyle{numberCenter}
%\makeevenfoot{numberCenter}{}{\thepage}{}
%\makeoddfoot{numberCenter}{}{\thepage}{}
%
%\makeevenhead{numberCenter}{\thechapter}{}{\thesection}
%\makeoddhead{numberCenter}{\thesection }{}{\thechapter}
\makeheadrule{numberCenter}{\textwidth}{1pt}

\makeevenhead{numberCenter}{\thepage}{}{\leftmark}
\makeoddhead{numberCenter}{\rightmark}{}{\thepage}


\makeatletter
\makepsmarks{numberCenter}{
	\def\chaptermark##1{\markboth{%
			\ifnum \value{secnumdepth} > -1
			\if@mainmatter
			\chaptername\ \thechapter\ --- %
			\fi
			\fi
	##1}{}}
	\def\sectionmark##1{\markright{%
			\ifnum \value{secnumdepth} > 0
			\thesection. \ %
			\fi
	##1}}
}
\makeatother
\newcommand{\mysetpagestyle}{
	%\pagestyle{numberCorner}
	\pagestyle{numberCenter}
}
\mysetpagestyle





\usepackage{refcheck}

%\settypeblocksize{0.65\stockheight}{0.65\stockwidth}{*}
%\setlrmargins{*}{*}{1.2}
%\setulmargins{*}{*}{1.4}
%\checkandfixthelayout[nearest]


\begin{document}

\tableofcontents

\section{referenced lemmas from previous sections}
\begin{quote}
	\begin{lemma}[Commutativity of lifting and logical operators]
		\label{lemma:lift_commute}
		\label{lemma:lift_logic_commute}
		Let $A$ and $B$ be first-order formulas and $s$ and $t$ be terms. Then it     holds that:
		\begin{enumerate}
			\item $\lift{\Phi}{\lnot A}{z} \spas\semiff{} \lnot \lift{\Phi}{A}{z}$
			\item $\lift{\Phi}{A \circ B}{z} \spas\semiff{} ( \lift{\Phi}{A}{z} \circ   \lift{\Phi}{B}{z} )$ for  $\circ \in \{\land, \lor\}$
			\item $\lift{\Phi}{s = t}{z} \spas\semiff{} ( \lift{\Phi}{s}{z} =           \lift{\Phi}{t}{z} )$
		\end{enumerate}
	\end{lemma}

	\begin{restatable}[Commutativity of lifting and substitution]{lemma}{lemmaCommutLiftSubst}
		\label{lemma:lif}
		Let $C$ be a clause and $\sigma$ a substitution such that no lifting variable occurs in $C$ or $\sigma$.
		%Let $t_1,\ldots,t_n$ be all maximal $\Delta$-terms in this context, i.e.\ those that occur in $C$ or $C\sigma$,  and
		%$x_1, \ldots, x_n$ the corresponding fresh variables to replace the $t_i$ (i.e.~none of the $x_i$ occur in $C$).
		Define $\sigma'$ with $\dom(\sigma') = \dom(\sigma) \cup \{ z_t \mid t\sigma \neq t \}$ such that for a variable $z$,
		\[
			x \sigma' =
			\begin{cases}
				z_{t\sigma} & \text{ if } x = z_t \text{ and } t\sigma \neq t \\
				\lifphi{x\sigma} & \text{ otherwise}
			\end{cases}
		\]

		Then
		$\lifphi{C\sigma} =
		\lifphi{C}\sigma'$.
	\end{restatable}
\end{quote}

\chapter{Interpolant extraction from resolution proofs in one phase}


While the previous chapter demonstrates that it is possible to extract propositional interpolants and lift them from the colored symbols later in order to obtain a proper interpolant, we now present a novel approach, which only operates with grey intermediary interpolants.
This is established by lifting any term which is added to the interpolant.

By its nature, this approach requires an alternate strategy than the proof of the extraction in two phases as a commutation of substitution and lifting is no longer possible if lifting variables are present.
Let us recall the corresponding lemma from the previous chapter:
\lemmaCommutLiftSubst*
Consider the following illustration of a problem of the notion of applying this lemma to terms containing lifting variables:

\begin{exa}
	Let $\sigma = \{x \mapsto a\}$
	and consider the terms $f(x)$ and $f(a)$, where $f$ and $a$ are colored symbols.
	Clearly $f(x)\sigma = f(a)$ and therefore necessarily $z_{f(x)}\sigma' = z_{f(a)}$.

	But now consider $x_{f(x)} \sigma$.
	As $z_{f(x)}$ is a lifting variable, it is not affected by unifiers from resolution derivations and also not by $\sigma$.
	Hence $z_{f(x)}\sigma = z_{f(x)}$ and therefore $\lifboth{z_{f(x)}\sigma} = \lifboth{z_{f(x)}} = z_{f(x)}$, but $\lifboth{z_{f(x)}}\sigma' = z_{f(x)}\sigma' = z_{f(a)}$.
	So $\lifboth{z_{f(x)}\sigma} \neq \lifboth{z_{f(x)}}\sigma'$.

	We see here that there are circumstances under which in order to commute lifting and substitution,
	the substitution $\sigma'$ is required to conform to the equation
	$z_{f(x)}\sigma' =\nolinebreak z_{f(a)}$,
	whereas in others, it must hold that
	$z_{f(x)}\sigma' = z_{f(x)}$.
\end{exa}


\section{Definition of the extraction algorithm}

The extracted interpolants are prenex formulas, where
the quantifier block and the matrix of the formula are calculated separately in each step of the traversal of the resolution refutation.


\subsection{Extraction of the interpolant formula matrix $\AImat$ and calculation of $\AIcl$}

$\AImat$ is inspired by the propositional interpolants $\PI$ from Definition \ref{def:PI}.
Its difference lies in the fact that the lifting occurs in every step of the extraction.
This however necessitates applying these liftings to the clauses of the resolution refutation as well.
For a clause $C$ of the resolution refutation, we will denote the clause with the respective liftings applied by $\AIcl(C)$ (a formal definition will be given below), and for a term $t$ at position $p$ in $C$, we denote $\AIcl(C)\at{p}$ by $t\cl$.

Now we can define preliminary versions of $\AImatpre$ and $\AIclpre$:

\begin{defi}[$\AImatpre$ and $\AIclpre$]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.

	For a clause $C$ in $\pi$, \defiemph{$\AImatpre(C)$} and \defiemph{$\AIclpre(C)$} are defined as follows:
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, $\AImatpre(C) \defeq \bot$.
			If otherwise $C \in \Delta$, $\AImatpre(C) \defeq \top$.

			In any case, $\AIclpre(C) \defeq \lifboth{C}$.
		\item[Resolution.]

			If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma =  l'\sigma$, then $\AImatpre(C)$ and $\AIclpre$ are defined as follows:

			$\AIclpre(C) \defeq \lifboth{(\AIclpre(C_1) \setminus \{l\fromclause\})\sigma} \spam\lor \lifboth{(\AIclpre(C_2)\setminus \{l\fromclause'\})\sigma} $

			\begin{enumerate}

				\item If $l$ is $\Gamma$-colored:
					$\AImatpre(C) \defeq \lifboth{\AImatpre(C_1)\sigma}\spas\lor \lifboth{\AImatpre(C_2)\sigma} $

				\item If $l$ is $\Delta$-colored:
					$\AImatpre(C) \defeq \lifboth{\AImatpre(C_1)\sigma}\spas\land \lifboth{\AImatpre(C_2)\sigma} $

				\item If $l$ is grey:
					$\AImatpre(C) \defeq
					(\lnot {\lifboth{l'\fromclause\sigma}} \land \lifboth{\AImatpre(C_1)\sigma}) \spam\lor
					(\lifboth{l\fromclause\sigma}\land \lifboth{\AImatpre(C_2)\sigma })
					$

			\end{enumerate}

		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\AImatpre(C) \defeq \lifboth{\AImatpre(C_1)\sigma}$ and $\AIclpre(C) \defeq \lifboth{ (\AIclause(C_1) \setminus\nolinebreak \{l'\cl\})\sigma}$.
			\qedhere

	\end{itemize}
\end{defi}

Note that in $\AImatpre$ and $\AIclpre$, it is possible that there for a colored term $t$ in $C$ that $t\cl \neq z_t$ as illustrated by the following examples:

\begin{exa}
	We consider a resolution refutation of the initial clause sets
	$\Gamma = \{ R(c), \lnot Q(v) \}$
	and
	$\Delta = \{ \lnot R(u) \lor Q(g(u)) \}$:
	\begin{prooftree}
		\AxiomCm{ R(c) }
		\AxiomCm{ \lnot R(u) \lor Q(g(u)) }
		\prflbl{\resruleres}{y\mapsto c}
		\BinaryInfCm{ Q(g(c)) }

		\AxiomCm{ \lnot Q(v) }
		\prflbl{\resruleres}{v\mapsto g(c)}
		\BinaryInfCm{ \square }
	\end{prooftree}

	We now replace every clause $C$ by $\AImatpre(C) \mid \AIclpre(C)$ in order to visualize the steps of the algorithm:
	\begin{prooftree}
		\AxiomCm{ \bot \mid  R(y_c) }
		\AxiomCm{ \top \mid \lnot R(u) \lor \lnot Q(x_{g(u)}) }
		\prflbl{\resruleres}{y\mapsto c}
		\BinaryInfCm{ R(y_c) \mid  Q(x_{g(u)}) }

		\AxiomCm{ \bot \mid \lnot Q(v) }
		\prflbl{\resruleres}{v\mapsto g(c)}
		\BinaryInfCm{ \lnot Q(x_{g(c)}) \land R(y_c) \mid  \square }
	\end{prooftree}

	By quantifying $y_c$ existentially and $x_{g(c)}$ universally\footnote{The procedure for calculating the quantifier block is defined in section \ref{sec:arrow_quantifier_block}}, we obtain an interpolant for $\Gamma \cup \Delta$:
	$\exists y_c \forall x_{g(c)} (\lnot Q(x_{g_c}) \land R(y_c))$.
	Note however that $\lifboth{Q(g(c))} = Q(x_{g(c)})$, but $\AImat(Q(g(c))) = Q(x_{g(u)})$.
	This example shows that this circumstance is not necessarily an obstacle for the correctness of this algorithm.
\end{exa}
\begin{exa}
	\label{exa:2b}
	We consider a resolution refutation of the initial clause sets
	$\Gamma = \{ R(c), P(c) \}$
	and
	$\Delta = \{ \lnot R(u) \lor \lnot Q(g(u)), \lnot P(v) \lor Q(g(v))\}$:
	\begin{prooftree}
		\AxiomCm{ \lnot R(u) \lor \lnot Q(g(u)) }
		\AxiomCm{ R(c) }
		\prflbl{\resruleres}{u\mapsto c}
		\BinaryInfCm{ \lnot Q(g(c)) }


		\AxiomCm{ \lnot P(v) \lor Q(g(v)) }
		\AxiomCm{ P(c) }
		\prflbl{\resruleres}{v\mapsto c}
		\BinaryInfCm{ Q(g(c)) }

		\prflblid{\resruleres}
		\BinaryInfCm{\square}

	\end{prooftree}

	We now again display $\AImatpre(C) \mid \AIclpre(C)$ for every clause $C$ of the refutation:
	\begin{prooftree}
		\AxiomCm{ \top \mid  \lnot R(u) \lor \lnot Q(x_{g(u)}) }
		\AxiomCm{ \bot \mid R(y_c) }
		\prflbl{\resruleres}{u\mapsto c}
		\BinaryInfCm{ R(y_c) \mid  \lnot Q(x_{g(u)}) }

		\AxiomCm{ \top \mid \lnot P(v) \lor Q(x_{g(v)}) }
		\AxiomCm{ \bot \mid P(y_c) }
		\prflbl{\resruleres}{v\mapsto c}
		\BinaryInfCm{ P(y_c) \mid  Q(x_{g(v)}) }

		\prflblid{\resruleres}
		\BinaryInfCm{ (Q(x_{g(v)}) \land R(y_c)) \spam\lor (\lnot Q(x_{g(u)}) \land P(y_c))  \mid \square}

	\end{prooftree}

	Note again that here, we have that
	%\[
	$
	\lifboth{\lnot Q(g(c))} = \lnot Q(x_{g(c)}) \spam\neq \AIclpre(\lnot Q(g(c))) = \lnot Q(x_{g(u)})
	$
	%\]
	%as well as a similar discrepancy for the other clause $Q(x_{g(c)})$.
	and
	%\[
	$
	\lifboth{Q(g(c))} = Q(x_{g(c)}) \spam\neq \AIclpre(Q(g(c))) =  Q(x_{g(v)}).
	$
	%\]
	However in this instance, it is not possible to find quantifiers for the free variables of $\AImatpre(\square)$ such that by binding them, an interpolant is produced.
	For the naive approach, namely to use $\exists y_c \forall x_{g(v)} \forall x_{g(u)}$ as prefix, it holds that
	$\Gamma \notentails \exists y_c \forall x_{g(v)} \forall x_{g(u)} ((Q(x_{g(v)}) \land R(y_c)) \spam\lor (\lnot Q(x_{g(u)}) \land P(y_c)))$.
	This failure is possible as intuitively, resolution deductions are valid by virtue of the resolved literals being equal.
	The interpolant extraction procedure exploits this property not directly on the clauses but on the lifted clause, i.e.\ on $\AIcl(C)$ for a clause $C$.
	Note that by ensuring that for resolved literals $l$ and $l'$, it holds that $l\cl = l'\cl$, we can obtain an interpolant, for instance:
	$
	\exists y_c \forall x^\ast ((Q(x^\ast) \land R(y_c)) \spam\lor (\lnot Q(x^\ast) \land P(y_c)))
	$.
\end{exa}

In order to avoid the pitfall shown in Example \ref{exa:2b} and to generalize the indicated solution,
we define a function on resolved literals calculating a substitution, which ensures that the literals in the lifted clause, which correspond to the resolved literals, are equal.

\begin{defi}[$\aiu$]
	Let $\inference$ be a resolution or factorisation rule application with $l$ and $l'$ as resolved or factorised literals, $\sigma = \mgu(\inference)$

	\newcommand{\aiuP}{\aiu'}

	For terms $s$ and $t$ where
	$s = \lifboth{l\fromclause\sigma}\at{p}$
	and
	$t = \lifboth{l'\fromclause\sigma}\at{p}$
	for some position $p$, we define:
	\[
		\aiuP (s, t) \defeq
		\begin{cases}
			\bigcup_{i=1}^n \aiuP(s_i, t_i) &
			\parbox[t]{.50\textwidth}{
				%\text{
			if $s$ is grey, $s=f_s(s_1, \dots, s_n)$ and\newline$t = f_{t}(t_1,\dots, t_n)$\footnotemark} \\
			\{z_{s'} \mapsto z_r, z_{t'} \mapsto z_r\} &
			\parbox[t]{.50\textwidth}{
				%\text{
				if $s$ is a lifting variable $z_{s'}$, $t = z_{t'}$,
				and $z_r = \lifboth{l\sigma}\at{p}$
			}
			%\{x_j \mapsto x_m, x_k \mapsto x_m\} & \parbox[t]{.75\textwidth}{if $a\cl = x_j$ and $b\cl = x_k$, both lifting variables, and $x_m$ is the       corresponding lifted term in the unified literal, i.e. $x_m = \lifboth{a\sigma} = \lifboth{b\sigma}$. This means to just take the term from the   literal in the actual clause.}
		\end{cases}
	\]
	\footnotetext{Note that constants are treated as function symbols of arity zero.}
	For $\lifboth{l\cl\sigma} = P(s_1, \dots, s_n)$ and $\lifboth{l'\cl\sigma} = P(t_1, \dots, t_n)$, we define:
	\[
		\aiuP(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma}) =
		\aiuP(P(\overline s), P(\overline t)) \defeq \bigcup_{i=1}^n \aiuP(s_i, t_i)
	\]
	\[
		\aiu(\inference) \defeq \aiuP(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma}) \qedhere
	\]
	%For resolved or factorised literals $l $ and $l'$ of a resolution derivation step with a unifier $\sigma$ such that $l\sigma = l'\sigma$,
\end{defi}

\begin{prop}
	\label{prop:tau_dom_ran}
	Let $\inference$ be a resolution or factorisation rule application with $l$ and $l'$ as resolved or factorised literals, $\sigma = \mgu(\inference)$
	Then $\dom(\aiu(\inference))$ consists exactly of the lifting variables of $\lifboth{l\fromclause\sigma}$ and $\lifboth{l'\fromclause\sigma}$ and $\ran(\aiu(\inference))$ consists exactly of the lifting variables of $\lifboth{l\sigma}$.
\end{prop}

\todo[inline]{possibly argue here why $\aiu$ is well-defined (but it follows more or less directly from a later lemma)}


\begin{defi}[$\AImat$ and $\AIcl$]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	\defiemph{$\AImat(\pi)$} is defined to be $\AImat(\square)$, where $\square$ is the empty clause derived in $\pi$.

	For a clause $C$ in $\pi$, \defiemph{$\AImat(C)$} and \defiemph{$\AIcl(C)$} are defined inductively as follows:
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, $\AImat(C) \defeq \bot$.
			If otherwise $C \in \Delta$, $\AImat(C) \defeq \top$.

			In any case, $\AIcl(C) \defeq \lifboth{C}$.
		\item[Resolution.]

			If the clause $C$ is the result of a resolution step \inference{} of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$,
			then
			let $\tau = \aiu(\inference)$ and
			define $\AImat(C)$ and $\AIcl(C)$ as follows:

			$\AIcl(C) \defeq \lifboth{(\AIclause(C_1) \setminus \{l\fromclause\})\sigma}\tau \spam\lor \lifboth{(\AIclause(C_2)\setminus \{l\fromclause'\})\sigma}\tau $
			\begin{enumerate}

				\item If $l$ is $\Gamma$-colored:
					$\AImat(C) \defeq \lifboth{\AImat(C_1)\sigma}\tau\spas\lor \lifboth{\AImat(C_2)\sigma}\tau $

				\item If $l$ is $\Delta$-colored:
					$\AImat(C) \defeq \lifboth{\AImat(C_1)\sigma}\tau\spas\land \lifboth{\AImat(C_2)\sigma}\tau $

				\item If $l$ is grey:
					$\AImat(C) \defeq
					(\lnot {\lifboth{l'\fromclause\sigma}}\tau \land \lifboth{\AImat(C_1)\sigma}\tau) \spam\lor
					(\lifboth{l\fromclause\sigma}\tau \land \lifboth{\AImat(C_2)\sigma}\tau)
					$

			\end{enumerate}

		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation $\inference$ of $C_1: l \lor l' \lor D$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$,
			then let $\tau = \aiu(\inference)$ and define
			$\AImat(C)$ and $\AIcl(C)$ as follows:

			$\AImat(C) \defeq{} \lifboth{\AImat(C_1)\sigma}\tau$

			$\AIcl(C) \defeq \lifboth{ (\AIclause(C_1) \setminus\nolinebreak \{l'\cl\})\sigma}\tau$
			\qedhere

	\end{itemize}
\end{defi}

\section{Lifting the $\Delta$-terms}

\begin{defi}
	$\AImatde(C)$ ($\AIclde(C)$) for a clause $C$ is defined as $\AImat(C)$ ($\AIcl(C)$) with the difference that in its inductive definition, every lifting $\lifboth{\varphi}$ for a formula or term $\varphi$ is replaced by a lifting of only the $\Delta$-terms $\lifdeltanovar{\varphi}$.
\end{defi}

\begin{lemma}
	\label{lemma:no_colored_terms}
	Let $C$ be a clause of a resolution refutation $\pi$ of $\Gamma\cup\Delta$.
	$\AImat(C)$ and $\AIcl(C)$ do not contain colored symbols.
	$\AImatde(C)$ and $\AIclde(C)$ do not contain \mbox{$\Delta$-c}olored symbols.
\end{lemma}
\begin{proof}
	For $\AImat(C)$ and $\AIcl(C)$, consider the following:
	In the base case of the inductive definitions of $\AImat(C)$ and $\AIcl(C)$, no colored symbols occur.
	In the inductive steps, any colored symbol which is added by $\sigma$ to intermediary formulas is lifted.
	By Proposition~\ref{prop:tau_dom_ran}, $\ran(\aiu(\inference))$ for inferences $\inference$ in $\pi$ only consists of lifting variables.

	For $\AImatde(C)$ and $\AIclde(C)$, a similar argument goes through by reading colored as $\Delta$-colored.
\end{proof}

\begin{lemma}
	\label{lemma:substitute_and_lift}
	Let $\sigma$ be a substitution and $F$ a formula without $\Phi$-colored terms such that for a set of formulas $\Psi$, $\Psi \entails F$.
	Then $\Psi \entails \lifphi{F\sigma}$.
\end{lemma}
\begin{proof}
	$\lifphi{F\sigma}$ is an instance of $F$:
	$\sigma$ substitutes variables either for terms not containing $\Phi$-colored symbols or by terms containing $\Phi$-colored symbols.
	For the first kind, the lifting has no effect.
	For the latter, the lifting only replaces subterms of the terms introduced by the substitution by a lifting variable such that the original structure of $F$ remains invariant as it by assumption does not contain colored terms.
\end{proof}

\begin{lemma}
	Let $l$ and $l'$ be resolved or factorised literals in a resolution derivation step $\inference$ creating a clause $C$ and
	$\tau = \aiu(\inference)$.
	For any substitution $(z_s \mapsto z_t) \in \tau$,




	\mytodo{check which statement we actually need (resolved literal, clause?)}

	make sure that it works for positions in the resolved literals as well as in the clause


\end{lemma}

\begin{lemma}
	\largered{ either reduce to ``equal up to index of lifting variables'' or use elaborate version as given below with additional lemma about how every $x_s$ refers to the same term PLUS variable renaming convention }
	\label{lemma:literals_clause_simgeq}
	Let $\lambda$ be a literal in a clause $C$ occurring in a resolution refutation of $\Gamma\cup\Delta$.
	Then $\AIcl(C)$ contains a literal $\lambda\cl$ such that $\lambda\cl \simgeq \lifboth{\lambda}$, where $\simgeq$ is defined as follows:
	\[
		\varphi \simgeq \varphi' \semiff
		\begin{cases}
			P = P' \land \bigwedge_{i=1}^n s_i \simgeq s'_i &  \text{ if $\varphi = P(s_1, \dots, s_n)$ and $\varphi' = P'(s'_1, \dots, s'_n)$} \\
			f = f' \land \bigwedge_{i=1}^n s_i \simgeq s'_i &  \text{ if $\varphi = f(s_1, \dots, s_n)$ and $\varphi' = f'(s'_1, \dots, s'_n)$} \\
			x = x' & \text{ if $\varphi, \varphi'$ are non-lifting variables, $\varphi = x$ and $\varphi' = x'$} \\
			s' \text{ is an instance of } s  & \text{ if $\varphi, \varphi'$ are lifting variables, $\varphi = z_s$ and $\varphi' = z_{s'}$} \\
		\end{cases}
	\]
	For resolved or factorised literals $\lambda$ of an inference $\inference$ with $\tau = \aiu(\inference)$ we furthermore have that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.
	\todo[inline]{introduce definition for characterising the relation between $C$ and $\AIcl(C)$}
\end{lemma}
\begin{proof}
	We proceed by induction on the resolution refutation.
	\begin{description}
		\item{Base case.}
			If for a clause $C$ either $C\in \Gamma$ or $C \in \Delta$ holds, then $\AIcl(C) = \lifboth{C}$.
			Therefore for every literal $l$ in $C$, there exists a literal $l\cl$ in $\AIcl(C)$ such that $\lifboth{l} = l\cl$, which implies $l\cl \simgeq \lifboth{l}$.

		\item{Resolution.}
			If the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$,
			then let $\tau = \aiu(\inference)$.
			Let $\lambda$ be a literal in $C_1$ or $C_2$.
			Note that every literal in $C$ is of the form $\lambda\sigma$.
			By the induction hypothesis, there is a literal in $\AIcl(C_1)$ or $\AIcl(C_2)$ respectively such that $\lambda\cl \simgeq \lifboth{\lambda\cl}$.
			If $\lambda \not\in\{l,l'\}$, then $\lifboth{\lambda\cl\sigma}\tau$ is contained in $\AIcl(C)$.
			Hence in any case, it remains to show that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.


			%Every literal in $C$ is of the form $\lambda\sigma$ for some $\lambda \in C_1$ or $\lambda \in C_2$. Without loss of generality let $\lambda \in C_1$.
			%By the induction hypothesis, there is a literal in $\AIcl(C_1)$ such that $\lambda\cl \simgeq \lifboth{\lambda\cl}$.

			%As $\lambda \neq l$, by the definition of $\AIcl$, $\lifboth{\lambda\cl\sigma}\tau$ is contained in $\AIcl(C)$.
			%It remains to show that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.

			We perform an induction on the structure of $\lambda\cl$ and $\lambda$
			by letting $p$ be the position of the current term in the induction and $t\cl = \lambda\cl\at{p}$ as well as $t=\lambda\at{p}$.
			\begin{itemize}
				\item
					Suppose that $t$ is a non-lifting variable.
					As by the induction hypothesis $\lifboth{t\cl} \simgeq t$, $t\cl$ is a non-lifting variable as well and $t = t\cl$.
					But then $\lifboth{t\cl\sigma} = \lifboth{t\sigma}$.
					If $\tau$ is trivial on $\lifboth{t\cl\sigma}$, we are done as then $\lifboth{t\cl\sigma}\tau = \lifboth{t\sigma}$, so assume that it is not.

					But by the definition of $\aiu$, the substitutions in $\tau$ only update lifting variables to correspond to the terms in the clause of the actual resolution derivation.
					More formally, $\lifboth{t\cl\sigma}\tau = z_s$ for some term $s$ implies that $\lifboth{\lambda\sigma}\at{p} = z_s$, but then $z_s = t$.
					\largered{this argument only holds for terms in the resolved literals, see remark in lemma statement}
					\todo[inline]{outsource this thought to lemma after definition of $\aiu$ in case needed elsewhere}

				\item
					Suppose that $t$ is colored term.
					Then $\lifboth{t}$ is a lifting variable and by the induction hypothesis, $t\cl$ is one as well such that
					$\lifboth{t}$ is an instance of $t\cl$.
					As lifting variables are not affected by the unifications occurring in resolution derivations, we only need to consider modifications by means of $\tau$.
					But as we have seen in the previous case, if $\tau$ substitutes $\lifboth{t\cl\sigma}$, then it does so by $t$.
					\todo[inline]{lemma}
					Hence we obtain that $\lifboth{t\cl\sigma}\tau \simgeq \lifboth{t\sigma}$.

				\item
					Suppose that $t$ is a grey term of the form $f(s_1, \dots, s_n)$.
					Then $\lifboth{t} = f(\lifboth{s_1}, \dots, \lifboth{s_n})$ and by the induction hypothesis, $t\cl = f(r_1, \dots, r_n)$ such that
					$\bigwedge_{i=1}^n r_i \simgeq \lifboth{s_i}$ .
					By the induction hypothesis applied to the parameters of $\lifboth{t}$ and $\lifboth{t\cl}$, we obtain that  $\lifboth{r_i\sigma}\tau \simgeq \lifboth{s_i\sigma}$ for $1\nolinebreak \varleq\nolinebreak i\nolinebreak \varleq\nolinebreak n$.
					Hence $  f(\lifboth{r_1\sigma}, \dots, \lifboth{r_n\sigma}) \simgeq f(\lifboth{s_1\sigma}, \dots, \lifboth{s_n\sigma})$,
					which however is nothing else than
					$\lifboth{t\cl\sigma} \simgeq \lifboth{t\sigma} $.

			\end{itemize}

		\item{Factorisation.}
			If the clause $C$ is the result of a factorisation, then we can argue analoguously as for resolution.
			%If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$, then let $\tau = \aiu(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma})$.
			%The rest of this proof resembles the case of resolution:
			%Every literal in $C$ is of the form $\lambda\sigma$ for some $\lambda \in C_1$.
			%By the induction hypothesis, there is a literal in $\AIcl(C_1)$ such that $\lambda\cl \simgeq \lifboth{\lambda}$.
			%As $\lambda \neq l$, by the definition of $\AIcl$, $\lifboth{\lambda\cl\sigma}\tau$ is contained in $\AIcl(C)$.
			%A similar induction argument as for the case of resolution shows that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.
			\qedhere
	\end{description}

\end{proof}

\begin{lemma}
	\label{lemma:lifted_literal_equal}
	Let $l$ and $l'$ be the resolved or factorised literals of a resolution derivation step $\inference$ employing the unifier $\sigma$ such that $l\sigma = l'\sigma$.
	Furthermore let $\tau =\nolinebreak \aiu(\inference)$.
	Then $\lifboth{l\cl\sigma}\tau = \lifboth{l\cl'\sigma}\tau$.
\end{lemma}
\begin{proof}
	As
	$l\sigma = l'\sigma$, it also holds that
	$\lifboth{l\sigma} = \lifboth{l'\sigma}$.
	By Lemma~\ref{lemma:literals_clause_simgeq}, we obtain that
	$\lifboth{l\cl\sigma}\tau \simgeq \lifboth{l\sigma}$ and
	$\lifboth{l'\cl\sigma}\tau \simgeq \lifboth{l'\sigma}$.
	Furthermore note that the $\simgeq$-\nolinebreak{}relation guarantees that pairs of predicates and terms in this relation are equal up to the index of their lifting variables.
	Hence it only remains to show that the lifting variables of $\lifboth{l\cl\sigma}\tau$ and $\lifboth{l'\cl\sigma}\tau$ match.
	But by the definition of $\aiu$, $\tau$ substitutes any lifting variable at position $p$ of $\lifboth{l\cl\sigma}$ and $\lifboth{l'\cl\sigma}$ by the lifting variable $\lifboth{l\sigma}\at{p}$,
	thus making them equal.
\end{proof}


\begin{lemma}
	\label{lemma:gamma_entails_aide}
	Let $\pi$ be a resolution refutation of $\Gamma\cup\Delta$.
	Then for clauses $C$ in\nolinebreak{} $\pi$,
	$\Gamma\entails\nolinebreak \AImatde(C) \lor\nolinebreak \AIclde(C)$.
\end{lemma}
\begin{proof}
	We proceed by induction of the strengthening $\Gamma\entails \AImatde(C) \lor \AIclde(C_\Gamma)$\footnotemark.\footnotetext{Recall that as in Lemma~\ref{lemma:gamma_entails_lifted_interpolant}, $D_\Phi$ denotes the clause created from the clause $D$ by removing all literals which are not contained $\Lang(\Phi)$.}

	\begin{description}
		\item{Base case.}
			For $C\in \Gamma$, $\AIclde(C_\Gamma) = \AIclde(C) = \lifdeltanovar{C} = C$, so $\Gamma \entails \AIclde(C_\Gamma)$.
			Otherwise $C \in \Delta$ and hence $\AImatde(C) = \top$.

		\item{Resolution.}
			Suppose the last rule application is an instance $\inference$ of resolution. Then it is of the following form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor l}
				\AxiomCm{C_2: E \lor \lnot l'}
				\RightLabelm{\quad l\sigma = l'\sigma}
				\BinaryInfCm{C: (D\lor E)\sigma}
			\end{prooftree}

			Let
			$\tau = \aiu(\inference)$.
			We introduce the following abbreviations:

			\newcommand{\clauseOnePrime}{\AIclausede((C_1)_\Gamma)^*}
			\newcommand{\clauseTwoPrime}{\AIclausede((C_2)_\Gamma)^*}


			$ \clauseOnePrime = \AIclausede((C_1)_\Gamma) \setminus \{{(l{\fromclausede})_\Gamma}\}$

			$ \clauseTwoPrime = \AIclausede((C_2)_\Gamma)\setminus \{{\lnot (l{\fromclausede'})_\Gamma}\}$

			Note that $\AIclde(C) = \lifdeltanovar{ \clauseOnePrime\sigma} \tau \lor \lifdeltanovar{ \clauseTwoPrime\sigma} \tau$.

			Employing these, the induction hypothesis yields
			$\Gamma \entails \AImatrixde(C_1) \lor \clauseOnePrime \lor {(l{\fromclausede})_\Gamma}$
			as well as
			$\Gamma \entails \AImatrixde(C_2) \lor \clauseTwoPrime \lor {\lnot (l'{\fromclausede})_\Gamma}$.
			By Lemma~\ref{lemma:no_colored_terms}, $\AImatrixde(C_i)$ and $\AIclde(C_i)$ for $i\in\{1,2\}$ do not contain $\Delta$-colored symbols.
			Hence by Lemma~\ref{lemma:substitute_and_lift}, pulling the lifting inwards using Lemma~\ref{lemma:lift_logic_commute} and applying $\tau$, we obtain:

			$\Gamma \stackrel{\markA}\entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{(l{\fromclausede})_\Gamma\sigma}\tau$

			$\Gamma \stackrel{\markB}\entails \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau \lor \lnot \lifboth{(l{\fromclausede'})_\Gamma\sigma}\tau$

			We continue by a case distinction on the color of $l$:
			\begin{enumerate}
				\item Suppose that $l$ is $\Gamma$-colored. Then $\AImatde(C) = \lifboth{\AImatde(C_1)\sigma}\tau\spas\lor \lifboth{\AImatde(C_2)\sigma}\tau$.
					As $l$ is $\Gamma$-colored, $(l{\fromclausede})_\Gamma = l\clde$ and
					as $l\sigma = l'\sigma$, also $(l{\fromclausede'})_\Gamma = l'\clde$.
					By Lemma~\ref{lemma:lifted_literal_equal}, $\lifboth{l{\fromclausede}\sigma}\tau = \lifboth{l{\fromclausede'}\sigma}\tau$.
					Hence we can perform a resolution step on \markA{} and \markB{} to arrive at
					$\Gamma \entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau
					\lor \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau$.
					This is however by Lemma~\ref{lemma:lift_logic_commute} nothing else than $\Gamma \entails \AImatde(C) \lor \AIclde(C)$.

				\item Suppose that $l$ is $\Delta$-colored. Then $\AImatde(C) = \lifboth{\AImatde(C_1)\sigma}\tau\spas\land \lifboth{\AImatde(C_2)\sigma}\tau$.
					As $l$ and $l'$ are $\Delta$-colored, \markA{} and \markB{} reduce to
					$\Gamma \entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau $ and
					$\Gamma \entails \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau $ respectively.
					These however imply that
					$\Gamma \entails (\lifboth{\AImatrixde(C_1)\sigma}\tau \land  \lifboth{\AImatrixde(C_2)\sigma}\tau) \spas\lor\allowbreak \lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau$,
					which in turn is nothing else than $\Gamma \entails\nolinebreak \AImatde(C) \lor \AIclde(C)$.

				\item Suppose that $l$ is grey. Then $\AImatde(C) =
					(\lnot {\lifboth{l'\fromclausede\sigma}}\tau \land \lifboth{\AImatde(C_1)\sigma}\tau) \spam\lor\allowbreak
					(\lifboth{l\fromclausede\sigma}\tau \land \lifboth{\AImatde(C_2)\sigma}\tau)
					$.

					Let $M$ be a model of $\Gamma$. Suppose that $M \notentails \AIclde(C)$ as otherwise we are done. Hence $M \notentails \lifboth{\clauseOnePrime\sigma}\tau$ and $M \notentails \lifboth{\clauseTwoPrime\sigma}\tau$ and \markA{} and \markB{} reduce to
					$\Gamma \entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{l{\fromclausede}\sigma}\tau$
					and
					$\Gamma \entails \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{l{\fromclausede'}\sigma}\tau$ respectively.
					As by Lemma~\ref{lemma:lifted_literal_equal} $\lifboth{l{\fromclausede}\sigma}\tau = \lifboth{l{\fromclausede'}\sigma}\tau$, a case distinction on the truth value of $\lifboth{l{\fromclausede}\sigma}\tau$ in $M$ shows that $M\entails \AImatde(C)$.


			\end{enumerate}



		\item{Factorisation.}
			Suppose the last rule application is an instance of factorisation. Then it is of the following form:
			\begin{prooftree}
				\AxiomCm{C_1: l \lor l' \lor D}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\UnaryInfCm{C: (l \lor D)\sigma}
			\end{prooftree}

			Let $\tau = \aiu(\inference)$.
			We introduce the abbreviation $\AIclde( (C_1)_\Gamma)^* \defeq \AIclde( (C_1)_\Gamma) \setminus \{ (l\cl)_\Gamma , (l'\cl)_\Gamma \}$ and express the induction hypothesis as follows:
			$\Gamma \entails \AImatde(C_1) \lor \AIclde( (C_1)_\Gamma)^* \lor (l\cl)_\Gamma \lor (l'\cl)_\Gamma $.
			By Lemma~\ref{lemma:no_colored_terms}, Lemma~\ref{lemma:substitute_and_lift} and Lemma~\ref{lemma:lift_logic_commute} and after applying $\tau$ to the induction hypothesis, we obtain that
			$\Gamma \entails \lifboth{\AImatde(C_1)\sigma}\tau \lor \lifboth{\AIclde( (C_1)_\Gamma)^*\sigma}\tau \lor \lifboth{(l\cl)_\Gamma \sigma}\tau \lor \lifboth{(l'\cl)_\Gamma\sigma}\tau $.

			However by Lemma~\ref{lemma:lifted_literal_equal},
			$\lifboth{(l\cl)_\Gamma\sigma}\tau =
			\lifboth{(l'\cl)_\Gamma\sigma}\tau$, hence we can perform a factorisation step to arrive at
			$\Gamma \entails \lifboth{\AImatde(C_1)\sigma}\tau \lor \lifboth{\AIclde( (C_1)_\Gamma)^*\sigma}\tau \lor \lifboth{(l\cl)_\Gamma \sigma}\tau$.
			This however is nothing else than $\Gamma\entails \AImatde(C) \lor \AIclde(C)$.
			\qedhere
	\end{description}
\end{proof}


As we have just seen, the formula $\AImatde(C) \lor \AIclde(C)$ now satisfies one condition of interpolants.
Using this, we are able to formulate a result on one-sided interpolants, which are defined as follows:

\begin{defi}
	Let $\Gamma$ and $\Delta$ be sets of first-order formulas.
	A \defiemph{one-sided interpolant} of $\Gamma$ and $\Delta$ is a first-order formula $I$ such that
	\begin{enumerate}
		\item $\Gamma \entails I$
		\item $\Lang(I) \subseteq \Lang(\Gamma) \cap \Lang(\Delta)$
			\qedhere
	\end{enumerate}
\end{defi}

\begin{prop}
	Let $\Gamma$ and $\Delta$ be sets of first-order forumulas such that $\Gamma\cup\Delta$ is unsatisfiable.
	Then there is a one-sided interpolant of $\Gamma$ and $\Delta$ which is a $\Pi_1$ formula.
\end{prop}
\begin{proof}
	Let $\pi$ be a resolution refutation of $\Gamma\cup\Delta$.
	By Lemma~\ref{lemma:gamma_entails_aide}, $\Gamma \entails \AImatde(\pi) \lor \AIclde(\pi)$,
	or in other words
	$\Gamma \entails \forall x_1 \dots \forall x_n  \AImatde(\pi) \lor \AIclde(\pi)$, where $x_1, \dots, x_n$ are the $\Delta$-lifting variables occurring in $\AImatde(\pi) \lor \AIclde(\pi)$.
	%Let $x_1, \dots, x_n$ be the $\Delta$-lifting variables in $I$.
	By Lemma~\ref{lemma:no_colored_terms}, the formula $\AImatde(\pi) \lor \AIclde(\pi)$ does not contain $\Delta$-colored symbols.

	Let $y_1, \dots y_m$ be the $\Gamma$-lifting variables of $\lifgamma{\AImatde(\pi) \lor \AIclde(\pi)}$
	and
	\[I = \forall x_1 \dots \forall x_n \exists y_1 \dots \exists y_m \lifgamma{\AImatde(\pi) \lor \AIclde(\pi)}.\]
	Note that $I$ does not contain any $\Gamma$-terms.
	As $\AImatde(\pi) \lor \AIclde(\pi)$ contains witness terms for every existential quantifier in $I$ with respect to $\Gamma$, $\Gamma \entails I$.
	Hence $I$ is a $\Pi_1$ formula which is a one-sided interpolant for $\Gamma \cup \Delta$.
\end{proof}


\section{Arrows}


\mytodo{transition to ordering of quantified lifting vars}

In order to establish the required ordering on the lifting variables, we annotate the literals with arrows.
More formally:

\begin{defi}[$\AIcol$]
	The set of colored literals with respect to a clause $C$ in a resolution derivation is defined as follows:

	\begin{itemize}
		\item[Base case.]
			For $C \in \Gamma\cup\Delta$, $\AIcol(C) \defeq \emptyset$.

		\item[Resolution.]
			Suppose the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ with $\sigma = \mgu(\inference)$ and $\tau = \aiu(\inference)$.
			Then:

			$\AIcol(C) \defeq \{ \lifboth{\varphi\sigma}\tau \mid \varphi \in \AIcol'(C) \}$, where

			$\AIcol'(C) \defeq
			\begin{cases}
				\AIcol(C_1) \cup \AIcol(C_2) \cup \{ l\cl, l'\cl \}  & \text{ if $l$ is a colored literal} \\
				\AIcol(C_1) \cup \AIcol(C_2) & \text{ if $l$ is a grey literal}
			\end{cases} $

		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation of $C_1$, then
			$\AIcol(C) \defeq \{ \lifboth{\varphi\sigma}\tau \mid \varphi \in \AIcol(C_1) \}$.
			\qedhere
	\end{itemize}
\end{defi}

\begin{defi}[$\AIany$]
	For a clause $C$, $\AIany(C)$ denotes $\AImat(C)$, $\AIcl(C)$, $\AIcol(C)$.
\end{defi}

This definition is convenient as it adheres to the following proposition:

\begin{prop}
	Let $l$ be a literal in a clause in $\Gamma \cup \Delta$.
	Then for a clause $C$ in a resolution refutation of $\Gamma\cup\Delta$,
	$\AIany(C)$ contains a literal derived from $l$.
\end{prop}


\mytodo{define: descendant (usual stuff, factorisation is merge, resolution is de-facto merge which happens implicitly so no actual merge required)}

\begin{defi}
	We define a directed graph $G_C$ for every clause $C$ of the derivation.
	The nodes are of the form $l.tp$, where $l$ denotes a literal and $tp$ a position of a term in $l$, which is not contained in a colored term.
	The node $l.tp$ in a graph $G_C$ refers to the literal in $\AImat(C)$, $\AIcl(C)$ or $\AIcol(C)$
	which is a descendant of $l$.
	Note that there exists exactly one for every literal of every clause which is an ancestor of $C$.
	Hence given $C$, $l.tp$ is a well-defined position and the position will usually just be denoted by $p$ or $q$ as abbreviation of $l.tp$.
	For literals in $\AIcl(C)$, we usually denote the literal by $l\cl$ and the corresponding literal in $C$ by $l$.
	Note that set of literals in $\AIcl(C)$ is exactly the set of literals of $C$.

	Note that term positions are well defined since arcs do not point into colored terms and are hence not removed by liftings and in the course of the derivation, terms in literals are only modified by substitutions, which does not remove any term which might invalidate a term position.

	\label{def:arrows}
	\begin{itemize}
		\item[Base case.]
			For $C \in \Gamma\cup\Delta$, we define $G_C$ to be the empty graph.

		\item[Resolution.]
			If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma =  l'\sigma$, we define:

			\mytodo{find meaningful name for index when usage of $\arr_1$ is clear}

			\comm{old idea, basically requires to know term behind lifting var \tiny $\arr_1 \defeq \{ (p, q) \mid $ maximal colored term $t$ occurs in $x\sigma$ for some variable $x$, $p$ grey occurrence of $t$ in $C$ (NOTE: does not only mean $C$ actually), $q$ maximal colored term containing colored occurrence of $x$ (where the color of $x$ is different from the color of $t$) in $C_1$ or $C_2 \}$}

			\NB{this will only work for $\AIde$, c.f.\ 212c:}

			$\arr_1 \defeq \{ (p, q) \mid $ maximal colored term $t$ occurs in $x\sigma$ for some variable $x$, $p$ grey occurrence of $z_t$ in $\AIany(C)$, $q$ maximal colored term containing colored occurrence of $x$ (where the color of $x$ is different from the color of $t$) in $C_1$ or $C_2 \}$

			$\arr_2 \defeq \{ (p, q) \mid $ maximal $\Phi$-term $t$ occurs in maximal $\Psi$-term $s$ in $x\sigma$ for some variable $x$, $p$ grey occurrence of $t$ in $C$, $q$ grey occurrence of $x$ or maximal colored term containing colored occurrence of $x$ in $C_1$ or $C_2$,
			$(\Phi, \Psi) \in \{(\Gamma, \Delta), (\Delta, \Gamma)\} \} $

			% old version:
			%$\arr_2 \defeq \{ (p, q) \mid $ maximal $\Phi$-term $t$ occurs in maximal $\Psi$-term $s$ in $x\sigma$ for some variable $x$, $p$ grey occurrence of $t$ in $C$, $q$ grey or colored occurrence of $x$ in $C_1$ or $C_2$,
			%$(\Phi, \Psi) \in \{(\Gamma, \Delta), (\Delta, \Gamma)\} \} $

			$G_C \defeq G_{C_1} \cup G_{C_2} \cup \arr_1 \cup \arr_2$


		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then

			$G_C \defeq G_{C_1} \cup G_{C_2}$\footnote{Note however that the literal $l$ in $C$ has $l$ as well as $l'$ in $C_1$ as predecessors, i.e.~the arrows from both of these literals apply implicitly.}
			\qedhere
	\end{itemize}
\end{defi}

\begin{defi}[$\apath$]
	For terms $s$ and $t$, $s\apath_{G_C} t$ holds if there is some $p, q$ in the edge set of $G_C$ such that $s$ is a subterm of the term at $p$ and $t$ is a subterm of the term at $t$ such that $s$ and $t$ are not contained in colored terms. (NOTE: in $\AIde$, $\Gamma$-terms are not colored terms in this sense.)
\end{defi}


\begin{lemma}
	\label{lemma:unified_term_starts_somewhere_grey}
	Let $l$ and $l'$ be variable disjoint literals and $\sigma = \mgu(l, l')$
	such that for a variable $x$, $t$ occurs grey in $x\sigma$.

	Then there is a sequence of variables $x_1,\dots, x_n$ with $x_1 = x$ such that for $1\varleq i \varleq n-1$,
	$t$ occurs grey in $x_i \sigma$ and
	$x_i \mguarr r\occ{x_{i+1}}$, where $x_{i+1}$ occurs grey in $r\occ{x_{i+1}}$.
	Furthermore,
	$x_n \mguarr r_t$, where $r_t$ contains the outermost symbol of $t$ at a grey position.


	\mytodo{prove here as well: } if $x_i$ occurs grey/in s.c.\ $\Phi$-term, then $x_{i+1}$ occs grey/in s.c.\ $\Phi$-term due to literals same and term grey in unifier image.
\end{lemma}

\begin{proof}
	\mytodo{ accidentally proved below: }
	
	POSSIBLE BETTER STATEMENT:
	There is a sequence of variable $y_1, \dots, y_n$ such that $y_i\sigma$ contains $x$ and $y_i \mguarr r\occ{y_{i+1}}$ for $1\varleq i \varleq n-1$ where $r\occ{y_{i+1}}$ is a grey term and $y_n \mguarr r\occ{x}$, where $r\occ{x}$ is a grey term as well or a variable.

	Inductive definition:
	Let $y_1 = y$. For each $y_i$, $y_i \mguarr t$ for some $t$ such that $t$ is an abstraction of $y_i\sigma$, which is a term containing a grey occurrence of $x$.
	Hence either $x$ occurs in $t$, then $i=n$.
	Otherwise $x$ does not occur in $t$ and there is a variable in $t$ such that $v\sigma$ contains a grey occurrence of $x$.
	Let $y_{i+1} = v$.
	Note that as $\sigma$ only changes a finite number of variables, a variable can only be added to the sequence finitely often and cycles are not possible by the nature of the unification algorithm.
\end{proof}


\begin{lemma}
	\label{lemma:colored_y_sigma_contains_grey_x}
	Let a single-colored $\Phi$-term $s\occ{y}$ occur in $l$ or $l'$ such that $x$ occurs grey in $y\sigma$.
	Then at least one of the following statements holds:
	\begin{compactenum}
	\item
		there is a variable $z$ such that $x$ occurs grey in $z\sigma$ and $z$ occurs grey in $l$ or $l'$
		\label{27_z_grey}
	\item $x$ occurs in a s.c.\ $\Phi$-term \label{27_x_in_sc_phi}
	\item there is a variable $z$ such that $z\sigma$ contains a grey occurrence of $x$ and $z$ occurs in either $l$ or $l'$ two times: once in s.c.\ $\Phi$-term and once in $s.c.$\ $\Psi$-term.
		\label{27_mixed}

	\end{compactenum}
\end{lemma}
\begin{proof}

	By Lemma~\ref{lemma:unified_term_starts_somewhere_grey}, there is a sequence \dots.
	We distinguish on the coloring of $y_n$.

	\begin{itemize}
		\item Suppose that $y_n$ occurs grey. 
			Then we have established item~\ref{27_z_grey} where $z=y_n$.
		\item 
			Suppose that $y_n$ occurs in a single-colored $\Phi$-term.
			Then as $y_n \mguarr r\occ{x}$ where $r\occ{x}$ contains a grey occurrence of $x$, $x$ does so as well and we have established item~\ref{27_x_in_sc_phi}.
		\item 
			Suppose that $y_n$ occurs in a single-colored $\Psi$-term for $\Psi \neq \Phi$.
			\mytodo{this is now proved in lemma 24, drop here}
			As $y_1 = y$, $y_1$ occurs in a single-colored $\Phi$-term.
			As for $1 \varleq i \varleq n-1$, $y_i \mguarr r\occ{y_{i+1}}$ where $y_{i+1}$ occurs grey in  $r\occ{y_{i+1}}$, each successive variable occurs in the same coloring as the last one.
			As $y_1$ and $y_n$ are contained in single-colored terms of different colors, there must be some $j$, $1\varleq j\varleq n$, such that $y_j$ occurs in a clause once in a single-colored $\Phi$-term as well as in a single-colored $\Psi$-term, establishing item~\ref{27_mixed}.
			\qedhere
	\end{itemize}

\end{proof}


\begin{lemma}
	\label{lemma:y_sigma_contains_colored_x}
	Let a variable $y$ occur in $l$ or $l'$ such that $x$ occurs in a single-colored $\Phi$-term in $y\sigma$.
	Then at least one of the following statements holds:
	\begin{compactenum}
	\item 
		there is a variable $z$ such that $x$ occurs grey in $z\sigma$ and $z$ occurs grey in $l$ or $l'$
	\item
		a single-colored $\Phi$-term in $l$ or $l'$ contains $x$
		\label{29_grey_x}
	\item
		there is a variable $z$ such that $z\sigma$ contains a grey occurrence of $x$ and $z$ occurs in either $l$ or $l'$ two times: once in s.c.\ $\Phi$-term and once in $s.c.$\ $\Psi$-term.
	\end{compactenum}
\end{lemma}
\begin{proof}

	\mytodo{rewrite without the sequence; should be just like an algo and only an induction if i know how to do it properly}

	We attempt to build a sequence of variables $y_1, \dots, y_n$ such that $y_i\mguarr r\occ{y_{i+1}}$, where $r\occ{y_{i+1}}$ contains $y_{i+1}$ and does not contain $\Psi$-terms.
	Furthermore for $1\varleq i \varleq n-1$, $y_i\sigma$ contains a single-colored $\Phi$-term containing $x$ (and no $\Psi$-symbols) and $y_n\sigma$ contains a grey occurrence of $x$ (and no $\Psi$-symbols).

	Let $y_1 = y$.
	$y_i \mguarr t$.
	\begin{itemize}
		\item
			Suppose that $t$ contains a single-colored $\Phi$-term containing $x$.
			Then we have established item~\ref{29_grey_x} and relinquish the partial sequence.

		\item
			Suppose that $t$ contains a variable $v$ such that $x$ occurs grey in $v\sigma$ and $v$ occurs in a single-colored $\Phi$-term in $t$. 
			Then by Lemma~\ref{lemma:colored_y_sigma_contains_grey_x} gives the result.

		\item
			Suppose that $t$ contains a variable $v$ such that $v\sigma$ contains a single-colored $\Phi$-term containing $x$ and no $\Psi$-symbols. Then let $y_{i+1} = v$.
	\end{itemize}
	Note that since $y_i$ contains a single-colored $\Phi$-term containing $x$, one of the last two cases must be the case in case the first isn't.

\end{proof}



\begin{lemma}
	\label{lemma:smallest_colored_container}

	Let a variable $x$ occur in $C$ once in a single-colored $\Gamma$-term and once in a single-colored $\Delta$-term.\footnote{Note that these terms may be subterms of other terms.}
	Then $x$ occurs grey in $\AIany(C)$.

	% equivalent formulation:
	%Let a variable $x$ occur in $C$ such that there is one occurrence which is contained in a smallest colored term which is a $\Gamma$-term and another occurrence which is contained in a smallest colored term which is a $\Delta$-term.
	%Then $x$ occurs grey in $\AIany(C)$.

	% equivalent formulation:
	%Let $s\occ{x}$ and $t\occ{x}$ be terms occurring in $C$ such that
	%$x$ occurs in $s\occ{x}$ and $t\occ{x}$
	%and $s$ is a $\Gamma$-term and all symbols of $s\occ{x}$ are either grey or $\Gamma$-colored,
	%and $t$ is a $\Delta$-term and all symbols of $t\occ{x}$ are either grey or $\Delta$-colored.
	%Then $x$ occurs grey in $\AIany(C)$.
\end{lemma}
\mytodo{add formal details above and below if result works out}
\begin{proof}
	We proceed by induction on the resolution refutation:

	\begin{description}
		\item{}Base case.
			Clauses contained in $\Gamma$ do not contain $\Delta$-terms and clauses contained in $\Delta$ do not contain $\Gamma$-terms.

		\item{}Resolution/Factorisation.
			Suppose the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$
			or of a factorisation step $\inference$ of $C_1: l \lor l' \lor D$.
			Let $\sigma = \mgu(\inference)$. 
			\mytodo{ avoid assigning $C_1$ twice here in final formulation }


			We consider an occurrence of a single-colored $\Phi$-term containing $x$ in $C$.
			There are three circumstances leading to this situation:
			\begin{compactenum}
				\item A single-colored $\Phi$-term containing $x$ occurs in a preceding clause.
				\item A single-colored $\Phi$-term $t\occ{y}$ in a preceding clause contains a variable $y$ such that $x$ occurs grey in $y\sigma$. \label{27_2}
				\item A variable $z$ occurs in a preceding clause such that $z\sigma$ contains a single-colored $\Phi$-term containing $x$. \label{27_3}
			\end{compactenum}

			We apply Lemma~\ref{lemma:colored_y_sigma_contains_grey_x} in the case of \ref{27_2} and
			Lemma~\ref{lemma:y_sigma_contains_colored_x} in the case of \ref{27_3} to obtain that in any of the cases, at least one of the following statements hold:

			[ copy formulation from lemma once it's finished there ]

			Now suppose that $x$ occurs in a single-colored $\Gamma$-term and in a single-colored $\Delta$-term in $C$.
			By applying the reasoning as just given, we know that one of the three statments holds for both occurrences. 

			If for any one $z$ grey with $z\sigma$ contains grey $x$, then done

			{ \tiny

				old way: 

				If IH-case, then: IH

				otw both s.c. $\Gamma$ and $\Delta$-term respectively $\Ra$ IH as well.

			}

			if for any one col change case, then col change var grey by IH, and this is unified to $x$.

			otw both IH case, so one in s.c.\ $\Gamma$ and one in s.c.\ $\Delta$, but due variable disjointness in same clause, that's why IH works here.
			\qedhere

	\end{description}
\end{proof}


application of lemma below:
Suppose such a term occurs in a clause. Then suppose that it occurs in same s.c.\ term in literal, otw grey (we are done) or other color (then IH). then lemma!

\begin{lemma}
	\label{lemma:u_sigma_contains_delta_term}
	Context: resolved literals.
	Suppose a single-colored $\Gamma$-term contains a variable $u$ such that a $\Delta$-term $s$ occurs grey in $u\sigma$.
	Then one of the following statements holds:
	\begin{compactenum}
	\item there is a variable $z$ such that $s$ occurs grey in $z\sigma$ and $z$ occurs grey in $l$ or $l'$ \mytodo{possibly change this everywhere to in $l\sigma$, $s$ occurs grey}
	\item a single-colored $\Gamma$-term in $l$ or $l'$ contains $s$ outermost symbol of $s$ and variables such that in total, with the unifier we get $s$
		%\item exists var s.t.\ once s.c.\ $\Gamma$, once s.c.\ $\Delta$
	\end{compactenum}
\end{lemma}
\begin{proof}
	Suppose sequence with each unifying to next one, last one: $u_n \mguarr r\occ{s}$, where $s$ occurs grey in $r$.
	also in lemma, successive variables in same coloring

	$u$ from lemma statement occs in $\bar u$. 	

	Suppose $u_i$ grey, then done as all $u_i\sigma$ contain grey $s$, hence case 1

	Suppose one $u_i$ occs s.c.\ $\Gamma$ and  s.c.\ $\Delta$. by lemma~\ref{lemma:smallest_colored_container}, $u_i$ occurs grey and $s$ occs grey as above, hence case 1

	Otw, all colored, and as successive vars same coloring, all same s.c.\ term.
	Start with $\Gamma$, hence all $\Gamma$. 
	Hence case 2 (term contains var $v$ at grey pos which has $s$ in grey pos at $v\sigma$), hence $s$ occs grey in $\Gamma$-term.



\end{proof}


\begin{lemma}
	If in $\AImatde(C) \lor \AIclde(C)$ a
	$\Gamma$-term $t\occatp{x_s}$ contains a $\Delta$-lifting variable $x_s$, then $x_s \apath_{G_C} t\occatp{x_s}$.
\end{lemma}
\begin{proof}
	We proceed by induction.

	\begin{description}
		\item{}Base case.
			For $C \in \Gamma\cup\Delta$, consider that no mixed-colored terms occur in $C$ and hence no $\Gamma$-term in $\AImatde(C) \lor \AIclde(C)$ can contain a $\Delta$-lifting variable.

		\item{}Resolution.
			Suppose the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ with $\sigma = \mgu(\inference)$ and $\tau = \aiu(\inference)$.
			There are two possible cases in which a $\Delta$-lifting variable $x_s$ can be subterm of a $\Gamma$-colored term $t\occatp{x_s}$ in $\AImatde(C)\lor \AIclde(C)$ such that this has not been the case in $C_1$ or $C_2$:

			\begin{enumerate}

				\item Suppose a maximal colored $\Gamma$-term in $C_1$ or $C_2$ contains a variable $u$ such that $s$ occurs grey in $u\sigma$.
					\label{25_1}

					Note that it suffices to show that $x_s$ occurs grey in $\AIanyde(C)$,
					since if we suppose that it does so at position $r$,
					then $\arr_1$ as defined in Definition~\ref{def:arrows} contains $(r, q)$ such that $\AIclde(C)\at{q}$ is $t\occatp{x_s}$.
					As $\arr_1 \subseteq G_C$, this implies $x_s \apath_{G_C} t\occatp{x_s}$.

					We apply Lemma~\ref{lemma:u_sigma_contains_delta_term} as we can assume that this is also a s.c.\ $\Gamma$-term (otherwise it would contains a $\Delta$-term and be lifted \NB{afterthought, did not check global implications for this lemma}).

					in case 1, $s$ occs grey.

					in case 2, IH for that term, say $s'$: $s' \apath_{G_{C_j}} \gamma'\occ{s'}$
					$s'$ is maximal $\Delta$-term (else would be contained in $r$ and we would talk about $x_r$).
					as $\Gamma$-terms not lifted, $s'$ occurs ``grey''.
					As $s$ is in range of subst, $s$ occurs in literal being unified,
					by the definition of $\aiu$, $\{x_s \mapsto x_r\} \in \tau$
					as $r$ is the term at the position of $x_s$ in $\lambda\sigma$ for $\lambda$ the resolved literal where $s'$ occurs.

					Hence there is a grey occurrence of $x_s$ in $\AIanyde(C)$.
					\mytodo{check this}




					{\fontsize{1}{1}\selectfont 

						By Lemma~\ref{lemma:proof_along_mgu}, there is a sequence of variable $u_1, \dots, u_n$ such that $u_1 = u$ and $s$ occurs grey in $u_i \sigma$ for $1\varleq i \varleq n$.
						Note that if any variable $u_i$ occurs grey in $C_1$ or $C_2$, then at the corresponding position in $C$, the term at this position is a grey occurrence of $s$ and we are done.\todo{this is the ramp!}{}
						Therefore suppose that $u_1, \dots, u_n$ occur only colored in $C_1$ and $C_2$.

						Note that in the prefix of $x_s$ in $t\occatp{x_s}$, no $\Delta$-colored symbol occurs as otherwise $x_s$ would not occur in this term.
						Hence the smallest colored term containing the occurrence of $u$ in the predecessor of $t\occ{x_s}$ is a $\Gamma$-term.

						Lemma~\ref{lemma:proof_along_mgu} furthermore asserts that $u_i$ occurs in a resolved literal $l_i$ at $l_i\at{\bhat u_i}$ such that in the respective opposite resolved literal $l_i'$, $l_i'\at{\bhat u_i}$ contains $u_{i+1}$ for $1\varleq i\varleq n-1$ and $l_n'\at{\bhat u_n}$ contains the outermost symbol of $s$.
						Note that for $1\varleq i \varleq n$, $u_i$ occurs at least twice in its respective clause.
						Note also that as $l_i\sigma = l_i'\sigma$, $l\at{\bhat u_i}$ and $l'\at{\bhat u_i}$ share the prefix of $\bhat u_i$, so if $l\at{\bhat u_i}$ is contained in a $\Phi$-colored term, then so is the grey occurrence of $u_{i+1}$ in $l'\at{\bhat u_i}$.

						If one of the $u_i$ occurs in a clause twice such that for one occurrence, the smallest colored term containing it is $\Gamma$-colored and for the other one, the smallest colored term containing it is $\Delta$-colored, then by Lemma~\ref{lemma:smallest_colored_container}, $u_i$ occurs grey in $\AIany(C)$ and we are done.
						Therefore assume that this situation does not arise for any $u_i$, $1\varleq i \varleq n$.

						Hence as the smallest colored term containing the occurrences of $u_1$ must be $\Gamma$-terms, the same holds for $u_n$.
						But as $l'_n\at{ \bhat u_n }$ contains the outermost symbol of $s$, which is a $\Delta$-term, and $l_n\sigma = l_n'\sigma$ and the smallest colored term containing $l_n\at{ \bhat u_n }$ is a $\Gamma$-term,
						$l'_n\at{ \bhat u_n }$ is contained in a $\Gamma$-term.
						Let $r\occ{x_\varphi}$ be hte maximal colored term containing $l'_n\at{ \bhat u_n }$ and $x_\varphi$ be the lifting variable at the position of the outermost symbol of $s$ in $l'_n{}\cl\at{ \bhat u_n }$.
						Let $C_j$ be the clause containing $l'_n$.

					}

					\begin{comment}

						Hence if there is a grey occurrence of $u$, we are done, so suppose $u$ only occurs colored in $C_1$.

						As $\sigma$ is the result of the $\mgu$ algorithm as defined in \ref{def:mgu_algo},
						there must be an occurrence of $u$ in the resolved literal, say w.l.o.g.\ at $l\at{\bhat u}$,
						such that $l'\at{\bhat u}$ is an abstraction of $u\sigma$ which is different from $u$ and as $l\sigma = l'\sigma$, $l'\at{\bhat u}$ is contained in a $\Gamma$-colored term.
						\begin{itemize}
							\item Suppose that $l'\at{\bhat u}$ contains the outermost symbol of $s$.
								Then it is a $\Delta$-term contained in a $\Gamma$-term, so by the induction hypothesis,
								$x_? \apath_{G_{C_1}} r$, where $r$ is the maximal colored term containing $l'\at{\bhat u}$.
								\mytodo{}

							\item Otherwise $l'\at{\bhat u}$ contains a variable $v$ such that $v\sigma$ contains $s$.

								same circumstances as $u$, only finitely often


						\end{itemize}
						%Either $u\sigma$ contains the outermost symbol of $s$, or it contains a variable $v$ such that $v\sigma$ contains the outermost symbol of $s$. But in the latter case, $v$ must occur elsewhere in $l'$, say at $l'\at{\bhat v}$, such that again $l\at{\bhat v}$ either contains the outermost symbol of $s$ or a variable $w$ such that $w\sigma$ contains the outermost symbol of $s$.
						%Since the $\mgu$ algorithm has terminated, we know that there

					\end{comment}

				\item Suppose a variable $u$ occurs in $C_1$ or $C_2$ such that $u\sigma$ contains a multi-colored $\Gamma$-term $t$.

					Then by Lemma~\ref{lemma:proof_along_mgu},
					a variable $u_n$ occurs in a resolved literal $l$ at $l\at{\bhat u_n}$ such that in the other resolved literal $l'$, $l'\at{\bhat u_n}$ contains the outermost symbol of $t$.

					If $l'\at{\bhat u_n}$ is a multi-colored $\Gamma$-term, then by the induction hypothesis, dots

					Otherwise as the outermost symbol of $t$ is $\Gamma$-colored, $l'\at{\bhat u_n}$ contains a $\Gamma$-colored term which contains a variable $v$ such that a $\Delta$-term occurs grey in $v\sigma$, where case~\ref{25_1} gives the result, or a multi-colored $\Gamma$-term $s$ occurs grey in $v$. But as $s$ is strictly smaller than $t$, this case can only repeat finitely often before the other case is reached.

			\end{enumerate}


		\item{}Factorisation.
			If the clause $C$ is the result of a factorisation of $C_1$, then
			\mytodo{}
			\qedhere
	\end{description}


\end{proof}



\section{Combining the results}

\largered{ doesn't it work to add arrows based on $C$ (actual clause), then prove correctness via $\AI^\Delta$ and $\AI^\Gamma$, then just use $\AI$ wihout actually needing the one-sided ones? }

there's also a similar result in \texttt{-presentable}: $\lifboth{C} \sim \lifgammanovar{ \AIde(C) } $

\begin{lemma}
	Let $\overline x$ be the $\Delta$-lifting variables and $\overline y$ be the $\Gamma$-lifting variables of $\AI(C)$.
	Let $\overline {x'}$ be the $\Delta$-lifting variables of $\AIde(C)$.

	$\Gamma \entails \overline{\forall x} \AIde(C)$ implies
	$\Gamma \entails \overline{\forall x | \exists y} \AI(C)$.
\end{lemma}
\begin{proof}
	\cbstart
	(sketch) (TODO: don't use $\AIde$)
	We need to show that every $y$ in $\AI$ corresponds to the same term in $\AIde$ and that every $x$ in $\AIde$ corresponds to the same $x'$ in $\AI$

	Then we can insert the terms for $y$ in $\AI$ and they will be equal to $\AIde$. Then as there are less restrictions on the $\AIde$ than there are on the $\AI$, we are done.
	\cbend
\end{proof}


\begin{thm}
	Let $\pi$ be a resolution refutation of $\Gamma\cup\Delta$.
	Then $\AImat( \pi )$ is an interpolant.
\end{thm}
\begin{proof}

	\todo[inline]{This needs too many things I don't yet know how to make precise, so let's start with $\Gamma \entails \dots$}
\end{proof}

\label{sec:arrow_quantifier_block}

\chapter{outline of arrow part}


\subsection{Variable occurrences}
Need for var $x$ the set of colored occs and grey occs in initial clauses.
lift clauses as usual s.t. to not see any of the colored structure, hence remember only in which max colored term the var is.

for resolution/factorisation, check unifier:
\begin{compactitem}
\item
	if $x$ occurs grey in $y\sigma$, then the set of occurrences of $y$ is added to the ones of $x$, col to col and grey to grey
\item
	if $x$ occurs colored in $y\sigma$, then the set of occurrences of $y$ is added to the ones of $x$, col and grey to col
\end{compactitem}


\begin{defi}~

	\comm{(apparently not needed) arrows 1: if $x$ occurs in $y\sigma$, add arrow from every \emph{grey} occurrence of $x$ in $C$ to every colored occurrence of $y$ in $C_i$.}

	arrows 2: if a maximal $\Phi$-colored term $t$ occurs grey in $x\sigma$, add arrow from every grey occurrence of $t$ in $C$ to every \emph{$\Psi$-colored} occurrence of $x$ in $C_i$.

	arrows 3: if a maximal $\Phi$-colored term $t$ occurs inside a maximal $\Psi$-colored term $s$ in $x\sigma$, add an arrow from every grey occurrence of $t$ in $C$ to every occurrence of $x$ in $C_i$.
\end{defi}

\begin{lemma}
	If in $\AImatde(C) \lor \AIclde(C)$ a $\Gamma$-colored term $t\occ{x_s}$ contains a $\Delta$-lifting variable $x_s$, then $x_s \apath t\occ{x_s}$.
\end{lemma}
\begin{proof}
	~
	\begin{description}
		\item{} Suppose term containing max colored term which is $\Delta$-term is introduced into $\Gamma$-colored term.

			Then $\Gamma$-colored occ of $u$ in $C_i$ s.t.\ $\delta_i$ grey in $u\sigma$ ($\delta_i$ is max col term).
			Hence by arrow 2, arrow from every grey $\delta_i$ to every colored $u$.
			\mytodo{as below, need existence}

			existence 1:
			If $u$ occurs grey in $C_i$, then there, $\delta_i$ occurs grey in $C$ (this is the necessary color change case $x, f(x)$) and hence the arrow actually exists.

			existence 2 proper:
			\begin{quote}
				need to show that $\delta_i$ occurs grey given the assumptions.

				unification algo produces a chain: $u\mapsto t$, $v \mapsto s$, \dots

				$u$ only occurs colored in $C_i$.
				Hence also at $l\at{\bhat u}$.
				Therefore $l'\at{\bhat u}$ is a colored occurrence as well.

				chain of colored variables:

				if var occurs at some point grey s.t.\ $\Delta$-term is still complete, then we are done.

				if var occurs at some point at position we are unifying with, then we are done by the induction hypothesis.

				AUX LEMMA: if a $\Delta$-term enters a $\Gamma$-term, there is an arrow. Later, the terms always look the same as they are affected by the same unifications.

				\mytodo{ICI; check example}

				\bigskip

				NEW THING:

				chain: either contain variables $v$ s.t. $v\sigma$ contains $\Delta$-term, or term contains $\Delta$-term already (such that outermost symbol matches with the one we get in the end)

				in both cases: if term occurs grey, we are done. in this case, we get exactly the lifting var we want.

				if term occurs colored (can only be in $\Gamma$), then if we hit a $\Delta$-symbol, we can use the ind hyp.
				Here, we get the lifting var which just is there. NOTE: different from whether both colors are lifted or just $\Delta$-terms (see 212c).

				\bigskip

				NEW THING MORE FORMAL:

				If for some $u$, $\delta_i$ grey in $u\sigma$ and $u$ occurs in $\Gamma$-term, then $\delta_i$ occurs grey somewhere.

				Prf.
				either $u$ occurs grey, then we are done.
				Otw. $u$ only occurs colored in $\Gamma$-terms.
				so $l'\at{\bhat u}$ also colored.

				Note: arguing along subst run.

				If $l'\at{\bhat u}$ contains outermost symbol of $\delta_i$, then have $\Delta$-term in $\Gamma$-term and ind hyp.
				Otw. $l'\at{\bhat u}$ contains var $v$ s.t. $\delta_i$ grey in $v\sigma$.
				Note that now, we can apply the same argument to $v$ and this recursion terminates as $\mgu$ algo has terminated.


			\end{quote}


		\item{} Suppose multi-colored $\Gamma$-term introduced.

			Then $u$ in $C_i$ s.t.\ $\gamma\occ{\delta_i}$ in $u\sigma$.
			Hence by arrow 3, arrow from every grey $\delta_i$ to every $u$.
			\mytodo{need make sure that grey $\delta_i$ exists (exactly $\delta_i$? what if lifted)}

			existence:
			$l'\at{\bhat u}$ is an abstraction of $u\sigma$ different from $u$.
			if contains multi-colored term $\Ra$ ind hyp.
			Otw induction, $\Delta$-term must come at some point.
			we either have other case, or some multi-colored term appears.






	\end{description}

\end{proof}


\section{Garbage}

%\begin{comment}


\begin{lemma}
	\label{lemma:single_col_x_in_unif_range_old}
	Let $l$ and $l'$ be variable disjoint literals and $\sigma = \mgu(l, l')$
	and $x$ and $y$ be variables such that
	$x$ occurs in a single-colored $\Delta$-term in $y\sigma$.

	Then there is a sequence $y_1, \dots, y_n$ and some $k$ such that $1\varleq k \varleq n$, for $1\varleq i \varleq k$,
	$y_i\sigma$ contains a single-colored $\Delta$-term containing $x$ and $y_i\sigma$ does not contain $\Gamma$-symbols,
	and for $k+1\varleq i \varleq n$,
	$y_i\sigma$ contains a grey occurrence of $x$.

	Furthermore, at least one of the following statements holds:

	\begin{compactenum}
	\item some single-colored $\Delta$-term containing $x$ occurs in $l$ or $l'$
		\label{25_delta_x}

	\item some single-colored $\Gamma$-term containing $x$ occurs in $l$ or $l'$ and there is a color change: some $y_i$ is contained in a single-col $\Delta$-term and some $y_{i+1}$ is contained in a single-col $\Gamma$-term %. (hence $y_i$ and $y_{i+1}$ have a grey occ of $x$).
		\label{25_gamma_x}

		\hl{possible new text: $y_i$ (and also $y_{i+1}$ occurs grey, and they are unified to $x$ as $i > k$}

	\item $x$ occs grey.
		\label{25_grey_x}
	\end{compactenum}

	additional conjecture: for the first $y_i$, but not $y_1$, the terms are contained in single-col $\Delta$-terms. when the colored tiers are peeled off, the remaining $y_i$ are grey occs of $x$. this is where color changes are possible.
\end{lemma}
\begin{proof}
	Let $y_1 = y$.


	that for some single-colored $\Delta$-term $r$, $y \mguarr r$.
	$r$ furthermore contains $x$ or a variable $z$ such that $z\sigma$ does not contain a $\Gamma$-symbol and contains a grey occurrence of $x$ or a single-colored $\Delta$-term containing $x$.

	We build the sequence inductively:
	By Lemma~\ref{lemma:proof_along_mgu}, there is an occurrence of $y_{i_n}$ of $y_i$ such that $y_{i_n} \mguarr r$, where $r$ shares the outermost symbol with $y_i\sigma$.
	As $y_i\sigma$ is a single-colored $\Delta$-term containing $x$, $r$ either contains $x$ in which case $i = k = n$ and item \ref{25_delta_x} holds and we are done.
	Otherwise $r$ contains a variable $z$ such that $z\sigma$ contains a grey occurrence of $x$ or $z\sigma$ does not contain $\Gamma$-terms and contains a single-colored $\Delta$-term which contains $x$.
	Hence $y_{i+1} = z$ and in the first case, $k=i+1$.
	Note that the length of $z\sigma$ is a strictly smaller than the length of $y\sigma$, hence the second case can not occur infinitely often.

	If we hit the first case and $k=i+1$, then we continue defining the sequence inductively.
	Let $y_j$ be such that $y_j\sigma$ contains a grey occurrence of $x$.
	By Lemma~\ref{lemma:proof_along_mgu}, there is an occurrence $y_{j_n}$ of $y_j$ such that $y_{j_n} \mguarr s\occ{x}$, where $s\occ{x}$ contains a grey occurrence of $x$.
	If $s\occ{x}$ occurs grey or in a single-colored $\Delta$-term, when we are done, so suppose it occurs in a single-colored $\Gamma$-term.
	Note that $y_{j_n}$ is contained in a single-colored $\Phi$-term if and only if $s\occ{x}$ is.
	Note that $y_k$ is contained in a single-colored $\Delta$-term\todo{when we have finished peeling, there is at least one peeling step}.
	As single-colored $\Delta$-terms and single-colored $\Gamma$-terms are not unifiable, there is some $i$, $i< k \varleq n$\todo{varlt?} such that $y_i$ and $y_{i+1}$ occur grey in either $l$ or $l'$, so \ref{25_gamma_x} is the case.


	\mytodo{check indices of $i$, $k$}

\end{proof}

\begin{lemma}
	\label{lemma:proof_along_mgu_old}
	% OLD formulation, subset of current one:
	%Let $x$ be a variable such that in a resolution or factorisation step $\inference$ with $\sigma = \mgu(\inference)$, $x\sigma$ contains a grey occurrence of a term $t$.
	%Then there is a sequence of variables $x_1,\dots, x_n$ with $x_1 = x$ such that $t$ occurs grey in  $x_i \sigma$ for $1\varleq i \varleq n$ and $x_n$ occurs in a resolved or factorised literal $l$ at $l\at{\bhat x_n}$ such that $l'\at{\bhat x_n}$ contains the outermost symbol of $t$, where $l'$ is the other resolved or factorised literal.

	%Let $x$ be a variable such that in a resolution or factorisation step $\inference$ with $\sigma = \mgu(\inference)$, $x\sigma$ contains a grey occurrence of a term $t$.

	Let $l$ and $l'$ be variable disjoint literals and $\sigma = \mgu(l, l')$
	such that for a variable $x$, $x\sigma$ contains a grey occurrence of a term $t$.

	\hl{old text:}
	Then there is a sequence of variables $x_1,\dots, x_n$ with $x_1 = x$ such that for $1\varleq i \varleq n$,
	$t$ occurs grey in $x_i \sigma$ and
	$x_i$ occurs in one of the literals, say $l_i$, at $l_i\at{\bhat x_i}$ such that
	with $l_i'$ being the respective other literal,
	$l_i'\at{\bhat x_i}$ contains $x_{i+1}$ for $1\varleq i \varleq n-1$ and $l_n'\at{\bhat x_n}$ contains the outermost symbol of $t$.

	\hl{new text:}
	Then there is a sequence of variables $x_1,\dots, x_n$ with $x_1 = x$ such that for $1\varleq i \varleq n$,
	$t$ occurs grey in $x_i \sigma$ and
	$x_i \mguarr r\occ{x_{i+1}}$ or
	$i=n \land x_n \mguarr r_t$, where $r_t$ contains the outermost symbol of $t$
	%$x_i$ occurs in one of the literals, say $l_i$, at $l_i\at{\bhat x_i}$ such that
	%with $l_i'$ being the respective other literal,
\end{lemma}
\begin{proof}
	Let $x_1 = x$ and note that $t$ occurs in $x\sigma$ by assumption.
	We now consider the execution of the $\mgu$ algorithm as defined in \ref{def:mgu_algo}
	and show that for an $x_i$ in the sequence, either we can find an element $x_{i+1}$ which matches the requirement for the sequence or there is an occurrence of $x_i$ which is unified with a term containing the outermost symbol of $t$.

	As the $\mgu$ algorithm produces a unifier which modifies $x_i$, $x_i$ must occur in a literal, say in $l_i$ at $l_i\at{\bhat x_i}$, such that at the other literal $l_i'$, $l_i'\at{\bhat x_i}$ is an abstraction of a term containing $t$ which is different from $x_i$.
	We distinguish two cases:
	\begin{itemize}
		\item Suppose that $l_i'\at{\bhat x_i}$ contains the outermost symbol of $t$.
			Then let $x_n = x_i$.

		\item Otherwise $l_i'\at{\bhat x_i}$ contains a variable $v$ such that $t$ occurs grey in $v\sigma$.
			Let $x_{i+1} = v$.
			\qedhere
	\end{itemize}


\end{proof}


\begin{lemma}
	\label{lemma:unified_term_starts_somewhere}
	Let $l$ and $l'$ be variable disjoint literals and $\sigma = \mgu(l, l')$
	such that for a variable $x$, $x\sigma$ contains a term $t$.

	\hl{new text:}
	Then there is a sequence of variables $x_1,\dots, x_n$ with $x_1 = x$ such that for $1\varleq i \varleq n$,
	$t$ occurs in $x_i \sigma$ and
	$x_i \mguarr r\occ{x_{i+1}}$ or
	$i=n \spas\land\allowbreak x_n \mguarr\nolinebreak r_t$, where $r_t$ contains the outermost symbol of $t$
\end{lemma}
\begin{proof}
	\mytodo{} (but is virtually a subset of some lemma below)
\end{proof}

{comment}

alternate version (unfinished)

Lemma~\ref{lemma:proof_along_mgu} furthermore asserts that $u_n$ occurs in a resolved literal $\lambda$ at $\lambda\at{\bhat u_n}$ such that $\lambda{}'\at{\bhat u_n}$ contains the outermost symbol of the $\Delta$-term $s$, where $\lambda{}'$ is the respective other resolved literal.
As $u_n$ is a colored occurrence and $\lambda\sigma = \lambda'\sigma$, $\lambda'\at{\bhat u_n}$ is a colored occurrence as well.

\begin{itemize}
	\item
		Suppose $\lambda'\at{\bhat u_n}$ is contained in a $\Gamma$-term.
		Let $r\occ{x_\varphi}$ be the maximal colored term containing $\lambda'\at{\bhat u_n}$ and $x_\varphi$ be the lifting variable at the position of the outermost symbol of $s$ in $\lambda'\at{\bhat u_n}$ in $\AIcl(C_j)$ for $j = 1$ or $j=2$.
		So by the induction hypothesis, $x_\varphi \apath_{G_{C_j}} r\occ{x_\varphi}$, hence $x_\varphi$ occurs grey in $\AImatde(C_j)$, $\AIclde(C_j)$ or $\AIcolde(C_j)$.
		As however $x_\varphi$ occurs grey in $\lambda'\cl$\todo{this is only guaranteed in $\AIde$, not in $\AI$}, by the definition of $\aiu$, $\{x_\varphi \mapsto x_s\} \in \tau$
		as $s$ is the term at the position of $x_\varphi$ in $\lambda'\sigma$.

		Hence there is a grey occurrence of $x_s$ in $\AImatde(C)$, $\AIclde(C)$ or $\AIcolde(C)$ and we are done.

	\item
		Suppose that $u_i$ for $1\varleq i \varleq n$ is contained in a $\Delta$-term which is contained in a $\Gamma$-term.

		\mytodo{}

	\item
		Suppose $\lambda'\at{\bhat u_n}$ is contained in a $\Delta$-term.
		Due to $\lambda \sigma = \lambda'\sigma$, $\lambda\at{\bhat u_n}$ is also contained in a $\Delta$-term.
		As by assumption none of the $u_i$, $1\varleq i \varleq n$ is a grey occurrence, there must be a clause which contains two occurrences of $u_i$ such that one of them is a $\Gamma$-occurrence and one is a $\Delta$-occurrence.

		\begin{itemize}
			\item Suppose that one is only gamma and the other only delta
			\item Suppose that mixed
		\end{itemize}

\end{itemize}

{comment}




old proof of smallest colored container 

{\tiny

	We start by making an observation \markC:
	If for two variables $x$ and $y$ it holds that $x$ occurs grey in $y\sigma$, then by Lemma~\ref{lemma:proof_along_mgu}, there exists a sequence $x_1,\dots, x_n$ such that for $1\varleq i \varleq n-1$, $u_i$ occurs in $\lambda\at{\bhat u_i}$ for a resolved literal $\lambda$ such that the other resolved literal $\lambda'$ has a grey occurrence of $u_{i+1}$ at $\lambda'\at{\bhat u_i}$.
	Hence if $u_i$ occurs in a single-colored $\Phi$-\nolinebreak{}colored term in $\lambda\at{\bhat u_i}$, then $u_{i+1}$ does so too in $\lambda'\at{\bhat u_i}$ as $\lambda\sigma = \lambda'\sigma$.
	As $u_{i+1}$ also occurs in $\lambda'\at{\bhat u_{i+1}}$ for $1\varleq 1 \varleq n-1$,
	i.e.\ in the same clause as $\lambda'\at{\bhat u_i}$, then if $\lambda'\at{\bhat u_{i+1}}$ occurs in a single-colored term which is not $\Phi$-colored, then by the induction hypothesis, $u_{i+1}$ occurs grey in $\AIany(C_i)$ for $i\in \{1,2\}$ and as $u_{i+1}\sigma$ contains a grey occurrence of $x$,
	$x$ occurs grey in $\AIany(C)$.
	Therefore we can assume that all variable of the sequence $x_1, \dots, x_n$ occur only colored and each of the $x_i$, $1\varleq i \varleq n$ is contained in some single-colored $\Phi$-term, as otherwise we are done.


	{ \tiny

		We make another observation \markB:
		If for two variables $x$ an $y$ it holds that $y\sigma = s\occ{x}$ a single-colored $\Delta$-term, then we can assume that $x$ occurs grey or in some single-colored $\Delta$-term in $C_1$ or $C_2$.
		Proof:
		We proceed by induction on the size of $s\occ{x}$.
		By Lemma~\ref{lemma:proof_along_mgu}, there is an occurrence of $y_n$ of $y$ in a resolved literal $\lambda$ in say $\lambda\occ{\bhat y_n}$ such that $\lambda'\occ{\bhat y_n}$ contains the outermost symbol of $s\occ{x}$.

		Suppose for the induction start that $s\occ{x}$ is of size $2$. Note that this is the smallest size for a single-colored term containing a variable.
		Then $\lambda'\at{\bhat y_n}$ either is $s\occ{x}$, in which case we are done, or $\lambda'\at{\bhat y_n}$ is $s\occ{z}$ for a variable $z$ such that $z\sigma = x$.
		Hence $z$ occurs elsewhere in $\lambda'$, say in $\lambda'\at{\bhat z}$, such that $\lambda\at{\bhat z}$ is $x$.
		So if $\lambda'\at{\bhat z}$ is a grey occurrence or $\lambda'\at{\bhat z}$ is contained in a single-colored $\Delta$-term, then due to $\lambda\sigma = \lambda'\sigma$, $\lambda\at{\bhat z}$ is a corresponding occurrence of $x$.
		Otherwise $\lambda'\at{\bhat z}$ is contained in a single-colored $\Gamma$-term.
		\hl{meh}


		\mytodo{ICI: ind hyp should work for when z/x occur in a single-colored $\Gamma$-term, otw check what we need to have as lemma statement. all is in the resolved literal, so it's gone from the clause in the next step.}

	}

	We distinguish between all four cases which produce a clause on which the lemma applies:

	\begin{itemize}

		\item
			Suppose that w.l.o.g.\ $C_1$ contains a single-colored $\Gamma$-term $s\occ{x}$ which contains $x$ and $C_1$ or $C_2$ contains a single-colored $\Delta$-term containing a variable $y$ such that $x$ occurs grey or in a single-colored $\Delta$-colored in $y\sigma$.
			Note that the case of an opposite assignment of colors can be argued in a symmetric manner.

			%Let $r$ be $x$ in the first case or the maximal colored term in $y\sigma$ containing $x$ in the second case.

			\begin{itemize}
				\item
					Suppose that $x$ occurs grey in $y\sigma$:
					Then by Lemma~\ref{lemma:proof_along_mgu}, there is a variable $y_n$ which occurs in a resolved literal $\lambda$ at $\lambda\at{\bhat y_n}$ such that $\lambda'\at{\bhat y_n}$ contains a grey occurrence of $x$.
					By observation \markC, $\lambda\at{\bhat y_n}$ is contained in a single-colored $\Delta$-term.
					But then so is $\lambda'\at{\bhat y_n}$, and as clauses are variable disjoint\todo{clauses var-disjoint}, $s\occ{x}$ also occurs in this clause. So by the induction hypothesis, there is a grey occurrence of $x$ in $\AIany(C_j)$ where $C_j$ is the clause containing $s\occ{x}$, and as $x$ is not affected by $\sigma$, $x$ also occurs grey in $\AIany(C)$.

				\item
					Suppose that $x$ occurs in a single-colored $\Delta$-term $y\sigma$:

					Then by Lemma~\ref{lemma:single_col_x_in_unif_range}, either $x$ occurs grey, in which case we are done, or some $y_i$ occurs grey in $l$ or $l'$ such that $y_i\sigma$ contains a grey occurrence of $x$, in which case we are done, or $x$ occurs in a single-colored $\Delta$-term $t\occ{x}$.
					Then however as $s\occ{x}$ occurs in $C_1$ and clauses are variable disjoint, $t\occ{x}$ occurs in $C_1$ as well and $x$ occurs grey in $\AIany(C_1)$ by the induction hypothesis.

					{\tiny

						If a single-colored $\Delta$-term $t\occ{x}$ containing $x$ occurs in $C_1$ or $C_2$, say in $C_j$, then as clauses are variable disjoint, it must be the same clause as $s\occ{x}$.
						But then $x$ occurs grey in $\AIany(C_j)$ by the induction hypothesis, so assume that no such $t\occ{x}$ occurs in $C_1$ or $C_2$.

						But as a single-colored $\Delta$-term containing $x$ occurs in $y\sigma$, there must be a single-colored $\Delta$-term in $C_1$ or $C_2$ which contains a variable $z$ such that $x$ occurs grey or in a single-colored $\Delta$-term in $z\sigma$.
						Hence this case is repeated, but as $z\sigma$ is strictly smaller than $y\sigma$, this case can only repeat finitely often.

					}

			\end{itemize}



		\item Suppose that
			a single-colored $\Gamma$-term $s\occ{y}$ occurs in $C_i$, $i\in \{1,2\}$
			such that $x$ occurs grey or in a single-colored $\Gamma$-term in $y\sigma$
			and
			a single-colored $\Delta$-term $t\occ{z}$ occurs in $C_j$, $j\in \{1,2\}$
			such that $x$ occurs grey or in a single-colored $\Delta$-term in $z\sigma$.

			%If $y\sigma = r\occ{x}$ is a single-colored $\Phi$-term, then either $r\occ{x}$ occurs in the clause or an abstraction of $r\occ{x}$ which is not a variable occurs in the clause, which contains a variable $z$ such that $x$ occurs grey or in a single-colored $\Phi$-term in $z\sigma$.





		\item 2 other items from arrow-final-conjectures.
	\end{itemize}
}



\largered{old semi-main lemma reasoning:}

\begin{itemize}
	\item
		Suppose a single-colored $\Phi$-term $s\occ{x}$ in $C_1$ or $C_2$ contains a grey occurrence of $x$ and 
		a single-colored $\Psi$-term $t\occ{x}$ is introduced in $C$.
		This is possible by two means: 
		\begin{compactenum}
		\item A single-colored $\Psi$-term $t\occ{z}$ in $C_1$ or $C_2$ contains a variable $z$ such that $x$ occurs grey in $z\sigma$
		\item A variable $u$ occurs in $C_1$ and $C_2$ such that $u\sigma$ contains a single-colored $\Psi$-term containing $x$
		\end{compactenum}
		We apply
		Lemma~\ref{lemma:y_sigma_contains_colored_x} in the first case
		and Lemma~\ref{lemma:colored}
		Then by Lemma~\ref{lemma:y_sigma_contains_colored_x}, at least one of the given three statments holds.

		(1) As there is a grey occurrence of $z$ in $C_1$ or $C_2$, there is a grey occurrence of $x$ in $\AIany(C)$.

		(2) then this term occurs in the same clause as $s\occ{x}$ as clauses are variable disjoint and $x$ occurs grey by the induction hypothesis

		(3) then by IH, there is a grey occurrence of $z$ in $C_1$ or $C_2$ and hence a grey occurrence of $x$ in $\AIany(C)$.


	\item 
		Suppose a single-colored $\Phi$-term $s\occ{y}$ in $C_1$ or $C_2$ contains a variable $y$ such that $x$ occurs grey in $y\sigma$
		and
		a single-colored $\Psi$-term $t\occ{z}$ in $C_1$ or $C_2$ contains a variable $z$ such that $x$ occurs grey in $z\sigma$.

		Then we can apply Lemma~\ref{lemma:colored_y_sigma_contains_grey_x} to both of $s\occ{y}$ and $t\occ{z}$.

		If any one yields case (1), we are done (as above).

		If any one yields case (3), we are done (IH, as above).

		Hence suppose that both yield case 2.
		Thus there is a single-colored $\Phi$-term containing $x$ and a single-colored $\Psi$-term containing $x$ in $C_1$ or $C_2$.
		Note that as clauses are variable disjoint, both these terms must occur in the same clause, say in $C_j$.
		But then by the induction hypothesis, $x$ occurs grey in $\AIany(C_j)$ and so also in $\AIany(C)$.

\end{itemize}


\mytodo{ ICI; finish this proof }

\hl{\textbf{ new distinction: } }
\begin{itemize}
	\item
		$\Phi$-col $s\occ{x}$ in $l$/$l'$, exists $\Psi$-col $t\occ{z}$ with $z\sigma$ contains grey $x$
	\item 
		exists $\Phi$-col $s\occ{y}$ with $y\sigma$ contains grey $x$ and
		exists $\Psi$-col $t\occ{z}$ with $z\sigma$ contains grey $x$

		by new 24 (for col occs of $y$), either
		\begin{compactitem}
		\item $x$ occs grey
		\item $y_i$ grey in $C_i$ OR $y_i$ in once in s.c.\ $\Phi$ and once in s.c.\ $\Psi$-term
		\item some $\Phi$-term $r\occ{x}$ in $C_i$

		\end{compactitem}

	\item
		$\Phi$-col $s\occ{x}$ in $l$/$l'$, exists $z$ in $C_i$ s.t. $z\sigma$ contains s.c. $\Psi$-term containing $x$

	\item 
		exists $y$ in $C_j$ s.t. $y\sigma$ contains s.c. $\Phi$-term $s\occ{x}$ and
		exists $z$ in $C_i$ s.t. $z\sigma$ contains s.c. $\Psi$-term $t\occ{x}$

		by new 25, either:
		\begin{compactitem}
		\item some $\Phi$-term $r\occ{x}$ in $C_i$
		\item $y_i$ grey in $C_i$ OR $y_i$ in once in s.c.\ $\Phi$ and once in s.c.\ $\Psi$-term
		\item $x$ occs grey 
		\end{compactitem}

		any of both case 2 or 3 $\Ra$ done.

		otw both case 1, but then ind hyp
\end{itemize}

%\end{comment}

\end{document}
