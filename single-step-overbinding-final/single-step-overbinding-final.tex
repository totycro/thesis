\documentclass[,%fontsize=11pt,%
	%landscape,
	%DIV8, % mehr text pro seite als defaultyyp
	%DIV10,
	%DIV=calc,%
	draft=false,% final|draft % draft ist platzsparender (kein code, bilder..)
	%titlepage,
	numbers=noendperiod
	11pt,
	a4paper,
	oneside,% apparently, this should stay below some other parameter to have an effect
	openany,
	%]{scrartcl}
]{memoir}



\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}


%\usepackage[urw-garamond]{mathdesign}

\usepackage{lscape}
\usepackage{stackengine}
\usepackage{enumerate}
\usepackage{paralist}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,backgrounds,graphs,%
	matrix,patterns,arrows,decorations.pathmorphing,decorations.pathreplacing,%
	positioning,fit,calc,decorations.text,shadows%
}


\input{../latex_header.tex}


% subsections also in toc
\setcounter{tocdepth}{2}
\setsecnumdepth{subsection}


\definethms

\def\proofSkipAmount{ \vskip -0.1em }


%\usepackage{bussproof}

%\usepackage{vaucanson-g}
%\usepackage{amssymb}
\usepackage{latexsym}

% for color-highlighted code
%\usepackage{color} % for grey comments
%\usepackage{alltt}

%\usepackage[doublespacing]{setspace}
%\usepackage[onehalfspacing]{setspace}
%\usepackage[singlespacing]{setspace}
%\usepackage{tabularx}
%\usepackage{hyperref}
%\usepackage{comment}
%\usepackage{color}
%\usepackage[final]{listings} % sourcecode in document
%\usepackage{url}      % for urls
%\usepackage{multicol}
%\usepackage{float}
%\usepackage{caption}
%\usepackage{amsmath}
%\usepackage{amssymb}
%
%\usepackage{graphicx}
%
%\usepackage[authoryear]{natbib} % \cite ; square|round etc.
%\usepackage[numbers,square]{natbib}
%\usepackage[square, authoryear]{natbib}
%\usepackage[language=english]{biblatex}

%\bibliographystyle{plain}
%\bibliographystyle{alpha}
%\bibliographystyle{alphadin}
%\bibliographystyle{dinat}
%\bibliographystyle{chicago}
%\bibliographystyle{plainnat}

% smaller url style
\makeatletter
\def\url@leostyle{%
\@ifundefined{selectfont}{\def\UrlFont{\sf}}{\def\UrlFont{\small\ttfamily}}}
\makeatother
\urlstyle{leo}

\newcommand{\myfig}[5] {
	\begin{figure}[tbph]
		\centering
		\includegraphics[#3]{#1}
		\caption[#4]{#5}
		\label{fig:#2}
	\end{figure}
}

%\usepackage{thmtools} % actually already in latex_header.tex ...

\usepackage{amsthm}


\chapterstyle{madsen}

% define page numbering styles
\makepagestyle{numberCorner}
\makeevenfoot{numberCorner}{\thepage}{}{}
\makeoddfoot{numberCorner}{}{}{\thepage}

\makepagestyle{numberCenter}
%\makeevenfoot{numberCenter}{}{\thepage}{}
%\makeoddfoot{numberCenter}{}{\thepage}{}
%
%\makeevenhead{numberCenter}{\thechapter}{}{\thesection}
%\makeoddhead{numberCenter}{\thesection }{}{\thechapter}
\makeheadrule{numberCenter}{\textwidth}{1pt}

\makeevenhead{numberCenter}{\thepage}{}{\leftmark}
\makeoddhead{numberCenter}{\rightmark}{}{\thepage}


\makeatletter
\makepsmarks{numberCenter}{
	\def\chaptermark##1{\markboth{%
			\ifnum \value{secnumdepth} > -1
			\if@mainmatter
			\chaptername\ \thechapter\ --- %
			\fi
			\fi
	##1}{}}
	\def\sectionmark##1{\markright{%
			\ifnum \value{secnumdepth} > 0
			\thesection. \ %
			\fi
	##1}}
}
\makeatother
\newcommand{\mysetpagestyle}{
	%\pagestyle{numberCorner}
	\pagestyle{numberCenter}
}
\mysetpagestyle





\usepackage{refcheck}

%\settypeblocksize{0.65\stockheight}{0.65\stockwidth}{*}
%\setlrmargins{*}{*}{1.2}
%\setulmargins{*}{*}{1.4}
%\checkandfixthelayout[nearest]


\begin{document}

\tableofcontents

\section{referenced lemmas from previous sections}
\begin{quote}
	\begin{lemma}[Commutativity of lifting and logical operators]
		\label{lemma:lift_commute}
		\label{lemma:lift_logic_commute}
		Let $A$ and $B$ be first-order formulas and $s$ and $t$ be terms. Then it     holds that:
		\begin{enumerate}
			\item $\lift{\Phi}{\lnot A}{z} \spas\semiff{} \lnot \lift{\Phi}{A}{z}$
			\item $\lift{\Phi}{A \circ B}{z} \spas\semiff{} ( \lift{\Phi}{A}{z} \circ   \lift{\Phi}{B}{z} )$ for  $\circ \in \{\land, \lor\}$
			\item $\lift{\Phi}{s = t}{z} \spas\semiff{} ( \lift{\Phi}{s}{z} =           \lift{\Phi}{t}{z} )$
		\end{enumerate}
	\end{lemma}

	\begin{restatable}[Commutativity of lifting and substitution]{lemma}{lemmaCommutLiftSubst}
		\label{lemma:lif}
		Let $C$ be a clause and $\sigma$ a substitution such that no lifting variable occurs in $C$ or $\sigma$.
		%Let $t_1,\ldots,t_n$ be all maximal $\Delta$-terms in this context, i.e.\ those that occur in $C$ or $C\sigma$,  and
		%$x_1, \ldots, x_n$ the corresponding fresh variables to replace the $t_i$ (i.e.~none of the $x_i$ occur in $C$).
		Define $\sigma'$ with $\dom(\sigma') = \dom(\sigma) \cup \{ z_t \mid t\sigma \neq t \}$ such that for a variable $z$,
		\[
			x \sigma' =
			\begin{cases}
				z_{t\sigma} & \text{ if } x = z_t \text{ and } t\sigma \neq t \\
				\lifphi{x\sigma} & \text{ otherwise}
			\end{cases}
		\]

		Then
		$\lifphi{C\sigma} =
		\lifphi{C}\sigma'$.
	\end{restatable}
\end{quote}

\chapter{Interpolant extraction from resolution proofs in one phase}


While the previous chapter demonstrates that it is possible to extract propositional interpolants and lift them from the colored symbols later in order to obtain a proper interpolant, we now present a novel approach, which only operates with grey intermediary interpolants.
This is established by lifting any term which is added to the interpolant.

By its nature, this approach requires an alternate strategy than the proof of the extraction in two phases as a commutation of substitution and lifting is no longer possible if lifting variables are present.
Let us recall the corresponding lemma from the previous chapter:
\lemmaCommutLiftSubst*
Consider the following illustration of a problem of the notion of applying this lemma to terms containing lifting variables:

\begin{exa}
	Let $\sigma = \{x \mapsto a\}$
	and consider the terms $f(x)$ and $f(a)$, where $f$ and $a$ are colored symbols.
	Clearly $f(x)\sigma = f(a)$ and therefore necessarily $z_{f(x)}\sigma' = z_{f(a)}$.

	But now consider $x_{f(x)} \sigma$.
	As $z_{f(x)}$ is a lifting variable, it is not affected by unifiers from resolution derivations and also not by $\sigma$.
	Hence $z_{f(x)}\sigma = z_{f(x)}$ and therefore $\lifboth{z_{f(x)}\sigma} = \lifboth{z_{f(x)}} = z_{f(x)}$, but $\lifboth{z_{f(x)}}\sigma' = z_{f(x)}\sigma' = z_{f(a)}$.
	So $\lifboth{z_{f(x)}\sigma} \neq \lifboth{z_{f(x)}}\sigma'$.

	We see here that there are circumstances under which in order to commute lifting and substitution,
	the substitution $\sigma'$ is required to conform to the equation
	$z_{f(x)}\sigma' =\nolinebreak z_{f(a)}$,
	whereas in others, it must hold that
	$z_{f(x)}\sigma' = z_{f(x)}$.
\end{exa}


\section{Definition of the extraction algorithm}

The extracted interpolants are prenex formulas, where
the quantifier block and the matrix of the formula are calculated separately in each step of the traversal of the resolution refutation.


\subsection{Extraction of the interpolant formula matrix $\AImat$ and calculation of $\AIcl$}

$\AImat$ is inspired by the propositional interpolants $\PI$ from Definition \ref{def:PI}.
Its difference lies in the fact that the lifting occurs in every step of the extraction.
This however necessitates applying these liftings to the clauses of the resolution refutation as well.
For a clause $C$ of the resolution refutation, we will denote the clause with the respective liftings applied by $\AIcl(C)$ (a formal definition will be given below), and for a term $t$ at position $p$ in $C$, we denote $\AIcl(C)\at{p}$ by $t\cl$.

Now we can define preliminary versions of $\AImatpre$ and $\AIclpre$:

\begin{defi}[$\AImatpre$ and $\AIclpre$]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.

	For a clause $C$ in $\pi$, \defiemph{$\AImatpre(C)$} and \defiemph{$\AIclpre(C)$} are defined as follows:
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, $\AImatpre(C) \defeq \bot$.
			If otherwise $C \in \Delta$, $\AImatpre(C) \defeq \top$.

			In any case, $\AIclpre(C) \defeq \lifboth{C}$.
		\item[Resolution.]

			If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma =  l'\sigma$, then $\AImatpre(C)$ and $\AIclpre$ are defined as follows:

			$\AIclpre(C) \defeq \lifboth{(\AIclpre(C_1) \setminus \{l\fromclause\})\sigma} \spam\lor \lifboth{(\AIclpre(C_2)\setminus \{l\fromclause'\})\sigma} $

			\begin{enumerate}

				\item If $l$ is $\Gamma$-colored:
					$\AImatpre(C) \defeq \lifboth{\AImatpre(C_1)\sigma}\spas\lor \lifboth{\AImatpre(C_2)\sigma} $

				\item If $l$ is $\Delta$-colored:
					$\AImatpre(C) \defeq \lifboth{\AImatpre(C_1)\sigma}\spas\land \lifboth{\AImatpre(C_2)\sigma} $

				\item If $l$ is grey:
					$\AImatpre(C) \defeq
					(\lnot {\lifboth{l'\fromclause\sigma}} \land \lifboth{\AImatpre(C_1)\sigma}) \spam\lor
					(\lifboth{l\fromclause\sigma}\land \lifboth{\AImatpre(C_2)\sigma })
					$

			\end{enumerate}

		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then $\AImatpre(C) \defeq \lifboth{\AImatpre(C_1)\sigma}$ and $\AIclpre(C) \defeq \lifboth{ (\AIclause(C_1) \setminus\nolinebreak \{l'\cl\})\sigma}$.
			\qedhere

	\end{itemize}
\end{defi}

Note that in $\AImatpre$ and $\AIclpre$, it is possible that there for a colored term $t$ in $C$ that $t\cl \neq z_t$ as illustrated by the following examples:

\begin{exa}
	We consider a resolution refutation of the initial clause sets
	$\Gamma = \{ R(c), \lnot Q(v) \}$
	and
	$\Delta = \{ \lnot R(u) \lor Q(g(u)) \}$:
	\begin{prooftree}
		\AxiomCm{ R(c) }
		\AxiomCm{ \lnot R(u) \lor Q(g(u)) }
		\prflbl{\resruleres}{y\mapsto c}
		\BinaryInfCm{ Q(g(c)) }

		\AxiomCm{ \lnot Q(v) }
		\prflbl{\resruleres}{v\mapsto g(c)}
		\BinaryInfCm{ \square }
	\end{prooftree}

	We now replace every clause $C$ by $\AImatpre(C) \mid \AIclpre(C)$ in order to visualize the steps of the algorithm:
	\begin{prooftree}
		\AxiomCm{ \bot \mid  R(y_c) }
		\AxiomCm{ \top \mid \lnot R(u) \lor \lnot Q(x_{g(u)}) }
		\prflbl{\resruleres}{y\mapsto c}
		\BinaryInfCm{ R(y_c) \mid  Q(x_{g(u)}) }

		\AxiomCm{ \bot \mid \lnot Q(v) }
		\prflbl{\resruleres}{v\mapsto g(c)}
		\BinaryInfCm{ \lnot Q(x_{g(c)}) \land R(y_c) \mid  \square }
	\end{prooftree}

	By quantifying $y_c$ existentially and $x_{g(c)}$ universally\footnote{The procedure for calculating the quantifier block is defined in Definition~\ref{def:arrow_quantifier_block}}, we obtain an interpolant for $\Gamma \cup \Delta$:
	$\exists y_c \forall x_{g(c)} (\lnot Q(x_{g_c}) \land R(y_c))$.
	Note however that $\lifboth{Q(g(c))} = Q(x_{g(c)})$, but $\AImat(Q(g(c))) = Q(x_{g(u)})$.
	This example shows that this circumstance is not necessarily an obstacle for the correctness of this algorithm.
\end{exa}
\begin{exa}
	\label{exa:2b}
	We consider a resolution refutation of the initial clause sets
	$\Gamma = \{ R(c), P(c) \}$
	and
	$\Delta = \{ \lnot R(u) \lor \lnot Q(g(u)), \lnot P(v) \lor Q(g(v))\}$:
	\begin{prooftree}
		\AxiomCm{ \lnot R(u) \lor \lnot Q(g(u)) }
		\AxiomCm{ R(c) }
		\prflbl{\resruleres}{u\mapsto c}
		\BinaryInfCm{ \lnot Q(g(c)) }


		\AxiomCm{ \lnot P(v) \lor Q(g(v)) }
		\AxiomCm{ P(c) }
		\prflbl{\resruleres}{v\mapsto c}
		\BinaryInfCm{ Q(g(c)) }

		\prflblid{\resruleres}
		\BinaryInfCm{\square}

	\end{prooftree}

	We now again display $\AImatpre(C) \mid \AIclpre(C)$ for every clause $C$ of the refutation:
	\begin{prooftree}
		\AxiomCm{ \top \mid  \lnot R(u) \lor \lnot Q(x_{g(u)}) }
		\AxiomCm{ \bot \mid R(y_c) }
		\prflbl{\resruleres}{u\mapsto c}
		\BinaryInfCm{ R(y_c) \mid  \lnot Q(x_{g(u)}) }

		\AxiomCm{ \top \mid \lnot P(v) \lor Q(x_{g(v)}) }
		\AxiomCm{ \bot \mid P(y_c) }
		\prflbl{\resruleres}{v\mapsto c}
		\BinaryInfCm{ P(y_c) \mid  Q(x_{g(v)}) }

		\prflblid{\resruleres}
		\BinaryInfCm{ (Q(x_{g(v)}) \land R(y_c)) \spam\lor (\lnot Q(x_{g(u)}) \land P(y_c))  \mid \square}

	\end{prooftree}

	Note again that here, we have that
	%\[
	$
	\lifboth{\lnot Q(g(c))} = \lnot Q(x_{g(c)}) \spam\neq \AIclpre(\lnot Q(g(c))) = \lnot Q(x_{g(u)})
	$
	%\]
	%as well as a similar discrepancy for the other clause $Q(x_{g(c)})$.
	and
	%\[
	$
	\lifboth{Q(g(c))} = Q(x_{g(c)}) \spam\neq \AIclpre(Q(g(c))) =  Q(x_{g(v)}).
	$
	%\]
	However in this instance, it is not possible to find quantifiers for the free variables of $\AImatpre(\square)$ such that by binding them, an interpolant is produced.
	For the naive approach, namely to use $\exists y_c \forall x_{g(v)} \forall x_{g(u)}$ as prefix, it holds that
	$\Gamma \notentails \exists y_c \forall x_{g(v)} \forall x_{g(u)} ((Q(x_{g(v)}) \land R(y_c)) \spam\lor (\lnot Q(x_{g(u)}) \land P(y_c)))$.
	This failure is possible as intuitively, resolution deductions are valid by virtue of the resolved literals being equal.
	The interpolant extraction procedure exploits this property not directly on the clauses but on the lifted clause, i.e.\ on $\AIcl(C)$ for a clause $C$.
	Note that by ensuring that for resolved literals $l$ and $l'$, it holds that $l\cl = l'\cl$, we can obtain an interpolant, for instance:
	$
	\exists y_c \forall x^\ast ((Q(x^\ast) \land R(y_c)) \spam\lor (\lnot Q(x^\ast) \land P(y_c)))
	$.
\end{exa}

In order to avoid the pitfall shown in Example \ref{exa:2b} and to generalize the indicated solution,
we define a function on resolved literals calculating a substitution, which ensures that the literals in the lifted clause, which correspond to the resolved literals, are equal.

\begin{defi}[$\aiu$]
	Let $\inference$ be a resolution or factorisation rule application with $l$ and $l'$ as resolved or factorised literals and $\sigma = \mgu(\inference)$.

	\newcommand{\aiuP}{\aiu'}

	For terms $s$ and $t$ where
	$s = \lifboth{l\fromclause\sigma}\at{p}$
	and
	$t = \lifboth{l'\fromclause\sigma}\at{p}$
	for some position $p$, we define:
	\[
		\aiuP (s, t) \defeq
		\begin{cases}
			\bigcup_{i=1}^n \aiuP(s_i, t_i) &
			\parbox[t]{.50\textwidth}{
				%\text{
			if $s$ is grey, $s=f_s(s_1, \dots, s_n)$ and\newline$t = f_{t}(t_1,\dots, t_n)$\footnotemark} \\
			\{z_{s'} \mapsto z_r, z_{t'} \mapsto z_r\} &
			\parbox[t]{.50\textwidth}{
				%\text{
				if $s$ is a lifting variable $z_{s'}$, $t = z_{t'}$,
				and $z_r = \lifboth{l\sigma}\at{p}$
			}
			%\{x_j \mapsto x_m, x_k \mapsto x_m\} & \parbox[t]{.75\textwidth}{if $a\cl = x_j$ and $b\cl = x_k$, both lifting variables, and $x_m$ is the       corresponding lifted term in the unified literal, i.e. $x_m = \lifboth{a\sigma} = \lifboth{b\sigma}$. This means to just take the term from the   literal in the actual clause.}
		\end{cases}
	\]
	\footnotetext{Note that constants are treated as function symbols of arity zero.}
	For $\lifboth{l\cl\sigma} = P(s_1, \dots, s_n)$ and $\lifboth{l'\cl\sigma} = P(t_1, \dots, t_n)$, we define:
	\[
		\aiuP(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma}) =
		\aiuP(P(\overline s), P(\overline t)) \defeq \bigcup_{i=1}^n \aiuP(s_i, t_i)
	\]
	\[
		\aiu(\inference) \defeq \aiuP(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma}) \qedhere
	\]
	%For resolved or factorised literals $l $ and $l'$ of a resolution derivation step with a unifier $\sigma$ such that $l\sigma = l'\sigma$,
\end{defi}

\begin{prop}
	\label{prop:tau_dom_ran}
	Let $\inference$ be a resolution or factorisation rule application with $l$ and $l'$ as resolved or factorised literals, $\sigma = \mgu(\inference)$
	Then $\dom(\aiu(\inference))$ consists exactly of the lifting variables of $\lifboth{l\fromclause\sigma}$ and $\lifboth{l'\fromclause\sigma}$ and $\ran(\aiu(\inference))$ consists exactly of the lifting variables of $\lifboth{l\sigma}$.
\end{prop}

\todo[inline]{possibly argue here why $\aiu$ is well-defined (but it follows more or less directly from a later lemma)}


\begin{defi}[$\AImat$ and $\AIcl$]
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$.
	\defiemph{$\AImat(\pi)$} is defined to be $\AImat(\square)$, where $\square$ is the empty clause derived in $\pi$.

	For a clause $C$ in $\pi$, \defiemph{$\AImat(C)$} and \defiemph{$\AIcl(C)$} are defined inductively as follows:
	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, $\AImat(C) \defeq \bot$.
			If otherwise $C \in \Delta$, $\AImat(C) \defeq \top$.

			In any case, $\AIcl(C) \defeq \lifboth{C}$.
		\item[Resolution.]

			If the clause $C$ is the result of a resolution step \inference{} of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$,
			then
			let $\tau = \aiu(\inference)$ and
			define $\AImat(C)$ and $\AIcl(C)$ as follows:

			$\AIcl(C) \defeq \lifboth{(\AIclause(C_1) \setminus \{l\fromclause\})\sigma}\tau \spam\lor \lifboth{(\AIclause(C_2)\setminus \{l\fromclause'\})\sigma}\tau $
			\begin{enumerate}

				\item If $l$ is $\Gamma$-colored:
					$\AImat(C) \defeq \lifboth{\AImat(C_1)\sigma}\tau\spas\lor \lifboth{\AImat(C_2)\sigma}\tau $

				\item If $l$ is $\Delta$-colored:
					$\AImat(C) \defeq \lifboth{\AImat(C_1)\sigma}\tau\spas\land \lifboth{\AImat(C_2)\sigma}\tau $

				\item If $l$ is grey:
					$\AImat(C) \defeq
					(\lnot {\lifboth{l'\fromclause\sigma}}\tau \land \lifboth{\AImat(C_1)\sigma}\tau) \spam\lor
					(\lifboth{l\fromclause\sigma}\tau \land \lifboth{\AImat(C_2)\sigma}\tau)
					$

			\end{enumerate}

		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation $\inference$ of $C_1: l \lor l' \lor D$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$,
			then let $\tau = \aiu(\inference)$ and define
			$\AImat(C)$ and $\AIcl(C)$ as follows:

			$\AImat(C) \defeq{} \lifboth{\AImat(C_1)\sigma}\tau$

			$\AIcl(C) \defeq \lifboth{ (\AIclause(C_1) \setminus\nolinebreak \{l'\cl\})\sigma}\tau$
			\qedhere

	\end{itemize}
\end{defi}

\section{Lifting the $\Delta$-terms}

\begin{defi}
	$\AImatde(C)$ ($\AIclde(C)$) for a clause $C$ is defined as $\AImat(C)$ ($\AIcl(C)$) with the difference that in its inductive definition, every lifting $\lifboth{\varphi}$ for a formula or term $\varphi$ is replaced by a lifting of only the $\Delta$-terms $\lifdeltanovar{\varphi}$.
\end{defi}

\begin{lemma}
	\label{lemma:no_colored_terms}
	Let $C$ be a clause of a resolution refutation $\pi$ of $\Gamma\cup\Delta$.
	$\AImat(C)$ and $\AIcl(C)$ do not contain colored symbols.
	$\AImatde(C)$ and $\AIclde(C)$ do not contain \mbox{$\Delta$-c}olored symbols.
\end{lemma}
\begin{proof}
	For $\AImat(C)$ and $\AIcl(C)$, consider the following:
	In the base case of the inductive definitions of $\AImat(C)$ and $\AIcl(C)$, no colored symbols occur.
	In the inductive steps, any colored symbol which is added by $\sigma$ to intermediary formulas is lifted.
	By Proposition~\ref{prop:tau_dom_ran}, $\ran(\aiu(\inference))$ for inferences $\inference$ in $\pi$ only consists of lifting variables.

	For $\AImatde(C)$ and $\AIclde(C)$, a similar argument goes through by reading colored as $\Delta$-colored.
\end{proof}

\begin{lemma}
	\label{lemma:substitute_and_lift}
	Let $\sigma$ be a substitution and $F$ a formula without $\Phi$-colored terms such that for a set of formulas $\Psi$, $\Psi \entails F$.
	Then $\Psi \entails \lifphi{F\sigma}$.
\end{lemma}
\begin{proof}
	$\lifphi{F\sigma}$ is an instance of $F$:
	$\sigma$ substitutes variables either for terms not containing $\Phi$-colored symbols or by terms containing $\Phi$-colored symbols.
	For the first kind, the lifting has no effect.
	For the latter, the lifting only replaces subterms of the terms introduced by the substitution by a lifting variable such that the original structure of $F$ remains invariant as it by assumption does not contain colored terms.
\end{proof}

\begin{lemma}
	Let $l$ and $l'$ be resolved or factorised literals in a resolution derivation step $\inference$ creating a clause $C$ and
	$\tau = \aiu(\inference)$.
	For any substitution $(z_s \mapsto z_t) \in \tau$,




	\mytodo{check which statement we actually need (resolved literal, clause?)}

	make sure that it works for positions in the resolved literals as well as in the clause


\end{lemma}

\begin{lemma}
	\largered{ either reduce to ``equal up to index of lifting variables'' or use elaborate version as given below with additional lemma about how every $x_s$ refers to the same term PLUS variable renaming convention }
	\label{lemma:literals_clause_simgeq}
	Let $\lambda$ be a literal in a clause $C$ occurring in a resolution refutation of $\Gamma\cup\Delta$.
	Then $\AIcl(C)$ contains a literal $\lambda\cl$ such that $\lambda\cl \simgeq \lifboth{\lambda}$, where $\simgeq$ is defined as follows:
	\[
		\varphi \simgeq \varphi' \semiff
		\begin{cases}
			P = P' \land \bigwedge_{i=1}^n s_i \simgeq s'_i &  \text{ if $\varphi = P(s_1, \dots, s_n)$ and $\varphi' = P'(s'_1, \dots, s'_n)$} \\
			f = f' \land \bigwedge_{i=1}^n s_i \simgeq s'_i &  \text{ if $\varphi = f(s_1, \dots, s_n)$ and $\varphi' = f'(s'_1, \dots, s'_n)$} \\
			x = x' & \text{ if $\varphi, \varphi'$ are non-lifting variables, $\varphi = x$ and $\varphi' = x'$} \\
			s' \text{ is an instance of } s  & \text{ if $\varphi, \varphi'$ are lifting variables, $\varphi = z_s$ and $\varphi' = z_{s'}$} \\
		\end{cases}
	\]
	For resolved or factorised literals $\lambda$ of an inference $\inference$ with $\tau = \aiu(\inference)$ we furthermore have that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.
	\todo[inline]{introduce definition for characterising the relation between $C$ and $\AIcl(C)$}
\end{lemma}
\begin{proof}
	We proceed by induction on the resolution refutation.
	\begin{description}
		\item{Base case.}
			If for a clause $C$ either $C\in \Gamma$ or $C \in \Delta$ holds, then $\AIcl(C) = \lifboth{C}$.
			Therefore for every literal $l$ in $C$, there exists a literal $l\cl$ in $\AIcl(C)$ such that $\lifboth{l} = l\cl$, which implies $l\cl \simgeq \lifboth{l}$.

		\item{Resolution.}
			If the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$,
			then let $\tau = \aiu(\inference)$.
			Let $\lambda$ be a literal in $C_1$ or $C_2$.
			Note that every literal in $C$ is of the form $\lambda\sigma$.
			By the induction hypothesis, there is a literal in $\AIcl(C_1)$ or $\AIcl(C_2)$ respectively such that $\lambda\cl \simgeq \lifboth{\lambda\cl}$.
			If $\lambda \not\in\{l,l'\}$, then $\lifboth{\lambda\cl\sigma}\tau$ is contained in $\AIcl(C)$.
			Hence in any case, it remains to show that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.


			%Every literal in $C$ is of the form $\lambda\sigma$ for some $\lambda \in C_1$ or $\lambda \in C_2$. Without loss of generality let $\lambda \in C_1$.
			%By the induction hypothesis, there is a literal in $\AIcl(C_1)$ such that $\lambda\cl \simgeq \lifboth{\lambda\cl}$.

			%As $\lambda \neq l$, by the definition of $\AIcl$, $\lifboth{\lambda\cl\sigma}\tau$ is contained in $\AIcl(C)$.
			%It remains to show that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.

			We perform an induction on the structure of $\lambda\cl$ and $\lambda$
			by letting $p$ be the position of the current term in the induction and $t\cl = \lambda\cl\at{p}$ as well as $t=\lambda\at{p}$.
			\begin{itemize}
				\item
					Suppose that $t$ is a non-lifting variable.
					As by the induction hypothesis $\lifboth{t\cl} \simgeq t$, $t\cl$ is a non-lifting variable as well and $t = t\cl$.
					But then $\lifboth{t\cl\sigma} = \lifboth{t\sigma}$.
					If $\tau$ is trivial on $\lifboth{t\cl\sigma}$, we are done as then $\lifboth{t\cl\sigma}\tau = \lifboth{t\sigma}$, so assume that it is not.

					But by the definition of $\aiu$, the substitutions in $\tau$ only update lifting variables to correspond to the terms in the clause of the actual resolution derivation.
					More formally, $\lifboth{t\cl\sigma}\tau = z_s$ for some term $s$ implies that $\lifboth{\lambda\sigma}\at{p} = z_s$, but then $z_s = t$.
					\largered{this argument only holds for terms in the resolved literals, see remark in lemma statement}
					\todo[inline]{outsource this thought to lemma after definition of $\aiu$ in case needed elsewhere}

				\item
					Suppose that $t$ is colored term.
					Then $\lifboth{t}$ is a lifting variable and by the induction hypothesis, $t\cl$ is one as well such that
					$\lifboth{t}$ is an instance of $t\cl$.
					As lifting variables are not affected by the unifications occurring in resolution derivations, we only need to consider modifications by means of $\tau$.
					But as we have seen in the previous case, if $\tau$ substitutes $\lifboth{t\cl\sigma}$, then it does so by $t$.
					\todo[inline]{lemma}
					Hence we obtain that $\lifboth{t\cl\sigma}\tau \simgeq \lifboth{t\sigma}$.

				\item
					Suppose that $t$ is a grey term of the form $f(s_1, \dots, s_n)$.
					Then $\lifboth{t} = f(\lifboth{s_1}, \dots, \lifboth{s_n})$ and by the induction hypothesis, $t\cl = f(r_1, \dots, r_n)$ such that
					$\bigwedge_{i=1}^n r_i \simgeq \lifboth{s_i}$ .
					By the induction hypothesis applied to the parameters of $\lifboth{t}$ and $\lifboth{t\cl}$, we obtain that  $\lifboth{r_i\sigma}\tau \simgeq \lifboth{s_i\sigma}$ for $1\nolinebreak \varleq\nolinebreak i\nolinebreak \varleq\nolinebreak n$.
					Hence $  f(\lifboth{r_1\sigma}, \dots, \lifboth{r_n\sigma}) \simgeq f(\lifboth{s_1\sigma}, \dots, \lifboth{s_n\sigma})$,
					which however is nothing else than
					$\lifboth{t\cl\sigma} \simgeq \lifboth{t\sigma} $.

			\end{itemize}

		\item{Factorisation.}
			If the clause $C$ is the result of a factorisation, then we can argue analoguously as for resolution.
			%If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier~$\sigma$ such that $l\sigma = l'\sigma$, then let $\tau = \aiu(\lifboth{l\cl\sigma}, \lifboth{l'\cl\sigma})$.
			%The rest of this proof resembles the case of resolution:
			%Every literal in $C$ is of the form $\lambda\sigma$ for some $\lambda \in C_1$.
			%By the induction hypothesis, there is a literal in $\AIcl(C_1)$ such that $\lambda\cl \simgeq \lifboth{\lambda}$.
			%As $\lambda \neq l$, by the definition of $\AIcl$, $\lifboth{\lambda\cl\sigma}\tau$ is contained in $\AIcl(C)$.
			%A similar induction argument as for the case of resolution shows that $\lifboth{\lambda\cl\sigma}\tau \simgeq \lifboth{\lambda\sigma}$.
			\qedhere
	\end{description}

\end{proof}

\begin{lemma}
	\label{lemma:resolved_literal_like_lifted_literal}
	Let $l$ be a resolved or factorised literal of a resolution derivation step $\inference$ employing the unifier $\sigma$ such that $l\sigma = l'\sigma$ and let $\tau =\nolinebreak \aiu(\inference)$.
	Then $\lifboth{l\cl\sigma}\tau = \lifboth{l\sigma}$.
\end{lemma}
\begin{proof}
	By Lemma~\ref{lemma:literals_clause_simgeq}, we obtain that
	$\lifboth{l\cl\sigma}\tau \simgeq \lifboth{l\sigma}$.
	Note that the $\simgeq$-\nolinebreak{}relation guarantees that pairs of predicates and terms in this relation are equal up to the index of their lifting variables.
	Hence it only remains to show that the lifting variables of $\lifboth{l\cl\sigma}\tau$ and $\lifboth{l\sigma}$ match.
	But the definition of $\aiu$, $\tau$ substitutes any lifting variable at position $p$ of $\lifboth{l\cl\sigma}$ by the lifting variable $\lifboth{l\sigma}\at{p}$.
\end{proof}


\begin{lemma}
	\label{lemma:resolved_literals_equal}
	Let $l$ and $l'$ be the resolved or factorised literals of a resolution derivation step $\inference$ employing the unifier $\sigma$ such that $l\sigma = l'\sigma$ and let $\tau =\nolinebreak \aiu(\inference)$.
	Then $\lifboth{l\cl\sigma}\tau = \lifboth{l\cl'\sigma}\tau$.
\end{lemma}
\begin{proof}
	By Lemma~\ref{lemma:resolved_literal_like_lifted_literal}, 
	we obtain that 
	$\lifboth{l\cl\sigma}\tau = \lifboth{l\sigma}$ and
	$\lifboth{l'\cl\sigma}\tau = \lifboth{l'\sigma}$.
	But due to $l\sigma \syneq l'\sigma$, it holds that
	$\lifboth{l\sigma} = \lifboth{l'\sigma}$.
\end{proof}


\begin{lemma}
	\label{lemma:gamma_entails_aide}
	Let $\pi$ be a resolution refutation of $\Gamma\cup\Delta$.
	Then for clauses $C$ in\nolinebreak{} $\pi$,
	$\Gamma\entails\nolinebreak \AImatde(C) \lor\nolinebreak \AIclde(C)$.
\end{lemma}
\begin{proof}
	We proceed by induction of the strengthening $\Gamma\entails \AImatde(C) \lor \AIclde(C_\Gamma)$\footnotemark.\footnotetext{Recall that as in Lemma~\ref{lemma:gamma_entails_lifted_interpolant}, $D_\Phi$ denotes the clause created from the clause $D$ by removing all literals which are not contained $\Lang(\Phi)$.}

	\begin{description}
		\item{Base case.}
			For $C\in \Gamma$, $\AIclde(C_\Gamma) = \AIclde(C) = \lifdeltanovar{C} = C$, so $\Gamma \entails \AIclde(C_\Gamma)$.
			Otherwise $C \in \Delta$ and hence $\AImatde(C) = \top$.

		\item{Resolution.}
			Suppose the last rule application is an instance $\inference$ of resolution. Then it is of the following form:
			\begin{prooftree}
				\AxiomCm{C_1: D \lor l}
				\AxiomCm{C_2: E \lor \lnot l'}
				\RightLabelm{\quad l\sigma = l'\sigma}
				\BinaryInfCm{C: (D\lor E)\sigma}
			\end{prooftree}

			Let
			$\tau = \aiu(\inference)$.
			We introduce the following abbreviations:

			\newcommand{\clauseOnePrime}{\AIclausede((C_1)_\Gamma)^*}
			\newcommand{\clauseTwoPrime}{\AIclausede((C_2)_\Gamma)^*}


			$ \clauseOnePrime = \AIclausede((C_1)_\Gamma) \setminus \{{(l{\fromclausede})_\Gamma}\}$

			$ \clauseTwoPrime = \AIclausede((C_2)_\Gamma)\setminus \{{\lnot (l{\fromclausede'})_\Gamma}\}$

			Note that $\AIclde(C) = \lifdeltanovar{ \clauseOnePrime\sigma} \tau \lor \lifdeltanovar{ \clauseTwoPrime\sigma} \tau$.

			Employing these, the induction hypothesis yields
			$\Gamma \entails \AImatrixde(C_1) \lor \clauseOnePrime \lor {(l{\fromclausede})_\Gamma}$
			as well as
			$\Gamma \entails \AImatrixde(C_2) \lor \clauseTwoPrime \lor {\lnot (l'{\fromclausede})_\Gamma}$.
			By Lemma~\ref{lemma:no_colored_terms}, $\AImatrixde(C_i)$ and $\AIclde(C_i)$ for $i\in\{1,2\}$ do not contain $\Delta$-colored symbols.
			Hence by Lemma~\ref{lemma:substitute_and_lift}, pulling the lifting inwards using Lemma~\ref{lemma:lift_logic_commute} and applying $\tau$, we obtain:

			$\Gamma \stackrel{\markA}\entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{(l{\fromclausede})_\Gamma\sigma}\tau$

			$\Gamma \stackrel{\markB}\entails \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau \lor \lnot \lifboth{(l{\fromclausede'})_\Gamma\sigma}\tau$

			We continue by a case distinction on the color of $l$:
			\begin{enumerate}
				\item Suppose that $l$ is $\Gamma$-colored. Then $\AImatde(C) = \lifboth{\AImatde(C_1)\sigma}\tau\spas\lor \lifboth{\AImatde(C_2)\sigma}\tau$.
					As $l$ is $\Gamma$-colored, $(l{\fromclausede})_\Gamma = l\clde$ and
					as $l\sigma = l'\sigma$, also $(l{\fromclausede'})_\Gamma = l'\clde$.
					By Lemma~\ref{lemma:resolved_literals_equal}, $\lifboth{l{\fromclausede}\sigma}\tau = \lifboth{l{\fromclausede'}\sigma}\tau$.
					Hence we can perform a resolution step on \markA{} and \markB{} to arrive at
					$\Gamma \entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau
					\lor \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau$.
					This is however by Lemma~\ref{lemma:lift_logic_commute} nothing else than $\Gamma \entails \AImatde(C) \lor \AIclde(C)$.

				\item Suppose that $l$ is $\Delta$-colored. Then $\AImatde(C) = \lifboth{\AImatde(C_1)\sigma}\tau\spas\land \lifboth{\AImatde(C_2)\sigma}\tau$.
					As $l$ and $l'$ are $\Delta$-colored, \markA{} and \markB{} reduce to
					$\Gamma \entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{\clauseOnePrime\sigma}\tau $ and
					$\Gamma \entails \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau $ respectively.
					These however imply that
					$\Gamma \entails (\lifboth{\AImatrixde(C_1)\sigma}\tau \land  \lifboth{\AImatrixde(C_2)\sigma}\tau) \spas\lor\allowbreak \lifboth{\clauseOnePrime\sigma}\tau \lor \lifboth{\clauseTwoPrime\sigma}\tau$,
					which in turn is nothing else than $\Gamma \entails\nolinebreak \AImatde(C) \lor \AIclde(C)$.

				\item Suppose that $l$ is grey. Then $\AImatde(C) =
					(\lnot {\lifboth{l'\fromclausede\sigma}}\tau \land \lifboth{\AImatde(C_1)\sigma}\tau) \spam\lor\allowbreak
					(\lifboth{l\fromclausede\sigma}\tau \land \lifboth{\AImatde(C_2)\sigma}\tau)
					$.

					Let $M$ be a model of $\Gamma$. Suppose that $M \notentails \AIclde(C)$ as otherwise we are done. Hence $M \notentails \lifboth{\clauseOnePrime\sigma}\tau$ and $M \notentails \lifboth{\clauseTwoPrime\sigma}\tau$ and \markA{} and \markB{} reduce to
					$\Gamma \entails \lifboth{\AImatrixde(C_1)\sigma}\tau \lor \lifboth{l{\fromclausede}\sigma}\tau$
					and
					$\Gamma \entails \lifboth{\AImatrixde(C_2)\sigma}\tau \lor \lifboth{l{\fromclausede'}\sigma}\tau$ respectively.
					As by Lemma~\ref{lemma:resolved_literals_equal} $\lifboth{l{\fromclausede}\sigma}\tau = \lifboth{l{\fromclausede'}\sigma}\tau$, a case distinction on the truth value of $\lifboth{l{\fromclausede}\sigma}\tau$ in $M$ shows that $M\entails \AImatde(C)$.


			\end{enumerate}



		\item{Factorisation.}
			Suppose the last rule application is an instance of factorisation. Then it is of the following form:
			\begin{prooftree}
				\AxiomCm{C_1: l \lor l' \lor D}
				\RightLabelm{\quad \sigma = \mgu(l, l')}
				\UnaryInfCm{C: (l \lor D)\sigma}
			\end{prooftree}

			Let $\tau = \aiu(\inference)$.
			We introduce the abbreviation $\AIclde( (C_1)_\Gamma)^* \defeq \AIclde( (C_1)_\Gamma) \setminus \{ (l\cl)_\Gamma , (l'\cl)_\Gamma \}$ and express the induction hypothesis as follows:
			$\Gamma \entails \AImatde(C_1) \lor \AIclde( (C_1)_\Gamma)^* \lor (l\cl)_\Gamma \lor (l'\cl)_\Gamma $.
			By Lemma~\ref{lemma:no_colored_terms}, Lemma~\ref{lemma:substitute_and_lift} and Lemma~\ref{lemma:lift_logic_commute} and after applying $\tau$ to the induction hypothesis, we obtain that
			$\Gamma \entails \lifboth{\AImatde(C_1)\sigma}\tau \lor \lifboth{\AIclde( (C_1)_\Gamma)^*\sigma}\tau \lor \lifboth{(l\cl)_\Gamma \sigma}\tau \lor \lifboth{(l'\cl)_\Gamma\sigma}\tau $.

			However by Lemma~\ref{lemma:resolved_literals_equal},
			$\lifboth{(l\cl)_\Gamma\sigma}\tau =
			\lifboth{(l'\cl)_\Gamma\sigma}\tau$, hence we can perform a factorisation step to arrive at
			$\Gamma \entails \lifboth{\AImatde(C_1)\sigma}\tau \lor \lifboth{\AIclde( (C_1)_\Gamma)^*\sigma}\tau \lor \lifboth{(l\cl)_\Gamma \sigma}\tau$.
			This however is nothing else than $\Gamma\entails \AImatde(C) \lor \AIclde(C)$.
			\qedhere
	\end{description}
\end{proof}


As we have just seen, the formula $\AImatde(C) \lor \AIclde(C)$ now satisfies one condition of interpolants.
Using this, we are able to formulate a result on one-sided interpolants, which are defined as follows:

\begin{defi}
	Let $\Gamma$ and $\Delta$ be sets of first-order formulas.
	A \defiemph{one-sided interpolant} of $\Gamma$ and $\Delta$ is a first-order formula $I$ such that
	\begin{enumerate}
		\item $\Gamma \entails I$
		\item $\Lang(I) \subseteq \Lang(\Gamma) \cap \Lang(\Delta)$
			\qedhere
	\end{enumerate}
\end{defi}

\begin{prop}
	Let $\Gamma$ and $\Delta$ be sets of first-order forumulas such that $\Gamma\cup\Delta$ is unsatisfiable.
	Then there is a one-sided interpolant of $\Gamma$ and $\Delta$ which is a $\Pi_1$ formula.
\end{prop}
\begin{proof}
	Let $\pi$ be a resolution refutation of $\Gamma\cup\Delta$.
	By Lemma~\ref{lemma:gamma_entails_aide}, $\Gamma \entails \AImatde(\pi) \lor \AIclde(\pi)$,
	or in other words
	$\Gamma \entails \forall x_1 \dots \forall x_n  \AImatde(\pi) \lor \AIclde(\pi)$, where $x_1, \dots, x_n$ are the $\Delta$-lifting variables occurring in $\AImatde(\pi) \lor \AIclde(\pi)$.
	%Let $x_1, \dots, x_n$ be the $\Delta$-lifting variables in $I$.
	By Lemma~\ref{lemma:no_colored_terms}, the formula $\AImatde(\pi) \lor \AIclde(\pi)$ does not contain $\Delta$-colored symbols.

	Let $y_1, \dots y_m$ be the $\Gamma$-lifting variables of $\lifgamma{\AImatde(\pi) \lor \AIclde(\pi)}$
	and
	\[I = \forall x_1 \dots \forall x_n \exists y_1 \dots \exists y_m \lifgamma{\AImatde(\pi) \lor \AIclde(\pi)}.\]
	Note that $I$ does not contain any $\Gamma$-terms.
	As $\AImatde(\pi) \lor \AIclde(\pi)$ contains witness terms for every existential quantifier in $I$ with respect to $\Gamma$, $\Gamma \entails I$.
	Hence $I$ is a $\Pi_1$ formula which is a one-sided interpolant for $\Gamma \cup \Delta$.
\end{proof}


\section{Arrows}


\mytodo{transition to ordering of quantified lifting vars}

In order to establish the required ordering on the lifting variables, we annotate the literals with arrows.
More formally:

\begin{defi}[$\AIcol$]
	The set of colored literals with respect to a clause $C$ in a resolution derivation is defined as follows:

	\begin{itemize}
		\item[Base case.]
			For $C \in \Gamma\cup\Delta$, $\AIcol(C) \defeq \emptyset$.

		\item[Resolution.]
			Suppose the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ with $\sigma = \mgu(\inference)$ and $\tau = \aiu(\inference)$.
			Then:

			$\AIcol(C) \defeq \{ \lifboth{\varphi\sigma}\tau \mid \varphi \in \AIcol'(C) \}$, where

			$\AIcol'(C) \defeq
			\begin{cases}
				\AIcol(C_1) \cup \AIcol(C_2) \cup \{ l\cl, l'\cl \}  & \text{ if $l$ is a colored literal} \\
				\AIcol(C_1) \cup \AIcol(C_2) & \text{ if $l$ is a grey literal}
			\end{cases} $

		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation of $C_1$, then
			$\AIcol(C) \defeq \{ \lifboth{\varphi\sigma}\tau \mid \varphi \in \AIcol(C_1) \}$.
			\qedhere
	\end{itemize}
\end{defi}

\begin{defi}[$\AIany$]
	For a clause $C$, $\AIany(C)$ denotes $\AImat(C)$, $\AIcl(C)$, $\AIcol(C)$.
\end{defi}

This definition is convenient as it adheres to the following proposition:

\begin{prop}
	Let $l$ be a literal in a clause in $\Gamma \cup \Delta$.
	Then for a clause $C$ in a resolution refutation of $\Gamma\cup\Delta$,
	$\AIany(C)$ contains a literal derived from $l$.
	\mytodo{actually \textbf{AT LEAST} one literal derived from $l$}
	\todo{ write this more formally, there is a relation like $\simgeq$ here. possibly write that lemma like this}
\end{prop}


\mytodo{define: descendant (usual stuff, factorisation is merge, resolution is de-facto merge which happens implicitly so no actual merge required)}

\cbstart
\begin{defi}
	We define a directed graph $G_C$ for every clause $C$ of the derivation.
	The nodes are of the form $l.tp$, where $l$ denotes a literal and $tp$ a position of a term in $l$, which is not contained in a colored term.
	The node $l.tp$ in a graph $G_C$ refers to the literal in $\AImat(C)$, $\AIcl(C)$ or $\AIcol(C)$
	which is a descendant of $l$.
	Note that there exists exactly one for every literal of every clause which is an ancestor of $C$.
	Hence given $C$, $l.tp$ is a well-defined position and the position will usually just be denoted by $p$ or $q$ as abbreviation of $l.tp$.
	For literals in $\AIcl(C)$, we usually denote the literal by $l\cl$ and the corresponding literal in $C$ by $l$.
	Note that set of literals in $\AIcl(C)$ is exactly the set of literals of $C$.

	Note that term positions are well defined since arcs do not point into colored terms and are hence not removed by liftings and in the course of the derivation, terms in literals are only modified by substitutions, which does not remove any term which might invalidate a term position.

	\label{def:arrows}
	\begin{itemize}
		\item[Base case.]
			For $C \in \Gamma\cup\Delta$, we define $G_C$ to be the empty graph.

		\item[Resolution.]
			If the clause $C$ is the result of a resolution step of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ using a unifier $\sigma$ such that $l\sigma =  l'\sigma$, we define:

			\mytodo{find meaningful name for index when usage of $\arr_1$ is clear}

			\comm{old idea, basically requires to know term behind lifting var \tiny $\arr_1 \defeq \{ (p, q) \mid $ maximal colored term $t$ occurs in $x\sigma$ for some variable $x$, $p$ grey occurrence of $t$ in $C$ (NOTE: does not only mean $C$ actually), $q$ maximal colored term containing colored occurrence of $x$ (where the color of $x$ is different from the color of $t$) in $C_1$ or $C_2 \}$}

			\NB{this will only work for $\AIde$, c.f.\ 212c:}

			$\arr_1 \defeq \{ (p, q) \mid $ maximal colored term $t$ occurs in $x\sigma$ for some variable $x$, $p$ grey occurrence of $z_t$ in $\AIany(C)$, $q$ maximal colored term containing colored occurrence of $x$ (where the color of $x$ is different from the color of $t$) in $C_1$ or $C_2 \}$

			$\arr_2 \defeq \{ (p, q) \mid $ maximal $\Phi$-term $t$ occurs in maximal $\Psi$-term $s$ in $x\sigma$ for some variable $x$, $p$ grey occurrence of $t$ in $C$, $q$ grey occurrence of $x$ or maximal colored term containing colored occurrence of $x$ in $C_1$ or $C_2$,
			$(\Phi, \Psi) \in \{(\Gamma, \Delta), (\Delta, \Gamma)\} \} $

			% old version:
			%$\arr_2 \defeq \{ (p, q) \mid $ maximal $\Phi$-term $t$ occurs in maximal $\Psi$-term $s$ in $x\sigma$ for some variable $x$, $p$ grey occurrence of $t$ in $C$, $q$ grey or colored occurrence of $x$ in $C_1$ or $C_2$,
			%$(\Phi, \Psi) \in \{(\Gamma, \Delta), (\Delta, \Gamma)\} \} $

			$G_C \defeq G_{C_1} \cup G_{C_2} \cup \arr_1 \cup \arr_2$


		\item[Factorisation.]
			If the clause $C$ is the result of a factorisation of $C_1: l \lor l' \lor D$ using a unifier $\sigma$ such that $l\sigma = l'\sigma$, then

			$G_C \defeq G_{C_1} \cup G_{C_2}$\footnote{Note however that the literal $l$ in $C$ has $l$ as well as $l'$ in $C_1$ as predecessors, i.e.~the arrows from both of these literals apply implicitly.}
			\qedhere
	\end{itemize}
\end{defi}
\cbend


\cbstart
\subsection{Variable occurrences}
Need for var $x$ the set of colored occs and grey occs in initial clauses.
lift clauses as usual s.t. to not see any of the colored structure, hence remember only in which max colored term the var is.

for resolution/factorisation, check unifier:
\begin{compactitem}
\item
	if $x$ occurs grey in $y\sigma$, then the set of occurrences of $y$ is added to the ones of $x$, col to col and grey to grey
\item
	if $x$ occurs colored in $y\sigma$, then the set of occurrences of $y$ is added to the ones of $x$, col and grey to col
\end{compactitem}
\cbend



\begin{defi}[$\apath$]
	For terms $s$ and $t$, $s\apath_{G_C} t$ holds if there is some $p, q$ in the edge set of $G_C$ such that $s$ is a subterm of the term at $p$ and $t$ is a subterm of the term at $t$ such that $s$ and $t$ are not contained in colored terms. (NOTE: in $\AIde$, $\Gamma$-terms are not colored terms in this sense.)
\end{defi}

\begin{comment}
	\begin{lemma}
		Let $l$ and $l'$ be literals such that $\sigma = \mgu(l, l')$
		and let $\lit = l\lor l'$.

		Suppose a single-colored $\Phi$-term $s\occ{y}$ containing a variable $y$ occurs in $\Lambda\sigmaz{i-1}$ where $1\varleq i \varleq n$ and $\sigma_0 = \id$ such that 
		a variable $x$ occurs grey in $y\sigma_i$.
		%Then at least one of the following statements holds:
		Then in $\Lambda\sigmazi$, there is an occurrence of $x$ of at least one of the following forms:
		\begin{enumerate}
			\item A grey occurrence
			\item An occurrence in a single-colored $\Phi$-term
			\item [ col change ]
		\end{enumerate}

	\end{lemma}
\end{comment}

\newcommand{\lits}{\alpha}
\begin{lemma}
	Let $l$ and $l'$ be literals such that $\sigma = \mgu(l, l')$
	and let $\lits = l\lor l'$.

	Suppose a single-colored $\Phi$-term $s\occ{y}$ containing a variable $y$ occurs in $\lits\sigmaz{i-1}$ where $1\varleq i \varleq n$ and $\sigma_0 = \id$ such that 
	a variable $x$ occurs grey in $y\sigma_i$.

	Then if $x$ only occurs only in single-colored $\Psi$-terms in $\lits\sigmaz{i-1}$, $y$ also occurs in a single-colored $\Psi$-term in $\lits\sigmaz{i-1}$.
	%Then there is at least one occurrence of $x$ in $\lits\sigmaz{i-1}$\todo{or $i$, depending on what we need}{} which is not contained in a single-colored $\Psi$-term.????
\end{lemma}
\begin{proof}
	There must be an occurrence $\bhat y$ of $y$, say w.l.o.g.\ in $l\sigmaz{i-1}$,
	such that $l'\sigmaz{i-1}\at{\bhat y} = y\sigma_i$.
	Note that $l\sigmaz{i-1}\at{\bhat y}$ and $l'\sigmaz{i-1}\at{\bhat y}$ agree on the prefix and that $x$ occurs grey in $l'\sigmaz{i-1}\at{\bhat y}$.

	Now suppose that $x$ only occurs in single-colored $\Psi$-terms in $\lits\sigmaz{i-1}$.
	Then $l\sigmaz{i-1}\at{\bhat y}$ is a single-colored $\Psi$-term containing $y$.
\end{proof}

\mytodo{ICI1: think about what $\Lambda$ is and how to define it in the context of multiply used clauses}

\begin{lemma}
	\label{lemma:color_change}
	Let $\pi$ be a resolution refutation of $\Gamma \cup \Delta$ and $C_1$ and $C_2$ be the clauses used in a resolution or factorisation step $\inference$ with $\sigma = \mgu(\inference)$.
	Let $\Lambda$ be the set of literals contained in $\Gamma\cup\Delta$ with all unifications of $C_1$ and $C_2$ applied.
	Then if a variable $x$ is a color-changing variable\footnote{Recall that a variable is a color-changing if it occurs both in a single-colored $\Gamma$-term and a single-colored $\Delta$-term}
	in $\Lambda\sigmazi$,
	$x$ also occurs grey 
	in $\Lambda\sigmazi$.
\end{lemma}
\begin{proof}
	We proceed by induction. Note that in the initial clause sets, no foreign colored terms occur.

	We consider a resolution or factorisation step.
	We perform a nested induction over the construction steps of $\sigma = \sigma_1 \cdots \sigma_n$ with $C_1$ and $C_2$ as induction start.

	Suppose that $x$ does not occur grey in $\Lambda\sigmaz{i-1}$ as otherwise we are done.
	We show that if a variable $x$ occurs in a single-colored $\Phi$-term in $\Lambda\sigmazi$, then (1) it does so in $\Lambda\sigmaz{i-1}$ or (2) there is a color-changing variable $y$ in $\Lambda\sigmaz{i-1}$ such that $x$ occurs grey in $y\sigma_i$.
	Consider the situations which produce a single-colored $\Phi$-term containing a variable:
	\begin{itemize}
		\item Suppose single-colored $\Phi$-colored term containing $x$ is present in $\Lambda\sigmaz{i-1}$. Then it is as well in $\Lambda\sigmaz{i}$.
		\item Suppose that a variable $y$ occurs a single-colored $\Phi$-term in $\Lambda\sigmaz{i-1}$ such that $x$ occurs grey in $y\sigma_i$.
			Suppose furthermore that $x$ does not occur in a single-colored $\Phi$-term in $\Lambda\sigmaz{i-1}$ as otherwise we are done.
			As by assumption it does not occur grey in $\Lambda\sigmaz{i-1}$, $x$ only occurs in single-colored $\Psi$-terms in $\sigmaz{i-1}$.
			But as $x$ occurs grey in $y\sigma_i$, there must be an occurrence $\bhat y$ of $y$ in a resolved or factorised literal, say $l\sigmaz{i-1}$, such that for the other resolved or factorised literal $l'$, $l'\sigmaz{i-1}\at{\bhat y}$ is a subterm where $x$ occurs grey.
			But as $l'\sigmaz{i-1}\at{\bhat y}$ is contained in a single-colored $\Psi$-term, so is $l\sigmaz{i-1}$, hence $y$ is a color-changing variable in $(C_1 \cup C_2)\sigmaz{i-1}$. 

		\item Suppose that a variable $y$ occurs in $(C_1 \cup C_2)\sigmaz{i-1}$ such that $x$ occurs in a single-colored $\Phi$-term in $y\sigma_i$.
			There must be an occurrence of $y\sigma_i$ in $(C_1 \cup C_2)\sigmaz{i-1}$, but this is nothing else than single-colored $\Phi$-term containing $x$.
	\end{itemize}

	Suppose now that $x$ occurs in $\Lambda\sigmazi$ in a single-colored $\Phi$-term as well as in a single-colored $\Psi$-term.
	If this is the case in $\Lambda\sigmaz{i-1}$, then by the induction hypothesis, $x$ occurs grey in $\Lambda\sigmaz{i-1}$ and consequently also in $\Lambda\sigmazi$.

	If otherwise $x$ does not occur in a single-colored $\Phi$- or $\Psi$-term in $\Lambda\sigmaz{i-1}$, then by the reasoning given above, there is a color-changing variable $y$ in $\Lambda\sigmaz{i-1}$ such that $x$ occurs grey in $y\sigma_i$. 
	By the induction hypothesis, then $y$ occurs grey in $\Lambda\sigmaz{i-1}$, which directly implies that $x$ occurs grey in $\Lambda\sigmazi$.
\end{proof}


\begin{lemma}
	\label{lemma:lft_var_occurs_grey}
 	Let $C$ be a clause in a resolution refutation of $\Gamma \cup \Delta$.
	If in $\AImatde(C) \lor \AIclde(C)$	a $\Gamma$-term $t\occ{x_s}$ contains a $\Delta$-lifting variable $x_s$, then $x_s$ occurs grey in $\AIanyde(C)$.

\end{lemma}
\begin{proof}
	Note that if a respective term occurs in $\AImatde(C) \lor \AIclde(C)$, the corresponding non-lifted term is a $\Gamma$-term containing a $\Delta$-term\todo{mention lemma once it exists}.

	Note that it suffices to show that at the derivation step which introduces $s$ as subterm of $t\occ{s}$, $x_s$ occurs grey in $\AIanyde(C)$ as any potential later modification of $x_s$ is only performed by the substitution $\tau$. 
	However $\tau$ is applied globally in $\AIanyde$, so it affects each occurrence of $x_s$ in the same manner.

	We proceed by induction.
	Note that for $C\in \Gamma\cup\Delta$, no $\Delta$-lifting variable occurs in a $\Gamma$-term in $\AImatde(C) \lor \AIclde(C)$.

	For the induction step, suppose that the condition holds for the clauses $C_1$ and $C_2$ used in a resolution or factorisation step $\inference$.
	Let $\sigma = \mgu(\inference)$.
	We continue by induction over the construction steps of $\sigma = \sigma_1 \cdots \sigma_n$ and consider the situations which produce $\Delta$-terms in $\Gamma$-terms:
	\begin{itemize}
		\item Suppose a maximal colored single-colored $\Gamma$-term $t\occ{u}$ in $\Lambda\sigmaz{i-1}$ contains a variable $u$ such that a $\Delta$-term $s'$ occurs grey in $u\sigma_i$ such that $s'\sigmarange{i+1}{n} = s$.

			We assume that $u$ does not occur grey in $\Lambda\sigmaz{i-1}$ as otherwise we are done.
			If $u$ occurs in $\Lambda\sigmaz{i-1}$ in a single-colored $\Delta$-term, then by Lemma~\ref{lemma:color_change}, $x$ occurs grey in $\Lambda\sigmazi$ and we are done as well.

			Therefore suppose that $u$ only occurs in single-colored $\Gamma$-terms in $\Lambda\sigmaz{i-1}$.
			As $u\in\dom(\mgu)$, $u$ occurs in a resolved or factorised literal, say at $\bhat u$ in $l\sigmaz{i-1}$.
			The other resolved or factorised literal $l'\sigmaz{i-1}$ contains a grey occurrence of $s'$ at the subterm $l'\sigmaz{i-1}$.
			But as $l\sigmaz{i-1}\at{\bhat u}$ and $l'\sigmaz{i-1}\at{\bhat u}$ agree on the prefix, $s'$ occurs in a single-colored $\Gamma$-term in $l'\sigmaz{i-1}$.
			So by the induction hypothesis, $s'$ occurs grey in $\Lambda\sigmaz{i-1}$.
			Note that if $s'$ is introduced by $\sigmaz{i-1}$, then due to $l\sigma\at{\bhat u} = s$, $\sigma$ introduces a grey occurrence of $s$, which in the corresponding literal in $\AIanyde$ is lifted to yield $x_s$, in which case we are done.

			Otherwise $s'$ has a predecessor $s''$ in $C_1$ or $C_2$ such that $s''$ is a $\Delta$-term which is contained in a $\Gamma$-term and $s''\sigmaz{i-1} = s'$.
			The lifting variable in $\AIanyde(C_1)$ or $\AIanyde(C_2)$\todo{formulate a lemma about that this works}{} corresponding to $s''$ in general is of the form $x_r$ with $r\neq s$.
			But Lemma~\ref{lemma:resolved_literal_like_lifted_literal}, we have that $\lifdeltanovar{l\cl\sigma}\tau = \lifdeltanovar{l\sigma}$ for the resolved or factorised literal $l$ with $\tau = \aiu(\inference)$.
			Since $x_r$ occurs in $l\cl$ and lifting variables are only modifed by $\tau$, it must be the case that $\{x_r \mapsto x_s\}\in \tau$.
			But then $x_s$ occurs in $\lifdeltanovar{l\cl\sigma}\tau$, which is contained in $\AIcolde(C)$ and hence in $\AIanyde(C)$.


		\item
			Suppose that a variable $u$ occurs in $C_1$ or $C_2$ either grey or in a maximal colored single-colored $\Gamma$-term such that $u\sigma$ contains a multi-colored $\Gamma$-term $t$.

			Then $u$ occurs in a resolved or factorised literal $\lambda\sigmaz{i-1}$ at $\bhat u$ such that at the other resolved or factorised literal $\lambda'\sigmaz{i-1}$, $\lambda'\sigmaz{i-1}\at{\bhat u} = t$.
			But then by the induction hypothesis, $\AIanyde(C)$ contains grey occurrences for every lifting variable in $t$ and as $t$ occurs in the resolved or factorised literal, but a similar reasoning as given in the other case, $\tau$ substitutes these lifting variables to exactly the ones occurring in $t\sigma$.
			\qedhere
	\end{itemize}


\end{proof}

\begin{exa}
	$ R(h(y)) \lor P(f(y))$;
	$ \lnot P(f(x_{g(x)})) \lor Q(x_{g(x)}) $ such that in the actual clause, it is $g(a)$ and not $g(x)$ any more.
	Then $ \{ x_{g(x)} \mapsto x_{g(a)} \} \in \tau $ as desired.
\end{exa}

\begin{lemma}
	\label{lemma:arrow_for_lft_var}
	Let $C$ be a clause in a resolution refutation of $\Gamma \cup \Delta$.
	If in $\AImatde(C) \lor \AIclde(C)$	a maximal colored $\Gamma$-term $t\occ{x_s}$ contains a $\Delta$-lifting variable $x_s$,
	then $x_s \apath_{G_C} t\occ{x_s}$.
\end{lemma}
\begin{proof}
	We proceed by induction. Note that for $C\in\Gamma\cup\Delta$, no $\Delta$-lifting variable occurs in a $\Gamma$-term in $\AImatde(C) \lor \AIclde(C)$.

	For the induction step, suppose that the condition holds for $C_1$ and $C_2$ which are used in a resolution or factorisation step $\inference$.
	By Lemma~\ref{lemma:lft_var_occurs_grey}, $x_s$ occurs grey in $\AIanyde(C)$. Let $r$ be the position of $x_s$ in $\AIanyde(C)$.
	We consider the two situations which produce $\Delta$-terms in $\Gamma$-terms:
	\begin{itemize}
		\item Suppose a maximal colored single-colored $\Gamma$-term $t\occ{u}$ in $\Lambda$ contains a variable $u$ such that a $\Delta$-term $s$ occurs grey in $u\sigma$.
			Then $\arr_1$ as defined in Definition~\ref{def:arrows} contains $(r, q)$ such that $\AIclde(C)\at{q}$ is $t\occ{x_s}$.

		\item
			Suppose that a variable $u$ occurs in $C_1$ or $C_2$ either grey or in a maximal colored single-colored $\Gamma$-term such that $u\sigma$ contains a multi-colored $\Gamma$-term $t$.
			Then $\arr_2$ as defined in Definition~\ref{def:arrows} contains $(r, q)$ such that $\AIclde(C)\at{q}$ is the grey occurrence of $u$ or the maximal colored term containing $u$ respectively.
			\qedhere
	\end{itemize}

\end{proof}



\section{Combining the results}

\begin{defi}
	\label{def:arrow_quantifier_block}
	Let $C$ be a clause in a resolution refutation $\pi$ of $\Gamma\cup\Delta$
	and $\bar x$ be the $\Delta$-lifting variables and $\bar y$ the $\Gamma$-lifting variables ocurring in $\AImat(C)$.
	$\Q(C)$ denotes an arrangement of the elements of  $\{ \forall x_t \mid x_t \in \bar x\} \cup \{ \exists y_t \mid y_t \in \bar y\}$ such that for two lifting variable $z_s$ and $z_r$ $z_s \apath_{G_C} z_r$ implies that $z_s$ is listed before $z_r$.
	We denote $\Q(\square)$ by $\Q(\pi)$.
	%such that for any edge $(p, q) \in G_C$, if $s$ is a subterm of $\AIany(C)\at{p}$ and $r$ is a subterm of $\AIany(C)\at{q}$ and $z_s$ and $z_r$ both occur in $\AImat(C)$, then $z_s$ is listed before $z_r$ is.
\end{defi}

\largered{ doesn't it work to add arrows based on $C$ (actual clause), then prove correctness via $\AI^\Delta$ and $\AI^\Gamma$, then just use $\AI$ wihout actually needing the one-sided ones? }

there's also a similar result in \texttt{-presentable}: $\lifboth{C} \sim \lifgammanovar{ \AIde(C) } $

\mytodo{ICI2: possibly use $\Lambda$ as to be defined above}

\begin{clemma}
	\label{lemma:ai_vs_aide_1}
	Let $C$ be a clause in a resolution refutation of $\Gamma\cup\Delta$.
	If a $\Gamma$-lifting variable occurs multiple times in $\AIany(C)$, then the terms at the corresponding positions in $\AIany(C))$ are equal.
\end{clemma}
\begin{proof}
	Note that $\AIclde(C) \sim \lifdeltanovar{C}$ and $\AIcl(C) \sim \lifboth{C}$.\todo{$\sim$ not defined here}

	We proceed by induction over the resolution refutation of $\Gamma\cup\Delta$.
	
	\begin{description}
		\item{} Base case.
			For $C \in \Gamma\cup\Delta$, if $\AIany(C)$ contains a $\Gamma$-lifting variable $y_t$ at position\nolinebreak{} $p$,
			then $\AIanyde(C)\at{p} = \lifdeltanovar{t}$.

		\item{} Induction step.
			Suppose the clause $C$ is the result of a resolution step $\inference$ of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$
			or of a factorisation step $\inference$ of $C_1: l \lor l' \lor D$. \mytodo{do not assign $C_1$ twice}
			Let $\sigma = \mgu(\inference)$.

			Suppose $\sigma$ introduces a $\Gamma$-term 

			how to argue formally over connection between aide and ai?



	\end{description}


\end{proof}

\begin{clemma}
	\label{lemma:gamma_entails_quantified_ai}
	Let $C$ be a clause in a resolution refutation of $\Gamma\cup\Delta$.
	%and $\overline y$ be the $\Gamma$-lifting variables of $\AImat(C) \lor \AIcl$.
	Then
	$\Gamma \entails\nolinebreak Q(C) ( \AImat(C) \lor\nolinebreak \AIcl(C))$.
\end{clemma}
\begin{proof}
	By Lemma~\ref{lemma:gamma_entails_aide}, we obtain that 
	$\Gamma \entails \forall x_1 \cdots \forall x_n (\AImatde(C) \lor \AIclde(C))$, where $x_1,\dots,x_n$ are the $\Delta$-lifting variables occurring in $\AImatde(C) \lor \AIclde(C)$.
	Note that $\AImatde(C) \lor \AIclde(C)$ and $\AImat(C) \lor\nolinebreak \AIcl(C)$ are structurally equal in the sense that for a position $p$ in the latter, the first has a related term: For a grey term, it is the same grey term. For a $\Delta$-lifting variable, it is also a $\Delta$-lifting variable but possibly a different one and for $\Gamma$-lifting variables, the first has a maximal colored $\Gamma$-term.

	In order to show prove the lemma, we show that
	\begin{compactenum}
	\item if a $\Gamma$-lifting variable occurs multiple times in $\AImat(C)\lor\AIcl(C)$, then the terms at the corresponding positions in $\AImatde(C) \lor \AIclde(C))$ are equal and 
	\item if a $\Delta$-lifting variable occurs multiple times in $\AImatde(C) \lor \AIclde(C))$, then the $\Delta$-lifting variables at the corresponding positions in $\AImatde(C) \lor \AIclde(C))$ are equal.
	\end{compactenum}
	%In order to show the implication, we show that for two occurrences $\bhat x_{t}$ and $\bhat x_t'$ of $\Gamma$-lifting variable $x_t$ in $\AImat(C)\lor\AIcl(C)$,
	These conditions allow for inserting the respective terms of $\AImatde(C) \lor \AIclde(C))$ as witness terms for the $\Gamma$-lifting variables in $\AImat(C)\lor\AIcl(C)$ to yield a formula where the universal quantifiers are either equally or less restrictive than in $\AImat(C)\lor\AIcl(C)$, but otherwise the formula coincides.

	In the witness terms for the $\Gamma$-lifting variables, in general $\Delta$-lifting variables occur. 
	By Lemma~\ref{lemma:arrow_for_lft_var}, for every lifting variable $x_s$ in $t\occ{x_s}$, we have that $x_s \apath_{G_C} t\occ{x_s}$, hence by Definition~\ref{def:arrow_quantifier_block}, the lifting variables are quantified in some order such that the lifting variable for $x_s$ is quantified before the lifting variable for $t\occ{x_s}$ is.

	~

	\mytodo{
	it remains to show 1 and 2.
}

\end{proof}

\begin{lemma}
	\label{lemma:ai_symmetry}
	Let $\pi$ be a refutation of $\Gamma\cup\Delta$ and $\bhat \pi$ be $\pi$ with $\bhat \Gamma = \Delta$ and $\bhat \Delta = \Gamma$. Then $\Q(\pi)\AImat(\pi) \spas\semiff \lnot \Q(\bhat \pi)\AImat(\bhat \pi)$.
\end{lemma}
\begin{proof}
	Let $C$ be a clause in $\pi$ and $\bhat C$ the corresponding clause in $\bhat \pi$. 
	Note that $\AIcl$ is defined irrespective of the coloring, so $\AIcl(C) \syneq \AIcl(\bhat C)$.

	Consider furthermore that liftings variables of $C$ and $\bhat C$ only differ in the variable symbol, but not in the index, and that the quantifier type of any given lifting variable in $C$ is exactly contrary to the corresponding one in $\bhat C$.
	Hence for any formula $\phi$, $\Q(C) \lnot \phi \spas\semiff \lnot \Q(\bhat C) \phi$.

	It remains to show that $\AImat(C) \semiff \lnot \AImat(\bhat C)$, which we do be induction:

	\begin{itemize}
		\item[Base case.]
			If $C \in \Gamma$, then $\AImat(C) = \bot \semiff \lnot \top \semiff \lnot \AImat(\bhat C)$ as $\bhat C\in\Delta$. 
			The case for $C\in\Delta$ can be argued analoguously.

		\item[Resolution.]
			Suppose the clause $C$ is the result of a resolution step \inference{} of $C_1: D \lor l$ and $C_2: E \lor \lnot l'$ with $\sigma = \mgu(\inference)$ and $\tau = \aiu(\inference)$.

			As $\aiu(\inference)$ depends only on $l\cl$, $l'\cl$ and $\sigma$ and as $\AIcl(C) \syneq \AIcl(\bhat C)$, $\tau$ is the same for both $\pi$ and $\bhat \pi$.

			We now distinguish the following cases:

			\begin{enumerate}

				\item $l$ is $\Gamma$-colored:
					\begin{align*}
						\AImat(C)	&= \lifboth{\AImat(C_1)\sigma}\tau\spas\lor \lifboth{\AImat(C_2)\sigma}\tau \\
														 &\semiff \lnot (\lnot\lifboth{\AImat(C_1)\sigma}\tau\spas\land \lnot \lifboth{\AImat(C_2)\sigma}\tau) \\
														 &\semiff \lnot (\lifboth{(\lnot \AImat(C_1))\sigma}\tau\spas\land \lifboth{(\lnot \AImat(C_2))\sigma}\tau) \\
														 &\semiff \lnot (\lifboth{\AImat(\bhat C_1)\sigma}\tau\spas\land \lifboth{\AImat(\bhat C_2)\sigma}\tau) \\
														 &= \lnot \AImat(\bhat C)
					\end{align*}

				\item $l$ is $\Delta$-colored:
					This case can be argued analogously

				\item $l$ is grey:
					Note that by Lemma~\ref{lemma:resolved_literals_equal}, $\lifboth{l\fromclause\sigma} = \lifboth{l\fromclause\sigma}$ \markB.
					\begin{align*}
						\AImat(C) &=
						(\lnot {\lifboth{l'\fromclause\sigma}}\tau \land \lifboth{\AImat(C_1)\sigma}\tau) \spam\lor 
						(\lifboth{l\fromclause\sigma}\tau \land \lifboth{\AImat(C_2)\sigma}\tau)\\
						&\stackrel\markB\semiff\,
						({\lifboth{l'\fromclause\sigma}}\tau \lor \lifboth{\AImat(C_1)\sigma}\tau) \spam\land 
						(\lnot \lifboth{l\fromclause\sigma}\tau \lor \lifboth{\AImat(C_2)\sigma}\tau)\\
						%&\semiff\,({\lifboth{l'\fromclause\sigma}}\tau \lor  \lifboth{\AImat(C_1)\sigma}\tau) \spam\land 
						%(\lnot\lifboth{l\fromclause\sigma}\tau \lor \lifboth{\AImat(C_2)\sigma}\tau)\\
						&\semiff \lnot \Big( (\lnot {\lifboth{l'\fromclause\sigma}}\tau \land \lnot \lifboth{\AImat(C_1)\sigma}\tau) \spam\lor 
						(\lifboth{l\fromclause\sigma}\tau \land \lnot\lifboth{\AImat(C_2)\sigma}\tau) \Big) \\
						&=\lnot \Big( (\lnot {\lifboth{\bhat l'\fromclause\sigma}}\tau \land \lifboth{\AImat(\bhat C_1)\sigma}\tau) \spam\lor 
						(\lifboth{\bhat l\fromclause\sigma}\tau \land \lifboth{\AImat(\bhat C_2)\sigma}\tau) \Big)\\
						& = \AImat(\bhat C) 
					\end{align*}


			\end{enumerate}



		\item[Factorisation.]
			Suppse the clause $C$ is the result of a factorisation $\inference$ of $C_1: l \lor l' \lor D$ 
with $\sigma = \mgu(\inference)$ and $\tau = \aiu(\inference)$.

			Then $\AImat(C) = \lifboth{\AImat(C_1)\sigma}\tau$, so the construction is not influenced by the coloring and the induction hypothesis gives the result.
			\qedhere
	\end{itemize}
\end{proof}


\begin{thm}
	Let $\pi$ be a resolution refutation of $\Gamma\cup\Delta$.
	Then $\AImat( \pi )$ is an interpolant.
\end{thm}
\begin{proof}
	By Lemma~\ref{lemma:gamma_entails_quantified_ai},
	$\Gamma \entails \Q(C)(\AImat(\square) \lor \AIcl(\square))$.
	But as $\AIcl(\square) = \square$, this simplifes to
	$\Gamma \entails \Q(C)\AImat(\pi)$.

	By constructing a proof $\bhat \pi$ from $\pi$ with $\bhat \Gamma = \Delta$ and $\bhat \Delta = \Gamma$, we obtain by Lemma~\ref{lemma:gamma_entails_quantified_ai} that $\bhat\Gamma \entails \Q(\bhat \pi)\AImat(\bhat \pi)$.
	By Lemma \ref{lemma:ai_symmetry}, this however is nothing else than
	$\Delta \entails \lnot \Q(\pi) \AImat(\pi)$. 

	As furthermore by construction no colored symbols occur in $\Q(\pi) \AImat(\pi)$, it is an interpolant for $\Gamma\cup\Delta$.

\end{proof}

\end{document}
